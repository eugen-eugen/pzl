(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const s of i)if(s.type==="childList")for(const o of s.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&n(o)}).observe(document,{childList:!0,subtree:!0});function t(i){const s={};return i.integrity&&(s.integrity=i.integrity),i.referrerPolicy&&(s.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?s.credentials="include":i.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function n(i){if(i.ep)return;i.ep=!0;const s=t(i);fetch(i.href,s)}})();const od="v1.2.0",yt=`puzzle-static-${od}`,pt=`puzzle-manifest-${od}`;let F="/puzzle/";async function _t(){try{const r=await caches.open(pt),e=await r.match("asset-manifest.json");let t=null;e&&(t=(await e.json()).version,console.log("[SW] Cached manifest version:",t));const i=await(await fetch("asset-manifest.json",{cache:"no-cache"})).json(),s=i.version;console.log("[SW] New manifest version:",s);const o=t!==s||s==="dev";if(o){console.log("[SW] Version changed or dev mode detected - invalidating cache");const a=await caches.keys();await Promise.all(a.filter(d=>d.startsWith("puzzle-")).map(d=>(console.log("[SW] Deleting cache:",d),caches.delete(d)))),await(await caches.open(pt)).put("asset-manifest.json",new Response(JSON.stringify(i))),console.log("[SW] Cache invalidated, new manifest cached")}else console.log("[SW] Version unchanged - keeping existing cache"),await r.put("asset-manifest.json",new Response(JSON.stringify(i)));return{manifest:i,cacheInvalidated:o}}catch(r){console.warn("[SW] Failed to check manifest version:",r);const t=await(await caches.open(pt)).match("asset-manifest.json");if(t)return{manifest:await t.json(),cacheInvalidated:!1};throw r}}async function Gf(){try{const{manifest:r,cacheInvalidated:e}=await _t();r.base&&(F=r.base);const t=[F,`${F}index.html`,`${F}manifest.json`,`${F}i18n/en.json`,`${F}i18n/de.json`,`${F}i18n/ru.json`,`${F}i18n/ua.json`,`${F}pictures/A320.jpg`,`${F}pictures/kleidung.png`,`${F}pictures/pictures.json`,`${F}pictures/remote-pictures.json`],n=[];return r.assets&&r.assets.js&&r.assets.js.forEach(function(i){n.push(`${F}assets/${i}`)}),r.assets&&r.assets.css&&r.assets.css.forEach(function(i){n.push(`${F}assets/${i}`)}),{base:F,allAssets:t.concat(n)}}catch(r){return console.warn("Could not load asset-manifest.json",r),{base:F,allAssets:[]}}}self.addEventListener("install",function(r){r.waitUntil(Gf().then(function(e){return F=e.base,console.log("Service Worker installing with base:",F),console.log("Prefetching",e.allAssets.length,"assets..."),caches.open(yt).then(function(t){return t.addAll(e.allAssets).then(function(){console.log("All assets prefetched and cached successfully")})})}).then(function(){return console.log("Service Worker installed, activating..."),self.skipWaiting()}).catch(function(e){throw console.error("Service Worker install failed:",e),e}))});self.addEventListener("activate",r=>{r.waitUntil(Promise.all([_t().catch(e=>{console.warn("[SW] Failed to check manifest on activate:",e)}),caches.keys().then(e=>Promise.all(e.filter(t=>t.startsWith("puzzle-static-")&&t!==yt).map(t=>(console.log("[SW] Removing old static cache:",t),caches.delete(t)))))]).then(()=>self.clients.claim()))});self.addEventListener("fetch",function(r){const e=r.request,t=new URL(e.url);if(e.method!=="GET")return;const n=t.origin+t.pathname;if(t.pathname.endsWith("/asset-manifest.json")||t.pathname===`${F}asset-manifest.json`){r.respondWith(_t().then(({manifest:i})=>new Response(JSON.stringify(i),{headers:{"Content-Type":"application/json"}})).catch(function(i){return console.error("[SW] Failed to fetch manifest:",i),caches.match("asset-manifest.json",{cacheName:pt})}));return}if(t.pathname===F||t.pathname===`${F}index.html`){r.respondWith(_t().then(function(){return fetch(e)}).then(function(i){const s=i.clone();return caches.open(yt).then(function(o){o.put(n,s)}),i}).catch(function(i){return console.warn("[SW] Failed to fetch index.html, using cache:",i),caches.match(n)}));return}if(t.origin===location.origin){r.respondWith(caches.match(n,{ignoreSearch:!0}).then(function(i){return i||fetch(e).then(function(s){if(s.status===200){const o=s.clone();caches.open(yt).then(function(a){a.put(n,o)})}return s})}));return}});"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.register("/pzl/service-worker.js",{type:"module"}).catch(e=>{console.warn("SW registration failed",e)})});class b{constructor(e=0,t=0){this._point=new DOMPoint(e,t)}get x(){return this._point.x}set x(e){this._point.x=e}get y(){return this._point.y}set y(e){this._point.y=e}clone(){return new b(this.x,this.y)}add(e){const t=this._point.matrixTransform(new DOMMatrix().translate(e.x,e.y));return new b(t.x,t.y)}sub(e){const t=this._point.matrixTransform(new DOMMatrix().translate(-e.x,-e.y));return new b(t.x,t.y)}scaled(e){const t=this._point.matrixTransform(new DOMMatrix().scale(e));return new b(t.x,t.y)}rotatedAroundDeg(e,t){const n=new DOMMatrix().translate(e.x,e.y).rotate(t).translate(-e.x,-e.y),i=this._point.matrixTransform(n);return new b(i.x,i.y)}mutAdd(e){return this.x+=e.x,this.y+=e.y,this}distance2(e){const t=this.x-e.x,n=this.y-e.y;return t*t+n*n}equals(e){return this.x===e.x&&this.y===e.y}toString(){return`Point(${this.x}, ${this.y})`}toJSON(){return{x:this.x,y:this.y}}static min(e,t){return new b(Math.min(e.x,t.x),Math.min(e.y,t.y))}static max(e,t){return new b(Math.max(e.x,t.x),Math.max(e.y,t.y))}}function jf(r,e){return r.distance2(e)}class W{constructor(e=null,t=0,n=0){this._position=e instanceof b?e.clone():new b,this.width=t,this.height=n}get position(){return this._position}static fromPoints(e,t){return new W(e,t.x-e.x,t.y-e.y)}clone(){return new W(this.position,this.width,this.height)}get topLeft(){return this.position.clone()}get bottomRight(){return new b(this.position.x+this.width,this.position.y+this.height)}get center(){return new b(this.position.x+this.width/2,this.position.y+this.height/2)}get centerOffset(){return new b(this.width/2,this.height/2)}isEmpty(){return this.width<=0||this.height<=0}plus(e){if(this.isEmpty())return e.clone();if(e.isEmpty())return this.clone();const t=new b(Math.min(this.topLeft.x,e.topLeft.x),Math.min(this.topLeft.y,e.topLeft.y)),n=new b(Math.max(this.bottomRight.x,e.bottomRight.x),Math.max(this.bottomRight.y,e.bottomRight.y));return W.fromPoints(t,n)}scaled(e){return new W(this.position.scaled(e),this.width*e,this.height*e)}toString(){return`Rectangle(${this.position.x}, ${this.position.y}, ${this.width}, ${this.height})`}}function Ao(r,e){const t={};for(const[n,i]of Object.entries(r))i instanceof b?t[n]=i.sub(e):Array.isArray(i)?t[n]=i.map(s=>s instanceof b?s.sub(e):s):t[n]=i;return t}function zf(r){const e={};for(const[t,n]of Object.entries(r))n&&typeof n.x=="number"&&typeof n.y=="number"?e[t]=new b(n.x,n.y):e[t]=n;return e}function ad(r){if(!r||r.length===0)return W.fromPoints(new b(0,0),new b(0,0));let e=1/0,t=-1/0,n=1/0,i=-1/0;for(const s of r)s&&s.x!==void 0&&s.y!==void 0&&(e=Math.min(e,s.x),t=Math.max(t,s.x),n=Math.min(n,s.y),i=Math.max(i,s.y));return isFinite(e)?W.fromPoints(new b(e,n),new b(t,i)):W.fromPoints(new b(0,0),new b(0,0))}const De=.7,ee="north",te="east",re="south",ne="west",Ze=[ee,te,re,ne],Lo="nw",Oo="ne",Mo="se",Do="sw";class ve{static isArrayEmpty(e){return!e||e.length===0}static hasElements(e){return e&&e.length>0}static getPieceCount(e){return e.pieces?e.pieces.length:0}static isElementValid(e){return e!=null}static isTotalPiecesEmpty(e){return!e.totalPieces||e.totalPieces===0}static isPositiveNumber(e){return typeof e=="number"&&!isNaN(e)&&e>0}static symmetricRandomDeviation(e){return(Math.random()-.5)*2*e}}function $s(r){return!r||r.length===0}const Bf=50,Uf=25;class Hf{constructor(){this.reset()}reset(){this.pieces=[],this.totalPieces=0,this.groups=[],this.snapNearPx=Bf,this.snapReadyPx=Uf,this.noRotate=!1,this.deepLinkImageUrl=null,this.deepLinkPieceCount=null,this.deepLinkNoRotate="n",this.deepLinkRemoveColor="n",this.deepLinkLicense=null,this.deepLinkResume="n",this.viewport={offsetX:0,offsetY:0,scale:1},this.image={data:null,source:null,id:null,license:null},this.puzzleSettings={sliderValue:3,removeColor:!1}}resetDeepLinkState(){this.deepLinkImageUrl=null,this.deepLinkPieceCount=null,this.deepLinkNoRotate="n",this.deepLinkRemoveColor="n",this.deepLinkLicense=null}}const p=new Hf;var lt=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function $f(r){throw new Error('Could not dynamically require "'+r+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var Ut,No;function Wf(){if(No)return Ut;No=1;function r(){this.__data__=[],this.size=0}return Ut=r,Ut}var Ht,ko;function ro(){if(ko)return Ht;ko=1;function r(e,t){return e===t||e!==e&&t!==t}return Ht=r,Ht}var $t,Fo;function St(){if(Fo)return $t;Fo=1;var r=ro();function e(t,n){for(var i=t.length;i--;)if(r(t[i][0],n))return i;return-1}return $t=e,$t}var Wt,Go;function Vf(){if(Go)return Wt;Go=1;var r=St(),e=Array.prototype,t=e.splice;function n(i){var s=this.__data__,o=r(s,i);if(o<0)return!1;var a=s.length-1;return o==a?s.pop():t.call(s,o,1),--this.size,!0}return Wt=n,Wt}var Vt,jo;function Kf(){if(jo)return Vt;jo=1;var r=St();function e(t){var n=this.__data__,i=r(n,t);return i<0?void 0:n[i][1]}return Vt=e,Vt}var Kt,zo;function Xf(){if(zo)return Kt;zo=1;var r=St();function e(t){return r(this.__data__,t)>-1}return Kt=e,Kt}var Xt,Bo;function Yf(){if(Bo)return Xt;Bo=1;var r=St();function e(t,n){var i=this.__data__,s=r(i,t);return s<0?(++this.size,i.push([t,n])):i[s][1]=n,this}return Xt=e,Xt}var Yt,Uo;function Rt(){if(Uo)return Yt;Uo=1;var r=Wf(),e=Vf(),t=Kf(),n=Xf(),i=Yf();function s(o){var a=-1,c=o==null?0:o.length;for(this.clear();++a<c;){var d=o[a];this.set(d[0],d[1])}}return s.prototype.clear=r,s.prototype.delete=e,s.prototype.get=t,s.prototype.has=n,s.prototype.set=i,Yt=s,Yt}var Zt,Ho;function Zf(){if(Ho)return Zt;Ho=1;var r=Rt();function e(){this.__data__=new r,this.size=0}return Zt=e,Zt}var Jt,$o;function Jf(){if($o)return Jt;$o=1;function r(e){var t=this.__data__,n=t.delete(e);return this.size=t.size,n}return Jt=r,Jt}var Qt,Wo;function Qf(){if(Wo)return Qt;Wo=1;function r(e){return this.__data__.get(e)}return Qt=r,Qt}var er,Vo;function eh(){if(Vo)return er;Vo=1;function r(e){return this.__data__.has(e)}return er=r,er}var tr,Ko;function cd(){if(Ko)return tr;Ko=1;var r=typeof lt=="object"&&lt&&lt.Object===Object&&lt;return tr=r,tr}var rr,Xo;function ae(){if(Xo)return rr;Xo=1;var r=cd(),e=typeof self=="object"&&self&&self.Object===Object&&self,t=r||e||Function("return this")();return rr=t,rr}var nr,Yo;function je(){if(Yo)return nr;Yo=1;var r=ae(),e=r.Symbol;return nr=e,nr}var ir,Zo;function th(){if(Zo)return ir;Zo=1;var r=je(),e=Object.prototype,t=e.hasOwnProperty,n=e.toString,i=r?r.toStringTag:void 0;function s(o){var a=t.call(o,i),c=o[i];try{o[i]=void 0;var d=!0}catch{}var u=n.call(o);return d&&(a?o[i]=c:delete o[i]),u}return ir=s,ir}var sr,Jo;function rh(){if(Jo)return sr;Jo=1;var r=Object.prototype,e=r.toString;function t(n){return e.call(n)}return sr=t,sr}var or,Qo;function ze(){if(Qo)return or;Qo=1;var r=je(),e=th(),t=rh(),n="[object Null]",i="[object Undefined]",s=r?r.toStringTag:void 0;function o(a){return a==null?a===void 0?i:n:s&&s in Object(a)?e(a):t(a)}return or=o,or}var ar,ea;function Pe(){if(ea)return ar;ea=1;function r(e){var t=typeof e;return e!=null&&(t=="object"||t=="function")}return ar=r,ar}var cr,ta;function Tt(){if(ta)return cr;ta=1;var r=ze(),e=Pe(),t="[object AsyncFunction]",n="[object Function]",i="[object GeneratorFunction]",s="[object Proxy]";function o(a){if(!e(a))return!1;var c=r(a);return c==n||c==i||c==t||c==s}return cr=o,cr}var ur,ra;function nh(){if(ra)return ur;ra=1;var r=ae(),e=r["__core-js_shared__"];return ur=e,ur}var lr,na;function ih(){if(na)return lr;na=1;var r=nh(),e=(function(){var n=/[^.]+$/.exec(r&&r.keys&&r.keys.IE_PROTO||"");return n?"Symbol(src)_1."+n:""})();function t(n){return!!e&&e in n}return lr=t,lr}var dr,ia;function ud(){if(ia)return dr;ia=1;var r=Function.prototype,e=r.toString;function t(n){if(n!=null){try{return e.call(n)}catch{}try{return n+""}catch{}}return""}return dr=t,dr}var fr,sa;function sh(){if(sa)return fr;sa=1;var r=Tt(),e=ih(),t=Pe(),n=ud(),i=/[\\^$.*+?()[\]{}|]/g,s=/^\[object .+?Constructor\]$/,o=Function.prototype,a=Object.prototype,c=o.toString,d=a.hasOwnProperty,u=RegExp("^"+c.call(d).replace(i,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");function l(f){if(!t(f)||e(f))return!1;var h=r(f)?u:s;return h.test(n(f))}return fr=l,fr}var hr,oa;function oh(){if(oa)return hr;oa=1;function r(e,t){return e==null?void 0:e[t]}return hr=r,hr}var pr,aa;function Ce(){if(aa)return pr;aa=1;var r=sh(),e=oh();function t(n,i){var s=e(n,i);return r(s)?s:void 0}return pr=t,pr}var gr,ca;function no(){if(ca)return gr;ca=1;var r=Ce(),e=ae(),t=r(e,"Map");return gr=t,gr}var mr,ua;function qt(){if(ua)return mr;ua=1;var r=Ce(),e=r(Object,"create");return mr=e,mr}var vr,la;function ah(){if(la)return vr;la=1;var r=qt();function e(){this.__data__=r?r(null):{},this.size=0}return vr=e,vr}var yr,da;function ch(){if(da)return yr;da=1;function r(e){var t=this.has(e)&&delete this.__data__[e];return this.size-=t?1:0,t}return yr=r,yr}var _r,fa;function uh(){if(fa)return _r;fa=1;var r=qt(),e="__lodash_hash_undefined__",t=Object.prototype,n=t.hasOwnProperty;function i(s){var o=this.__data__;if(r){var a=o[s];return a===e?void 0:a}return n.call(o,s)?o[s]:void 0}return _r=i,_r}var wr,ha;function lh(){if(ha)return wr;ha=1;var r=qt(),e=Object.prototype,t=e.hasOwnProperty;function n(i){var s=this.__data__;return r?s[i]!==void 0:t.call(s,i)}return wr=n,wr}var br,pa;function dh(){if(pa)return br;pa=1;var r=qt(),e="__lodash_hash_undefined__";function t(n,i){var s=this.__data__;return this.size+=this.has(n)?0:1,s[n]=r&&i===void 0?e:i,this}return br=t,br}var Er,ga;function fh(){if(ga)return Er;ga=1;var r=ah(),e=ch(),t=uh(),n=lh(),i=dh();function s(o){var a=-1,c=o==null?0:o.length;for(this.clear();++a<c;){var d=o[a];this.set(d[0],d[1])}}return s.prototype.clear=r,s.prototype.delete=e,s.prototype.get=t,s.prototype.has=n,s.prototype.set=i,Er=s,Er}var Ir,ma;function hh(){if(ma)return Ir;ma=1;var r=fh(),e=Rt(),t=no();function n(){this.size=0,this.__data__={hash:new r,map:new(t||e),string:new r}}return Ir=n,Ir}var Pr,va;function ph(){if(va)return Pr;va=1;function r(e){var t=typeof e;return t=="string"||t=="number"||t=="symbol"||t=="boolean"?e!=="__proto__":e===null}return Pr=r,Pr}var Cr,ya;function xt(){if(ya)return Cr;ya=1;var r=ph();function e(t,n){var i=t.__data__;return r(n)?i[typeof n=="string"?"string":"hash"]:i.map}return Cr=e,Cr}var Sr,_a;function gh(){if(_a)return Sr;_a=1;var r=xt();function e(t){var n=r(this,t).delete(t);return this.size-=n?1:0,n}return Sr=e,Sr}var Rr,wa;function mh(){if(wa)return Rr;wa=1;var r=xt();function e(t){return r(this,t).get(t)}return Rr=e,Rr}var Tr,ba;function vh(){if(ba)return Tr;ba=1;var r=xt();function e(t){return r(this,t).has(t)}return Tr=e,Tr}var qr,Ea;function yh(){if(Ea)return qr;Ea=1;var r=xt();function e(t,n){var i=r(this,t),s=i.size;return i.set(t,n),this.size+=i.size==s?0:1,this}return qr=e,qr}var xr,Ia;function io(){if(Ia)return xr;Ia=1;var r=hh(),e=gh(),t=mh(),n=vh(),i=yh();function s(o){var a=-1,c=o==null?0:o.length;for(this.clear();++a<c;){var d=o[a];this.set(d[0],d[1])}}return s.prototype.clear=r,s.prototype.delete=e,s.prototype.get=t,s.prototype.has=n,s.prototype.set=i,xr=s,xr}var Ar,Pa;function _h(){if(Pa)return Ar;Pa=1;var r=Rt(),e=no(),t=io(),n=200;function i(s,o){var a=this.__data__;if(a instanceof r){var c=a.__data__;if(!e||c.length<n-1)return c.push([s,o]),this.size=++a.size,this;a=this.__data__=new t(c)}return a.set(s,o),this.size=a.size,this}return Ar=i,Ar}var Lr,Ca;function so(){if(Ca)return Lr;Ca=1;var r=Rt(),e=Zf(),t=Jf(),n=Qf(),i=eh(),s=_h();function o(a){var c=this.__data__=new r(a);this.size=c.size}return o.prototype.clear=e,o.prototype.delete=t,o.prototype.get=n,o.prototype.has=i,o.prototype.set=s,Lr=o,Lr}var Or,Sa;function oo(){if(Sa)return Or;Sa=1;function r(e,t){for(var n=-1,i=e==null?0:e.length;++n<i&&t(e[n],n,e)!==!1;);return e}return Or=r,Or}var Mr,Ra;function ld(){if(Ra)return Mr;Ra=1;var r=Ce(),e=(function(){try{var t=r(Object,"defineProperty");return t({},"",{}),t}catch{}})();return Mr=e,Mr}var Dr,Ta;function dd(){if(Ta)return Dr;Ta=1;var r=ld();function e(t,n,i){n=="__proto__"&&r?r(t,n,{configurable:!0,enumerable:!0,value:i,writable:!0}):t[n]=i}return Dr=e,Dr}var Nr,qa;function fd(){if(qa)return Nr;qa=1;var r=dd(),e=ro(),t=Object.prototype,n=t.hasOwnProperty;function i(s,o,a){var c=s[o];(!(n.call(s,o)&&e(c,a))||a===void 0&&!(o in s))&&r(s,o,a)}return Nr=i,Nr}var kr,xa;function At(){if(xa)return kr;xa=1;var r=fd(),e=dd();function t(n,i,s,o){var a=!s;s||(s={});for(var c=-1,d=i.length;++c<d;){var u=i[c],l=o?o(s[u],n[u],u,s,n):void 0;l===void 0&&(l=n[u]),a?e(s,u,l):r(s,u,l)}return s}return kr=t,kr}var Fr,Aa;function wh(){if(Aa)return Fr;Aa=1;function r(e,t){for(var n=-1,i=Array(e);++n<e;)i[n]=t(n);return i}return Fr=r,Fr}var Gr,La;function le(){if(La)return Gr;La=1;function r(e){return e!=null&&typeof e=="object"}return Gr=r,Gr}var jr,Oa;function bh(){if(Oa)return jr;Oa=1;var r=ze(),e=le(),t="[object Arguments]";function n(i){return e(i)&&r(i)==t}return jr=n,jr}var zr,Ma;function Lt(){if(Ma)return zr;Ma=1;var r=bh(),e=le(),t=Object.prototype,n=t.hasOwnProperty,i=t.propertyIsEnumerable,s=r((function(){return arguments})())?r:function(o){return e(o)&&n.call(o,"callee")&&!i.call(o,"callee")};return zr=s,zr}var Br,Da;function B(){if(Da)return Br;Da=1;var r=Array.isArray;return Br=r,Br}var $e={exports:{}},Ur,Na;function Eh(){if(Na)return Ur;Na=1;function r(){return!1}return Ur=r,Ur}$e.exports;var ka;function tt(){return ka||(ka=1,(function(r,e){var t=ae(),n=Eh(),i=e&&!e.nodeType&&e,s=i&&!0&&r&&!r.nodeType&&r,o=s&&s.exports===i,a=o?t.Buffer:void 0,c=a?a.isBuffer:void 0,d=c||n;r.exports=d})($e,$e.exports)),$e.exports}var Hr,Fa;function hd(){if(Fa)return Hr;Fa=1;var r=9007199254740991,e=/^(?:0|[1-9]\d*)$/;function t(n,i){var s=typeof n;return i=i??r,!!i&&(s=="number"||s!="symbol"&&e.test(n))&&n>-1&&n%1==0&&n<i}return Hr=t,Hr}var $r,Ga;function ao(){if(Ga)return $r;Ga=1;var r=9007199254740991;function e(t){return typeof t=="number"&&t>-1&&t%1==0&&t<=r}return $r=e,$r}var Wr,ja;function Ih(){if(ja)return Wr;ja=1;var r=ze(),e=ao(),t=le(),n="[object Arguments]",i="[object Array]",s="[object Boolean]",o="[object Date]",a="[object Error]",c="[object Function]",d="[object Map]",u="[object Number]",l="[object Object]",f="[object RegExp]",h="[object Set]",g="[object String]",m="[object WeakMap]",y="[object ArrayBuffer]",_="[object DataView]",v="[object Float32Array]",I="[object Float64Array]",w="[object Int8Array]",S="[object Int16Array]",E="[object Int32Array]",P="[object Uint8Array]",R="[object Uint8ClampedArray]",T="[object Uint16Array]",M="[object Uint32Array]",C={};C[v]=C[I]=C[w]=C[S]=C[E]=C[P]=C[R]=C[T]=C[M]=!0,C[n]=C[i]=C[y]=C[s]=C[_]=C[o]=C[a]=C[c]=C[d]=C[u]=C[l]=C[f]=C[h]=C[g]=C[m]=!1;function L(j){return t(j)&&e(j.length)&&!!C[r(j)]}return Wr=L,Wr}var Vr,za;function co(){if(za)return Vr;za=1;function r(e){return function(t){return e(t)}}return Vr=r,Vr}var We={exports:{}};We.exports;var Ba;function uo(){return Ba||(Ba=1,(function(r,e){var t=cd(),n=e&&!e.nodeType&&e,i=n&&!0&&r&&!r.nodeType&&r,s=i&&i.exports===n,o=s&&t.process,a=(function(){try{var c=i&&i.require&&i.require("util").types;return c||o&&o.binding&&o.binding("util")}catch{}})();r.exports=a})(We,We.exports)),We.exports}var Kr,Ua;function Ot(){if(Ua)return Kr;Ua=1;var r=Ih(),e=co(),t=uo(),n=t&&t.isTypedArray,i=n?e(n):r;return Kr=i,Kr}var Xr,Ha;function pd(){if(Ha)return Xr;Ha=1;var r=wh(),e=Lt(),t=B(),n=tt(),i=hd(),s=Ot(),o=Object.prototype,a=o.hasOwnProperty;function c(d,u){var l=t(d),f=!l&&e(d),h=!l&&!f&&n(d),g=!l&&!f&&!h&&s(d),m=l||f||h||g,y=m?r(d.length,String):[],_=y.length;for(var v in d)(u||a.call(d,v))&&!(m&&(v=="length"||h&&(v=="offset"||v=="parent")||g&&(v=="buffer"||v=="byteLength"||v=="byteOffset")||i(v,_)))&&y.push(v);return y}return Xr=c,Xr}var Yr,$a;function Mt(){if($a)return Yr;$a=1;var r=Object.prototype;function e(t){var n=t&&t.constructor,i=typeof n=="function"&&n.prototype||r;return t===i}return Yr=e,Yr}var Zr,Wa;function gd(){if(Wa)return Zr;Wa=1;function r(e,t){return function(n){return e(t(n))}}return Zr=r,Zr}var Jr,Va;function Ph(){if(Va)return Jr;Va=1;var r=gd(),e=r(Object.keys,Object);return Jr=e,Jr}var Qr,Ka;function lo(){if(Ka)return Qr;Ka=1;var r=Mt(),e=Ph(),t=Object.prototype,n=t.hasOwnProperty;function i(s){if(!r(s))return e(s);var o=[];for(var a in Object(s))n.call(s,a)&&a!="constructor"&&o.push(a);return o}return Qr=i,Qr}var en,Xa;function Se(){if(Xa)return en;Xa=1;var r=Tt(),e=ao();function t(n){return n!=null&&e(n.length)&&!r(n)}return en=t,en}var tn,Ya;function Re(){if(Ya)return tn;Ya=1;var r=pd(),e=lo(),t=Se();function n(i){return t(i)?r(i):e(i)}return tn=n,tn}var rn,Za;function Ch(){if(Za)return rn;Za=1;var r=At(),e=Re();function t(n,i){return n&&r(i,e(i),n)}return rn=t,rn}var nn,Ja;function Sh(){if(Ja)return nn;Ja=1;function r(e){var t=[];if(e!=null)for(var n in Object(e))t.push(n);return t}return nn=r,nn}var sn,Qa;function Rh(){if(Qa)return sn;Qa=1;var r=Pe(),e=Mt(),t=Sh(),n=Object.prototype,i=n.hasOwnProperty;function s(o){if(!r(o))return t(o);var a=e(o),c=[];for(var d in o)d=="constructor"&&(a||!i.call(o,d))||c.push(d);return c}return sn=s,sn}var on,ec;function fo(){if(ec)return on;ec=1;var r=pd(),e=Rh(),t=Se();function n(i){return t(i)?r(i,!0):e(i)}return on=n,on}var an,tc;function Th(){if(tc)return an;tc=1;var r=At(),e=fo();function t(n,i){return n&&r(i,e(i),n)}return an=t,an}var Ve={exports:{}};Ve.exports;var rc;function qh(){return rc||(rc=1,(function(r,e){var t=ae(),n=e&&!e.nodeType&&e,i=n&&!0&&r&&!r.nodeType&&r,s=i&&i.exports===n,o=s?t.Buffer:void 0,a=o?o.allocUnsafe:void 0;function c(d,u){if(u)return d.slice();var l=d.length,f=a?a(l):new d.constructor(l);return d.copy(f),f}r.exports=c})(Ve,Ve.exports)),Ve.exports}var cn,nc;function xh(){if(nc)return cn;nc=1;function r(e,t){var n=-1,i=e.length;for(t||(t=Array(i));++n<i;)t[n]=e[n];return t}return cn=r,cn}var un,ic;function md(){if(ic)return un;ic=1;function r(e,t){for(var n=-1,i=e==null?0:e.length,s=0,o=[];++n<i;){var a=e[n];t(a,n,e)&&(o[s++]=a)}return o}return un=r,un}var ln,sc;function vd(){if(sc)return ln;sc=1;function r(){return[]}return ln=r,ln}var dn,oc;function ho(){if(oc)return dn;oc=1;var r=md(),e=vd(),t=Object.prototype,n=t.propertyIsEnumerable,i=Object.getOwnPropertySymbols,s=i?function(o){return o==null?[]:(o=Object(o),r(i(o),function(a){return n.call(o,a)}))}:e;return dn=s,dn}var fn,ac;function Ah(){if(ac)return fn;ac=1;var r=At(),e=ho();function t(n,i){return r(n,e(n),i)}return fn=t,fn}var hn,cc;function po(){if(cc)return hn;cc=1;function r(e,t){for(var n=-1,i=t.length,s=e.length;++n<i;)e[s+n]=t[n];return e}return hn=r,hn}var pn,uc;function go(){if(uc)return pn;uc=1;var r=gd(),e=r(Object.getPrototypeOf,Object);return pn=e,pn}var gn,lc;function yd(){if(lc)return gn;lc=1;var r=po(),e=go(),t=ho(),n=vd(),i=Object.getOwnPropertySymbols,s=i?function(o){for(var a=[];o;)r(a,t(o)),o=e(o);return a}:n;return gn=s,gn}var mn,dc;function Lh(){if(dc)return mn;dc=1;var r=At(),e=yd();function t(n,i){return r(n,e(n),i)}return mn=t,mn}var vn,fc;function _d(){if(fc)return vn;fc=1;var r=po(),e=B();function t(n,i,s){var o=i(n);return e(n)?o:r(o,s(n))}return vn=t,vn}var yn,hc;function wd(){if(hc)return yn;hc=1;var r=_d(),e=ho(),t=Re();function n(i){return r(i,t,e)}return yn=n,yn}var _n,pc;function Oh(){if(pc)return _n;pc=1;var r=_d(),e=yd(),t=fo();function n(i){return r(i,t,e)}return _n=n,_n}var wn,gc;function Mh(){if(gc)return wn;gc=1;var r=Ce(),e=ae(),t=r(e,"DataView");return wn=t,wn}var bn,mc;function Dh(){if(mc)return bn;mc=1;var r=Ce(),e=ae(),t=r(e,"Promise");return bn=t,bn}var En,vc;function bd(){if(vc)return En;vc=1;var r=Ce(),e=ae(),t=r(e,"Set");return En=t,En}var In,yc;function Nh(){if(yc)return In;yc=1;var r=Ce(),e=ae(),t=r(e,"WeakMap");return In=t,In}var Pn,_c;function Be(){if(_c)return Pn;_c=1;var r=Mh(),e=no(),t=Dh(),n=bd(),i=Nh(),s=ze(),o=ud(),a="[object Map]",c="[object Object]",d="[object Promise]",u="[object Set]",l="[object WeakMap]",f="[object DataView]",h=o(r),g=o(e),m=o(t),y=o(n),_=o(i),v=s;return(r&&v(new r(new ArrayBuffer(1)))!=f||e&&v(new e)!=a||t&&v(t.resolve())!=d||n&&v(new n)!=u||i&&v(new i)!=l)&&(v=function(I){var w=s(I),S=w==c?I.constructor:void 0,E=S?o(S):"";if(E)switch(E){case h:return f;case g:return a;case m:return d;case y:return u;case _:return l}return w}),Pn=v,Pn}var Cn,wc;function kh(){if(wc)return Cn;wc=1;var r=Object.prototype,e=r.hasOwnProperty;function t(n){var i=n.length,s=new n.constructor(i);return i&&typeof n[0]=="string"&&e.call(n,"index")&&(s.index=n.index,s.input=n.input),s}return Cn=t,Cn}var Sn,bc;function Ed(){if(bc)return Sn;bc=1;var r=ae(),e=r.Uint8Array;return Sn=e,Sn}var Rn,Ec;function mo(){if(Ec)return Rn;Ec=1;var r=Ed();function e(t){var n=new t.constructor(t.byteLength);return new r(n).set(new r(t)),n}return Rn=e,Rn}var Tn,Ic;function Fh(){if(Ic)return Tn;Ic=1;var r=mo();function e(t,n){var i=n?r(t.buffer):t.buffer;return new t.constructor(i,t.byteOffset,t.byteLength)}return Tn=e,Tn}var qn,Pc;function Gh(){if(Pc)return qn;Pc=1;var r=/\w*$/;function e(t){var n=new t.constructor(t.source,r.exec(t));return n.lastIndex=t.lastIndex,n}return qn=e,qn}var xn,Cc;function jh(){if(Cc)return xn;Cc=1;var r=je(),e=r?r.prototype:void 0,t=e?e.valueOf:void 0;function n(i){return t?Object(t.call(i)):{}}return xn=n,xn}var An,Sc;function zh(){if(Sc)return An;Sc=1;var r=mo();function e(t,n){var i=n?r(t.buffer):t.buffer;return new t.constructor(i,t.byteOffset,t.length)}return An=e,An}var Ln,Rc;function Bh(){if(Rc)return Ln;Rc=1;var r=mo(),e=Fh(),t=Gh(),n=jh(),i=zh(),s="[object Boolean]",o="[object Date]",a="[object Map]",c="[object Number]",d="[object RegExp]",u="[object Set]",l="[object String]",f="[object Symbol]",h="[object ArrayBuffer]",g="[object DataView]",m="[object Float32Array]",y="[object Float64Array]",_="[object Int8Array]",v="[object Int16Array]",I="[object Int32Array]",w="[object Uint8Array]",S="[object Uint8ClampedArray]",E="[object Uint16Array]",P="[object Uint32Array]";function R(T,M,C){var L=T.constructor;switch(M){case h:return r(T);case s:case o:return new L(+T);case g:return e(T,C);case m:case y:case _:case v:case I:case w:case S:case E:case P:return i(T,C);case a:return new L;case c:case l:return new L(T);case d:return t(T);case u:return new L;case f:return n(T)}}return Ln=R,Ln}var On,Tc;function Id(){if(Tc)return On;Tc=1;var r=Pe(),e=Object.create,t=(function(){function n(){}return function(i){if(!r(i))return{};if(e)return e(i);n.prototype=i;var s=new n;return n.prototype=void 0,s}})();return On=t,On}var Mn,qc;function Uh(){if(qc)return Mn;qc=1;var r=Id(),e=go(),t=Mt();function n(i){return typeof i.constructor=="function"&&!t(i)?r(e(i)):{}}return Mn=n,Mn}var Dn,xc;function Hh(){if(xc)return Dn;xc=1;var r=Be(),e=le(),t="[object Map]";function n(i){return e(i)&&r(i)==t}return Dn=n,Dn}var Nn,Ac;function $h(){if(Ac)return Nn;Ac=1;var r=Hh(),e=co(),t=uo(),n=t&&t.isMap,i=n?e(n):r;return Nn=i,Nn}var kn,Lc;function Wh(){if(Lc)return kn;Lc=1;var r=Be(),e=le(),t="[object Set]";function n(i){return e(i)&&r(i)==t}return kn=n,kn}var Fn,Oc;function Vh(){if(Oc)return Fn;Oc=1;var r=Wh(),e=co(),t=uo(),n=t&&t.isSet,i=n?e(n):r;return Fn=i,Fn}var Gn,Mc;function Kh(){if(Mc)return Gn;Mc=1;var r=so(),e=oo(),t=fd(),n=Ch(),i=Th(),s=qh(),o=xh(),a=Ah(),c=Lh(),d=wd(),u=Oh(),l=Be(),f=kh(),h=Bh(),g=Uh(),m=B(),y=tt(),_=$h(),v=Pe(),I=Vh(),w=Re(),S=fo(),E=1,P=2,R=4,T="[object Arguments]",M="[object Array]",C="[object Boolean]",L="[object Date]",j="[object Error]",K="[object Function]",de="[object GeneratorFunction]",Bt="[object Map]",_f="[object Number]",So="[object Object]",wf="[object RegExp]",bf="[object Set]",Ef="[object String]",If="[object Symbol]",Pf="[object WeakMap]",Cf="[object ArrayBuffer]",Sf="[object DataView]",Rf="[object Float32Array]",Tf="[object Float64Array]",qf="[object Int8Array]",xf="[object Int16Array]",Af="[object Int32Array]",Lf="[object Uint8Array]",Of="[object Uint8ClampedArray]",Mf="[object Uint16Array]",Df="[object Uint32Array]",D={};D[T]=D[M]=D[Cf]=D[Sf]=D[C]=D[L]=D[Rf]=D[Tf]=D[qf]=D[xf]=D[Af]=D[Bt]=D[_f]=D[So]=D[wf]=D[bf]=D[Ef]=D[If]=D[Lf]=D[Of]=D[Mf]=D[Df]=!0,D[j]=D[K]=D[Pf]=!1;function ot(O,Te,qe,Nf,at,fe){var $,ct=Te&E,ut=Te&P,kf=Te&R;if(qe&&($=at?qe(O,Nf,at,fe):qe(O)),$!==void 0)return $;if(!v(O))return O;var Ro=m(O);if(Ro){if($=f(O),!ct)return o(O,$)}else{var xe=l(O),To=xe==K||xe==de;if(y(O))return s(O,ct);if(xe==So||xe==T||To&&!at){if($=ut||To?{}:g(O),!ct)return ut?c(O,i($,O)):a(O,n($,O))}else{if(!D[xe])return at?O:{};$=h(O,xe,ct)}}fe||(fe=new r);var qo=fe.get(O);if(qo)return qo;fe.set(O,$),I(O)?O.forEach(function(he){$.add(ot(he,Te,qe,he,O,fe))}):_(O)&&O.forEach(function(he,we){$.set(we,ot(he,Te,qe,we,O,fe))});var Ff=kf?ut?u:d:ut?S:w,xo=Ro?void 0:Ff(O);return e(xo||O,function(he,we){xo&&(we=he,he=O[we]),t($,we,ot(he,Te,qe,we,O,fe))}),$}return Gn=ot,Gn}var jn,Dc;function Xh(){if(Dc)return jn;Dc=1;var r=Kh(),e=4;function t(n){return r(n,e)}return jn=t,jn}var zn,Nc;function Pd(){if(Nc)return zn;Nc=1;function r(e){return function(){return e}}return zn=r,zn}var Bn,kc;function Yh(){if(kc)return Bn;kc=1;function r(e){return function(t,n,i){for(var s=-1,o=Object(t),a=i(t),c=a.length;c--;){var d=a[e?c:++s];if(n(o[d],d,o)===!1)break}return t}}return Bn=r,Bn}var Un,Fc;function Zh(){if(Fc)return Un;Fc=1;var r=Yh(),e=r();return Un=e,Un}var Hn,Gc;function Cd(){if(Gc)return Hn;Gc=1;var r=Zh(),e=Re();function t(n,i){return n&&r(n,i,e)}return Hn=t,Hn}var $n,jc;function Jh(){if(jc)return $n;jc=1;var r=Se();function e(t,n){return function(i,s){if(i==null)return i;if(!r(i))return t(i,s);for(var o=i.length,a=n?o:-1,c=Object(i);(n?a--:++a<o)&&s(c[a],a,c)!==!1;);return i}}return $n=e,$n}var Wn,zc;function Dt(){if(zc)return Wn;zc=1;var r=Cd(),e=Jh(),t=e(r);return Wn=t,Wn}var Vn,Bc;function Nt(){if(Bc)return Vn;Bc=1;function r(e){return e}return Vn=r,Vn}var Kn,Uc;function Qh(){if(Uc)return Kn;Uc=1;var r=Nt();function e(t){return typeof t=="function"?t:r}return Kn=e,Kn}var Xn,Hc;function ep(){if(Hc)return Xn;Hc=1;var r=oo(),e=Dt(),t=Qh(),n=B();function i(s,o){var a=n(s)?r:e;return a(s,t(o))}return Xn=i,Xn}var Yn,$c;function tp(){return $c||($c=1,Yn=ep()),Yn}var Zn,Wc;function rp(){if(Wc)return Zn;Wc=1;var r=Dt();function e(t,n){var i=[];return r(t,function(s,o,a){n(s,o,a)&&i.push(s)}),i}return Zn=e,Zn}var Jn,Vc;function np(){if(Vc)return Jn;Vc=1;var r="__lodash_hash_undefined__";function e(t){return this.__data__.set(t,r),this}return Jn=e,Jn}var Qn,Kc;function ip(){if(Kc)return Qn;Kc=1;function r(e){return this.__data__.has(e)}return Qn=r,Qn}var ei,Xc;function Sd(){if(Xc)return ei;Xc=1;var r=io(),e=np(),t=ip();function n(i){var s=-1,o=i==null?0:i.length;for(this.__data__=new r;++s<o;)this.add(i[s])}return n.prototype.add=n.prototype.push=e,n.prototype.has=t,ei=n,ei}var ti,Yc;function sp(){if(Yc)return ti;Yc=1;function r(e,t){for(var n=-1,i=e==null?0:e.length;++n<i;)if(t(e[n],n,e))return!0;return!1}return ti=r,ti}var ri,Zc;function Rd(){if(Zc)return ri;Zc=1;function r(e,t){return e.has(t)}return ri=r,ri}var ni,Jc;function Td(){if(Jc)return ni;Jc=1;var r=Sd(),e=sp(),t=Rd(),n=1,i=2;function s(o,a,c,d,u,l){var f=c&n,h=o.length,g=a.length;if(h!=g&&!(f&&g>h))return!1;var m=l.get(o),y=l.get(a);if(m&&y)return m==a&&y==o;var _=-1,v=!0,I=c&i?new r:void 0;for(l.set(o,a),l.set(a,o);++_<h;){var w=o[_],S=a[_];if(d)var E=f?d(S,w,_,a,o,l):d(w,S,_,o,a,l);if(E!==void 0){if(E)continue;v=!1;break}if(I){if(!e(a,function(P,R){if(!t(I,R)&&(w===P||u(w,P,c,d,l)))return I.push(R)})){v=!1;break}}else if(!(w===S||u(w,S,c,d,l))){v=!1;break}}return l.delete(o),l.delete(a),v}return ni=s,ni}var ii,Qc;function op(){if(Qc)return ii;Qc=1;function r(e){var t=-1,n=Array(e.size);return e.forEach(function(i,s){n[++t]=[s,i]}),n}return ii=r,ii}var si,eu;function vo(){if(eu)return si;eu=1;function r(e){var t=-1,n=Array(e.size);return e.forEach(function(i){n[++t]=i}),n}return si=r,si}var oi,tu;function ap(){if(tu)return oi;tu=1;var r=je(),e=Ed(),t=ro(),n=Td(),i=op(),s=vo(),o=1,a=2,c="[object Boolean]",d="[object Date]",u="[object Error]",l="[object Map]",f="[object Number]",h="[object RegExp]",g="[object Set]",m="[object String]",y="[object Symbol]",_="[object ArrayBuffer]",v="[object DataView]",I=r?r.prototype:void 0,w=I?I.valueOf:void 0;function S(E,P,R,T,M,C,L){switch(R){case v:if(E.byteLength!=P.byteLength||E.byteOffset!=P.byteOffset)return!1;E=E.buffer,P=P.buffer;case _:return!(E.byteLength!=P.byteLength||!C(new e(E),new e(P)));case c:case d:case f:return t(+E,+P);case u:return E.name==P.name&&E.message==P.message;case h:case m:return E==P+"";case l:var j=i;case g:var K=T&o;if(j||(j=s),E.size!=P.size&&!K)return!1;var de=L.get(E);if(de)return de==P;T|=a,L.set(E,P);var Bt=n(j(E),j(P),T,M,C,L);return L.delete(E),Bt;case y:if(w)return w.call(E)==w.call(P)}return!1}return oi=S,oi}var ai,ru;function cp(){if(ru)return ai;ru=1;var r=wd(),e=1,t=Object.prototype,n=t.hasOwnProperty;function i(s,o,a,c,d,u){var l=a&e,f=r(s),h=f.length,g=r(o),m=g.length;if(h!=m&&!l)return!1;for(var y=h;y--;){var _=f[y];if(!(l?_ in o:n.call(o,_)))return!1}var v=u.get(s),I=u.get(o);if(v&&I)return v==o&&I==s;var w=!0;u.set(s,o),u.set(o,s);for(var S=l;++y<h;){_=f[y];var E=s[_],P=o[_];if(c)var R=l?c(P,E,_,o,s,u):c(E,P,_,s,o,u);if(!(R===void 0?E===P||d(E,P,a,c,u):R)){w=!1;break}S||(S=_=="constructor")}if(w&&!S){var T=s.constructor,M=o.constructor;T!=M&&"constructor"in s&&"constructor"in o&&!(typeof T=="function"&&T instanceof T&&typeof M=="function"&&M instanceof M)&&(w=!1)}return u.delete(s),u.delete(o),w}return ai=i,ai}var ci,nu;function up(){if(nu)return ci;nu=1;var r=so(),e=Td(),t=ap(),n=cp(),i=Be(),s=B(),o=tt(),a=Ot(),c=1,d="[object Arguments]",u="[object Array]",l="[object Object]",f=Object.prototype,h=f.hasOwnProperty;function g(m,y,_,v,I,w){var S=s(m),E=s(y),P=S?u:i(m),R=E?u:i(y);P=P==d?l:P,R=R==d?l:R;var T=P==l,M=R==l,C=P==R;if(C&&o(m)){if(!o(y))return!1;S=!0,T=!1}if(C&&!T)return w||(w=new r),S||a(m)?e(m,y,_,v,I,w):t(m,y,P,_,v,I,w);if(!(_&c)){var L=T&&h.call(m,"__wrapped__"),j=M&&h.call(y,"__wrapped__");if(L||j){var K=L?m.value():m,de=j?y.value():y;return w||(w=new r),I(K,de,_,v,w)}}return C?(w||(w=new r),n(m,y,_,v,I,w)):!1}return ci=g,ci}var ui,iu;function qd(){if(iu)return ui;iu=1;var r=up(),e=le();function t(n,i,s,o,a){return n===i?!0:n==null||i==null||!e(n)&&!e(i)?n!==n&&i!==i:r(n,i,s,o,t,a)}return ui=t,ui}var li,su;function lp(){if(su)return li;su=1;var r=so(),e=qd(),t=1,n=2;function i(s,o,a,c){var d=a.length,u=d,l=!c;if(s==null)return!u;for(s=Object(s);d--;){var f=a[d];if(l&&f[2]?f[1]!==s[f[0]]:!(f[0]in s))return!1}for(;++d<u;){f=a[d];var h=f[0],g=s[h],m=f[1];if(l&&f[2]){if(g===void 0&&!(h in s))return!1}else{var y=new r;if(c)var _=c(g,m,h,s,o,y);if(!(_===void 0?e(m,g,t|n,c,y):_))return!1}}return!0}return li=i,li}var di,ou;function xd(){if(ou)return di;ou=1;var r=Pe();function e(t){return t===t&&!r(t)}return di=e,di}var fi,au;function dp(){if(au)return fi;au=1;var r=xd(),e=Re();function t(n){for(var i=e(n),s=i.length;s--;){var o=i[s],a=n[o];i[s]=[o,a,r(a)]}return i}return fi=t,fi}var hi,cu;function Ad(){if(cu)return hi;cu=1;function r(e,t){return function(n){return n==null?!1:n[e]===t&&(t!==void 0||e in Object(n))}}return hi=r,hi}var pi,uu;function fp(){if(uu)return pi;uu=1;var r=lp(),e=dp(),t=Ad();function n(i){var s=e(i);return s.length==1&&s[0][2]?t(s[0][0],s[0][1]):function(o){return o===i||r(o,i,s)}}return pi=n,pi}var gi,lu;function yo(){if(lu)return gi;lu=1;var r=ze(),e=le(),t="[object Symbol]";function n(i){return typeof i=="symbol"||e(i)&&r(i)==t}return gi=n,gi}var mi,du;function _o(){if(du)return mi;du=1;var r=B(),e=yo(),t=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,n=/^\w*$/;function i(s,o){if(r(s))return!1;var a=typeof s;return a=="number"||a=="symbol"||a=="boolean"||s==null||e(s)?!0:n.test(s)||!t.test(s)||o!=null&&s in Object(o)}return mi=i,mi}var vi,fu;function hp(){if(fu)return vi;fu=1;var r=io(),e="Expected a function";function t(n,i){if(typeof n!="function"||i!=null&&typeof i!="function")throw new TypeError(e);var s=function(){var o=arguments,a=i?i.apply(this,o):o[0],c=s.cache;if(c.has(a))return c.get(a);var d=n.apply(this,o);return s.cache=c.set(a,d)||c,d};return s.cache=new(t.Cache||r),s}return t.Cache=r,vi=t,vi}var yi,hu;function pp(){if(hu)return yi;hu=1;var r=hp(),e=500;function t(n){var i=r(n,function(o){return s.size===e&&s.clear(),o}),s=i.cache;return i}return yi=t,yi}var _i,pu;function gp(){if(pu)return _i;pu=1;var r=pp(),e=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,t=/\\(\\)?/g,n=r(function(i){var s=[];return i.charCodeAt(0)===46&&s.push(""),i.replace(e,function(o,a,c,d){s.push(c?d.replace(t,"$1"):a||o)}),s});return _i=n,_i}var wi,gu;function wo(){if(gu)return wi;gu=1;function r(e,t){for(var n=-1,i=e==null?0:e.length,s=Array(i);++n<i;)s[n]=t(e[n],n,e);return s}return wi=r,wi}var bi,mu;function mp(){if(mu)return bi;mu=1;var r=je(),e=wo(),t=B(),n=yo(),i=r?r.prototype:void 0,s=i?i.toString:void 0;function o(a){if(typeof a=="string")return a;if(t(a))return e(a,o)+"";if(n(a))return s?s.call(a):"";var c=a+"";return c=="0"&&1/a==-1/0?"-0":c}return bi=o,bi}var Ei,vu;function vp(){if(vu)return Ei;vu=1;var r=mp();function e(t){return t==null?"":r(t)}return Ei=e,Ei}var Ii,yu;function Ld(){if(yu)return Ii;yu=1;var r=B(),e=_o(),t=gp(),n=vp();function i(s,o){return r(s)?s:e(s,o)?[s]:t(n(s))}return Ii=i,Ii}var Pi,_u;function kt(){if(_u)return Pi;_u=1;var r=yo();function e(t){if(typeof t=="string"||r(t))return t;var n=t+"";return n=="0"&&1/t==-1/0?"-0":n}return Pi=e,Pi}var Ci,wu;function Od(){if(wu)return Ci;wu=1;var r=Ld(),e=kt();function t(n,i){i=r(i,n);for(var s=0,o=i.length;n!=null&&s<o;)n=n[e(i[s++])];return s&&s==o?n:void 0}return Ci=t,Ci}var Si,bu;function yp(){if(bu)return Si;bu=1;var r=Od();function e(t,n,i){var s=t==null?void 0:r(t,n);return s===void 0?i:s}return Si=e,Si}var Ri,Eu;function _p(){if(Eu)return Ri;Eu=1;function r(e,t){return e!=null&&t in Object(e)}return Ri=r,Ri}var Ti,Iu;function Md(){if(Iu)return Ti;Iu=1;var r=Ld(),e=Lt(),t=B(),n=hd(),i=ao(),s=kt();function o(a,c,d){c=r(c,a);for(var u=-1,l=c.length,f=!1;++u<l;){var h=s(c[u]);if(!(f=a!=null&&d(a,h)))break;a=a[h]}return f||++u!=l?f:(l=a==null?0:a.length,!!l&&i(l)&&n(h,l)&&(t(a)||e(a)))}return Ti=o,Ti}var qi,Pu;function wp(){if(Pu)return qi;Pu=1;var r=_p(),e=Md();function t(n,i){return n!=null&&e(n,i,r)}return qi=t,qi}var xi,Cu;function bp(){if(Cu)return xi;Cu=1;var r=qd(),e=yp(),t=wp(),n=_o(),i=xd(),s=Ad(),o=kt(),a=1,c=2;function d(u,l){return n(u)&&i(l)?s(o(u),l):function(f){var h=e(f,u);return h===void 0&&h===l?t(f,u):r(l,h,a|c)}}return xi=d,xi}var Ai,Su;function Dd(){if(Su)return Ai;Su=1;function r(e){return function(t){return t==null?void 0:t[e]}}return Ai=r,Ai}var Li,Ru;function Ep(){if(Ru)return Li;Ru=1;var r=Od();function e(t){return function(n){return r(n,t)}}return Li=e,Li}var Oi,Tu;function Ip(){if(Tu)return Oi;Tu=1;var r=Dd(),e=Ep(),t=_o(),n=kt();function i(s){return t(s)?r(n(s)):e(s)}return Oi=i,Oi}var Mi,qu;function Ft(){if(qu)return Mi;qu=1;var r=fp(),e=bp(),t=Nt(),n=B(),i=Ip();function s(o){return typeof o=="function"?o:o==null?t:typeof o=="object"?n(o)?e(o[0],o[1]):r(o):i(o)}return Mi=s,Mi}var Di,xu;function Pp(){if(xu)return Di;xu=1;var r=md(),e=rp(),t=Ft(),n=B();function i(s,o){var a=n(s)?r:e;return a(s,t(o,3))}return Di=i,Di}var Ni,Au;function Cp(){if(Au)return Ni;Au=1;var r=Object.prototype,e=r.hasOwnProperty;function t(n,i){return n!=null&&e.call(n,i)}return Ni=t,Ni}var ki,Lu;function Sp(){if(Lu)return ki;Lu=1;var r=Cp(),e=Md();function t(n,i){return n!=null&&e(n,i,r)}return ki=t,ki}var Fi,Ou;function Rp(){if(Ou)return Fi;Ou=1;var r=lo(),e=Be(),t=Lt(),n=B(),i=Se(),s=tt(),o=Mt(),a=Ot(),c="[object Map]",d="[object Set]",u=Object.prototype,l=u.hasOwnProperty;function f(h){if(h==null)return!0;if(i(h)&&(n(h)||typeof h=="string"||typeof h.splice=="function"||s(h)||a(h)||t(h)))return!h.length;var g=e(h);if(g==c||g==d)return!h.size;if(o(h))return!r(h).length;for(var m in h)if(l.call(h,m))return!1;return!0}return Fi=f,Fi}var Gi,Mu;function Tp(){if(Mu)return Gi;Mu=1;function r(e){return e===void 0}return Gi=r,Gi}var ji,Du;function qp(){if(Du)return ji;Du=1;var r=Dt(),e=Se();function t(n,i){var s=-1,o=e(n)?Array(n.length):[];return r(n,function(a,c,d){o[++s]=i(a,c,d)}),o}return ji=t,ji}var zi,Nu;function xp(){if(Nu)return zi;Nu=1;var r=wo(),e=Ft(),t=qp(),n=B();function i(s,o){var a=n(s)?r:t;return a(s,e(o,3))}return zi=i,zi}var Bi,ku;function Ap(){if(ku)return Bi;ku=1;function r(e,t,n,i){var s=-1,o=e==null?0:e.length;for(i&&o&&(n=e[++s]);++s<o;)n=t(n,e[s],s,e);return n}return Bi=r,Bi}var Ui,Fu;function Lp(){if(Fu)return Ui;Fu=1;function r(e,t,n,i,s){return s(e,function(o,a,c){n=i?(i=!1,o):t(n,o,a,c)}),n}return Ui=r,Ui}var Hi,Gu;function Op(){if(Gu)return Hi;Gu=1;var r=Ap(),e=Dt(),t=Ft(),n=Lp(),i=B();function s(o,a,c){var d=i(o)?r:n,u=arguments.length<3;return d(o,t(a,4),c,u,e)}return Hi=s,Hi}var $i,ju;function Mp(){if(ju)return $i;ju=1;var r=ze(),e=B(),t=le(),n="[object String]";function i(s){return typeof s=="string"||!e(s)&&t(s)&&r(s)==n}return $i=i,$i}var Wi,zu;function Dp(){if(zu)return Wi;zu=1;var r=Dd(),e=r("length");return Wi=e,Wi}var Vi,Bu;function Np(){if(Bu)return Vi;Bu=1;var r="\\ud800-\\udfff",e="\\u0300-\\u036f",t="\\ufe20-\\ufe2f",n="\\u20d0-\\u20ff",i=e+t+n,s="\\ufe0e\\ufe0f",o="\\u200d",a=RegExp("["+o+r+i+s+"]");function c(d){return a.test(d)}return Vi=c,Vi}var Ki,Uu;function kp(){if(Uu)return Ki;Uu=1;var r="\\ud800-\\udfff",e="\\u0300-\\u036f",t="\\ufe20-\\ufe2f",n="\\u20d0-\\u20ff",i=e+t+n,s="\\ufe0e\\ufe0f",o="["+r+"]",a="["+i+"]",c="\\ud83c[\\udffb-\\udfff]",d="(?:"+a+"|"+c+")",u="[^"+r+"]",l="(?:\\ud83c[\\udde6-\\uddff]){2}",f="[\\ud800-\\udbff][\\udc00-\\udfff]",h="\\u200d",g=d+"?",m="["+s+"]?",y="(?:"+h+"(?:"+[u,l,f].join("|")+")"+m+g+")*",_=m+g+y,v="(?:"+[u+a+"?",a,l,f,o].join("|")+")",I=RegExp(c+"(?="+c+")|"+v+_,"g");function w(S){for(var E=I.lastIndex=0;I.test(S);)++E;return E}return Ki=w,Ki}var Xi,Hu;function Fp(){if(Hu)return Xi;Hu=1;var r=Dp(),e=Np(),t=kp();function n(i){return e(i)?t(i):r(i)}return Xi=n,Xi}var Yi,$u;function Gp(){if($u)return Yi;$u=1;var r=lo(),e=Be(),t=Se(),n=Mp(),i=Fp(),s="[object Map]",o="[object Set]";function a(c){if(c==null)return 0;if(t(c))return n(c)?i(c):c.length;var d=e(c);return d==s||d==o?c.size:r(c).length}return Yi=a,Yi}var Zi,Wu;function jp(){if(Wu)return Zi;Wu=1;var r=oo(),e=Id(),t=Cd(),n=Ft(),i=go(),s=B(),o=tt(),a=Tt(),c=Pe(),d=Ot();function u(l,f,h){var g=s(l),m=g||o(l)||d(l);if(f=n(f,4),h==null){var y=l&&l.constructor;m?h=g?new y:[]:c(l)?h=a(y)?e(i(l)):{}:h={}}return(m?r:t)(l,function(_,v,I){return f(h,_,v,I)}),h}return Zi=u,Zi}var Ji,Vu;function zp(){if(Vu)return Ji;Vu=1;var r=je(),e=Lt(),t=B(),n=r?r.isConcatSpreadable:void 0;function i(s){return t(s)||e(s)||!!(n&&s&&s[n])}return Ji=i,Ji}var Qi,Ku;function Bp(){if(Ku)return Qi;Ku=1;var r=po(),e=zp();function t(n,i,s,o,a){var c=-1,d=n.length;for(s||(s=e),a||(a=[]);++c<d;){var u=n[c];i>0&&s(u)?i>1?t(u,i-1,s,o,a):r(a,u):o||(a[a.length]=u)}return a}return Qi=t,Qi}var es,Xu;function Up(){if(Xu)return es;Xu=1;function r(e,t,n){switch(n.length){case 0:return e.call(t);case 1:return e.call(t,n[0]);case 2:return e.call(t,n[0],n[1]);case 3:return e.call(t,n[0],n[1],n[2])}return e.apply(t,n)}return es=r,es}var ts,Yu;function Hp(){if(Yu)return ts;Yu=1;var r=Up(),e=Math.max;function t(n,i,s){return i=e(i===void 0?n.length-1:i,0),function(){for(var o=arguments,a=-1,c=e(o.length-i,0),d=Array(c);++a<c;)d[a]=o[i+a];a=-1;for(var u=Array(i+1);++a<i;)u[a]=o[a];return u[i]=s(d),r(n,this,u)}}return ts=t,ts}var rs,Zu;function $p(){if(Zu)return rs;Zu=1;var r=Pd(),e=ld(),t=Nt(),n=e?function(i,s){return e(i,"toString",{configurable:!0,enumerable:!1,value:r(s),writable:!0})}:t;return rs=n,rs}var ns,Ju;function Wp(){if(Ju)return ns;Ju=1;var r=800,e=16,t=Date.now;function n(i){var s=0,o=0;return function(){var a=t(),c=e-(a-o);if(o=a,c>0){if(++s>=r)return arguments[0]}else s=0;return i.apply(void 0,arguments)}}return ns=n,ns}var is,Qu;function Vp(){if(Qu)return is;Qu=1;var r=$p(),e=Wp(),t=e(r);return is=t,is}var ss,el;function Kp(){if(el)return ss;el=1;var r=Nt(),e=Hp(),t=Vp();function n(i,s){return t(e(i,s,r),i+"")}return ss=n,ss}var os,tl;function Xp(){if(tl)return os;tl=1;function r(e,t,n,i){for(var s=e.length,o=n+(i?1:-1);i?o--:++o<s;)if(t(e[o],o,e))return o;return-1}return os=r,os}var as,rl;function Yp(){if(rl)return as;rl=1;function r(e){return e!==e}return as=r,as}var cs,nl;function Zp(){if(nl)return cs;nl=1;function r(e,t,n){for(var i=n-1,s=e.length;++i<s;)if(e[i]===t)return i;return-1}return cs=r,cs}var us,il;function Jp(){if(il)return us;il=1;var r=Xp(),e=Yp(),t=Zp();function n(i,s,o){return s===s?t(i,s,o):r(i,e,o)}return us=n,us}var ls,sl;function Qp(){if(sl)return ls;sl=1;var r=Jp();function e(t,n){var i=t==null?0:t.length;return!!i&&r(t,n,0)>-1}return ls=e,ls}var ds,ol;function eg(){if(ol)return ds;ol=1;function r(e,t,n){for(var i=-1,s=e==null?0:e.length;++i<s;)if(n(t,e[i]))return!0;return!1}return ds=r,ds}var fs,al;function tg(){if(al)return fs;al=1;function r(){}return fs=r,fs}var hs,cl;function rg(){if(cl)return hs;cl=1;var r=bd(),e=tg(),t=vo(),n=1/0,i=r&&1/t(new r([,-0]))[1]==n?function(s){return new r(s)}:e;return hs=i,hs}var ps,ul;function ng(){if(ul)return ps;ul=1;var r=Sd(),e=Qp(),t=eg(),n=Rd(),i=rg(),s=vo(),o=200;function a(c,d,u){var l=-1,f=e,h=c.length,g=!0,m=[],y=m;if(u)g=!1,f=t;else if(h>=o){var _=d?null:i(c);if(_)return s(_);g=!1,f=n,y=new r}else y=d?[]:m;e:for(;++l<h;){var v=c[l],I=d?d(v):v;if(v=u||v!==0?v:0,g&&I===I){for(var w=y.length;w--;)if(y[w]===I)continue e;d&&y.push(I),m.push(v)}else f(y,I,u)||(y!==m&&y.push(I),m.push(v))}return m}return ps=a,ps}var gs,ll;function ig(){if(ll)return gs;ll=1;var r=Se(),e=le();function t(n){return e(n)&&r(n)}return gs=t,gs}var ms,dl;function sg(){if(dl)return ms;dl=1;var r=Bp(),e=Kp(),t=ng(),n=ig(),i=e(function(s){return t(r(s,1,n,!0))});return ms=i,ms}var vs,fl;function og(){if(fl)return vs;fl=1;var r=wo();function e(t,n){return r(n,function(i){return t[i]})}return vs=e,vs}var ys,hl;function ag(){if(hl)return ys;hl=1;var r=og(),e=Re();function t(n){return n==null?[]:r(n,e(n))}return ys=t,ys}var _s,pl;function Y(){if(pl)return _s;pl=1;var r;if(typeof $f=="function")try{r={clone:Xh(),constant:Pd(),each:tp(),filter:Pp(),has:Sp(),isArray:B(),isEmpty:Rp(),isFunction:Tt(),isUndefined:Tp(),keys:Re(),map:xp(),reduce:Op(),size:Gp(),transform:jp(),union:sg(),values:ag()}}catch{}return r||(r=window._),_s=r,_s}var ws,gl;function bo(){if(gl)return ws;gl=1;var r=Y();ws=i;var e="\0",t="\0",n="";function i(u){this._isDirected=r.has(u,"directed")?u.directed:!0,this._isMultigraph=r.has(u,"multigraph")?u.multigraph:!1,this._isCompound=r.has(u,"compound")?u.compound:!1,this._label=void 0,this._defaultNodeLabelFn=r.constant(void 0),this._defaultEdgeLabelFn=r.constant(void 0),this._nodes={},this._isCompound&&(this._parent={},this._children={},this._children[t]={}),this._in={},this._preds={},this._out={},this._sucs={},this._edgeObjs={},this._edgeLabels={}}i.prototype._nodeCount=0,i.prototype._edgeCount=0,i.prototype.isDirected=function(){return this._isDirected},i.prototype.isMultigraph=function(){return this._isMultigraph},i.prototype.isCompound=function(){return this._isCompound},i.prototype.setGraph=function(u){return this._label=u,this},i.prototype.graph=function(){return this._label},i.prototype.setDefaultNodeLabel=function(u){return r.isFunction(u)||(u=r.constant(u)),this._defaultNodeLabelFn=u,this},i.prototype.nodeCount=function(){return this._nodeCount},i.prototype.nodes=function(){return r.keys(this._nodes)},i.prototype.sources=function(){var u=this;return r.filter(this.nodes(),function(l){return r.isEmpty(u._in[l])})},i.prototype.sinks=function(){var u=this;return r.filter(this.nodes(),function(l){return r.isEmpty(u._out[l])})},i.prototype.setNodes=function(u,l){var f=arguments,h=this;return r.each(u,function(g){f.length>1?h.setNode(g,l):h.setNode(g)}),this},i.prototype.setNode=function(u,l){return r.has(this._nodes,u)?(arguments.length>1&&(this._nodes[u]=l),this):(this._nodes[u]=arguments.length>1?l:this._defaultNodeLabelFn(u),this._isCompound&&(this._parent[u]=t,this._children[u]={},this._children[t][u]=!0),this._in[u]={},this._preds[u]={},this._out[u]={},this._sucs[u]={},++this._nodeCount,this)},i.prototype.node=function(u){return this._nodes[u]},i.prototype.hasNode=function(u){return r.has(this._nodes,u)},i.prototype.removeNode=function(u){var l=this;if(r.has(this._nodes,u)){var f=function(h){l.removeEdge(l._edgeObjs[h])};delete this._nodes[u],this._isCompound&&(this._removeFromParentsChildList(u),delete this._parent[u],r.each(this.children(u),function(h){l.setParent(h)}),delete this._children[u]),r.each(r.keys(this._in[u]),f),delete this._in[u],delete this._preds[u],r.each(r.keys(this._out[u]),f),delete this._out[u],delete this._sucs[u],--this._nodeCount}return this},i.prototype.setParent=function(u,l){if(!this._isCompound)throw new Error("Cannot set parent in a non-compound graph");if(r.isUndefined(l))l=t;else{l+="";for(var f=l;!r.isUndefined(f);f=this.parent(f))if(f===u)throw new Error("Setting "+l+" as parent of "+u+" would create a cycle");this.setNode(l)}return this.setNode(u),this._removeFromParentsChildList(u),this._parent[u]=l,this._children[l][u]=!0,this},i.prototype._removeFromParentsChildList=function(u){delete this._children[this._parent[u]][u]},i.prototype.parent=function(u){if(this._isCompound){var l=this._parent[u];if(l!==t)return l}},i.prototype.children=function(u){if(r.isUndefined(u)&&(u=t),this._isCompound){var l=this._children[u];if(l)return r.keys(l)}else{if(u===t)return this.nodes();if(this.hasNode(u))return[]}},i.prototype.predecessors=function(u){var l=this._preds[u];if(l)return r.keys(l)},i.prototype.successors=function(u){var l=this._sucs[u];if(l)return r.keys(l)},i.prototype.neighbors=function(u){var l=this.predecessors(u);if(l)return r.union(l,this.successors(u))},i.prototype.isLeaf=function(u){var l;return this.isDirected()?l=this.successors(u):l=this.neighbors(u),l.length===0},i.prototype.filterNodes=function(u){var l=new this.constructor({directed:this._isDirected,multigraph:this._isMultigraph,compound:this._isCompound});l.setGraph(this.graph());var f=this;r.each(this._nodes,function(m,y){u(y)&&l.setNode(y,m)}),r.each(this._edgeObjs,function(m){l.hasNode(m.v)&&l.hasNode(m.w)&&l.setEdge(m,f.edge(m))});var h={};function g(m){var y=f.parent(m);return y===void 0||l.hasNode(y)?(h[m]=y,y):y in h?h[y]:g(y)}return this._isCompound&&r.each(l.nodes(),function(m){l.setParent(m,g(m))}),l},i.prototype.setDefaultEdgeLabel=function(u){return r.isFunction(u)||(u=r.constant(u)),this._defaultEdgeLabelFn=u,this},i.prototype.edgeCount=function(){return this._edgeCount},i.prototype.edges=function(){return r.values(this._edgeObjs)},i.prototype.setPath=function(u,l){var f=this,h=arguments;return r.reduce(u,function(g,m){return h.length>1?f.setEdge(g,m,l):f.setEdge(g,m),m}),this},i.prototype.setEdge=function(){var u,l,f,h,g=!1,m=arguments[0];typeof m=="object"&&m!==null&&"v"in m?(u=m.v,l=m.w,f=m.name,arguments.length===2&&(h=arguments[1],g=!0)):(u=m,l=arguments[1],f=arguments[3],arguments.length>2&&(h=arguments[2],g=!0)),u=""+u,l=""+l,r.isUndefined(f)||(f=""+f);var y=a(this._isDirected,u,l,f);if(r.has(this._edgeLabels,y))return g&&(this._edgeLabels[y]=h),this;if(!r.isUndefined(f)&&!this._isMultigraph)throw new Error("Cannot set a named edge when isMultigraph = false");this.setNode(u),this.setNode(l),this._edgeLabels[y]=g?h:this._defaultEdgeLabelFn(u,l,f);var _=c(this._isDirected,u,l,f);return u=_.v,l=_.w,Object.freeze(_),this._edgeObjs[y]=_,s(this._preds[l],u),s(this._sucs[u],l),this._in[l][y]=_,this._out[u][y]=_,this._edgeCount++,this},i.prototype.edge=function(u,l,f){var h=arguments.length===1?d(this._isDirected,arguments[0]):a(this._isDirected,u,l,f);return this._edgeLabels[h]},i.prototype.hasEdge=function(u,l,f){var h=arguments.length===1?d(this._isDirected,arguments[0]):a(this._isDirected,u,l,f);return r.has(this._edgeLabels,h)},i.prototype.removeEdge=function(u,l,f){var h=arguments.length===1?d(this._isDirected,arguments[0]):a(this._isDirected,u,l,f),g=this._edgeObjs[h];return g&&(u=g.v,l=g.w,delete this._edgeLabels[h],delete this._edgeObjs[h],o(this._preds[l],u),o(this._sucs[u],l),delete this._in[l][h],delete this._out[u][h],this._edgeCount--),this},i.prototype.inEdges=function(u,l){var f=this._in[u];if(f){var h=r.values(f);return l?r.filter(h,function(g){return g.v===l}):h}},i.prototype.outEdges=function(u,l){var f=this._out[u];if(f){var h=r.values(f);return l?r.filter(h,function(g){return g.w===l}):h}},i.prototype.nodeEdges=function(u,l){var f=this.inEdges(u,l);if(f)return f.concat(this.outEdges(u,l))};function s(u,l){u[l]?u[l]++:u[l]=1}function o(u,l){--u[l]||delete u[l]}function a(u,l,f,h){var g=""+l,m=""+f;if(!u&&g>m){var y=g;g=m,m=y}return g+n+m+n+(r.isUndefined(h)?e:h)}function c(u,l,f,h){var g=""+l,m=""+f;if(!u&&g>m){var y=g;g=m,m=y}var _={v:g,w:m};return h&&(_.name=h),_}function d(u,l){return a(u,l.v,l.w,l.name)}return ws}var bs,ml;function cg(){return ml||(ml=1,bs="2.1.8"),bs}var Es,vl;function ug(){return vl||(vl=1,Es={Graph:bo(),version:cg()}),Es}var Is,yl;function lg(){if(yl)return Is;yl=1;var r=Y(),e=bo();Is={write:t,read:s};function t(o){var a={options:{directed:o.isDirected(),multigraph:o.isMultigraph(),compound:o.isCompound()},nodes:n(o),edges:i(o)};return r.isUndefined(o.graph())||(a.value=r.clone(o.graph())),a}function n(o){return r.map(o.nodes(),function(a){var c=o.node(a),d=o.parent(a),u={v:a};return r.isUndefined(c)||(u.value=c),r.isUndefined(d)||(u.parent=d),u})}function i(o){return r.map(o.edges(),function(a){var c=o.edge(a),d={v:a.v,w:a.w};return r.isUndefined(a.name)||(d.name=a.name),r.isUndefined(c)||(d.value=c),d})}function s(o){var a=new e(o.options).setGraph(o.value);return r.each(o.nodes,function(c){a.setNode(c.v,c.value),c.parent&&a.setParent(c.v,c.parent)}),r.each(o.edges,function(c){a.setEdge({v:c.v,w:c.w,name:c.name},c.value)}),a}return Is}var Ps,_l;function dg(){if(_l)return Ps;_l=1;var r=Y();Ps=e;function e(t){var n={},i=[],s;function o(a){r.has(n,a)||(n[a]=!0,s.push(a),r.each(t.successors(a),o),r.each(t.predecessors(a),o))}return r.each(t.nodes(),function(a){s=[],o(a),s.length&&i.push(s)}),i}return Ps}var Cs,wl;function Nd(){if(wl)return Cs;wl=1;var r=Y();Cs=e;function e(){this._arr=[],this._keyIndices={}}return e.prototype.size=function(){return this._arr.length},e.prototype.keys=function(){return this._arr.map(function(t){return t.key})},e.prototype.has=function(t){return r.has(this._keyIndices,t)},e.prototype.priority=function(t){var n=this._keyIndices[t];if(n!==void 0)return this._arr[n].priority},e.prototype.min=function(){if(this.size()===0)throw new Error("Queue underflow");return this._arr[0].key},e.prototype.add=function(t,n){var i=this._keyIndices;if(t=String(t),!r.has(i,t)){var s=this._arr,o=s.length;return i[t]=o,s.push({key:t,priority:n}),this._decrease(o),!0}return!1},e.prototype.removeMin=function(){this._swap(0,this._arr.length-1);var t=this._arr.pop();return delete this._keyIndices[t.key],this._heapify(0),t.key},e.prototype.decrease=function(t,n){var i=this._keyIndices[t];if(n>this._arr[i].priority)throw new Error("New priority is greater than current priority. Key: "+t+" Old: "+this._arr[i].priority+" New: "+n);this._arr[i].priority=n,this._decrease(i)},e.prototype._heapify=function(t){var n=this._arr,i=2*t,s=i+1,o=t;i<n.length&&(o=n[i].priority<n[o].priority?i:o,s<n.length&&(o=n[s].priority<n[o].priority?s:o),o!==t&&(this._swap(t,o),this._heapify(o)))},e.prototype._decrease=function(t){for(var n=this._arr,i=n[t].priority,s;t!==0&&(s=t>>1,!(n[s].priority<i));)this._swap(t,s),t=s},e.prototype._swap=function(t,n){var i=this._arr,s=this._keyIndices,o=i[t],a=i[n];i[t]=a,i[n]=o,s[a.key]=t,s[o.key]=n},Cs}var Ss,bl;function kd(){if(bl)return Ss;bl=1;var r=Y(),e=Nd();Ss=n;var t=r.constant(1);function n(s,o,a,c){return i(s,String(o),a||t,c||function(d){return s.outEdges(d)})}function i(s,o,a,c){var d={},u=new e,l,f,h=function(g){var m=g.v!==l?g.v:g.w,y=d[m],_=a(g),v=f.distance+_;if(_<0)throw new Error("dijkstra does not allow negative edge weights. Bad edge: "+g+" Weight: "+_);v<y.distance&&(y.distance=v,y.predecessor=l,u.decrease(m,v))};for(s.nodes().forEach(function(g){var m=g===o?0:Number.POSITIVE_INFINITY;d[g]={distance:m},u.add(g,m)});u.size()>0&&(l=u.removeMin(),f=d[l],f.distance!==Number.POSITIVE_INFINITY);)c(l).forEach(h);return d}return Ss}var Rs,El;function fg(){if(El)return Rs;El=1;var r=kd(),e=Y();Rs=t;function t(n,i,s){return e.transform(n.nodes(),function(o,a){o[a]=r(n,a,i,s)},{})}return Rs}var Ts,Il;function Fd(){if(Il)return Ts;Il=1;var r=Y();Ts=e;function e(t){var n=0,i=[],s={},o=[];function a(c){var d=s[c]={onStack:!0,lowlink:n,index:n++};if(i.push(c),t.successors(c).forEach(function(f){r.has(s,f)?s[f].onStack&&(d.lowlink=Math.min(d.lowlink,s[f].index)):(a(f),d.lowlink=Math.min(d.lowlink,s[f].lowlink))}),d.lowlink===d.index){var u=[],l;do l=i.pop(),s[l].onStack=!1,u.push(l);while(c!==l);o.push(u)}}return t.nodes().forEach(function(c){r.has(s,c)||a(c)}),o}return Ts}var qs,Pl;function hg(){if(Pl)return qs;Pl=1;var r=Y(),e=Fd();qs=t;function t(n){return r.filter(e(n),function(i){return i.length>1||i.length===1&&n.hasEdge(i[0],i[0])})}return qs}var xs,Cl;function pg(){if(Cl)return xs;Cl=1;var r=Y();xs=t;var e=r.constant(1);function t(i,s,o){return n(i,s||e,o||function(a){return i.outEdges(a)})}function n(i,s,o){var a={},c=i.nodes();return c.forEach(function(d){a[d]={},a[d][d]={distance:0},c.forEach(function(u){d!==u&&(a[d][u]={distance:Number.POSITIVE_INFINITY})}),o(d).forEach(function(u){var l=u.v===d?u.w:u.v,f=s(u);a[d][l]={distance:f,predecessor:d}})}),c.forEach(function(d){var u=a[d];c.forEach(function(l){var f=a[l];c.forEach(function(h){var g=f[d],m=u[h],y=f[h],_=g.distance+m.distance;_<y.distance&&(y.distance=_,y.predecessor=m.predecessor)})})}),a}return xs}var As,Sl;function Gd(){if(Sl)return As;Sl=1;var r=Y();As=e,e.CycleException=t;function e(n){var i={},s={},o=[];function a(c){if(r.has(s,c))throw new t;r.has(i,c)||(s[c]=!0,i[c]=!0,r.each(n.predecessors(c),a),delete s[c],o.push(c))}if(r.each(n.sinks(),a),r.size(i)!==n.nodeCount())throw new t;return o}function t(){}return t.prototype=new Error,As}var Ls,Rl;function gg(){if(Rl)return Ls;Rl=1;var r=Gd();Ls=e;function e(t){try{r(t)}catch(n){if(n instanceof r.CycleException)return!1;throw n}return!0}return Ls}var Os,Tl;function jd(){if(Tl)return Os;Tl=1;var r=Y();Os=e;function e(n,i,s){r.isArray(i)||(i=[i]);var o=(n.isDirected()?n.successors:n.neighbors).bind(n),a=[],c={};return r.each(i,function(d){if(!n.hasNode(d))throw new Error("Graph does not have node: "+d);t(n,d,s==="post",c,o,a)}),a}function t(n,i,s,o,a,c){r.has(o,i)||(o[i]=!0,s||c.push(i),r.each(a(i),function(d){t(n,d,s,o,a,c)}),s&&c.push(i))}return Os}var Ms,ql;function mg(){if(ql)return Ms;ql=1;var r=jd();Ms=e;function e(t,n){return r(t,n,"post")}return Ms}var Ds,xl;function vg(){if(xl)return Ds;xl=1;var r=jd();Ds=e;function e(t,n){return r(t,n,"pre")}return Ds}var Ns,Al;function yg(){if(Al)return Ns;Al=1;var r=Y(),e=bo(),t=Nd();Ns=n;function n(i,s){var o=new e,a={},c=new t,d;function u(f){var h=f.v===d?f.w:f.v,g=c.priority(h);if(g!==void 0){var m=s(f);m<g&&(a[h]=d,c.decrease(h,m))}}if(i.nodeCount()===0)return o;r.each(i.nodes(),function(f){c.add(f,Number.POSITIVE_INFINITY),o.setNode(f)}),c.decrease(i.nodes()[0],0);for(var l=!1;c.size()>0;){if(d=c.removeMin(),r.has(a,d))o.setEdge(d,a[d]);else{if(l)throw new Error("Input graph is not connected: "+i);l=!0}i.nodeEdges(d).forEach(u)}return o}return Ns}var ks,Ll;function _g(){return Ll||(Ll=1,ks={components:dg(),dijkstra:kd(),dijkstraAll:fg(),findCycles:hg(),floydWarshall:pg(),isAcyclic:gg(),postorder:mg(),preorder:vg(),prim:yg(),tarjan:Fd(),topsort:Gd()}),ks}var Fs,Ol;function wg(){if(Ol)return Fs;Ol=1;var r=ug();return Fs={Graph:r.Graph,json:lg(),alg:_g(),version:r.version},Fs}var Ml=wg();class H{constructor(e,t=[],{validateConnectivity:n=!0}={}){if(this.id=e,this.pieces=[...t],this.borderPieces=new Set,t.length>0){if(n&&!H.arePiecesConnected(t))throw new Error(`Cannot create group ${e}: initial pieces are not connected`);t.forEach(i=>{i&&i._setGroupId(this.id)}),this._updateBorderPieces()}}addPieces(e){const t=e.filter(o=>o!=null);if(t.length===0)return 0;const n=[...this.pieces,...t];if(!H.arePiecesConnected(n))throw new Error(`Cannot add pieces to group ${this.id}: resulting group would not be connected`);const i=t.filter(o=>!this.pieces.includes(o)),s=i.length;return s>0&&(this.pieces=[...this.pieces,...i],i.forEach(o=>{o._setGroupId(this.id)})),s>0&&this._updateBorderPieces(),s}removePieces(e){const t=new Set(e.filter(a=>a&&this.pieces.includes(a)));if(t.size===0)return[];const n=this.pieces.filter(a=>!t.has(a));if(t.forEach(a=>{a._setGroupId(null)}),n.length===0)return this.pieces=[],[];const i=H._findConnectedComponents(n);if(i.length===1)return this.pieces=n,this._updateBorderPieces(),[];const s=[],o=i.reduce((a,c)=>c.length>a.length?c:a);return this.pieces=[...o],o.forEach(a=>{a._setGroupId(this.id)}),this._updateBorderPieces(),i.forEach((a,c)=>{if(a!==o){const d=`${this.id}_split_${c}_${Date.now()}`,u=new H(d,a);s.push(u)}}),s}get allPieces(){return this.pieces}size(){return this.pieces.length}isEmpty(){return this.pieces.length===0}clear(){this.pieces.forEach(e=>{e._setGroupId(null)}),this.pieces=[],this.borderPieces.clear()}get allBorderPieces(){return Array.from(this.borderPieces)}static getGroupNeighbors(e){if(!e||!e.groupId)return{};const t=z.getGroup(e.groupId);if(!t)return{};const n=t.pieces,i=new Map;for(const a of n){if(!a)continue;const c=`${a.gridPos.x},${a.gridPos.y}`;i.set(c,a)}const s={},o=[{key:ee,x:e.gridPos.x,y:e.gridPos.y-1},{key:te,x:e.gridPos.x+1,y:e.gridPos.y},{key:re,x:e.gridPos.x,y:e.gridPos.y+1},{key:ne,x:e.gridPos.x-1,y:e.gridPos.y}];for(const a of o){const c=`${a.x},${a.y}`,d=i.get(c);d&&(s[a.key]=d)}return s}_updateBorderPieces(){if(this.borderPieces.clear(),this.pieces.length===0)return;const e=new Map;for(const t of this.pieces){if(!t)continue;const n=`${t.gridPos.x},${t.gridPos.y}`;e.set(n,t)}for(const t of this.pieces){if(!t)continue;let n=0;const i=[{x:t.gridPos.x,y:t.gridPos.y-1},{x:t.gridPos.x+1,y:t.gridPos.y},{x:t.gridPos.x,y:t.gridPos.y+1},{x:t.gridPos.x-1,y:t.gridPos.y}];for(const s of i){const o=`${s.x},${s.y}`;e.has(o)&&n++}n<4&&this.borderPieces.add(t)}}calculateBounds(){if(this.isEmpty())return null;let e=new W;for(const t of this.pieces){if(!t||!t.calculateBoundingFrame)continue;const n=t.calculateBoundingFrame();if(!n)continue;const i=A.getPiecePosition(t.id)||new b(0,0),s=i.add(n.topLeft),o=i.add(n.bottomRight),a=W.fromPoints(s,o);a.isEmpty()||(e=e.plus(a))}return e.isEmpty()?null:e}getCenter(){const e=this.calculateBounds();return e?e.center:null}merge(e){if(!e||e===this)return!1;const t=e.allPieces;return this.addPieces(t),e.clear(),!0}validate(){for(const e of this.pieces)if(!e||e.groupId!==this.id)return!1;return!0}getStats(){const e=this.calculateBounds();return{id:this.id,pieceCount:this.size(),bounds:e,center:this.getCenter()}}static arePiecesConnected(e){return e.length<2?!0:H._findConnectedComponents(e).length===1}static _findConnectedComponents(e){if(e.length===0)return[];const t=new Ml.Graph({directed:!1});e.forEach(i=>{t.setNode(i.id,i)});for(let i=0;i<e.length;i++){const s=e[i];for(let o=i+1;o<e.length;o++){const a=e[o];A.arePiecesNeighbors(s,a)&&t.setEdge(s.id,a.id)}}return Ml.alg.components(t).map(i=>i.map(s=>t.node(s)))}isConnected(){return this.size()<=1?!0:H.arePiecesConnected(this.pieces)}toString(){return`Group(id: ${this.id}, pieces: ${this.size()}, center: ${this.getCenter()})`}}const zd="piecesGenerated",Eo="piece:rotate",Gt="piece:select",Je="piece:deselect",Bd="piece:detach-animation",Ws="piece:long-press-start",be="piece:long-press-end",Ud="piece:north",Io="drag:move",rt="drag:end",Hd="drag:high-curvature",wt="groups:changed",Ne="puzzle:state-changed",Vs="deeplink:enabled",Ae="deeplink:disabled",$d="image:upload-request",bg="persistence:save",gt="persistence:restore",Wd="persistence:can-resume",Ks="persistence:cannot-resume",Vd="pieces:connected",Eg="pieces:disconnected",Dl=/^g(\d+)/;class Ig{constructor(){this.groups=new Map,this.nextGroupId=1}initialize(){this.groups.clear();const e=new Map;p.pieces.forEach(t=>{let n=t.groupId;n||(n=`g${t.id}`,t._setGroupId(n));let i=e.get(n);i||(i=[],e.set(n,i)),i.push(t)}),e.forEach((t,n)=>{const i=H._findConnectedComponents(t);i.length>1&&console.warn(`[GroupManager] Group ${n} is fragmented into ${i.length} components`),i.forEach(s=>{const o=this.generateGroupId();s.forEach(c=>{c._setGroupId(o)});const a=new H(o,s,{validateConnectivity:!1});this.groups.set(o,a)})}),console.log(`[GroupManager] Initialized with ${this.groups.size} groups for ${p.pieces.length} pieces`),this.updateNextGroupId()}generateGroupId(){return`g${this.nextGroupId++}`}updateNextGroupId(){const t=[...Array.from(this.groups.keys()),...p.pieces.map(n=>n.groupId)].filter(n=>n&&n.match(Dl)).map(n=>parseInt(n.match(Dl)[1],10)).reduce((n,i)=>Math.max(n,i),0);this.nextGroupId=t+1}getGroup(e){return this.groups.get(e)}getGroupCount(){return this.groups.size}getGroupForPiece(e){return this.groups.get(e.groupId)}createSinglePieceGroup(e){const t=this.generateGroupId();e._setGroupId(t);const n=new H(t,[e]);return this.groups.set(t,n),n}mergeGroups(e,t){const n=this.getGroupForPiece(e),i=this.getGroupForPiece(t);if(!n||!i)return!1;if(n===i)return!0;try{const s=[...n.allPieces,...i.allPieces];if(!H.arePiecesConnected(s))return console.warn("[GroupManager] Cannot merge - would create disconnected group"),!1;const o=new Set([...n.allBorderPieces,...i.allBorderPieces]),[a,c]=n.size()>=i.size()?[n,i]:[i,n],d=c.allPieces;a.addPieces(d),this.groups.delete(c.id),document.dispatchEvent(new CustomEvent(wt,{detail:{type:"merged",fromGroupId:c.id,toGroupId:a.id,changedBorder:o}}));const u=H.getGroupNeighbors(t);return document.dispatchEvent(new CustomEvent(Vd,{detail:{pieceAId:e.id,pieceBId:t.id,groupId:a.id,pieceId:t.id,neighbors:u}})),!0}catch(s){return console.error("[GroupManager] Error during group merge:",s),!1}}detachPiece(e){const t=this.getGroupForPiece(e);if(!t)return null;if(t.size()===1)return t;try{const n=H.getGroupNeighbors(e),i=[e,...Object.values(n).filter(a=>a!==null)],s=t.removePieces([e]),o=this.createSinglePieceGroup(e);return s.forEach(a=>{this.groups.set(a.id,a),console.log(`[GroupManager] Created fragment group ${a.id} with ${a.size()} pieces`)}),document.dispatchEvent(new CustomEvent(Eg,{detail:{pieceId:e.id,neighbors:n}})),document.dispatchEvent(new CustomEvent(wt,{detail:{type:"detached",pieceId:e.id,newGroupId:o.id,changedBorder:i}})),o}catch(n){return console.error("[GroupManager] Error during piece detachment:",n),null}}validateConnectivity(e){return!e||e.length<=1?!0:new H("temp",e).isConnected()}}const z=new Ig;typeof window<"u"&&(window.groupManager=z);const Nl=new WeakMap;function Pg(r){const e=r.toString();let t=0;for(let n=0;n<e.length;n++){const i=e.charCodeAt(n);t=(t<<5)-t+i,t=t&t}return`fn_${t}_${e.length}`}function N(r,e,t=document){if(Array.isArray(r)){let i=!0;return r.forEach(s=>{N(s,e,t)||(i=!1)}),i}(Array.isArray(r)?r:[r]).forEach(i=>{if(typeof i!="string"||!i)return console.warn("[event-util] Invalid event name:",i),!1;if(typeof e!="function")return console.warn("[event-util] Invalid handler:",e),!1;if(!t||typeof t.addEventListener!="function")return console.warn("[event-util] Invalid target:",t),!1;const s=Pg(e);let o=Nl.get(t);o||(o=new Map,Nl.set(t,o));let a=o.get(i);return a||(a=new Map,o.set(i,a)),a.has(s)?(console.debug(`[event-util] Handler already registered for event "${i}"`),!1):(t.addEventListener(i,e),a.set(s,e),!0)})}const kl=30,Kd=kl*kl,Cg=Kd,Fl=2,Sg=Fl*Fl,Rg=1.5,Ke={CONNECTION_TOLERANCE:Kd,ALIGNMENT_TOLERANCE:Cg,PROFILE_TOLERANCE:Sg};let Ue=null;function Gl(r){switch(r){case ee:return{first:Lo,second:Oo};case te:return{first:Oo,second:Mo};case re:return{first:Do,second:Mo};case ne:return{first:Lo,second:Do};default:return{first:null,second:null}}}function Tg(r,e){if(r.length===0)return!1;const t=Math.max(...r),n=Math.min(...r);return t-n<=e}function jl(r,e,t,n,i=!1){if(r.length!==e.length)return null;let s=[],o=!0;for(let a=0;a<r.length;a++){const c=jf(r[a],e[a]);if(s.push(c),c>t){o=!1;break}}if(o){const a=Tg(s,n);return{reversed:i,distances2:s,profileValid:a}}return null}function qg(r,e,t,n){const i=ke(),s=Ke.CONNECTION_TOLERANCE/(i*i),o=Ke.PROFILE_TOLERANCE/(i*i);let a=null;return Ze.forEach(c=>{const d=r.sPoints[c];if($s(d))return;const u=Gl(c),l=t.worldCorners[u.first],f=t.worldCorners[u.second],h=t.worldSPoints[c];Ze.forEach(g=>{const m=e.sPoints[g];if($s(m))return;const y=Gl(g),_=n.worldCorners[y.first],v=n.worldCorners[y.second],I=n.worldSPoints[g],w=[l,...h,f],S=[_,...I,v],E=jl(w,S,s,o)||jl(w,[...S].reverse(),s,o,!0);if(E&&E.profileValid){const P=E.distances2.reduce((T,M)=>T+M,0);let R;E.reversed?R=y.second:R=y.first,(!a||P<a.score)&&(a={score:P,stationaryPieceId:e.id,mapping:{movingCornerA:u.first,stationaryCornerA:R}})}})}),a}function Xd(r){const e=r.worldData,t=r.bitmap.width*r.scale,n=r.bitmap.height*r.scale,s=Math.max(t,n)*Rg,o=r.getCenter(),a=A.queryRadius(o,s);let c=null;return a.forEach(d=>{if(d===r.id)return;const u=p.pieces.find(g=>g.id===d),l=z.getGroupForPiece(u),f=z.getGroupForPiece(r);if(l&&f&&l===f)return;const h=qg(r,u,e,u.worldData);h&&(!c||h.score<c.score)&&(c=h)}),c}function Yd(r){if(!r||r.length===0){Ue&&(Ue=null,Ys(null));return}const e=[...new Set(r.map(i=>i.candidate.stationaryPieceId))],t=Ue?Ue.map(i=>i.pieceId).sort().join(","):"",n=e.sort().join(",");t!==n&&(Ue=r.map(i=>({pieceId:i.candidate.stationaryPieceId,data:i.candidate})),Ys(e))}function xg(){Yd(null)}function Ag(r,e){if(!e)return;const t=p.pieces.find(i=>i.id===e.stationaryPieceId);if(!t)return;const n=t.worldData.worldCorners[e.mapping.stationaryCornerA].sub(r.worldData.worldCorners[e.mapping.movingCornerA]);A&&r.groupId&&A.moveGroup(r.groupId,n)}function Zd(r){r.tolerance!=null&&(Ke.CONNECTION_TOLERANCE=r.tolerance,Ke.ALIGNMENT_TOLERANCE=r.tolerance),r.profileTolerance!=null&&(Ke.PROFILE_TOLERANCE=r.profileTolerance)}N(Io,r=>{const e=r.detail.piece;if(!e)return;const t=z.getGroup(e.groupId),n=t?t.allBorderPieces:[e],i=[];for(const s of n){const o=Xd(s);o&&o.stationaryPieceId!=null&&i.push({movingPiece:s,candidate:o})}Yd(i.length>0?i:null)});N(rt,r=>{const e=r.detail.piece;if(!e)return;const t=z.getGroup(e.groupId),n=t?t.allBorderPieces:[e],i=[];for(const s of n){const o=Xd(s);o&&o.stationaryPieceId!=null&&i.push({movingPiece:s,candidate:o})}if(i.length>0){i.sort((a,c)=>a.candidate.score-c.candidate.score);const s=i[0],o=p.pieces.find(a=>a.id===s.candidate.stationaryPieceId);o&&(Ag(s.movingPiece,s.candidate),z.mergeGroups(s.movingPiece,o))}xg()});class Lg{constructor(){this.lastPosition=null,this.lastTimestamp=null,this.currentCurvature=1,this.positionWindow=[],this.maxPositionSamples=10,this.curvatureThreshold=8,this.curvatureCallbacks=[],this.isDragging=!1,this._setupEventListeners()}_setupEventListeners(){N(Io,e=>{this.dragEvent(e.detail)}),N(rt,()=>{this.endDrag()})}dragEvent(e){const t=e.timestamp||performance.now(),n={x:e.x,y:e.y};if(this.lastPosition===null||this.lastTimestamp===null){this.lastPosition=n,this.lastTimestamp=t,this.isDragging=!0;return}this.positionWindow.push({x:n.x,y:n.y,timestamp:t}),this.positionWindow.length>this.maxPositionSamples&&this.positionWindow.shift(),this.calculateCurvature(),this.checkCurvatureCallbacks(),this.lastPosition=n,this.lastTimestamp=t,this.isDragging=!0}calculateCurvature(){if(this.positionWindow.length<3){this.currentCurvature=1;return}let e=0;for(let a=1;a<this.positionWindow.length;a++){const c=this.positionWindow[a-1],d=this.positionWindow[a],u=d.x-c.x,l=d.y-c.y;e+=Math.sqrt(u*u+l*l)}const t=this.positionWindow[0],n=this.positionWindow[this.positionWindow.length-1],i=n.x-t.x,s=n.y-t.y,o=Math.sqrt(i*i+s*s);o<1?this.currentCurvature=1:this.currentCurvature=e/o}getCurvature(){return this.currentCurvature}registerCurvatureCallback(e,t){if(typeof e!="number"||e<=0)return console.warn("[DragMonitor] Invalid curvature threshold:",e),()=>{};if(typeof t!="function")return console.warn("[DragMonitor] Invalid callback:",t),()=>{};const n={threshold:e,callback:t,lastTriggered:0};return this.curvatureCallbacks.push(n),()=>{const i=this.curvatureCallbacks.indexOf(n);i!==-1&&this.curvatureCallbacks.splice(i,1)}}checkCurvatureCallbacks(){this.currentCurvature>=this.curvatureThreshold&&document.dispatchEvent(new CustomEvent(Hd,{detail:{curvature:this.currentCurvature,threshold:this.curvatureThreshold,positionCount:this.positionWindow.length}}));const e=performance.now();for(const t of this.curvatureCallbacks)if(this.currentCurvature>=t.threshold&&e-t.lastTriggered>100){t.lastTriggered=e;try{t.callback({curvature:this.currentCurvature,threshold:t.threshold,positionCount:this.positionWindow.length})}catch(n){console.error("[DragMonitor] Curvature callback error:",n)}}}endDrag(){this.isDragging=!1,this.currentCurvature=1,this.lastPosition=null,this.lastTimestamp=null,this.positionWindow=[]}reset(){this.currentCurvature=1,this.positionWindow=[],this.lastPosition=null,this.lastTimestamp=null,this.isDragging=!1}getStatistics(){return{currentCurvature:this.currentCurvature,positionWindowCount:this.positionWindow.length,isDragging:this.isDragging,curvatureCallbackCount:this.curvatureCallbacks.length}}}new Lg;let U=null,G=null;function Og(r){G=r,N(Eo,e=>{const{pieceId:t,rotation:n}=e.detail;kg(t,n)}),N(rt,e=>{const{pieceId:t,wentOutside:n}=e.detail;Ng(t,n)}),N(Ud,e=>{Fg()})}function zl(r){const e=typeof r=="string"?parseInt(r,10):r;if(isNaN(e)||e==null){console.warn("[hlInteractionHandler] onPieceSelected: invalid ID",r);return}const t=nt(e);if(!t){console.warn("[hlInteractionHandler] onPieceSelected: piece not found for ID",e);return}if((U==null?void 0:U.id)===e)return;const n=(U==null?void 0:U.id)??null;U=t,A.bringToFront(e),G!=null&&G.onPieceSelectedVisual&&G.onPieceSelectedVisual(e,n),document.dispatchEvent(new CustomEvent(Gt,{detail:{pieceId:e,piece:t}}))}function Mg(){if(U){const r=U.id;U=null,G!=null&&G.onPieceDeselectedVisual&&G.onPieceDeselectedVisual(r),document.dispatchEvent(new CustomEvent(Je,{detail:{pieceId:r}}))}}function Dg(r,e){const t=nt(r);t&&(t.groupId?A.moveGroup(t.groupId,e):A.movePiece(t.id,e))}function Ng(r,e){nt(r)&&(e?rm():G!=null&&G.onEnsurePieceInView&&G.onEnsurePieceInView(r))}function kg(r,e){const t=nt(r);if(t){if(p.noRotate){console.log("[hlInteractionHandler] Rotation disabled (noRotate mode)");return}A.rotatePieceOrGroup(t.id,e),G!=null&&G.onEnsurePieceInView&&G.onEnsurePieceInView(r)}}function Gs(r){const e=nt(r);if(!e)return;if(!z.detachPiece(e)){console.error("[hlInteractionHandler] GroupManager detachment failed - piece cannot be detached");return}A.bringToFront(e.id),G!=null&&G.onPieceDetachedVisual&&G.onPieceDetachedVisual(e.id)}function Jd(){return U}function Fg(){if(!U)return!1;const r=U.rotation;if(r===0)return!0;let e=-r;e<=-180&&(e+=360),e>180&&(e-=360);const t=z.getGroup(U.groupId);return t&&t.size()>1?A.rotateGroup(t.id,e,U):A.rotatePiece(U.id,e),!0}function nt(r){const e=typeof r=="string"?parseInt(r,10):r;return p.pieces.find(t=>t.id===e)}const dt=40,js=1e3;class Qd{constructor(e){this.pieceElements=e,this.activeTouchIds=new Set,this.longPressTimer=null,this.longPressStartTime=null,this.longPressPieceId=null,this.dragPauseTimer=null,this.isDragging=!1,this.highCurvatureDetach=!1,this._initialize()}_initialize(){Og({onPieceSelectedVisual:(t,n)=>{n!=null&&document.dispatchEvent(new CustomEvent(Je,{detail:{pieceId:n}})),document.dispatchEvent(new CustomEvent(Gt,{detail:{pieceId:t}}))},onPieceDeselectedVisual:t=>{document.dispatchEvent(new CustomEvent(Je,{detail:{pieceId:t}}))},onPieceDetachedVisual:t=>{document.dispatchEvent(new CustomEvent(Bd,{detail:{pieceId:t}}))},onEnsurePieceInView:t=>{const n=p.pieces.find(s=>s.id===t),i=this.pieceElements.get(t);if(n&&i){const s=A.getPiecePosition(n.id)||new b(0,0);tm(s,new b(i.offsetWidth,i.offsetHeight),{forceZoom:!1})}}});try{this.pieceElements.forEach((t,n)=>{var i=window.interact(t);i.unset(),i=window.interact(t),i.draggable({listeners:{start:s=>this._onDragStart(s),move:s=>this._onDragMove(s),end:s=>this._onDragEnd(s)}}).on("tap",s=>this._onTap(s)).on("doubletap",s=>this._onDoubleTap(s)).on("down",s=>this._onPointerDown(s)).on("up",s=>this._onPointerUp(s)),i.options&&i.options.actions&&(i.options.actions.doubletap={interval:500,distance:30})});var e=window.interact("#piecesContainer");e.unset(),e=window.interact("#piecesContainer"),e.on("tap",t=>this._onContainerTap(t)).draggable({ignoreFrom:".piece",listeners:{start:t=>this._onViewportDragStart(t),move:t=>this._onViewportDragMove(t),end:t=>this._onViewportDragEnd(t)}})}catch(t){throw console.error("[interactionManager] Error configuring interact.js:",t),t}N(Hd,t=>{this.highCurvatureDetach=!0})}addPieceInteraction(e){const t=window.interact(e);t.draggable({origin:"self",listeners:{start:n=>this._onDragStart(n),move:n=>this._onDragMove(n),end:n=>this._onDragEnd(n)}}).on("tap",n=>this._onTap(n)).on("doubletap",n=>this._onDoubleTap(n)).on("down",n=>this._onPointerDown(n)).on("up",n=>this._onPointerUp(n)),t.options&&t.options.actions&&(t.options.actions.doubletap={interval:500,distance:30})}_onDragStart(e){const{element:t,pieceId:n}=this.getNearestPieceId(e);zl(n),e.interaction.pointerType==="touch"&&this.activeTouchIds.add(e.interaction.id),this.isDragging=!0,this._clearDragPauseTimer();const i=e.shiftKey,s=e.interaction.pointerType==="touch"&&this.activeTouchIds.size>=2,o=this.longPressStartTime!==null&&String(this.longPressPieceId)===String(n)&&performance.now()-this.longPressStartTime>=js;(i||s||o)&&Gs(n),document.dispatchEvent(new CustomEvent(be,{detail:{pieceId:n}})),this._clearLongPressTimer(),this.longPressStartTime=null,this.longPressPieceId=null}_onDragMove(e){const{element:t,pieceId:n}=this.getNearestPieceId(e),i=p.pieces.find(c=>c.id===n);if(!i)return;document.dispatchEvent(new CustomEvent(Io,{detail:{piece:i,x:e.client.x,y:e.client.y,timestamp:performance.now()}}));const s=Wg(),o=e.dx/s.scale,a=e.dy/s.scale;if(this.highCurvatureDetach){const c=z.getGroup(i.groupId);c&&c.size()>1&&Gs(i.id),this.highCurvatureDetach=!1}if(this._clearDragPauseTimer(),document.dispatchEvent(new CustomEvent(be,{detail:{pieceId:n}})),i.groupId){const c=z.getGroup(i.groupId);c&&c.size()>1&&(this.dragPauseTimer=setTimeout(()=>{document.dispatchEvent(new CustomEvent(Ws,{detail:{pieceId:i.id}})),Gs(i.id),setTimeout(()=>{document.dispatchEvent(new CustomEvent(be,{detail:{pieceId:i.id}}))},300)},js))}Dg(i.id,new b(o,a)),this._checkBoundaries(t,i)}_onDragEnd(e){const{element:t,pieceId:n}=this.getNearestPieceId(e);e.interaction.pointerType==="touch"&&this.activeTouchIds.delete(e.interaction.id),this.isDragging=!1,this._clearDragPauseTimer(),document.dispatchEvent(new CustomEvent(be,{detail:{pieceId:n}})),this.highCurvatureDetach=!1;const i=t.hasAttribute("data-outside");i&&t.removeAttribute("data-outside");const s=p.pieces.find(o=>o.id===n);document.dispatchEvent(new CustomEvent(rt,{detail:{pieceId:n,wentOutside:i,piece:s}}))}_onPointerDown(e){const{pieceId:t}=this.getNearestPieceId(e);this.longPressStartTime=performance.now(),this.longPressPieceId=t,this._clearLongPressTimer(),this.longPressTimer=setTimeout(()=>{document.dispatchEvent(new CustomEvent(Ws,{detail:{pieceId:parseInt(t,10)}}))},js)}_onPointerUp(e){const{pieceId:t}=this.getNearestPieceId(e);document.dispatchEvent(new CustomEvent(be,{detail:{pieceId:t}})),this._clearLongPressTimer(),this.longPressStartTime=null,this.longPressPieceId=null}_onTap(e){const{pieceId:t}=this.getNearestPieceId(e);zl(t)}_onDoubleTap(e){const{pieceId:t}=this.getNearestPieceId(e);document.dispatchEvent(new CustomEvent(be,{detail:{pieceId:t}})),this._clearLongPressTimer(),this.longPressStartTime=null,this.longPressPieceId=null,e.preventDefault(),e.stopPropagation(),document.dispatchEvent(new CustomEvent(Eo,{detail:{pieceId:t,rotation:90}}))}getNearestPieceId(e){const t=e.target.closest(".piece")||e.target,n=parseInt(t.dataset.id,10);return{element:t,pieceId:n}}_onContainerTap(e){(e.target.id==="piecesContainer"||e.target.classList.contains("pieces-viewport"))&&(this._clearLongPressTimer(),this.longPressStartTime=null,this.longPressPieceId=null,Mg())}_checkBoundaries(e,t){const i=e.parentElement.getBoundingClientRect(),s=A.getPiecePosition(t.id),o=s.x<-dt,a=s.y<-dt,c=s.x+e.offsetWidth>i.width+dt,d=s.y+e.offsetHeight>i.height+dt,u=o||a||c||d;u&&!e.hasAttribute("data-outside")?e.setAttribute("data-outside","true"):!u&&e.hasAttribute("data-outside")&&e.removeAttribute("data-outside")}getPieceElement(e){return this.pieceElements.get(e)}applyHighlight(e){Ys(e)}_clearLongPressTimer(){this.longPressTimer&&(clearTimeout(this.longPressTimer),this.longPressTimer=null)}_clearDragPauseTimer(){this.dragPauseTimer&&(clearTimeout(this.dragPauseTimer),this.dragPauseTimer=null)}_onViewportDragStart(e){const t=document.getElementById("piecesContainer");e.preventDefault(),Bl(new b(e.client.x,e.client.y)),t.style.cursor="grabbing"}_onViewportDragMove(e){e.preventDefault();const t=new b(e.client.x,e.client.y),n=t.sub(Zg());Yg(Xg().add(n)),Bl(t)}_onViewportDragEnd(e){const t=document.getElementById("piecesContainer");t.style.cursor="grab",vt()}}const ie=new Map,Gg=De,jg=Gg;function zg(r,e,t=!1){const n=r.clientWidth||800,i=r.clientHeight||600;if(ie.clear(),t)e.forEach(o=>{o.setRotation(0)});else{const o=[0,90,180,270];e.forEach(a=>{const c=o[Math.floor(Math.random()*o.length)];a.setRotation(c)})}e.forEach(o=>{const a=of(o,jg);r.appendChild(a),ie.set(o.id,a),o.scale=De}),new Qd(ie);const s=Array.from({length:e.length},(o,a)=>a);for(let o=0;o<e.length;o++){const a=Math.floor(Math.random()*e.length),c=Math.floor(Math.random()*e.length);[s[a],s[c]]=[s[c],s[a]]}e.forEach((o,a)=>{const c=ie.get(o.id);A.setPiecePosition(o.id,e[s[a]].imgRect.position,c),Le(o)}),z.initialize(),Zd({}),A.updateViewportArea(n,i),A.syncAllPositions(),A.attachPieceElements(ie)}function Bg(r,e){var i;const t=r.clientWidth||800,n=r.clientHeight||600;ie.clear(),e.reduce((s,o)=>s+Math.min(o.imgRect.width,o.imgRect.height),0)/e.length*(((i=e[0])==null?void 0:i.scale)||De),e.forEach(s=>{const o=s.scale||De,a=of(s,o);s.zIndex!==null&&s.zIndex!==void 0&&(a.style.zIndex=s.zIndex.toString()),Le(s),s.scale=o,ie.set(s.id,a),r.appendChild(a)}),z.initialize(),Zd({tolerance:900}),A.updateViewportArea(t,n),A.syncAllPositions(),A.initializeMaxZIndex(),A.attachPieceElements(ie),new Qd(ie),e.forEach((s,o)=>Le(s))}function ef(r){return ie.get(r)}function tf(r){const e=r.getContext("2d");e.save(),e.setTransform(1,0,0,1,0,0),e.clearRect(0,0,r.width,r.height),e.restore()}const bt=.1,rf=5,Et=1.2,Ug=1.1,Hg=.9;let me=null,X=null,Xs=null,Q=1,x=new b(0,0),nf=new b(0,0),k=null,se=4;N(zd,r=>{const e=r.detail.totalPieces||20;se=8*Math.sqrt(Math.sqrt(20/e))},window);N(Gt,r=>{const{pieceId:e}=r.detail,t=k==null?void 0:k.get(e);t&&t.classList.add("selected")});N(Je,r=>{const{pieceId:e}=r.detail,t=k==null?void 0:k.get(e);t&&t.classList.remove("selected")});N(Bd,r=>{const{pieceId:e}=r.detail,t=k==null?void 0:k.get(e);t&&(t.classList.add("detached-piece"),setTimeout(()=>t.classList.remove("detached-piece"),1e3))});N(Ws,r=>{const{pieceId:e}=r.detail,t=k==null?void 0:k.get(e);t&&t.classList.add("long-press-active")});N(be,r=>{const{pieceId:e}=r.detail,t=k==null?void 0:k.get(e);t&&t.classList.remove("long-press-active")});N(wt,r=>{const{changedBorder:e}=r.detail;!e||e.length===0||e.forEach(t=>{if(!t)return;const n=ef(t.id);if(!n)return;const i=n.querySelector("canvas");if(!i)return;const s=i.getContext("2d");tf(i),s.drawImage(t.bitmap,0,0),sf(s,t.paths,t)})});function $g(){return me=document.getElementById("piecesViewport"),X=document.getElementById("piecesContainer"),Xs=document.getElementById("zoomDisplay"),me}function Xe(){return me}function Wg(){return{offsetX:p.viewport.offsetX,offsetY:p.viewport.offsetY,scale:p.viewport.scale}}function Le(r){if(!r)return null;const e=ef(r.id);if(!e)return null;const t=r.calculateBoundingFrame(),n=new b(e.offsetWidth,e.offsetHeight).scaled(.5),s=t.centerOffset.scaled(r.scale).sub(n),o=A.getPiecePosition(r.id).sub(s);return e.style.left=o.x+"px",e.style.top=o.y+"px",e.style.transform=`rotate(${r.rotation}deg)`,e}function Vg(r){k=r}function Kg(r,e){const t=k==null?void 0:k.get(r);t&&(t.style.zIndex=e.toString())}function mt(){if(!me)return;const r=p.puzzleSettings.removeColor||p.deepLinkRemoveColor;r===!0||r==="y"?(me.style.filter="grayscale(100%)",p.puzzleSettings.removeColor=!0):(me.style.filter="none",p.puzzleSettings.removeColor=!1)}function ke(){return Q}function Xg(){return x}function Yg(r){x=r,p.viewport.offsetX=r.x,p.viewport.offsetY=r.y,Oe()}function Zg(){return nf}function Bl(r){nf=r}function ce(r,e=null){const t=Q,n=Math.max(bt,Math.min(rf,r));if(Q=n,p.viewport.scale=n,e&&X){const i=X.getBoundingClientRect(),s=new b(i.left,i.top),o=e.sub(s),a=n/t,c=o.sub(x).scaled(a);x=o.sub(c),p.viewport.offsetX=x.x,p.viewport.offsetY=x.y}Oe(),Po()}function Oe(){!ve.isElementValid(me)||!x||(me.style.transform=`translate(${x.x}px, ${x.y}px) scale(${Q})`)}function Ul(r){const e=document.getElementById("orientationTipButton");e&&(p.noRotate||!r?e.style.display="none":r&&(e.style.display="block"))}function Po(){Xs&&(Xs.textContent=Math.round(Q*100)+"%")}function Ys(r){if(!k||(k.forEach(t=>t.classList.remove("candidate-highlight")),r==null))return;(Array.isArray(r)?r:[r]).forEach(t=>{const n=k.get(t);n&&n.classList.add("candidate-highlight")})}const zs="#D2691E";function Jg(r,e){const t=r.replace("#",""),n=Math.max(0,parseInt(t.substring(0,2),16)*(1-e)),i=Math.max(0,parseInt(t.substring(2,4),16)*(1-e)),s=Math.max(0,parseInt(t.substring(4,6),16)*(1-e));return`rgb(${Math.round(n)}, ${Math.round(i)}, ${Math.round(s)})`}function Qg(r,e){const t=r.replace("#",""),n=Math.min(255,parseInt(t.substring(0,2),16)+255*e),i=Math.min(255,parseInt(t.substring(2,4),16)+255*e),s=Math.min(255,parseInt(t.substring(4,6),16)+255*e);return`rgb(${Math.round(n)}, ${Math.round(i)}, ${Math.round(s)})`}function sf(r,e,t){r.lineJoin="round",r.lineCap="round",r.save();var n=t.calculateBoundingFrame();r.translate(-n.topLeft.x+se,-n.topLeft.y+se);const i=t?H.getGroupNeighbors(t):{},s=[];i[ee]||s.push(e.north),i[te]||s.push(e.east),i[re]||s.push(e.south),i[ne]||s.push(e.west);for(const o of s)r.strokeStyle=Jg(zs,.4),r.lineWidth=se,r.shadowColor="rgba(0, 0, 0, 0.3)",r.shadowBlur=4,r.shadowOffsetX=2,r.shadowOffsetY=2,r.stroke(o);r.shadowColor="transparent",r.shadowBlur=0,r.shadowOffsetX=0,r.shadowOffsetY=0;for(const o of s)r.strokeStyle=zs,r.lineWidth=se,r.stroke(o);for(const o of s)r.strokeStyle=Qg(zs,.3),r.lineWidth=se/2,r.stroke(o);r.restore()}function em(r,e,t,n,i){const s=Math.ceil(r.width),o=Math.ceil(r.height),a=document.createElement("canvas");a.width=s+2*se,a.height=o+2*se;const c=a.getContext("2d");c.translate(-r.topLeft.x+se,-r.topLeft.y+se),tf(a);const d=r.topLeft.add(t),u=r.bottomRight.add(t);let l=d.x,f=d.y,h=u.x-d.x,g=u.y-d.y;const m=Math.max(0,l),y=Math.max(0,f),_=Math.min(h,n.width-m),v=Math.min(g,n.height-y);return c.save(),c.clip(e.combined),c.drawImage(n,m,y,_,v,r.position.x,r.position.y,_,v),c.restore(),a}function tm(r,e,t={}){const{forceZoom:n=!1}=t;if(!ve.isElementValid(X))return;const i=X.clientWidth,s=X.clientHeight;function o(){const u=r.scaled(Q),l=x.add(u),f=e.scaled(Q),h=l,g=l.add(f);return{topLeft:h,bottomRight:g}}let a=o();if(n){const u=Math.max(0,-a.topLeft.x),l=Math.max(0,a.bottomRight.x-i),f=Math.max(0,-a.topLeft.y),h=Math.max(0,a.bottomRight.y-s),g=u+l,m=f+h;if(g>0||m>0){const _=g>0?i/(i+g):1,v=m>0?s/(s+m):1,I=Math.min(_,v);if(I<.999){const w=Math.max(bt,Q*I);w<Q-1e-4&&(ce(w),a=o())}}a.topLeft.x<0&&(x=x.add(new b(-a.topLeft.x,0))),a.topLeft.y<0&&(x=x.add(new b(0,-a.topLeft.y))),a.bottomRight.x>i&&(x=x.sub(new b(a.bottomRight.x-i,0))),a.bottomRight.y>s&&(x=x.sub(new b(0,a.bottomRight.y-s))),Oe();return}let c=!1;if(a.topLeft.x<0&&(x=x.add(new b(-a.topLeft.x,0)),c=!0),a.topLeft.y<0&&(x=x.add(new b(0,-a.topLeft.y)),c=!0),a.bottomRight.x>i&&(x=x.sub(new b(a.bottomRight.x-i,0)),c=!0),a.bottomRight.y>s&&(x=x.sub(new b(0,a.bottomRight.y-s)),c=!0),c&&(Oe(),a=o()),a.topLeft.x<0||a.topLeft.y<0||a.bottomRight.x>i||a.bottomRight.y>s){const u=i/e.x,l=s/e.y,f=Math.min(Q,u,l);f<Q-5e-4&&(ce(Math.max(bt,f)),a=o(),a.topLeft.x<0&&(x=x.add(new b(-a.topLeft.x,0))),a.topLeft.y<0&&(x=x.add(new b(0,-a.topLeft.y))),a.bottomRight.x>i&&(x=x.sub(new b(a.bottomRight.x-i,0))),a.bottomRight.y>s&&(x=x.sub(new b(0,a.bottomRight.y-s))),Oe(),Po())}}function rm(){if(ve.isArrayEmpty(p.pieces))return;const r=(X==null?void 0:X.clientWidth)||0,e=(X==null?void 0:X.clientHeight)||0;if(r===0||e===0)return;const t=A.calculatePiecesBounds(p.pieces);if(!t)return;const n=t.topLeft.x,i=t.topLeft.y,s=t.bottomRight.x,o=t.bottomRight.y;if(!isFinite(n)||!isFinite(i)||!isFinite(s)||!isFinite(o))return;const a=Math.max(1,s-n),c=Math.max(1,o-i),d=Math.min(r/a,e/c),u=Math.max(bt,Math.min(rf,d));ce(u),x=new b(-n*u,-i*u),Oe()}const Hl=24;function of(r,e){const t=Math.max(Hl,r.bitmap.width*e),n=Math.max(Hl,r.bitmap.height*e),i=document.createElement("div");i.className="piece",i.dataset.id=r.id;const s=document.createElement("canvas");s.width=t,s.height=n;const o=s.getContext("2d");return o.scale(e,e),o.drawImage(r.bitmap,0,0),sf(o,r.paths,r),i.style.width=t+"px",i.style.height=n+"px",i.appendChild(s),i}class nm{constructor(){this._cells=new Map}_key(e,t){return`${e},${t}`}set(e,t,n){this._cells.set(this._key(e,t),n)}get(e,t){return this._cells.get(this._key(e,t))}has(e,t){return this._cells.has(this._key(e,t))}delete(e,t){return this._cells.delete(this._key(e,t))}clear(){this._cells.clear()}getRange(e,t,n,i){const s=[];for(let o=n;o<=i;o++)for(let a=e;a<=t;a++){const c=this._key(a,o);this._cells.has(c)&&s.push({col:a,row:o,value:this._cells.get(c)})}return s}get size(){return this._cells.size}forEach(e){this._cells.forEach((t,n)=>{const[i,s]=n.split(",").map(Number);e(t,i,s)})}}const $l=80,Wl=2.5;class im{constructor(e,t,n){this.boundsWidth=e,this.boundsHeight=t,this.avgPieceSize=n,this.cellSize=Math.max($l,Math.round(n*Wl)),this.grid=new nm,this.itemMap=new Map}needsRebuild(e,t,n){return this.boundsWidth!==e||this.boundsHeight!==t||Math.abs(this.avgPieceSize-n)>.01}updateDimensions(e,t,n){return this.needsRebuild(e,t,n)?(this.boundsWidth=e,this.boundsHeight=t,this.avgPieceSize=n,this.cellSize=Math.max($l,Math.round(n*Wl)),!0):!1}_cellFor(e){const t=Math.floor(e.x/this.cellSize),n=Math.floor(e.y/this.cellSize);return{col:t,row:n}}insert(e){const{col:t,row:n}=this._cellFor(e.position);let i=this.grid.get(t,n);i||(i=new Set,this.grid.set(t,n,i)),i.add(e.id),this.itemMap.set(e.id,{col:t,row:n,point:e.position})}update(e){const t=this.itemMap.get(e.id),{col:n,row:i}=this._cellFor(e.position);if(!t||t.col!==n||t.row!==i){if(t){const o=this.grid.get(t.col,t.row);o&&(o.delete(e.id),o.size===0&&this.grid.delete(t.col,t.row))}let s=this.grid.get(n,i);s||(s=new Set,this.grid.set(n,i,s)),s.add(e.id),this.itemMap.set(e.id,{col:n,row:i,point:e.position})}}remove(e){const t=this.itemMap.get(e.id);if(t){const n=this.grid.get(t.col,t.row);n&&(n.delete(e.id),n.size===0&&this.grid.delete(t.col,t.row)),this.itemMap.delete(e.id)}}queryRadius(e,t){const n=new Set,i=Math.floor((e.x-t)/this.cellSize),s=Math.floor((e.x+t)/this.cellSize),o=Math.floor((e.y-t)/this.cellSize),a=Math.floor((e.y+t)/this.cellSize);for(let c=o;c<=a;c++)for(let d=i;d<=s;d++){const u=this.grid.get(d,c);u&&u.forEach(l=>n.add(l))}return Array.from(n)}rebuild(e){this.grid.clear(),this.itemMap.clear(),e.forEach(t=>this.insert(t))}}class sm{constructor({spatialIndex:e=null,pieceElements:t=null}={}){this.spatialIndex=e,this.pieceElements=t,this._piecePositions=new Map,this._worldDataCache=new Map,this.maxZIndex=0}syncAllPositions(){!p||!p.pieces||(p.pieces.forEach(e=>{!this.getPiecePosition(e.id)&&e.displayX!==void 0&&e.displayY!==void 0&&this._piecePositions.set(e.id,new b(e.displayX,e.displayY))}),this._autoManageSpatialIndex(null,null))}attachPieceElements(e){this.pieceElements=e,Vg(e)}bringToFront(e){var o;const t=(o=p.pieces)==null?void 0:o.find(a=>a.id===e);if(!t)return;const n=z.getGroup(t.groupId),i=n?n.allPieces:[t];this.maxZIndex++;const s=this.maxZIndex;i.forEach(a=>{a.zIndex=s,Kg(a.id,s)})}initializeMaxZIndex(){this.maxZIndex=0,p.pieces.forEach(e=>{e.zIndex&&e.zIndex>this.maxZIndex&&(this.maxZIndex=e.zIndex)})}updateViewportArea(e,t){this._autoManageSpatialIndex(e,t)}_computeAvgPieceSize(){var e;return!p||!p.pieces||p.pieces.length===0?0:p.pieces.reduce((t,n)=>t+Math.min(n.imgRect.width,n.imgRect.height),0)/p.pieces.length*(((e=p.pieces[0])==null?void 0:e.scale)||1)}_autoManageSpatialIndex(e=null,t=null){if(e==null||t==null){if(!this.spatialIndex)return;e=this.spatialIndex.boundsWidth,t=this.spatialIndex.boundsHeight}if(!p||!p.pieces||p.pieces.length===0){this.spatialIndex=null;return}const n=this._computeAvgPieceSize();this.spatialIndex?this.spatialIndex.updateDimensions(e,t,n)&&this._rebuildSpatialIndex():(this.spatialIndex=new im(e,t,n),this._rebuildSpatialIndex())}_rebuildSpatialIndex(){if(!this.spatialIndex)return;const e=[];p.pieces.forEach(t=>{const n=this._getElement(t.id),i=this.getCenter(t,n);i&&e.push({id:t.id,position:i})}),this.spatialIndex.rebuild(e)}getPiecePosition(e){return this._piecePositions.get(e)||null}getWorldData(e){const t=this.getPiecePosition(e.id);if(!t)return{worldCorners:{},worldSPoints:{}};let n=this._worldDataCache.get(e.id);const i=!n||!t.equals(n.lastPosition),s=n&&(e.rotation!==n.lastRotation||e.scale!==n.lastScale);return(!n||i||s)&&(n={data:this._computeWorldDataInternal(e),lastPosition:t.clone(),lastRotation:e.rotation,lastScale:e.scale},this._worldDataCache.set(e.id,n)),n.data}getCenter(e,t=null){const n=e.calculateBoundingFrame(),i=e.scale;let s,o;t?(s=t.offsetWidth,o=t.offsetHeight):(s=n.width*i,o=n.height*i);const a=new b(s/2,o/2),d=n.centerOffset.scaled(i).sub(a);return this.getPiecePosition(e.id).sub(d).add(a)}_computeWorldDataInternal(e){const t=e.scale,n=this.getPiecePosition(e.id)||new b(0,0),i=e.calculateBoundingFrame(),o=new b(e.bitmap.width*t,e.bitmap.height*t).scaled(.5),c=i.centerOffset.scaled(t).sub(o),d=n.sub(c),u=this.getCenter(e),l=y=>y.sub(i.topLeft).scaled(t),f={nw:l(e.corners.nw),ne:l(e.corners.ne),se:l(e.corners.se),sw:l(e.corners.sw)},h={};for(const[y,_]of Object.entries(f)){const I=_.add(d).rotatedAroundDeg(u,e.rotation);h[y]=I}const g=e.sPoints,m={};return Ze.forEach(y=>{const _=g[y];if($s(_)){m[y]=[];return}else m[y]=_.map(v=>l(new b(v.x,v.y)).add(d).rotatedAroundDeg(u,e.rotation))}),{worldCorners:h,worldSPoints:m}}setPiecePosition(e,t){this._piecePositions.set(e,t.clone()),this._updateSpatialIndexFor(e);const n=this._findPiece(e);n&&Le(n)}movePiece(e,t){const n=this.getPiecePosition(e);n&&this.setPiecePosition(e,n.add(t))}placePieceCenter(e,t,n){const i=this._findPiece(e);if(!i)return;const s=n.offsetWidth,o=n.offsetHeight,a=i.calculateBoundingFrame(),c=i.scale,d=new b(s/2,o/2),l=a.centerOffset.scaled(c).sub(d);this.setPiecePosition(e,t.sub(d).add(l))}moveGroup(e,t){const n=z.getGroup(e);n&&n.allPieces.forEach(i=>this.movePiece(i.id,t))}rotatePiece(e,t){const n=this._findPiece(e);n&&(n.rotate(t),Le(n))}rotateGroup(e,t,n){const i=z.getGroup(e);if(!i||i.isEmpty())return;const s=this._getElement(n.id);if(!s)return;const o=this.getCenter(n,s);i.allPieces.forEach(a=>{if(!a)return;const c=this._getElement(a.id);if(!c)return;a.rotate(t);const u=this.getCenter(a,c).rotatedAroundDeg(o,t);this.placePieceCenter(a.id,u,c),Le(a)})}queryRadius(e,t){return!this.spatialIndex||!e?[]:this.spatialIndex.queryRadius(e,t)}rotatePieceOrGroup(e,t){const n=this._findPiece(e);if(!n)return;const i=z.getGroup(n.groupId);i&&i.size()>1?this.rotateGroup(i.id,t,n):this.rotatePiece(e,t)}calculatePiecesBounds(e){if(ve.isArrayEmpty(e))return null;let t=new W;for(const n of e){if(!n)continue;const i=n.calculateBoundingFrame();if(!i)continue;const s=this.getPiecePosition(n.id)||new b(0,0),o=s.add(i.topLeft),a=s.add(i.bottomRight),c=W.fromPoints(o,a);c.isEmpty()||(t=t.plus(c))}return t.isEmpty()?null:t}arePiecesNeighbors(e,t){if(!e||!t||!e.worldData||!t.worldData)return!1;const n=e.worldData.worldCorners,i=t.worldData.worldCorners;if(!n||!i)return!1;const o=18*((e.scale+t.scale)*.5)+4,a=(f,h)=>{const g=f.x-h.x,m=f.y-h.y;return g*g+m*m<=o*o};return!!(a(n.nw,i.sw)&&a(n.ne,i.se)||a(n.sw,i.nw)&&a(n.se,i.ne)||a(n.ne,i.nw)&&a(n.se,i.sw)||a(n.nw,i.ne)&&a(n.sw,i.se))}_findPiece(e){return p.pieces.find(t=>t.id===e)}_getElement(e){return this.pieceElements?this.pieceElements.get(e):null}_updateSpatialIndexFor(e){if(!this.spatialIndex)return;const t=this._findPiece(e);if(!t)return;const n=this._getElement(e),i=this.getCenter(t,n);this.spatialIndex.update({id:t.id,position:i})}}const A=new sm;class Zs{constructor(e){this.id=e.id,this.gridPos=e.gridPos,this._groupId=e.groupId||null,this.imgRect=new W(e.imgPos,e.w,e.h),this.nw=e.imgPos,this.master=e.master,this.bitmap=e.bitmap,this.paths=e.paths,this.scale=e.scale||De;const t=e.position||new b(0,0);if(this.rotation=e.rotation||0,this.zIndex=e.zIndex!==void 0?e.zIndex:null,e.geometryCorners&&e.geometrySidePoints){this.corners=Ao(e.geometryCorners,e.imgPos);const n=Ao(e.geometrySidePoints,e.imgPos);this.sPoints=this._convertSidePointArrays(n)}else this.corners=e.corners,this.sPoints=e.sPoints?this._convertSidePointArrays(e.sPoints):{};if(!this.paths&&this.corners&&this.corners.nw&&this.corners.ne&&this.corners.se&&this.corners.sw&&this.sPoints&&(this.paths=this.generatePath()),!this.bitmap&&this.paths&&this.nw){const n=this.calculateBoundingFrame();e.master&&(this.bitmap=em(n,this.paths,this.nw,e.master))}A.setPiecePosition(this.id,t)}get worldData(){return A.getWorldData(this)}get groupId(){return this._groupId}getCenter(e=null){return A.getCenter(this,e)}rotate(e){this.rotation=(this.rotation+e)%360,this.rotation<0&&(this.rotation+=360)}setRotation(e){this.rotation=e%360,this.rotation<0&&(this.rotation+=360)}_setGroupId(e){this._groupId=e}_convertSidePointArrays(e){const t={};return Ze.forEach(n=>{const i=e[n];if(!i)t[n]=[];else if(Array.isArray(i))t[n]=i.map(s=>s instanceof b?s:new b(s.x,s.y));else{const s=i instanceof b?i:new b(i.x,i.y);t[n]=[s,s,s]}}),t}getWorldCorners(){var e;return((e=this.worldData)==null?void 0:e.worldCorners)||{}}getWorldSidePoints(){var e;return((e=this.worldData)==null?void 0:e.worldSPoints)||{}}calculateBoundingFrame(){const e=[this.corners.nw,this.corners.ne,this.corners.se,this.corners.sw];return this.sPoints[ee]&&this.sPoints[ee].length>0&&e.push(...this.sPoints[ee]),this.sPoints[te]&&this.sPoints[te].length>0&&e.push(...this.sPoints[te]),this.sPoints[re]&&this.sPoints[re].length>0&&e.push(...this.sPoints[re]),this.sPoints[ne]&&this.sPoints[ne].length>0&&e.push(...this.sPoints[ne]),ad(e)}generatePath(){const e={north:new Path2D,east:new Path2D,south:new Path2D,west:new Path2D,combined:new Path2D};return e.north.moveTo(this.corners.nw.x,this.corners.nw.y),this._addEdgeSpline(e.north,this.corners.nw,this.sPoints[ee],this.corners.ne),e.east.moveTo(this.corners.ne.x,this.corners.ne.y),this._addEdgeSpline(e.east,this.corners.ne,this.sPoints[te],this.corners.se),e.west.moveTo(this.corners.nw.x,this.corners.nw.y),this._addEdgeSpline(e.west,this.corners.nw,this.sPoints[ne],this.corners.sw),e.south.moveTo(this.corners.sw.x,this.corners.sw.y),this._addEdgeSpline(e.south,this.corners.sw,this.sPoints[re],this.corners.se),e.combined.moveTo(this.corners.nw.x,this.corners.nw.y),this._addEdgeSpline(e.combined,this.corners.nw,this.sPoints[ee],this.corners.ne),this._addEdgeSpline(e.combined,this.corners.ne,this.sPoints[te],this.corners.se),e.combined.moveTo(this.corners.nw.x,this.corners.nw.y),this._addEdgeSpline(e.combined,this.corners.nw,this.sPoints[ne],this.corners.sw),this._addEdgeSpline(e.combined,this.corners.sw,this.sPoints[re],this.corners.se),e}_addEdgeSpline(e,t,n,i){if(!n||n.length===0){e.lineTo(i.x,i.y);return}const s=[t,...n,i],o=.2;for(let a=1;a<s.length;a++){const c=s[a-1],d=s[a],u=a<s.length-1?s[a+1]:null,l=a>1?s[a-2]:c,f=d.sub(l).scaled(o),g=(u||d).sub(c).scaled(o),m=c.add(f),y=d.sub(g);e.bezierCurveTo(m.x,m.y,y.x,y.y,d.x,d.y)}}serialize(e=!1){var i;const t=A.getPiecePosition(this.id)||new b(0,0),n={id:this.id,gridPos:this.gridPos,rotation:this.rotation,position:t,groupId:this.groupId,zIndex:this.zIndex,corners:this.corners,sPoints:this.sPoints,w:this.imgRect.width,h:this.imgRect.height,scale:De,imgPos:this.imgRect.position};if(e&&((i=this.bitmap)!=null&&i.toDataURL))try{n.bitmapData=this.bitmap.toDataURL()}catch(s){console.warn(`[Piece] Failed to serialize bitmap for piece ${this.id}:`,s)}return n}static deserialize(e){const t=e.gridPos instanceof b?e.gridPos:new b(e.gridPos.x,e.gridPos.y),n=e.position instanceof b?e.position:new b(e.position.x,e.position.y),i=e.imgPos instanceof b?e.imgPos:new b(e.imgPos.x,e.imgPos.y),s=zf(e.corners),o={};return Ze.forEach(a=>{var d;const c=(d=e.sPoints)==null?void 0:d[a];!c||!Array.isArray(c)?o[a]=[]:o[a]=c.map(u=>u instanceof b?u:new b(u.x,u.y))}),{id:e.id,gridPos:t,rotation:e.rotation,position:n,groupId:e.groupId,zIndex:e.zIndex,corners:s,sPoints:o,w:e.w,h:e.h,imgPos:i,scale:e.scale,bitmapData:e.bitmapData}}toString(){const e=A.getPiecePosition(this.id)||new b(0,0);return`Piece{id:${this.id}, grid:(${this.gridPos.x},${this.gridPos.y}), pos:(${e.x.toFixed(1)},${e.y.toFixed(1)}), rot:${this.rotation}, group:${this.groupId}}`}}const om="PuzzleImageStorage",am=1,oe="images";let ge=null;async function jt(){return ge||new Promise((r,e)=>{const t=indexedDB.open(om,am);t.onerror=()=>{console.error("Failed to open IndexedDB:",t.error),e(t.error)},t.onsuccess=()=>{ge=t.result,console.log("IndexedDB initialized successfully"),r(ge)},t.onupgradeneeded=n=>{const i=n.target.result;if(!i.objectStoreNames.contains(oe)){const s=i.createObjectStore(oe,{keyPath:"id"});s.createIndex("filename","filename",{unique:!1}),s.createIndex("timestamp","timestamp",{unique:!1}),console.log("Created IndexedDB object store")}}})}function ye(){return"indexedDB"in window}async function cm(r){if(!ye())throw new Error("IndexedDB not supported");try{await jt();try{await um(3),console.log("Maintained last 3 recent images")}catch(i){console.warn("Failed to maintain recent images, proceeding anyway:",i)}const e=`img_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,t=r instanceof Blob?r:new Blob([r]),n={id:e,filename:r.name||"uploaded_image",blob:t,size:t.size,type:t.type,timestamp:Date.now()};return new Promise((i,s)=>{const c=ge.transaction([oe],"readwrite").objectStore(oe).add(n);c.onsuccess=()=>{console.log(`Stored image in IndexedDB: ${e} (previous images cleared)`),i({imageId:e,filename:n.filename,size:n.size,type:n.type})},c.onerror=()=>{console.error("Failed to store image in IndexedDB:",c.error),s(c.error)}})}catch(e){throw console.error("Error storing image in IndexedDB:",e),e}}async function af(r){if(!ye())throw new Error("IndexedDB not supported");try{return await jt(),new Promise((e,t)=>{const s=ge.transaction([oe],"readonly").objectStore(oe).get(r);s.onsuccess=()=>{const o=s.result;o?(console.log(`Loaded image from IndexedDB: ${r}`),e({id:o.id,filename:o.filename,blob:o.blob,size:o.size,type:o.type,timestamp:o.timestamp})):t(new Error(`Image not found: ${r}`))},s.onerror=()=>{console.error("Failed to load image from IndexedDB:",s.error),t(s.error)}})}catch(e){throw console.error("Error loading image from IndexedDB:",e),e}}async function um(r=3){if(!ye())throw new Error("IndexedDB not supported");try{return await jt(),new Promise((e,t)=>{const i=ge.transaction([oe],"readwrite").objectStore(oe),o=i.index("timestamp").openCursor(null,"prev");let a=0;const c=[];o.onsuccess=d=>{const u=d.target.result;u?(a<r?a++:c.push(u.primaryKey),u.continue()):(c.forEach(l=>{i.delete(l)}),console.log(`Kept ${a} recent images, deleted ${c.length} old images`),e(!0))},o.onerror=()=>{console.error("Failed to keep recent images:",o.error),t(o.error)}})}catch(e){throw console.error("Error keeping recent images:",e),e}}async function lm(r=3){if(!ye())throw new Error("IndexedDB not supported");try{return await jt(),new Promise((e,t)=>{const o=ge.transaction([oe],"readonly").objectStore(oe).index("timestamp").openCursor(null,"prev"),a=[];o.onsuccess=c=>{const d=c.target.result;if(d&&a.length<r){const u=d.value;a.push({id:u.id,filename:u.filename,blob:u.blob,size:u.size,type:u.type,timestamp:u.timestamp}),d.continue()}else e(a)},o.onerror=()=>{console.error("Failed to get recent images:",o.error),t(o.error)}})}catch(e){throw console.error("Error getting recent images:",e),e}}const _e="puzzle.save.v3.",zt="puzzle.save.index",dm=20,fm=1200,cf=!1,hm=1,pm=25e5;let Qe=!1,Bs=null,V=null;function it(r){if(!r)return null;const e=r.split("").reduce((t,n)=>(t=(t<<5)-t+n.charCodeAt(0),t&t),0);return`img_${Math.abs(e)}`}function et(){try{const r=localStorage.getItem(zt);return r?JSON.parse(r):[]}catch{return[]}}function gm(r,e,t){let n=et();const i=Date.now();for(n=n.filter(s=>s.key!==r),n.unshift({key:r,imageUrl:e,timestamp:i,size:t});n.length>dm;){const s=n.pop();try{localStorage.removeItem(_e+s.key),console.info(`[persistence] Evicted old save for ${s.imageUrl}`)}catch(o){console.warn(`[persistence] Failed to evict save for ${s.key}`,o)}}try{localStorage.setItem(zt,JSON.stringify(n))}catch(s){console.warn("[persistence] Failed to update index",s)}}function uf(r){V=it(r),console.info(`[persistence] Set current image key: ${V}`)}function mm(){N(bg,()=>{vt()}),N(gt,()=>{wm()}),N(Vd,()=>{vt()}),N(rt,()=>{vt()}),window.puzzlePersistence={manualSave:Js,load:Qs,clear:Me,clearAll:_m,listGames:et,stats:()=>{var e;const r=V?_e+V:null;return{currentKey:V,size:r&&((e=localStorage.getItem(r))==null?void 0:e.length)||0,totalGames:et().length}}},window.addEventListener("beforeunload",()=>{if(Qe)try{Js()}catch{}}),console.info("[persistence] Initialized with event-driven architecture")}function vt(){Qe=!0,Bs&&clearTimeout(Bs),Bs=setTimeout(()=>{Js()},fm)}function vm(r){let e=0,t=0;for(const n of r)n.gridY>e&&(e=n.gridY),n.gridX>t&&(t=n.gridX);return{rows:e+1,cols:t+1}}function ym(r=cf){var i,s,o,a;if(ve.isArrayEmpty(p.pieces))return null;const e=p.pieces.map(c=>{var l,f;if(typeof c.serialize=="function")return c.serialize(r);let d=null;if(r)try{d=(f=(l=c.bitmap)==null?void 0:l.toDataURL)==null?void 0:f.call(l)}catch{d=null}const u=A.getPiecePosition(c.id)||new b(0,0);return{id:c.id,gridX:c.gridX,gridY:c.gridY,rotation:c.rotation,displayX:u.x,displayY:u.y,groupId:c.groupId,sPoints:c.sPoints,w:c.imgRect.width,h:c.imgRect.height,scale:c.scale,imgX:c.imgRect.position.x,imgY:c.imgRect.position.y,bitmapData:d}}),{rows:t,cols:n}=vm(p.pieces);return{version:"puzzleStateV2",savedAt:Date.now(),layout:{rows:t,cols:n},ui:{offsetX:p.viewport.offsetX,offsetY:p.viewport.offsetY,scale:p.viewport.scale,sliderValue:p.puzzleSettings.sliderValue,removeColor:p.puzzleSettings.removeColor,noRotate:p.noRotate},imageSource:{source:p.image.source,width:((i=p.image.data)==null?void 0:i.naturalWidth)||((s=p.image.data)==null?void 0:s.width)||null,height:((o=p.image.data)==null?void 0:o.naturalHeight)||((a=p.image.data)==null?void 0:a.height)||null,imageId:p.image.id,license:p.image.license},totalPieces:p.totalPieces,pieces:e,light:!r}}function Js(){try{let r=0,e=cf;for(;r<=hm;){const t=ym(e);if(!t){Qe=!1;return}const n=JSON.stringify(t);if(n.length>pm&&e){console.warn(`[persistence] Payload ~${n.length}B above soft limit; retry without bitmaps.`),e=!1,r++;continue}try{if(!V){console.warn("[persistence] No current image key, skipping save");return}const i=_e+V;localStorage.setItem(i,n);const s=p.currentImageSource||"unknown";gm(V,s,n.length),Qe=!1,console.info("[persistence] Saved successfully",{imageKey:V,pieces:t.pieces.length,size:`${(n.length/1024).toFixed(1)}KB`});break}catch(i){if(e&&(i.name==="QuotaExceededError"||i.code===22)){console.warn("[persistence] Quota exceeded with bitmaps; retrying without them."),e=!1,r++;continue}console.warn("[persistence] Save failed",i);break}}}catch(r){console.warn("[persistence] Save failed (outer)",r)}}function lf(r=null){const e=r?it(r):V;return e?!!localStorage.getItem(_e+e):!1}function Me(r=null){const e=r?it(r):V;if(!e){console.warn("[persistence] No image key to clear");return}const t=_e+e;localStorage.removeItem(t);let n=et();n=n.filter(i=>i.key!==e),localStorage.setItem(zt,JSON.stringify(n)),console.info(`[persistence] Cleared save for ${e}`)}function _m(){et().forEach(e=>{localStorage.removeItem(_e+e.key)}),localStorage.removeItem(zt),console.info("[persistence] Cleared all saved games")}function wm(r=null){const e=lf(r),t=r?it(r):V;if(e&&t){const n=_e+t,i=localStorage.getItem(n);try{const s=JSON.parse(i);document.dispatchEvent(new CustomEvent(Wd,{detail:{savedState:s,imageUrl:r||s.imageSource}}))}catch{console.warn(`[persistence] Corrupt save for ${t}; clearing`),Me(r),document.dispatchEvent(new CustomEvent(Ks,{detail:{imageUrl:r}}))}}else document.dispatchEvent(new CustomEvent(Ks,{detail:{imageUrl:r}}))}function Qs(r=null){var s,o;const e=r?it(r):V;if(!e){console.warn("[persistence] No image key to load");return}const t=_e+e,n=localStorage.getItem(t);if(!n){console.warn(`[persistence] No saved game found for ${e}`);return}let i;try{i=JSON.parse(n)}catch{console.warn("[persistence] Corrupt save; clearing"),Me();return}if(i.version!=="puzzleStateV2"&&i.version!=="puzzleStateV1"){console.warn("[persistence] Version mismatch:",i.version);return}if((s=i.imageSource)!=null&&s.source){const a=i.imageSource.source;p.image.source=a,p.image.id=i.imageSource.imageId,p.image.license=i.imageSource.license;const c=new Image;if(c.onload=()=>{p.image.data=c,pe(i,c)},c.onerror=()=>{console.warn("[persistence] Failed to load image from source:",a),console.warn("[persistence] This may be due to file being moved or URL no longer accessible"),pe(i,null)},a.startsWith("idb:")&&p.image.id)if(console.log("[persistence] Attempting to load IndexedDB source:",p.image.id),ye()){af(p.image.id).then(d=>{const u=URL.createObjectURL(d.blob);c.src=u,c.onload=()=>{URL.revokeObjectURL(u),p.image.data=c,p.image.id=d.id,pe(i,c)}}).catch(d=>{console.warn("[persistence] Failed to load IndexedDB image:",d),pe(i,null)});return}else{console.warn("[persistence] IndexedDB not supported"),pe(i,null);return}else c.crossOrigin="anonymous",c.src=a}else if((o=i.image)!=null&&o.src){const a=new Image;a.onload=()=>{p.image.data=a,pe(i,a)},a.onerror=()=>{console.warn("[persistence] Failed to load embedded image"),pe(i,null)},a.src=i.image.src}else pe(i,null)}function pe(r,e){var i;const t=r.pieces.map(s=>{let o=null;e&&(o=document.createElement("canvas"),o.width=e.width,o.height=e.height,o.getContext("2d").drawImage(e,0,0));const a=Zs.deserialize(s),c=new Zs({...a,master:o});return p.pieces.push(c),A.setPiecePosition(c.id,a.position),c});p.totalPieces=t.length,p.noRotate=((i=r.ui)==null?void 0:i.noRotate)||!1,p.noRotate&&p.pieces.forEach(s=>{s.setRotation(0)}),r.ui&&(typeof r.ui.offsetX=="number"&&(p.viewport.offsetX=r.ui.offsetX),typeof r.ui.offsetY=="number"&&(p.viewport.offsetY=r.ui.offsetY),typeof r.ui.scale=="number"&&(p.viewport.scale=r.ui.scale),typeof r.ui.sliderValue=="number"&&(p.puzzleSettings.sliderValue=r.ui.sliderValue),typeof r.ui.removeColor=="boolean"&&(p.puzzleSettings.removeColor=r.ui.removeColor));const n=Xe();n&&(n.innerHTML="",Bg(n,p.pieces)),A.syncAllPositions(),document.dispatchEvent(new CustomEvent(Ne,{detail:{action:"loaded"}})),console.info("[persistence] Loaded game",{pieces:t.length,light:r.light}),Qe=!1}let df="en",Ee={};function bm(r,e){return e?Object.entries(e).reduce((t,[n,i])=>t.replace(new RegExp("{"+n+"}","g"),i),r):r}function q(r,e){const t=Ee[r]||r;return bm(t,e)}async function eo(r){try{const t=await fetch(`/pzl/i18n/${r}.json`,{cache:"no-cache"});if(!t.ok)throw new Error(`${t.status} ${t.statusText}`);Ee=await t.json(),df=r,localStorage.setItem("lang",r),ff()}catch(e){console.warn("[i18n] Failed to load language",r,e),r!=="en"&&await eo("en")}}function ff(){document.querySelectorAll("[data-i18n]").forEach(e=>{const t=e.dataset.i18n;Ee[t]&&(e.innerHTML=q(t))}),document.querySelectorAll("[data-i18n-title]").forEach(e=>{const t=e.dataset.i18nTitle;Ee[t]&&(e.title=q(t))}),document.querySelectorAll("[data-i18n-aria-label]").forEach(e=>{const t=e.dataset.i18nAriaLabel;Ee[t]&&e.setAttribute("aria-label",q(t))});const r=document.querySelector("#helpModal .modal-body");r&&Ee["help.bodyHtml"]&&(r.innerHTML=Ee["help.bodyHtml"]),Im()}async function Em(){var i;const r=localStorage.getItem("lang"),e=((i=navigator.language)==null?void 0:i.toLowerCase())||"en";let t="en";e.startsWith("de")?t="de":e.startsWith("ru")?t="ru":e.startsWith("ua")&&(t="ua"),await eo(r||t||"en");const n=document.getElementById("langSelect");n&&(n.value=df,n.addEventListener("change",s=>{const o=s.target.value;eo(o)}))}function Vl({onResume:r,onDiscard:e,onCancel:t,hasResume:n=!0}){const i=document.getElementById("resume-modal-overlay");i&&i.remove();const s=document.createElement("div");s.id="resume-modal-overlay";const o=n?`
    <button class="resume-primary" data-action="resume">${q("resume.resume")}</button>
    <button class="resume-warn" data-action="cancel">${q("resume.cancel")}</button>
    <button class="resume-danger" data-action="discard">${q("resume.discard")}</button>
  `:`
    <button class="resume-primary" data-action="discard">${q("welcome.start")}</button>
    <button class="resume-warn" data-action="cancel">${q("resume.cancel")}</button>
  `;s.innerHTML=`
    <div class="resume-modal" role="dialog" aria-modal="true" aria-labelledby="resume-modal-title">
      <div style="text-align: center; font-size: 4rem; margin-bottom: 12px; line-height: 1;"></div>
      <h2 id="resume-modal-title">${q(n?"resume.title":"welcome.title")}</h2>
      <p>${q(n?"resume.message":"welcome.message")}</p>
      <div class="resume-actions">
        ${o}
      </div>
      ${n?`<div class="resume-meta">${q("resume.meta")}</div>`:""}
    </div>`,document.body.appendChild(s);function a(){s.remove(),document.removeEventListener("keydown",c)}function c(u){u.key==="Escape"&&(a(),t&&t())}document.addEventListener("keydown",c),s.addEventListener("click",u=>{u.target===s&&(a(),t&&t())}),s.querySelectorAll("button").forEach(u=>{u.addEventListener("click",()=>{const l=u.dataset.action;l==="resume"?(a(),r&&r()):l==="discard"?(a(),e&&e()):l==="cancel"&&(a(),t&&t())})});const d=s.querySelector("button[data-action='resume']");d&&d.focus()}function Im(){const r=document.getElementById("resume-modal-overlay");if(r){const e=r.querySelector("#resume-modal-title");e&&(e.textContent=q("resume.title"));const t=r.querySelector(".resume-modal p");t&&(t.textContent=q("resume.message")),r.querySelectorAll("button").forEach(i=>{const s=i.dataset.action;s==="resume"?i.textContent=q("resume.resume"):s==="cancel"?i.textContent=q("resume.cancel"):s==="discard"&&(i.textContent=q("resume.discard"))});const n=r.querySelector(".resume-meta");n&&(n.textContent=q("resume.meta"))}}async function Pm(r,e={}){const{returnDataUrl:t=!1}=e,n=typeof r=="string"?await hf(r):r,i=document.createElement("canvas");i.width=n.width,i.height=n.height;const s=i.getContext("2d");s.filter="grayscale(100%)",s.drawImage(n,0,0),s.filter="none";const o=i.toDataURL();if(t)return o;const a=new Image;return a.src=o,await a.decode(),a}async function It(r,e={}){const t=typeof r=="string"?await hf(r):r,{centered:n=!1,fontSizePercent:i=2,minFontSize:s=12,returnDataUrl:o=!1,removeColor:a=null,license:c=null}=e,d=c??p.deepLinkLicense??null;if(!d)return t;const u=a??p.deepLinkRemoveColor??"n",l=document.createElement("canvas");l.width=t.width,l.height=t.height;const f=l.getContext("2d");u==="y"&&(f.filter="grayscale(100%)"),f.drawImage(t,0,0),f.filter="none";const h=Math.max(s,Math.floor(t.height*(i/100))),g=Math.floor(h*.5);f.font=`${h}px Arial, sans-serif`,f.textBaseline="bottom",n?f.textAlign="center":f.textAlign="left";const y=f.measureText(d).width,_=h;let v,I;n?(v=(t.width-y)/2-g,I=t.width/2):(v=g,I=g*2);const w=t.height-_-g*2,S=y+g*2,E=_+g*2;f.fillStyle="rgba(0, 0, 0, 0.7)",f.fillRect(v,w,S,E),f.fillStyle="white",f.fillText(d,I,t.height-g*1.5);const P=l.toDataURL();if(o)return P;const R=new Image;return R.src=P,await R.decode(),R}function hf(r,e=!0){return new Promise((t,n)=>{const i=new Image;e&&(i.crossOrigin="anonymous"),i.onload=()=>t(i),i.onerror=()=>n(new Error(`Failed to load image: ${r}`)),i.src=r})}function Kl(r,e={}){const{timeout:t=1e4,onLoad:n=()=>{},onError:i=()=>{},onTimeout:s=()=>{}}=e;return new Promise((o,a)=>{if(r.startsWith("idb:")){const u=r.substring(4);if(!ye()){console.warn("[remote-image] IndexedDB not supported"),i(),a(new Error("IndexedDB not supported"));return}const l=setTimeout(()=>{console.warn("[remote-image] IndexedDB load timeout for:",u),s(),a(new Error(`IndexedDB load timeout: ${u}`))},t);af(u).then(f=>{clearTimeout(l);const h=URL.createObjectURL(f.blob),g=new Image;g.onload=()=>{URL.revokeObjectURL(h),console.info("[remote-image] IndexedDB image loaded successfully:",u),n(g),o(g)},g.onerror=()=>{URL.revokeObjectURL(h),console.warn("[remote-image] Failed to load IndexedDB image:",u),i(),a(new Error(`Failed to load IndexedDB image: ${u}`))},g.src=h}).catch(f=>{clearTimeout(l),console.warn("[remote-image] Failed to load from IndexedDB:",f),i(),a(f)});return}const c=new Image;c.crossOrigin="anonymous",c.decoding="async";const d=setTimeout(()=>{console.warn("[remote-image] Image load timeout for:",r),s(),a(new Error(`Image load timeout: ${r}`))},t);c.onload=async()=>{clearTimeout(d),console.info("[remote-image] Image loaded successfully:",r),n(c),o(c)},c.onerror=()=>{clearTimeout(d),console.warn("[remote-image] Failed to load image URL:",r),i(),a(new Error(`Failed to load image: ${r}`))},c.src=r})}const Cm=1,Us=-1,Xl=.1,Sm=.25,Rm=.5,Tm=.3,Yl=2;class qm{constructor(e,t,n,i,s,o){this.rows=e,this.cols=t,this.imgWidth=n,this.imgHeight=i,this.pieceW=n/t,this.pieceH=i/e,this.totalInternalEdges=(e-1)*t+(t-1)*e,this.positiveTarget=this.totalInternalEdges/2,this.posCount=0,this.corners=this.buildCornerLattice();const{hSides:a,vSides:c}=this.generateInternalEdges(s,o);this.hSides=a,this.vSides=c}chooseOrientation(){const e=this.totalInternalEdges-this.posCount,n=(this.positiveTarget-this.posCount)/Math.max(1,e);return Math.random()<n?(this.posCount++,Cm):Us}splitSegment(e,t){if(t===0)return[];const n=[];for(let i=1;i<=t;i++){const s=i/(t+1)*e,o=e/(t+1)*Tm;n.push(s+ve.symmetricRandomDeviation(o))}return n}buildCornerLattice(){const e=this.splitSegment(this.imgWidth,this.cols-1),t=this.splitSegment(this.imgWidth,this.cols-1),n=this.splitSegment(this.imgHeight,this.rows-1),i=this.splitSegment(this.imgHeight,this.rows-1),s=Array(this.rows+1).fill(0).map(()=>Array(this.cols+1));s[0][0]=new b(0,0),s[0][this.cols]=new b(this.imgWidth,0),s[this.rows][0]=new b(0,this.imgHeight),s[this.rows][this.cols]=new b(this.imgWidth,this.imgHeight);for(let o=1;o<this.cols;o++)s[0][o]=new b(e[o-1],0),s[this.rows][o]=new b(t[o-1],this.imgHeight);for(let o=1;o<this.rows;o++)s[o][0]=new b(0,n[o-1]),s[o][this.cols]=new b(this.imgWidth,i[o-1]);for(let o=1;o<this.rows;o++)for(let a=1;a<this.cols;a++){const c=new b(e[a-1],0),d=new b(t[a-1],this.imgHeight),u=new b(0,n[o-1]),l=new b(this.imgWidth,i[o-1]),f=this.calculateLineIntersection(c,d,u,l);s[o][a]=f}return s}calculateLineIntersection(e,t,n,i){const s=(e.x-t.x)*(n.y-i.y)-(e.y-t.y)*(n.x-i.x);if(Math.abs(s)<1e-10)return null;const o=((e.x-n.x)*(n.y-i.y)-(e.y-n.y)*(n.x-i.x))/s,a=e.x+o*(t.x-e.x),c=e.y+o*(t.y-e.y);return new b(a,c)}deviatePoint(e,t,n){const s=.5+ve.symmetricRandomDeviation(n);return e.add(t.sub(e).scaled(s))}clampDepthForCavity(e,t){return Math.min(e,Sm*Math.min(this.pieceW,this.pieceH),Rm*t)}generateInternalEdges(e,t){if(!this.corners)throw new Error("Corner lattice must be built before generating internal edges");const n=Array(this.rows-1).fill(0).map(()=>Array(this.cols)),i=Array(this.rows).fill(0).map(()=>Array(this.cols-1));for(let s=0;s<this.rows-1;s++)for(let o=0;o<this.cols;o++){const a=this.corners[s+1][o],c=this.corners[s+1][o+1],d=this.pieceW,u=this.deviatePoint(a,c,Xl),l=this.chooseOrientation();let f=e+Math.random()*(t-e);l===Us&&(f=this.clampDepthForCavity(f,d));const h=u.y+l*f,g=new b(u.x,h),{point1A:m,point2a:y,point2b:_,point1B:v}=this.generateCavityPoints(a,c,u,g);n[s][o]={points:[m,y,g,_,v],orientation:l}}for(let s=0;s<this.rows&&!(this.cols-1<=0);s++)for(let o=0;o<this.cols-1;o++){const a=this.corners[s][o+1],c=this.corners[s+1][o+1],d=this.pieceH,u=this.deviatePoint(a,c,Xl),l=this.chooseOrientation();let f=e+Math.random()*(t-e);l===Us&&(f=this.clampDepthForCavity(f,d));const h=u.x+l*f,g=new b(h,u.y),{point1A:m,point2a:y,point2b:_,point1B:v}=this.generateCavityPoints(a,c,u,g);i[s][o]={points:[m,y,g,_,v],orientation:l}}return{hSides:n,vSides:i}}generateCavityPoints(e,t,n,i){const s=t.sub(e),o=.05+.1*Math.random(),a=.05+.1*Math.random(),c=n.sub(s.scaled(o)),d=e.sub(i),u=a+o,l=i.add(d.scaled(u*Yl)),f=t.sub(i),h=i.add(f.scaled(u*Yl)),g=c.add(s.scaled(u));return{point1A:c,point2a:l,point2b:h,point1B:g}}getCorners(){return this.corners}getHSides(){return this.hSides}getVSides(){return this.vSides}}const Zl=2,xm=.4,Am=.2,Jl=[0,90,180,270];function Lm(r,e){var{cols:t,rows:n,actualCount:i}=Om(r,e);window.dispatchEvent(new CustomEvent(zd,{detail:{totalPieces:i}}));const s=r.width/t,o=r.height/n,a=xm*Math.min(s,o),c=Am*Math.min(s,o),d=new qm(n,t,r.width,r.height,c,a),u=d.getCorners(),l=d.getHSides(),f=d.getVSides(),h=[];let g=0;const m=document.createElement("canvas");m.width=r.width,m.height=r.height,m.getContext("2d").drawImage(r,0,0);for(let _=0;_<n;_++)for(let v=0;v<t;v++){const I=u[_][v],w=u[_][v+1],S=u[_+1][v+1],E=u[_+1][v],P={north:_>0?l[_-1][v].points:null,east:v<t-1&&f[_][v]?f[_][v].points:null,south:_<n-1?l[_][v].points:null,west:v>0&&f[_][v-1]?f[_][v-1].points:null},R=[I,w,S,E];P.north&&R.push(...P.north),P.east&&R.push(...P.east),P.south&&R.push(...P.south),P.west&&R.push(...P.west);const T=ad(R),M=g++,C={id:M,gridPos:new b(v,_),w:T.width,h:T.height,imgPos:I,rotation:Jl[Math.floor(Math.random()*Jl.length)],groupId:"g"+M,geometryCorners:{nw:I,ne:w,se:S,sw:E},geometrySidePoints:P,position:new b(I.x,I.y),master:m};h.push(new Zs(C))}return{pieces:h,rows:n,cols:t,actualCount:i}}function Om(r,e){const t=r.width/r.height;let n=Math.max(Zl,Math.round(Math.sqrt(e*t))),i=Math.max(Zl,Math.round(e/n));for(;i*n<e;)n++;const s=i*n;return{cols:n,rows:i,actualCount:s}}const Ql=document.getElementById("helpButton"),ue=document.getElementById("helpModal"),ed=document.getElementById("closeHelp");function Mm(){ue&&(ue.style.display="flex")}function Co(){ue&&(ue.style.display="none")}function pf(){return ue&&ue.style.display==="flex"}function Dm(r){r.target===ue&&Co()}function Nm(r){r.key==="Escape"&&pf()&&Co()}function km(){Ql&&Ql.addEventListener("click",Mm),ed&&ed.addEventListener("click",Co),ue&&ue.addEventListener("click",Dm),document.addEventListener("keydown",Nm)}const ft="pictures/",J=20;let He=null;async function Fm(){if(He!==null)return He;const r=[];try{const e=await fetch(`${ft}pictures.json`);if(e.ok){const n=((await e.json()).pictures||[]).map(i=>typeof i=="string"?{type:"local",filename:i,url:`${ft}${i}`,title:i.replace(/\.(png|jpg|jpeg|gif|webp)$/i,""),pieces:J}:{type:"local",filename:i.filename,url:`${ft}${i.filename}`,title:i.title||i.filename.replace(/\.(png|jpg|jpeg|gif|webp)$/i,""),pieces:i.pieces??J,removeColor:i.removeColor??"n",...i});r.push(...n),console.log(`[picture-gallery] Loaded ${n.length} local pictures`)}}catch(e){console.error("[picture-gallery] Error loading local pictures:",e)}try{const e=await fetch(`${ft}remote-pictures.json`);if(e.ok){const n=((await e.json()).pictures||[]).map(i=>({type:"remote",url:i.url,title:i.title??"Remote Image",pieces:i.pieces??J,removeColor:i.removeColor??"n",...i}));r.push(...n),console.log(`[picture-gallery] Loaded ${n.length} remote pictures`)}}catch(e){console.error("[picture-gallery] Error loading remote pictures:",e)}return He=r,console.log(`[picture-gallery] Total ${He.length} pictures available`),He}async function Pt(r,e){const t=document.getElementById("picture-gallery-overlay");t&&t.remove();const n=document.createElement("div");n.id="picture-gallery-overlay",n.className="picture-gallery-overlay";const i=document.createElement("div");i.className="picture-gallery";const s=document.createElement("h2");s.textContent=q("gallery.title"),i.appendChild(s);const o=document.createElement("div");o.className="picture-gallery-filter-bar";const a=document.createElement("button");a.className="picture-gallery-filter-btn",a.innerHTML="",a.title=q("gallery.filterBaby");const c=document.createElement("button");c.className="picture-gallery-filter-btn",c.innerHTML="",c.title=q("gallery.filterStudent");const d=document.createElement("button");d.className="picture-gallery-filter-btn",d.innerHTML="",d.title=q("gallery.filterMaster"),o.appendChild(a),o.appendChild(c),o.appendChild(d),i.appendChild(o);let u=null;const l=document.createElement("div");l.className="picture-gallery-grid",i.appendChild(l);const f=await Fm();let h=[];if(ye())try{h=await lm(3),console.log(`[picture-gallery] Loaded ${h.length} recent images from IndexedDB`)}catch(v){console.warn("[picture-gallery] Failed to load recent images:",v)}function g(v){if(l.innerHTML="",h.length>0&&!v){const w=document.createElement("div");w.className="picture-gallery-recent-section";const S=document.createElement("h3");S.className="picture-gallery-section-title",S.textContent=q("gallery.recentImages"),l.appendChild(S),h.forEach(E=>{const P=document.createElement("a");P.className="picture-gallery-item picture-gallery-recent-item";const R=URL.createObjectURL(E.blob),T=`?image=idb:${E.id}&pieces=${J}&norotate=y&resume=y`;P.href=T,P.title=`${E.filename} - ${q("gallery.itemTooltip",{title:E.filename,pieces:J})}`;const M=document.createElement("div");M.className="picture-gallery-item-container";const C=document.createElement("img");C.alt=E.filename,C.src=R,C.loading="eager",C.addEventListener("error",()=>{P.style.display="none",URL.revokeObjectURL(R)});const L=document.createElement("div");L.className="picture-gallery-item-title",L.textContent=E.filename,M.appendChild(C),M.appendChild(L),P.appendChild(M),P.addEventListener("click",j=>{j.preventDefault(),Ie(),r&&r(T,`idb:${E.id}`,E.id),URL.revokeObjectURL(R)}),l.appendChild(P)})}let I=f;[a,c,d].forEach(w=>w.classList.remove("selected")),v==="baby"?(I=f.filter(w=>(w.pieces||J)>=4&&(w.pieces||J)<=8),a.classList.add("selected")):v==="student"?(I=f.filter(w=>(w.pieces||J)>=10&&(w.pieces||J)<=100),c.classList.add("selected")):v==="master"&&(I=f.filter(w=>(w.pieces||J)>100),d.classList.add("selected")),v||(I=f),I.forEach(w=>{const S=document.createElement("a");S.className="picture-gallery-item";const E=w.pieces||J,P=w.removeColor||"n",R=w.license?`&license=${encodeURIComponent(w.license)}`:"",T=`&removeColor=${P}`,M=`?image=${encodeURIComponent(w.url)}&pieces=${E}&norotate=y${T}${R}&resume=y`;S.href=M,S.title=q("gallery.itemTooltip",{title:w.title,pieces:E});const C=document.createElement("div");C.className="picture-gallery-item-container";const L=document.createElement("img");L.alt=w.title,L.loading="lazy",It(w.url,{centered:!0,fontSizePercent:4,minFontSize:20,returnDataUrl:!0,removeColor:w.removeColor,license:w.license}).then(K=>{L.src=K}).catch(K=>{console.warn(`[picture-gallery] Failed to add license to preview: ${K.message}`),w.removeColor==="y"?Pm(w.url,{returnDataUrl:!0}).then(de=>{L.src=de}).catch(()=>{L.src=w.url}):L.src=w.url}),L.addEventListener("error",()=>{S.style.display="none",console.warn(`[picture-gallery] Failed to load image: ${w.url}`)});const j=document.createElement("div");j.className="picture-gallery-item-title",j.textContent=w.title,C.appendChild(L),C.appendChild(j),S.appendChild(C),S.addEventListener("click",K=>{K.preventDefault(),Ie(),r&&r(M,w.url)}),l.appendChild(S)}),m()}function m(){const v=document.createElement("button");v.className="picture-gallery-item picture-gallery-upload",v.title=q("gallery.uploadOwn");const I=document.createElement("div");I.className="picture-gallery-item-container";const w=document.createElement("div");w.innerHTML="",w.style.flex="0 0 80%",w.style.fontSize="6em",w.style.display="flex",w.style.alignItems="center",w.style.justifyContent="center",w.style.width="100%",I.appendChild(w);const S=document.createElement("div");S.className="picture-gallery-item-title",S.textContent=q("gallery.selectOwn"),I.appendChild(S),v.appendChild(I),v.style.border="none",v.style.background="transparent",v.style.cursor="pointer",v.style.padding="0",v.addEventListener("click",()=>{const E=document.createElement("input");E.type="file",E.accept="image/png,image/jpeg,image/jpg,image/gif,image/webp",E.addEventListener("change",async P=>{var T;const R=(T=P.target.files)==null?void 0:T[0];R&&(Ie(),window.dispatchEvent(new CustomEvent(Ae,{detail:{reason:"file-upload"}})),window.dispatchEvent(new CustomEvent($d,{detail:{file:R}})))}),E.click()}),l.appendChild(v)}g(),a.addEventListener("click",()=>{u==="baby"?(u=null,g()):(u="baby",g("baby"))}),c.addEventListener("click",()=>{u==="student"?(u=null,g()):(u="student",g("student"))}),d.addEventListener("click",()=>{u==="master"?(u=null,g()):(u="master",g("master"))});const y=document.getElementById("logo");y&&(y.style.cursor="pointer",y.addEventListener("click",()=>{Pt(r)})),n.appendChild(i),document.body.appendChild(n),n.addEventListener("click",v=>{v.target===n&&Ie()});const _=v=>{v.key==="Escape"&&(Ie(),document.removeEventListener("keydown",_))};document.addEventListener("keydown",_)}function Ie(){const r=document.getElementById("picture-gallery-overlay");r&&r.remove()}const gf=3,mf=1e3,ht=document.querySelector(".top-bar"),st=document.getElementById("pieceSlider"),Gm=document.getElementById("pieceDisplay"),Fe=document.getElementById("progressDisplay"),jm=document.getElementById("orientationTipButton"),zm=document.getElementById("zoomInButton"),Bm=document.getElementById("zoomOutButton"),Um=document.getElementById("zoomResetButton"),Hm=document.getElementById("piecesContainer");let Hs=!1,Ct=null;function vf(r){if(r===0)return 0;const e=r/100*gf,t=Math.round(Math.pow(10,e));return Math.max(1,Math.min(mf,t))}function td(r){const e=Math.max(1,Math.min(mf,r)),n=Math.log10(e)/gf*100;return Math.round(Math.max(0,Math.min(100,n)))}function Ge(){const r=vf(parseInt(st.value));Gm.textContent=r}function rd(r){st.value=String(r),p.puzzleSettings.sliderValue=r,Ge()}function nd(r){p.image.data=r}function Ye(r){p.image.source=r}function $m(r){p.image.id=r}function id(r){p.image.license=r}function yf(){ce(1,null)}function sd(){if(!p.pieces||p.pieces.length===0){Fe.textContent=q("status.emptyProgress");return}const r=p.totalPieces;let e;try{e=z.getGroupCount()}catch{console.warn("[updateProgress] GroupManager not available, falling back to simple count"),e=new Set(p.pieces.map(o=>o.groupId)).size}const t=r-(e-1),n=(t/r*100).toFixed(1);Fe.textContent=q("status.progressFormat",{score:t,total:r,percent:n}),e===1&&r>0&&setTimeout(()=>rv(),100)}async function to(){if(!p.image.data||Hs)return;const r=p.noRotate||!1;console.log("[control-bar] generatePuzzle called with noRotate from state:",r);const e=vf(parseInt(st.value));if(e===0){const n=Xe();if(n){const i=p.deepLinkLicense;p.deepLinkLicense=p.image.license;const s=await It(p.image.data);p.deepLinkLicense=i,n.innerHTML=`
        <div class="original-image-container">
          <img src="${s.src}" alt="${q("alt.originalImage")}" style="max-width:100%;max-height:100%;object-fit:contain;" />
        </div>
      `}p.pieces=[],p.totalPieces=0,document.dispatchEvent(new CustomEvent(Ne,{detail:{action:"cleared"}}));return}Hs=!0;const t=Xe();t&&(t.innerHTML=""),Fe.textContent=q("status.generating");try{p.image.source&&uf(p.image.source);const n=await It(p.image.data),{pieces:i,rows:s,cols:o}=Lm(n,e);p.pieces=i,p.totalPieces=i.length,p.noRotate=r,console.log("[control-bar] Set state.noRotate to:",p.noRotate),z.initialize();const a=Xe();a&&zg(a,i,r),document.dispatchEvent(new CustomEvent(Ne,{detail:{action:"generated"}})),Ct&&Ct.markDirty}catch(n){console.error(n),alert(q("error.generate",{error:n.message})),Fe.textContent=q("status.error")}finally{Hs=!1}}function Wm(){Ge(),to()}function Vm(){if(p.noRotate){console.log("[control-bar] Rotation disabled (noRotate mode)");return}const r=Jd();r&&document.dispatchEvent(new CustomEvent(Ud,{detail:{pieceId:r.id}}))}function Km(){ce(ke()*Et)}function Xm(){ce(ke()/Et)}function Ym(){yf()}function Zm(r){r.preventDefault();const e=r.deltaY>0?Hg:Ug;ce(ke()*e,new b(r.clientX,r.clientY))}function Jm(r){if(!(pf()||r.target.tagName==="INPUT"))switch(r.key){case"+":case"=":r.preventDefault(),ce(ke()*Et);break;case"-":r.preventDefault(),ce(ke()/Et);break;case"0":r.preventDefault(),yf();break;case"r":case"R":const e=Jd();if(e){const t=r.shiftKey?270:90;document.dispatchEvent(new CustomEvent(Eo,{detail:{pieceId:e.id,rotation:t}}))}break}}function Qm(){const r=document.getElementById("logo");r&&(r.style.cursor="pointer",r.addEventListener("click",()=>{Pt(e=>{window.location.href=e})})),st.addEventListener("input",Wm),jm.addEventListener("click",Vm),zm.addEventListener("click",Km),Bm.addEventListener("click",Xm),Um.addEventListener("click",Ym),Hm.addEventListener("wheel",Zm),document.addEventListener("keydown",Jm),N(Gt,e=>{const{piece:t}=e.detail;Ul(t)}),N(Je,()=>{Ul(null)}),N(wt,sd),N(Ne,sd),window.addEventListener(Vs,()=>{ht&&ht.classList.add("deep-link-mode")}),window.addEventListener(Ae,()=>{ht&&ht.classList.remove("deep-link-mode")}),window.addEventListener($d,e=>{const{file:t}=e.detail;ev(t)}),Ge(),Po()}async function ev(r){if(r)try{p.reset(),mt(),Fe.textContent=q("status.loadingImage");const e=new Image,t=await new Promise((i,s)=>{const o=new FileReader;o.onload=a=>i(a.target.result),o.onerror=s,o.readAsDataURL(r)});if(await new Promise((i,s)=>{e.onload=i,e.onerror=s,e.src=t}),p.image.data=e,p.image.id=null,ye())try{console.log("[controlBar] Attempting to store file in IndexedDB");const i=await cm(r);$m(i.imageId),Ye(`idb:${i.imageId}`),console.log("[controlBar] File stored successfully in IndexedDB:",i.imageId)}catch(i){console.warn("[controlBar] Failed to store file in IndexedDB:",i.message),Ye(r.webkitRelativePath||r.name)}else Ye(r.webkitRelativePath||r.name);st.value=0,Ge();const n=Xe();if(n){const i=p.deepLinkLicense;p.deepLinkLicense=p.image.license;const s=await It(p.image.data);p.deepLinkLicense=i,n.innerHTML=`
        <div class="original-image-container">
          <img src="${s.src}" alt="${q("alt.originalImage")}" style="max-width:100%;max-height:100%;object-fit:contain;" />
        </div>
      `}p.pieces=[],p.totalPieces=0,document.dispatchEvent(new CustomEvent(Ne,{detail:{action:"cleared"}})),Ct&&Ct.markDirty}catch(e){console.error(e),alert(q("error.loadImage",{error:e.message})),Fe.textContent=q("status.error")}}function tv(){try{const r=new URLSearchParams(window.location.search),e=r.get("image"),t=r.get("pieces"),n=r.get("norotate"),i=r.get("removeColor"),s=r.get("license"),o=r.get("resume");if(!e||!t){p.deepLinkImageUrl=null,p.deepLinkPieceCount=null;return}const a=parseInt(t,10);if(!ve.isPositiveNumber(a)){console.warn("[url-util] Invalid pieces param:",t),p.deepLinkImageUrl=null,p.deepLinkPieceCount=null;return}const c=n==="y"?"y":"n",d=i==="y"?"y":"n",u=o||"n";p.deepLinkImageUrl=e,p.deepLinkPieceCount=a,p.deepLinkNoRotate=c,p.deepLinkRemoveColor=d,p.deepLinkLicense=s||null,p.deepLinkResume=u,p.noRotate=c==="y"}catch(r){console.warn("[url-util] Error parsing deep link params:",r),p.deepLinkImageUrl=null,p.deepLinkPieceCount=null}}document.getElementById("piecesContainer");let Z=!1;function rv(){const r=p.pieces.map(t=>t.rotation),e=r.every(t=>t===r[0]);p.pieces.forEach(t=>{let n=[];if(!e){const s={};r.forEach(a=>{s[a]=(s[a]||0)+1});const o=Object.entries(s).sort((a,c)=>c[1]-a[1])[0][0];t.rotation!==Number(o)&&n.push(`Inconsistent rotation: ${t.rotation} (most pieces at ${o})`)}const i={[ee]:p.pieces.find(s=>s.gridX===t.gridX&&s.gridY===t.gridY-1),[te]:p.pieces.find(s=>s.gridX===t.gridX+1&&s.gridY===t.gridY),[re]:p.pieces.find(s=>s.gridX===t.gridX&&s.gridY===t.gridY+1),[ne]:p.pieces.find(s=>s.gridX===t.gridX-1&&s.gridY===t.gridY)};Object.entries(i).forEach(([s,o])=>{o&&(t.groupId!==o.groupId?n.push(`Not connected to expected neighbor at (${o.gridX}, ${o.gridY})`):A.arePiecesNeighbors(t,o)||n.push(`Neighbor ${s} (${o.gridX}, ${o.gridY}) corners are not properly aligned with this piece`))})})}async function nv(){if(await Em(),ff(),$g(),mt(),Qm(),km(),tv(),mm(),p.deepLinkImageUrl){if(p.deepLinkResume==="y"&&lf(p.deepLinkImageUrl)){console.info("[deeplink] Resume=y: Asking user to resume saved game"),Ie(),Vl({onResume:()=>{uf(p.deepLinkImageUrl),Qs(p.deepLinkImageUrl)},onDiscard:()=>{Me(p.deepLinkImageUrl),Z=!0,window.dispatchEvent(new CustomEvent(Vs)),Kl(p.deepLinkImageUrl,{timeout:1e4,onLoad:async r=>{nd(r),Ye(p.deepLinkImageUrl),id(p.deepLinkLicense);const e=td(p.deepLinkPieceCount);rd(e),Ge(),mt(p.deepLinkRemoveColor),await to(),Z=!1},onTimeout:()=>{Z=!1,window.dispatchEvent(new CustomEvent(Ae,{detail:{reason:"timeout"}}))},onError:()=>{Z=!1,window.dispatchEvent(new CustomEvent(Ae,{detail:{reason:"error"}}))}}).catch(()=>{})},onCancel:()=>{},hasResume:!0});return}Z=!0,window.dispatchEvent(new CustomEvent(Vs)),Kl(p.deepLinkImageUrl,{timeout:1e4,onLoad:async r=>{nd(r),Ye(p.deepLinkImageUrl),id(p.deepLinkLicense);const e=td(p.deepLinkPieceCount);rd(e),Ge(),mt(p.deepLinkRemoveColor),await to(),Z=!1,Ie()},onTimeout:()=>{Z=!1,window.dispatchEvent(new CustomEvent(Ae,{detail:{reason:"timeout"}})),document.dispatchEvent(new CustomEvent(gt))},onError:()=>{Z=!1,window.dispatchEvent(new CustomEvent(Ae,{detail:{reason:"error"}})),document.dispatchEvent(new CustomEvent(gt))}}).catch(()=>{})}if(N(Wd,r=>{const{savedState:e}=r.detail;Vl({onResume:()=>Qs(),onDiscard:()=>{Me(),document.dispatchEvent(new CustomEvent(Ne,{detail:{action:"cleared"}})),Z||Pt(t=>{window.location.href=t})},onCancel:()=>{},hasResume:!0})}),N(Ks,()=>{Z||Pt(r=>{window.location.href=r})}),Z)try{Me(),console.info("[deep-link] Previous session discarded due to deep link mode")}catch(r){console.warn("[deep-link] Failed to clear previous save",r)}else document.dispatchEvent(new CustomEvent(gt))}window.__puzzleBootstrapExecuted||(window.__puzzleBootstrapExecuted=!0,nv());
