(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const s of i)if(s.type==="childList")for(const a of s.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&n(a)}).observe(document,{childList:!0,subtree:!0});function t(i){const s={};return i.integrity&&(s.integrity=i.integrity),i.referrerPolicy&&(s.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?s.credentials="include":i.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function n(i){if(i.ep)return;i.ep=!0;const s=t(i);fetch(i.href,s)}})();const rd="v1.2.0",dt=`puzzle-static-${rd}`,lt=`puzzle-manifest-${rd}`;let k="/puzzle/";async function ft(){try{const r=await caches.open(lt),e=await r.match("asset-manifest.json");let t=null;e&&(t=(await e.json()).version,console.log("[SW] Cached manifest version:",t));const i=await(await fetch("asset-manifest.json",{cache:"no-cache"})).json(),s=i.version;console.log("[SW] New manifest version:",s);const a=t!==s||s==="dev";if(a){console.log("[SW] Version changed or dev mode detected - invalidating cache");const o=await caches.keys();await Promise.all(o.filter(d=>d.startsWith("puzzle-")).map(d=>(console.log("[SW] Deleting cache:",d),caches.delete(d)))),await(await caches.open(lt)).put("asset-manifest.json",new Response(JSON.stringify(i))),console.log("[SW] Cache invalidated, new manifest cached")}else console.log("[SW] Version unchanged - keeping existing cache"),await r.put("asset-manifest.json",new Response(JSON.stringify(i)));return{manifest:i,cacheInvalidated:a}}catch(r){console.warn("[SW] Failed to check manifest version:",r);const t=await(await caches.open(lt)).match("asset-manifest.json");if(t)return{manifest:await t.json(),cacheInvalidated:!1};throw r}}async function Of(){try{const{manifest:r,cacheInvalidated:e}=await ft();r.base&&(k=r.base);const t=[k,`${k}index.html`,`${k}manifest.json`,`${k}i18n/en.json`,`${k}i18n/de.json`,`${k}i18n/ru.json`,`${k}i18n/ua.json`,`${k}pictures/A320.jpg`,`${k}pictures/kleidung.png`,`${k}pictures/pictures.json`,`${k}pictures/remote-pictures.json`],n=[];return r.assets&&r.assets.js&&r.assets.js.forEach(function(i){n.push(`${k}assets/${i}`)}),r.assets&&r.assets.css&&r.assets.css.forEach(function(i){n.push(`${k}assets/${i}`)}),{base:k,allAssets:t.concat(n)}}catch(r){return console.warn("Could not load asset-manifest.json",r),{base:k,allAssets:[]}}}self.addEventListener("install",function(r){r.waitUntil(Of().then(function(e){return k=e.base,console.log("Service Worker installing with base:",k),console.log("Prefetching",e.allAssets.length,"assets..."),caches.open(dt).then(function(t){return t.addAll(e.allAssets).then(function(){console.log("All assets prefetched and cached successfully")})})}).then(function(){return console.log("Service Worker installed, activating..."),self.skipWaiting()}).catch(function(e){throw console.error("Service Worker install failed:",e),e}))});self.addEventListener("activate",r=>{r.waitUntil(Promise.all([ft().catch(e=>{console.warn("[SW] Failed to check manifest on activate:",e)}),caches.keys().then(e=>Promise.all(e.filter(t=>t.startsWith("puzzle-static-")&&t!==dt).map(t=>(console.log("[SW] Removing old static cache:",t),caches.delete(t)))))]).then(()=>self.clients.claim()))});self.addEventListener("fetch",function(r){const e=r.request,t=new URL(e.url);if(e.method!=="GET")return;const n=t.origin+t.pathname;if(t.pathname.endsWith("/asset-manifest.json")||t.pathname===`${k}asset-manifest.json`){r.respondWith(ft().then(({manifest:i})=>new Response(JSON.stringify(i),{headers:{"Content-Type":"application/json"}})).catch(function(i){return console.error("[SW] Failed to fetch manifest:",i),caches.match("asset-manifest.json",{cacheName:lt})}));return}if(t.pathname===k||t.pathname===`${k}index.html`){r.respondWith(ft().then(function(){return fetch(e)}).then(function(i){const s=i.clone();return caches.open(dt).then(function(a){a.put(n,s)}),i}).catch(function(i){return console.warn("[SW] Failed to fetch index.html, using cache:",i),caches.match(n)}));return}if(t.origin===location.origin){r.respondWith(caches.match(n,{ignoreSearch:!0}).then(function(i){return i||fetch(e).then(function(s){if(s.status===200){const a=s.clone();caches.open(dt).then(function(o){o.put(n,a)})}return s})}));return}});"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.register("/pzl/service-worker.js",{type:"module"}).catch(e=>{console.warn("SW registration failed",e)})});const Mf=50,Df=25;class Nf{constructor(){this.reset()}reset(){this.pieces=[],this.totalPieces=0,this.groups=[],this.snapNearPx=Mf,this.snapReadyPx=Df,this.noRotate=!1,this.deepLinkImageUrl=null,this.deepLinkPieceCount=null,this.deepLinkNoRotate="n",this.deepLinkRemoveColor="n",this.deepLinkLicense=null}resetDeepLinkState(){this.deepLinkImageUrl=null,this.deepLinkPieceCount=null,this.deepLinkNoRotate="n",this.deepLinkRemoveColor="n",this.deepLinkLicense=null}}const w=new Nf;class ne{static isArrayEmpty(e){return!e||e.length===0}static hasElements(e){return e&&e.length>0}static getPieceCount(e){return e.pieces?e.pieces.length:0}static isElementValid(e){return e!=null}static isTotalPiecesEmpty(e){return!e.totalPieces||e.totalPieces===0}static isPositiveNumber(e){return typeof e=="number"&&!isNaN(e)&&e>0}static symmetricRandomDeviation(e){return(Math.random()-.5)*2*e}}class b{constructor(e=0,t=0){this._point=new DOMPoint(e,t)}get x(){return this._point.x}set x(e){this._point.x=e}get y(){return this._point.y}set y(e){this._point.y=e}clone(){return new b(this.x,this.y)}add(e){const t=this._point.matrixTransform(new DOMMatrix().translate(e.x,e.y));return new b(t.x,t.y)}sub(e){const t=this._point.matrixTransform(new DOMMatrix().translate(-e.x,-e.y));return new b(t.x,t.y)}scaled(e){const t=this._point.matrixTransform(new DOMMatrix().scale(e));return new b(t.x,t.y)}rotatedAroundDeg(e,t){const n=new DOMMatrix().translate(e.x,e.y).rotate(t).translate(-e.x,-e.y),i=this._point.matrixTransform(n);return new b(i.x,i.y)}mutAdd(e){return this.x+=e.x,this.y+=e.y,this}distance2(e){const t=this.x-e.x,n=this.y-e.y;return t*t+n*n}equals(e){return this.x===e.x&&this.y===e.y}toString(){return`Point(${this.x}, ${this.y})`}toJSON(){return{x:this.x,y:this.y}}static min(e,t){return new b(Math.min(e.x,t.x),Math.min(e.y,t.y))}static max(e,t){return new b(Math.max(e.x,t.x),Math.max(e.y,t.y))}}function Ff(r,e){return r.distance2(e)}class ${constructor(e=null,t=0,n=0){this._position=e instanceof b?e.clone():new b,this.width=t,this.height=n}get position(){return this._position}static fromPoints(e,t){return new $(e,t.x-e.x,t.y-e.y)}clone(){return new $(this.position,this.width,this.height)}get topLeft(){return this.position.clone()}get bottomRight(){return new b(this.position.x+this.width,this.position.y+this.height)}get center(){return new b(this.position.x+this.width/2,this.position.y+this.height/2)}get centerOffset(){return new b(this.width/2,this.height/2)}isEmpty(){return this.width<=0||this.height<=0}plus(e){if(this.isEmpty())return e.clone();if(e.isEmpty())return this.clone();const t=new b(Math.min(this.topLeft.x,e.topLeft.x),Math.min(this.topLeft.y,e.topLeft.y)),n=new b(Math.max(this.bottomRight.x,e.bottomRight.x),Math.max(this.bottomRight.y,e.bottomRight.y));return $.fromPoints(t,n)}scaled(e){return new $(this.position.scaled(e),this.width*e,this.height*e)}toString(){return`Rectangle(${this.position.x}, ${this.position.y}, ${this.width}, ${this.height})`}}var st=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function kf(r){throw new Error('Could not dynamically require "'+r+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var Nt,Ca;function jf(){if(Ca)return Nt;Ca=1;function r(){this.__data__=[],this.size=0}return Nt=r,Nt}var Ft,Sa;function Vs(){if(Sa)return Ft;Sa=1;function r(e,t){return e===t||e!==e&&t!==t}return Ft=r,Ft}var kt,Ra;function yt(){if(Ra)return kt;Ra=1;var r=Vs();function e(t,n){for(var i=t.length;i--;)if(r(t[i][0],n))return i;return-1}return kt=e,kt}var jt,qa;function Gf(){if(qa)return jt;qa=1;var r=yt(),e=Array.prototype,t=e.splice;function n(i){var s=this.__data__,a=r(s,i);if(a<0)return!1;var o=s.length-1;return a==o?s.pop():t.call(s,a,1),--this.size,!0}return jt=n,jt}var Gt,xa;function Bf(){if(xa)return Gt;xa=1;var r=yt();function e(t){var n=this.__data__,i=r(n,t);return i<0?void 0:n[i][1]}return Gt=e,Gt}var Bt,Ta;function zf(){if(Ta)return Bt;Ta=1;var r=yt();function e(t){return r(this.__data__,t)>-1}return Bt=e,Bt}var zt,Aa;function Hf(){if(Aa)return zt;Aa=1;var r=yt();function e(t,n){var i=this.__data__,s=r(i,t);return s<0?(++this.size,i.push([t,n])):i[s][1]=n,this}return zt=e,zt}var Ht,La;function _t(){if(La)return Ht;La=1;var r=jf(),e=Gf(),t=Bf(),n=zf(),i=Hf();function s(a){var o=-1,c=a==null?0:a.length;for(this.clear();++o<c;){var d=a[o];this.set(d[0],d[1])}}return s.prototype.clear=r,s.prototype.delete=e,s.prototype.get=t,s.prototype.has=n,s.prototype.set=i,Ht=s,Ht}var Ut,Oa;function Uf(){if(Oa)return Ut;Oa=1;var r=_t();function e(){this.__data__=new r,this.size=0}return Ut=e,Ut}var $t,Ma;function $f(){if(Ma)return $t;Ma=1;function r(e){var t=this.__data__,n=t.delete(e);return this.size=t.size,n}return $t=r,$t}var Wt,Da;function Wf(){if(Da)return Wt;Da=1;function r(e){return this.__data__.get(e)}return Wt=r,Wt}var Vt,Na;function Vf(){if(Na)return Vt;Na=1;function r(e){return this.__data__.has(e)}return Vt=r,Vt}var Kt,Fa;function nd(){if(Fa)return Kt;Fa=1;var r=typeof st=="object"&&st&&st.Object===Object&&st;return Kt=r,Kt}var Yt,ka;function ee(){if(ka)return Yt;ka=1;var r=nd(),e=typeof self=="object"&&self&&self.Object===Object&&self,t=r||e||Function("return this")();return Yt=t,Yt}var Xt,ja;function Le(){if(ja)return Xt;ja=1;var r=ee(),e=r.Symbol;return Xt=e,Xt}var Zt,Ga;function Kf(){if(Ga)return Zt;Ga=1;var r=Le(),e=Object.prototype,t=e.hasOwnProperty,n=e.toString,i=r?r.toStringTag:void 0;function s(a){var o=t.call(a,i),c=a[i];try{a[i]=void 0;var d=!0}catch{}var u=n.call(a);return d&&(o?a[i]=c:delete a[i]),u}return Zt=s,Zt}var Jt,Ba;function Yf(){if(Ba)return Jt;Ba=1;var r=Object.prototype,e=r.toString;function t(n){return e.call(n)}return Jt=t,Jt}var Qt,za;function Oe(){if(za)return Qt;za=1;var r=Le(),e=Kf(),t=Yf(),n="[object Null]",i="[object Undefined]",s=r?r.toStringTag:void 0;function a(o){return o==null?o===void 0?i:n:s&&s in Object(o)?e(o):t(o)}return Qt=a,Qt}var er,Ha;function _e(){if(Ha)return er;Ha=1;function r(e){var t=typeof e;return e!=null&&(t=="object"||t=="function")}return er=r,er}var tr,Ua;function wt(){if(Ua)return tr;Ua=1;var r=Oe(),e=_e(),t="[object AsyncFunction]",n="[object Function]",i="[object GeneratorFunction]",s="[object Proxy]";function a(o){if(!e(o))return!1;var c=r(o);return c==n||c==i||c==t||c==s}return tr=a,tr}var rr,$a;function Xf(){if($a)return rr;$a=1;var r=ee(),e=r["__core-js_shared__"];return rr=e,rr}var nr,Wa;function Zf(){if(Wa)return nr;Wa=1;var r=Xf(),e=(function(){var n=/[^.]+$/.exec(r&&r.keys&&r.keys.IE_PROTO||"");return n?"Symbol(src)_1."+n:""})();function t(n){return!!e&&e in n}return nr=t,nr}var ir,Va;function id(){if(Va)return ir;Va=1;var r=Function.prototype,e=r.toString;function t(n){if(n!=null){try{return e.call(n)}catch{}try{return n+""}catch{}}return""}return ir=t,ir}var sr,Ka;function Jf(){if(Ka)return sr;Ka=1;var r=wt(),e=Zf(),t=_e(),n=id(),i=/[\\^$.*+?()[\]{}|]/g,s=/^\[object .+?Constructor\]$/,a=Function.prototype,o=Object.prototype,c=a.toString,d=o.hasOwnProperty,u=RegExp("^"+c.call(d).replace(i,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");function l(f){if(!t(f)||e(f))return!1;var h=r(f)?u:s;return h.test(n(f))}return sr=l,sr}var ar,Ya;function Qf(){if(Ya)return ar;Ya=1;function r(e,t){return e==null?void 0:e[t]}return ar=r,ar}var or,Xa;function we(){if(Xa)return or;Xa=1;var r=Jf(),e=Qf();function t(n,i){var s=e(n,i);return r(s)?s:void 0}return or=t,or}var cr,Za;function Ks(){if(Za)return cr;Za=1;var r=we(),e=ee(),t=r(e,"Map");return cr=t,cr}var ur,Ja;function bt(){if(Ja)return ur;Ja=1;var r=we(),e=r(Object,"create");return ur=e,ur}var lr,Qa;function eh(){if(Qa)return lr;Qa=1;var r=bt();function e(){this.__data__=r?r(null):{},this.size=0}return lr=e,lr}var dr,eo;function th(){if(eo)return dr;eo=1;function r(e){var t=this.has(e)&&delete this.__data__[e];return this.size-=t?1:0,t}return dr=r,dr}var fr,to;function rh(){if(to)return fr;to=1;var r=bt(),e="__lodash_hash_undefined__",t=Object.prototype,n=t.hasOwnProperty;function i(s){var a=this.__data__;if(r){var o=a[s];return o===e?void 0:o}return n.call(a,s)?a[s]:void 0}return fr=i,fr}var hr,ro;function nh(){if(ro)return hr;ro=1;var r=bt(),e=Object.prototype,t=e.hasOwnProperty;function n(i){var s=this.__data__;return r?s[i]!==void 0:t.call(s,i)}return hr=n,hr}var pr,no;function ih(){if(no)return pr;no=1;var r=bt(),e="__lodash_hash_undefined__";function t(n,i){var s=this.__data__;return this.size+=this.has(n)?0:1,s[n]=r&&i===void 0?e:i,this}return pr=t,pr}var gr,io;function sh(){if(io)return gr;io=1;var r=eh(),e=th(),t=rh(),n=nh(),i=ih();function s(a){var o=-1,c=a==null?0:a.length;for(this.clear();++o<c;){var d=a[o];this.set(d[0],d[1])}}return s.prototype.clear=r,s.prototype.delete=e,s.prototype.get=t,s.prototype.has=n,s.prototype.set=i,gr=s,gr}var mr,so;function ah(){if(so)return mr;so=1;var r=sh(),e=_t(),t=Ks();function n(){this.size=0,this.__data__={hash:new r,map:new(t||e),string:new r}}return mr=n,mr}var vr,ao;function oh(){if(ao)return vr;ao=1;function r(e){var t=typeof e;return t=="string"||t=="number"||t=="symbol"||t=="boolean"?e!=="__proto__":e===null}return vr=r,vr}var yr,oo;function It(){if(oo)return yr;oo=1;var r=oh();function e(t,n){var i=t.__data__;return r(n)?i[typeof n=="string"?"string":"hash"]:i.map}return yr=e,yr}var _r,co;function ch(){if(co)return _r;co=1;var r=It();function e(t){var n=r(this,t).delete(t);return this.size-=n?1:0,n}return _r=e,_r}var wr,uo;function uh(){if(uo)return wr;uo=1;var r=It();function e(t){return r(this,t).get(t)}return wr=e,wr}var br,lo;function lh(){if(lo)return br;lo=1;var r=It();function e(t){return r(this,t).has(t)}return br=e,br}var Ir,fo;function dh(){if(fo)return Ir;fo=1;var r=It();function e(t,n){var i=r(this,t),s=i.size;return i.set(t,n),this.size+=i.size==s?0:1,this}return Ir=e,Ir}var Pr,ho;function Ys(){if(ho)return Pr;ho=1;var r=ah(),e=ch(),t=uh(),n=lh(),i=dh();function s(a){var o=-1,c=a==null?0:a.length;for(this.clear();++o<c;){var d=a[o];this.set(d[0],d[1])}}return s.prototype.clear=r,s.prototype.delete=e,s.prototype.get=t,s.prototype.has=n,s.prototype.set=i,Pr=s,Pr}var Er,po;function fh(){if(po)return Er;po=1;var r=_t(),e=Ks(),t=Ys(),n=200;function i(s,a){var o=this.__data__;if(o instanceof r){var c=o.__data__;if(!e||c.length<n-1)return c.push([s,a]),this.size=++o.size,this;o=this.__data__=new t(c)}return o.set(s,a),this.size=o.size,this}return Er=i,Er}var Cr,go;function Xs(){if(go)return Cr;go=1;var r=_t(),e=Uf(),t=$f(),n=Wf(),i=Vf(),s=fh();function a(o){var c=this.__data__=new r(o);this.size=c.size}return a.prototype.clear=e,a.prototype.delete=t,a.prototype.get=n,a.prototype.has=i,a.prototype.set=s,Cr=a,Cr}var Sr,mo;function Zs(){if(mo)return Sr;mo=1;function r(e,t){for(var n=-1,i=e==null?0:e.length;++n<i&&t(e[n],n,e)!==!1;);return e}return Sr=r,Sr}var Rr,vo;function sd(){if(vo)return Rr;vo=1;var r=we(),e=(function(){try{var t=r(Object,"defineProperty");return t({},"",{}),t}catch{}})();return Rr=e,Rr}var qr,yo;function ad(){if(yo)return qr;yo=1;var r=sd();function e(t,n,i){n=="__proto__"&&r?r(t,n,{configurable:!0,enumerable:!0,value:i,writable:!0}):t[n]=i}return qr=e,qr}var xr,_o;function od(){if(_o)return xr;_o=1;var r=ad(),e=Vs(),t=Object.prototype,n=t.hasOwnProperty;function i(s,a,o){var c=s[a];(!(n.call(s,a)&&e(c,o))||o===void 0&&!(a in s))&&r(s,a,o)}return xr=i,xr}var Tr,wo;function Pt(){if(wo)return Tr;wo=1;var r=od(),e=ad();function t(n,i,s,a){var o=!s;s||(s={});for(var c=-1,d=i.length;++c<d;){var u=i[c],l=a?a(s[u],n[u],u,s,n):void 0;l===void 0&&(l=n[u]),o?e(s,u,l):r(s,u,l)}return s}return Tr=t,Tr}var Ar,bo;function hh(){if(bo)return Ar;bo=1;function r(e,t){for(var n=-1,i=Array(e);++n<e;)i[n]=t(n);return i}return Ar=r,Ar}var Lr,Io;function se(){if(Io)return Lr;Io=1;function r(e){return e!=null&&typeof e=="object"}return Lr=r,Lr}var Or,Po;function ph(){if(Po)return Or;Po=1;var r=Oe(),e=se(),t="[object Arguments]";function n(i){return e(i)&&r(i)==t}return Or=n,Or}var Mr,Eo;function Et(){if(Eo)return Mr;Eo=1;var r=ph(),e=se(),t=Object.prototype,n=t.hasOwnProperty,i=t.propertyIsEnumerable,s=r((function(){return arguments})())?r:function(a){return e(a)&&n.call(a,"callee")&&!i.call(a,"callee")};return Mr=s,Mr}var Dr,Co;function H(){if(Co)return Dr;Co=1;var r=Array.isArray;return Dr=r,Dr}var je={exports:{}},Nr,So;function gh(){if(So)return Nr;So=1;function r(){return!1}return Nr=r,Nr}je.exports;var Ro;function Ye(){return Ro||(Ro=1,(function(r,e){var t=ee(),n=gh(),i=e&&!e.nodeType&&e,s=i&&!0&&r&&!r.nodeType&&r,a=s&&s.exports===i,o=a?t.Buffer:void 0,c=o?o.isBuffer:void 0,d=c||n;r.exports=d})(je,je.exports)),je.exports}var Fr,qo;function cd(){if(qo)return Fr;qo=1;var r=9007199254740991,e=/^(?:0|[1-9]\d*)$/;function t(n,i){var s=typeof n;return i=i??r,!!i&&(s=="number"||s!="symbol"&&e.test(n))&&n>-1&&n%1==0&&n<i}return Fr=t,Fr}var kr,xo;function Js(){if(xo)return kr;xo=1;var r=9007199254740991;function e(t){return typeof t=="number"&&t>-1&&t%1==0&&t<=r}return kr=e,kr}var jr,To;function mh(){if(To)return jr;To=1;var r=Oe(),e=Js(),t=se(),n="[object Arguments]",i="[object Array]",s="[object Boolean]",a="[object Date]",o="[object Error]",c="[object Function]",d="[object Map]",u="[object Number]",l="[object Object]",f="[object RegExp]",h="[object Set]",g="[object String]",p="[object WeakMap]",y="[object ArrayBuffer]",m="[object DataView]",_="[object Float32Array]",v="[object Float64Array]",I="[object Int8Array]",S="[object Int16Array]",E="[object Int32Array]",P="[object Uint8Array]",R="[object Uint8ClampedArray]",q="[object Uint16Array]",M="[object Uint32Array]",C={};C[_]=C[v]=C[I]=C[S]=C[E]=C[P]=C[R]=C[q]=C[M]=!0,C[n]=C[i]=C[y]=C[s]=C[m]=C[a]=C[o]=C[c]=C[d]=C[u]=C[l]=C[f]=C[h]=C[g]=C[p]=!1;function N(G){return t(G)&&e(G.length)&&!!C[r(G)]}return jr=N,jr}var Gr,Ao;function Qs(){if(Ao)return Gr;Ao=1;function r(e){return function(t){return e(t)}}return Gr=r,Gr}var Ge={exports:{}};Ge.exports;var Lo;function ea(){return Lo||(Lo=1,(function(r,e){var t=nd(),n=e&&!e.nodeType&&e,i=n&&!0&&r&&!r.nodeType&&r,s=i&&i.exports===n,a=s&&t.process,o=(function(){try{var c=i&&i.require&&i.require("util").types;return c||a&&a.binding&&a.binding("util")}catch{}})();r.exports=o})(Ge,Ge.exports)),Ge.exports}var Br,Oo;function Ct(){if(Oo)return Br;Oo=1;var r=mh(),e=Qs(),t=ea(),n=t&&t.isTypedArray,i=n?e(n):r;return Br=i,Br}var zr,Mo;function ud(){if(Mo)return zr;Mo=1;var r=hh(),e=Et(),t=H(),n=Ye(),i=cd(),s=Ct(),a=Object.prototype,o=a.hasOwnProperty;function c(d,u){var l=t(d),f=!l&&e(d),h=!l&&!f&&n(d),g=!l&&!f&&!h&&s(d),p=l||f||h||g,y=p?r(d.length,String):[],m=y.length;for(var _ in d)(u||o.call(d,_))&&!(p&&(_=="length"||h&&(_=="offset"||_=="parent")||g&&(_=="buffer"||_=="byteLength"||_=="byteOffset")||i(_,m)))&&y.push(_);return y}return zr=c,zr}var Hr,Do;function St(){if(Do)return Hr;Do=1;var r=Object.prototype;function e(t){var n=t&&t.constructor,i=typeof n=="function"&&n.prototype||r;return t===i}return Hr=e,Hr}var Ur,No;function ld(){if(No)return Ur;No=1;function r(e,t){return function(n){return e(t(n))}}return Ur=r,Ur}var $r,Fo;function vh(){if(Fo)return $r;Fo=1;var r=ld(),e=r(Object.keys,Object);return $r=e,$r}var Wr,ko;function ta(){if(ko)return Wr;ko=1;var r=St(),e=vh(),t=Object.prototype,n=t.hasOwnProperty;function i(s){if(!r(s))return e(s);var a=[];for(var o in Object(s))n.call(s,o)&&o!="constructor"&&a.push(o);return a}return Wr=i,Wr}var Vr,jo;function be(){if(jo)return Vr;jo=1;var r=wt(),e=Js();function t(n){return n!=null&&e(n.length)&&!r(n)}return Vr=t,Vr}var Kr,Go;function Ie(){if(Go)return Kr;Go=1;var r=ud(),e=ta(),t=be();function n(i){return t(i)?r(i):e(i)}return Kr=n,Kr}var Yr,Bo;function yh(){if(Bo)return Yr;Bo=1;var r=Pt(),e=Ie();function t(n,i){return n&&r(i,e(i),n)}return Yr=t,Yr}var Xr,zo;function _h(){if(zo)return Xr;zo=1;function r(e){var t=[];if(e!=null)for(var n in Object(e))t.push(n);return t}return Xr=r,Xr}var Zr,Ho;function wh(){if(Ho)return Zr;Ho=1;var r=_e(),e=St(),t=_h(),n=Object.prototype,i=n.hasOwnProperty;function s(a){if(!r(a))return t(a);var o=e(a),c=[];for(var d in a)d=="constructor"&&(o||!i.call(a,d))||c.push(d);return c}return Zr=s,Zr}var Jr,Uo;function ra(){if(Uo)return Jr;Uo=1;var r=ud(),e=wh(),t=be();function n(i){return t(i)?r(i,!0):e(i)}return Jr=n,Jr}var Qr,$o;function bh(){if($o)return Qr;$o=1;var r=Pt(),e=ra();function t(n,i){return n&&r(i,e(i),n)}return Qr=t,Qr}var Be={exports:{}};Be.exports;var Wo;function Ih(){return Wo||(Wo=1,(function(r,e){var t=ee(),n=e&&!e.nodeType&&e,i=n&&!0&&r&&!r.nodeType&&r,s=i&&i.exports===n,a=s?t.Buffer:void 0,o=a?a.allocUnsafe:void 0;function c(d,u){if(u)return d.slice();var l=d.length,f=o?o(l):new d.constructor(l);return d.copy(f),f}r.exports=c})(Be,Be.exports)),Be.exports}var en,Vo;function Ph(){if(Vo)return en;Vo=1;function r(e,t){var n=-1,i=e.length;for(t||(t=Array(i));++n<i;)t[n]=e[n];return t}return en=r,en}var tn,Ko;function dd(){if(Ko)return tn;Ko=1;function r(e,t){for(var n=-1,i=e==null?0:e.length,s=0,a=[];++n<i;){var o=e[n];t(o,n,e)&&(a[s++]=o)}return a}return tn=r,tn}var rn,Yo;function fd(){if(Yo)return rn;Yo=1;function r(){return[]}return rn=r,rn}var nn,Xo;function na(){if(Xo)return nn;Xo=1;var r=dd(),e=fd(),t=Object.prototype,n=t.propertyIsEnumerable,i=Object.getOwnPropertySymbols,s=i?function(a){return a==null?[]:(a=Object(a),r(i(a),function(o){return n.call(a,o)}))}:e;return nn=s,nn}var sn,Zo;function Eh(){if(Zo)return sn;Zo=1;var r=Pt(),e=na();function t(n,i){return r(n,e(n),i)}return sn=t,sn}var an,Jo;function ia(){if(Jo)return an;Jo=1;function r(e,t){for(var n=-1,i=t.length,s=e.length;++n<i;)e[s+n]=t[n];return e}return an=r,an}var on,Qo;function sa(){if(Qo)return on;Qo=1;var r=ld(),e=r(Object.getPrototypeOf,Object);return on=e,on}var cn,ec;function hd(){if(ec)return cn;ec=1;var r=ia(),e=sa(),t=na(),n=fd(),i=Object.getOwnPropertySymbols,s=i?function(a){for(var o=[];a;)r(o,t(a)),a=e(a);return o}:n;return cn=s,cn}var un,tc;function Ch(){if(tc)return un;tc=1;var r=Pt(),e=hd();function t(n,i){return r(n,e(n),i)}return un=t,un}var ln,rc;function pd(){if(rc)return ln;rc=1;var r=ia(),e=H();function t(n,i,s){var a=i(n);return e(n)?a:r(a,s(n))}return ln=t,ln}var dn,nc;function gd(){if(nc)return dn;nc=1;var r=pd(),e=na(),t=Ie();function n(i){return r(i,t,e)}return dn=n,dn}var fn,ic;function Sh(){if(ic)return fn;ic=1;var r=pd(),e=hd(),t=ra();function n(i){return r(i,t,e)}return fn=n,fn}var hn,sc;function Rh(){if(sc)return hn;sc=1;var r=we(),e=ee(),t=r(e,"DataView");return hn=t,hn}var pn,ac;function qh(){if(ac)return pn;ac=1;var r=we(),e=ee(),t=r(e,"Promise");return pn=t,pn}var gn,oc;function md(){if(oc)return gn;oc=1;var r=we(),e=ee(),t=r(e,"Set");return gn=t,gn}var mn,cc;function xh(){if(cc)return mn;cc=1;var r=we(),e=ee(),t=r(e,"WeakMap");return mn=t,mn}var vn,uc;function Me(){if(uc)return vn;uc=1;var r=Rh(),e=Ks(),t=qh(),n=md(),i=xh(),s=Oe(),a=id(),o="[object Map]",c="[object Object]",d="[object Promise]",u="[object Set]",l="[object WeakMap]",f="[object DataView]",h=a(r),g=a(e),p=a(t),y=a(n),m=a(i),_=s;return(r&&_(new r(new ArrayBuffer(1)))!=f||e&&_(new e)!=o||t&&_(t.resolve())!=d||n&&_(new n)!=u||i&&_(new i)!=l)&&(_=function(v){var I=s(v),S=I==c?v.constructor:void 0,E=S?a(S):"";if(E)switch(E){case h:return f;case g:return o;case p:return d;case y:return u;case m:return l}return I}),vn=_,vn}var yn,lc;function Th(){if(lc)return yn;lc=1;var r=Object.prototype,e=r.hasOwnProperty;function t(n){var i=n.length,s=new n.constructor(i);return i&&typeof n[0]=="string"&&e.call(n,"index")&&(s.index=n.index,s.input=n.input),s}return yn=t,yn}var _n,dc;function vd(){if(dc)return _n;dc=1;var r=ee(),e=r.Uint8Array;return _n=e,_n}var wn,fc;function aa(){if(fc)return wn;fc=1;var r=vd();function e(t){var n=new t.constructor(t.byteLength);return new r(n).set(new r(t)),n}return wn=e,wn}var bn,hc;function Ah(){if(hc)return bn;hc=1;var r=aa();function e(t,n){var i=n?r(t.buffer):t.buffer;return new t.constructor(i,t.byteOffset,t.byteLength)}return bn=e,bn}var In,pc;function Lh(){if(pc)return In;pc=1;var r=/\w*$/;function e(t){var n=new t.constructor(t.source,r.exec(t));return n.lastIndex=t.lastIndex,n}return In=e,In}var Pn,gc;function Oh(){if(gc)return Pn;gc=1;var r=Le(),e=r?r.prototype:void 0,t=e?e.valueOf:void 0;function n(i){return t?Object(t.call(i)):{}}return Pn=n,Pn}var En,mc;function Mh(){if(mc)return En;mc=1;var r=aa();function e(t,n){var i=n?r(t.buffer):t.buffer;return new t.constructor(i,t.byteOffset,t.length)}return En=e,En}var Cn,vc;function Dh(){if(vc)return Cn;vc=1;var r=aa(),e=Ah(),t=Lh(),n=Oh(),i=Mh(),s="[object Boolean]",a="[object Date]",o="[object Map]",c="[object Number]",d="[object RegExp]",u="[object Set]",l="[object String]",f="[object Symbol]",h="[object ArrayBuffer]",g="[object DataView]",p="[object Float32Array]",y="[object Float64Array]",m="[object Int8Array]",_="[object Int16Array]",v="[object Int32Array]",I="[object Uint8Array]",S="[object Uint8ClampedArray]",E="[object Uint16Array]",P="[object Uint32Array]";function R(q,M,C){var N=q.constructor;switch(M){case h:return r(q);case s:case a:return new N(+q);case g:return e(q,C);case p:case y:case m:case _:case v:case I:case S:case E:case P:return i(q,C);case o:return new N;case c:case l:return new N(q);case d:return t(q);case u:return new N;case f:return n(q)}}return Cn=R,Cn}var Sn,yc;function yd(){if(yc)return Sn;yc=1;var r=_e(),e=Object.create,t=(function(){function n(){}return function(i){if(!r(i))return{};if(e)return e(i);n.prototype=i;var s=new n;return n.prototype=void 0,s}})();return Sn=t,Sn}var Rn,_c;function Nh(){if(_c)return Rn;_c=1;var r=yd(),e=sa(),t=St();function n(i){return typeof i.constructor=="function"&&!t(i)?r(e(i)):{}}return Rn=n,Rn}var qn,wc;function Fh(){if(wc)return qn;wc=1;var r=Me(),e=se(),t="[object Map]";function n(i){return e(i)&&r(i)==t}return qn=n,qn}var xn,bc;function kh(){if(bc)return xn;bc=1;var r=Fh(),e=Qs(),t=ea(),n=t&&t.isMap,i=n?e(n):r;return xn=i,xn}var Tn,Ic;function jh(){if(Ic)return Tn;Ic=1;var r=Me(),e=se(),t="[object Set]";function n(i){return e(i)&&r(i)==t}return Tn=n,Tn}var An,Pc;function Gh(){if(Pc)return An;Pc=1;var r=jh(),e=Qs(),t=ea(),n=t&&t.isSet,i=n?e(n):r;return An=i,An}var Ln,Ec;function Bh(){if(Ec)return Ln;Ec=1;var r=Xs(),e=Zs(),t=od(),n=yh(),i=bh(),s=Ih(),a=Ph(),o=Eh(),c=Ch(),d=gd(),u=Sh(),l=Me(),f=Th(),h=Dh(),g=Nh(),p=H(),y=Ye(),m=kh(),_=_e(),v=Gh(),I=Ie(),S=ra(),E=1,P=2,R=4,q="[object Arguments]",M="[object Array]",C="[object Boolean]",N="[object Date]",G="[object Error]",ae="[object Function]",Pe="[object GeneratorFunction]",Dt="[object Map]",hf="[object Number]",wa="[object Object]",pf="[object RegExp]",gf="[object Set]",mf="[object String]",vf="[object Symbol]",yf="[object WeakMap]",_f="[object ArrayBuffer]",wf="[object DataView]",bf="[object Float32Array]",If="[object Float64Array]",Pf="[object Int8Array]",Ef="[object Int16Array]",Cf="[object Int32Array]",Sf="[object Uint8Array]",Rf="[object Uint8ClampedArray]",qf="[object Uint16Array]",xf="[object Uint32Array]",D={};D[q]=D[M]=D[_f]=D[wf]=D[C]=D[N]=D[bf]=D[If]=D[Pf]=D[Ef]=D[Cf]=D[Dt]=D[hf]=D[wa]=D[pf]=D[gf]=D[mf]=D[vf]=D[Sf]=D[Rf]=D[qf]=D[xf]=!0,D[G]=D[ae]=D[yf]=!1;function tt(O,Ee,Ce,Tf,rt,oe){var W,nt=Ee&E,it=Ee&P,Af=Ee&R;if(Ce&&(W=rt?Ce(O,Tf,rt,oe):Ce(O)),W!==void 0)return W;if(!_(O))return O;var ba=p(O);if(ba){if(W=f(O),!nt)return a(O,W)}else{var Se=l(O),Ia=Se==ae||Se==Pe;if(y(O))return s(O,nt);if(Se==wa||Se==q||Ia&&!rt){if(W=it||Ia?{}:g(O),!nt)return it?c(O,i(W,O)):o(O,n(W,O))}else{if(!D[Se])return rt?O:{};W=h(O,Se,nt)}}oe||(oe=new r);var Pa=oe.get(O);if(Pa)return Pa;oe.set(O,W),v(O)?O.forEach(function(ce){W.add(tt(ce,Ee,Ce,ce,O,oe))}):m(O)&&O.forEach(function(ce,he){W.set(he,tt(ce,Ee,Ce,he,O,oe))});var Lf=Af?it?u:d:it?S:I,Ea=ba?void 0:Lf(O);return e(Ea||O,function(ce,he){Ea&&(he=ce,ce=O[he]),t(W,he,tt(ce,Ee,Ce,he,O,oe))}),W}return Ln=tt,Ln}var On,Cc;function zh(){if(Cc)return On;Cc=1;var r=Bh(),e=4;function t(n){return r(n,e)}return On=t,On}var Mn,Sc;function _d(){if(Sc)return Mn;Sc=1;function r(e){return function(){return e}}return Mn=r,Mn}var Dn,Rc;function Hh(){if(Rc)return Dn;Rc=1;function r(e){return function(t,n,i){for(var s=-1,a=Object(t),o=i(t),c=o.length;c--;){var d=o[e?c:++s];if(n(a[d],d,a)===!1)break}return t}}return Dn=r,Dn}var Nn,qc;function Uh(){if(qc)return Nn;qc=1;var r=Hh(),e=r();return Nn=e,Nn}var Fn,xc;function wd(){if(xc)return Fn;xc=1;var r=Uh(),e=Ie();function t(n,i){return n&&r(n,i,e)}return Fn=t,Fn}var kn,Tc;function $h(){if(Tc)return kn;Tc=1;var r=be();function e(t,n){return function(i,s){if(i==null)return i;if(!r(i))return t(i,s);for(var a=i.length,o=n?a:-1,c=Object(i);(n?o--:++o<a)&&s(c[o],o,c)!==!1;);return i}}return kn=e,kn}var jn,Ac;function Rt(){if(Ac)return jn;Ac=1;var r=wd(),e=$h(),t=e(r);return jn=t,jn}var Gn,Lc;function qt(){if(Lc)return Gn;Lc=1;function r(e){return e}return Gn=r,Gn}var Bn,Oc;function Wh(){if(Oc)return Bn;Oc=1;var r=qt();function e(t){return typeof t=="function"?t:r}return Bn=e,Bn}var zn,Mc;function Vh(){if(Mc)return zn;Mc=1;var r=Zs(),e=Rt(),t=Wh(),n=H();function i(s,a){var o=n(s)?r:e;return o(s,t(a))}return zn=i,zn}var Hn,Dc;function Kh(){return Dc||(Dc=1,Hn=Vh()),Hn}var Un,Nc;function Yh(){if(Nc)return Un;Nc=1;var r=Rt();function e(t,n){var i=[];return r(t,function(s,a,o){n(s,a,o)&&i.push(s)}),i}return Un=e,Un}var $n,Fc;function Xh(){if(Fc)return $n;Fc=1;var r="__lodash_hash_undefined__";function e(t){return this.__data__.set(t,r),this}return $n=e,$n}var Wn,kc;function Zh(){if(kc)return Wn;kc=1;function r(e){return this.__data__.has(e)}return Wn=r,Wn}var Vn,jc;function bd(){if(jc)return Vn;jc=1;var r=Ys(),e=Xh(),t=Zh();function n(i){var s=-1,a=i==null?0:i.length;for(this.__data__=new r;++s<a;)this.add(i[s])}return n.prototype.add=n.prototype.push=e,n.prototype.has=t,Vn=n,Vn}var Kn,Gc;function Jh(){if(Gc)return Kn;Gc=1;function r(e,t){for(var n=-1,i=e==null?0:e.length;++n<i;)if(t(e[n],n,e))return!0;return!1}return Kn=r,Kn}var Yn,Bc;function Id(){if(Bc)return Yn;Bc=1;function r(e,t){return e.has(t)}return Yn=r,Yn}var Xn,zc;function Pd(){if(zc)return Xn;zc=1;var r=bd(),e=Jh(),t=Id(),n=1,i=2;function s(a,o,c,d,u,l){var f=c&n,h=a.length,g=o.length;if(h!=g&&!(f&&g>h))return!1;var p=l.get(a),y=l.get(o);if(p&&y)return p==o&&y==a;var m=-1,_=!0,v=c&i?new r:void 0;for(l.set(a,o),l.set(o,a);++m<h;){var I=a[m],S=o[m];if(d)var E=f?d(S,I,m,o,a,l):d(I,S,m,a,o,l);if(E!==void 0){if(E)continue;_=!1;break}if(v){if(!e(o,function(P,R){if(!t(v,R)&&(I===P||u(I,P,c,d,l)))return v.push(R)})){_=!1;break}}else if(!(I===S||u(I,S,c,d,l))){_=!1;break}}return l.delete(a),l.delete(o),_}return Xn=s,Xn}var Zn,Hc;function Qh(){if(Hc)return Zn;Hc=1;function r(e){var t=-1,n=Array(e.size);return e.forEach(function(i,s){n[++t]=[s,i]}),n}return Zn=r,Zn}var Jn,Uc;function oa(){if(Uc)return Jn;Uc=1;function r(e){var t=-1,n=Array(e.size);return e.forEach(function(i){n[++t]=i}),n}return Jn=r,Jn}var Qn,$c;function ep(){if($c)return Qn;$c=1;var r=Le(),e=vd(),t=Vs(),n=Pd(),i=Qh(),s=oa(),a=1,o=2,c="[object Boolean]",d="[object Date]",u="[object Error]",l="[object Map]",f="[object Number]",h="[object RegExp]",g="[object Set]",p="[object String]",y="[object Symbol]",m="[object ArrayBuffer]",_="[object DataView]",v=r?r.prototype:void 0,I=v?v.valueOf:void 0;function S(E,P,R,q,M,C,N){switch(R){case _:if(E.byteLength!=P.byteLength||E.byteOffset!=P.byteOffset)return!1;E=E.buffer,P=P.buffer;case m:return!(E.byteLength!=P.byteLength||!C(new e(E),new e(P)));case c:case d:case f:return t(+E,+P);case u:return E.name==P.name&&E.message==P.message;case h:case p:return E==P+"";case l:var G=i;case g:var ae=q&a;if(G||(G=s),E.size!=P.size&&!ae)return!1;var Pe=N.get(E);if(Pe)return Pe==P;q|=o,N.set(E,P);var Dt=n(G(E),G(P),q,M,C,N);return N.delete(E),Dt;case y:if(I)return I.call(E)==I.call(P)}return!1}return Qn=S,Qn}var ei,Wc;function tp(){if(Wc)return ei;Wc=1;var r=gd(),e=1,t=Object.prototype,n=t.hasOwnProperty;function i(s,a,o,c,d,u){var l=o&e,f=r(s),h=f.length,g=r(a),p=g.length;if(h!=p&&!l)return!1;for(var y=h;y--;){var m=f[y];if(!(l?m in a:n.call(a,m)))return!1}var _=u.get(s),v=u.get(a);if(_&&v)return _==a&&v==s;var I=!0;u.set(s,a),u.set(a,s);for(var S=l;++y<h;){m=f[y];var E=s[m],P=a[m];if(c)var R=l?c(P,E,m,a,s,u):c(E,P,m,s,a,u);if(!(R===void 0?E===P||d(E,P,o,c,u):R)){I=!1;break}S||(S=m=="constructor")}if(I&&!S){var q=s.constructor,M=a.constructor;q!=M&&"constructor"in s&&"constructor"in a&&!(typeof q=="function"&&q instanceof q&&typeof M=="function"&&M instanceof M)&&(I=!1)}return u.delete(s),u.delete(a),I}return ei=i,ei}var ti,Vc;function rp(){if(Vc)return ti;Vc=1;var r=Xs(),e=Pd(),t=ep(),n=tp(),i=Me(),s=H(),a=Ye(),o=Ct(),c=1,d="[object Arguments]",u="[object Array]",l="[object Object]",f=Object.prototype,h=f.hasOwnProperty;function g(p,y,m,_,v,I){var S=s(p),E=s(y),P=S?u:i(p),R=E?u:i(y);P=P==d?l:P,R=R==d?l:R;var q=P==l,M=R==l,C=P==R;if(C&&a(p)){if(!a(y))return!1;S=!0,q=!1}if(C&&!q)return I||(I=new r),S||o(p)?e(p,y,m,_,v,I):t(p,y,P,m,_,v,I);if(!(m&c)){var N=q&&h.call(p,"__wrapped__"),G=M&&h.call(y,"__wrapped__");if(N||G){var ae=N?p.value():p,Pe=G?y.value():y;return I||(I=new r),v(ae,Pe,m,_,I)}}return C?(I||(I=new r),n(p,y,m,_,v,I)):!1}return ti=g,ti}var ri,Kc;function Ed(){if(Kc)return ri;Kc=1;var r=rp(),e=se();function t(n,i,s,a,o){return n===i?!0:n==null||i==null||!e(n)&&!e(i)?n!==n&&i!==i:r(n,i,s,a,t,o)}return ri=t,ri}var ni,Yc;function np(){if(Yc)return ni;Yc=1;var r=Xs(),e=Ed(),t=1,n=2;function i(s,a,o,c){var d=o.length,u=d,l=!c;if(s==null)return!u;for(s=Object(s);d--;){var f=o[d];if(l&&f[2]?f[1]!==s[f[0]]:!(f[0]in s))return!1}for(;++d<u;){f=o[d];var h=f[0],g=s[h],p=f[1];if(l&&f[2]){if(g===void 0&&!(h in s))return!1}else{var y=new r;if(c)var m=c(g,p,h,s,a,y);if(!(m===void 0?e(p,g,t|n,c,y):m))return!1}}return!0}return ni=i,ni}var ii,Xc;function Cd(){if(Xc)return ii;Xc=1;var r=_e();function e(t){return t===t&&!r(t)}return ii=e,ii}var si,Zc;function ip(){if(Zc)return si;Zc=1;var r=Cd(),e=Ie();function t(n){for(var i=e(n),s=i.length;s--;){var a=i[s],o=n[a];i[s]=[a,o,r(o)]}return i}return si=t,si}var ai,Jc;function Sd(){if(Jc)return ai;Jc=1;function r(e,t){return function(n){return n==null?!1:n[e]===t&&(t!==void 0||e in Object(n))}}return ai=r,ai}var oi,Qc;function sp(){if(Qc)return oi;Qc=1;var r=np(),e=ip(),t=Sd();function n(i){var s=e(i);return s.length==1&&s[0][2]?t(s[0][0],s[0][1]):function(a){return a===i||r(a,i,s)}}return oi=n,oi}var ci,eu;function ca(){if(eu)return ci;eu=1;var r=Oe(),e=se(),t="[object Symbol]";function n(i){return typeof i=="symbol"||e(i)&&r(i)==t}return ci=n,ci}var ui,tu;function ua(){if(tu)return ui;tu=1;var r=H(),e=ca(),t=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,n=/^\w*$/;function i(s,a){if(r(s))return!1;var o=typeof s;return o=="number"||o=="symbol"||o=="boolean"||s==null||e(s)?!0:n.test(s)||!t.test(s)||a!=null&&s in Object(a)}return ui=i,ui}var li,ru;function ap(){if(ru)return li;ru=1;var r=Ys(),e="Expected a function";function t(n,i){if(typeof n!="function"||i!=null&&typeof i!="function")throw new TypeError(e);var s=function(){var a=arguments,o=i?i.apply(this,a):a[0],c=s.cache;if(c.has(o))return c.get(o);var d=n.apply(this,a);return s.cache=c.set(o,d)||c,d};return s.cache=new(t.Cache||r),s}return t.Cache=r,li=t,li}var di,nu;function op(){if(nu)return di;nu=1;var r=ap(),e=500;function t(n){var i=r(n,function(a){return s.size===e&&s.clear(),a}),s=i.cache;return i}return di=t,di}var fi,iu;function cp(){if(iu)return fi;iu=1;var r=op(),e=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,t=/\\(\\)?/g,n=r(function(i){var s=[];return i.charCodeAt(0)===46&&s.push(""),i.replace(e,function(a,o,c,d){s.push(c?d.replace(t,"$1"):o||a)}),s});return fi=n,fi}var hi,su;function la(){if(su)return hi;su=1;function r(e,t){for(var n=-1,i=e==null?0:e.length,s=Array(i);++n<i;)s[n]=t(e[n],n,e);return s}return hi=r,hi}var pi,au;function up(){if(au)return pi;au=1;var r=Le(),e=la(),t=H(),n=ca(),i=r?r.prototype:void 0,s=i?i.toString:void 0;function a(o){if(typeof o=="string")return o;if(t(o))return e(o,a)+"";if(n(o))return s?s.call(o):"";var c=o+"";return c=="0"&&1/o==-1/0?"-0":c}return pi=a,pi}var gi,ou;function lp(){if(ou)return gi;ou=1;var r=up();function e(t){return t==null?"":r(t)}return gi=e,gi}var mi,cu;function Rd(){if(cu)return mi;cu=1;var r=H(),e=ua(),t=cp(),n=lp();function i(s,a){return r(s)?s:e(s,a)?[s]:t(n(s))}return mi=i,mi}var vi,uu;function xt(){if(uu)return vi;uu=1;var r=ca();function e(t){if(typeof t=="string"||r(t))return t;var n=t+"";return n=="0"&&1/t==-1/0?"-0":n}return vi=e,vi}var yi,lu;function qd(){if(lu)return yi;lu=1;var r=Rd(),e=xt();function t(n,i){i=r(i,n);for(var s=0,a=i.length;n!=null&&s<a;)n=n[e(i[s++])];return s&&s==a?n:void 0}return yi=t,yi}var _i,du;function dp(){if(du)return _i;du=1;var r=qd();function e(t,n,i){var s=t==null?void 0:r(t,n);return s===void 0?i:s}return _i=e,_i}var wi,fu;function fp(){if(fu)return wi;fu=1;function r(e,t){return e!=null&&t in Object(e)}return wi=r,wi}var bi,hu;function xd(){if(hu)return bi;hu=1;var r=Rd(),e=Et(),t=H(),n=cd(),i=Js(),s=xt();function a(o,c,d){c=r(c,o);for(var u=-1,l=c.length,f=!1;++u<l;){var h=s(c[u]);if(!(f=o!=null&&d(o,h)))break;o=o[h]}return f||++u!=l?f:(l=o==null?0:o.length,!!l&&i(l)&&n(h,l)&&(t(o)||e(o)))}return bi=a,bi}var Ii,pu;function hp(){if(pu)return Ii;pu=1;var r=fp(),e=xd();function t(n,i){return n!=null&&e(n,i,r)}return Ii=t,Ii}var Pi,gu;function pp(){if(gu)return Pi;gu=1;var r=Ed(),e=dp(),t=hp(),n=ua(),i=Cd(),s=Sd(),a=xt(),o=1,c=2;function d(u,l){return n(u)&&i(l)?s(a(u),l):function(f){var h=e(f,u);return h===void 0&&h===l?t(f,u):r(l,h,o|c)}}return Pi=d,Pi}var Ei,mu;function Td(){if(mu)return Ei;mu=1;function r(e){return function(t){return t==null?void 0:t[e]}}return Ei=r,Ei}var Ci,vu;function gp(){if(vu)return Ci;vu=1;var r=qd();function e(t){return function(n){return r(n,t)}}return Ci=e,Ci}var Si,yu;function mp(){if(yu)return Si;yu=1;var r=Td(),e=gp(),t=ua(),n=xt();function i(s){return t(s)?r(n(s)):e(s)}return Si=i,Si}var Ri,_u;function Tt(){if(_u)return Ri;_u=1;var r=sp(),e=pp(),t=qt(),n=H(),i=mp();function s(a){return typeof a=="function"?a:a==null?t:typeof a=="object"?n(a)?e(a[0],a[1]):r(a):i(a)}return Ri=s,Ri}var qi,wu;function vp(){if(wu)return qi;wu=1;var r=dd(),e=Yh(),t=Tt(),n=H();function i(s,a){var o=n(s)?r:e;return o(s,t(a,3))}return qi=i,qi}var xi,bu;function yp(){if(bu)return xi;bu=1;var r=Object.prototype,e=r.hasOwnProperty;function t(n,i){return n!=null&&e.call(n,i)}return xi=t,xi}var Ti,Iu;function _p(){if(Iu)return Ti;Iu=1;var r=yp(),e=xd();function t(n,i){return n!=null&&e(n,i,r)}return Ti=t,Ti}var Ai,Pu;function wp(){if(Pu)return Ai;Pu=1;var r=ta(),e=Me(),t=Et(),n=H(),i=be(),s=Ye(),a=St(),o=Ct(),c="[object Map]",d="[object Set]",u=Object.prototype,l=u.hasOwnProperty;function f(h){if(h==null)return!0;if(i(h)&&(n(h)||typeof h=="string"||typeof h.splice=="function"||s(h)||o(h)||t(h)))return!h.length;var g=e(h);if(g==c||g==d)return!h.size;if(a(h))return!r(h).length;for(var p in h)if(l.call(h,p))return!1;return!0}return Ai=f,Ai}var Li,Eu;function bp(){if(Eu)return Li;Eu=1;function r(e){return e===void 0}return Li=r,Li}var Oi,Cu;function Ip(){if(Cu)return Oi;Cu=1;var r=Rt(),e=be();function t(n,i){var s=-1,a=e(n)?Array(n.length):[];return r(n,function(o,c,d){a[++s]=i(o,c,d)}),a}return Oi=t,Oi}var Mi,Su;function Pp(){if(Su)return Mi;Su=1;var r=la(),e=Tt(),t=Ip(),n=H();function i(s,a){var o=n(s)?r:t;return o(s,e(a,3))}return Mi=i,Mi}var Di,Ru;function Ep(){if(Ru)return Di;Ru=1;function r(e,t,n,i){var s=-1,a=e==null?0:e.length;for(i&&a&&(n=e[++s]);++s<a;)n=t(n,e[s],s,e);return n}return Di=r,Di}var Ni,qu;function Cp(){if(qu)return Ni;qu=1;function r(e,t,n,i,s){return s(e,function(a,o,c){n=i?(i=!1,a):t(n,a,o,c)}),n}return Ni=r,Ni}var Fi,xu;function Sp(){if(xu)return Fi;xu=1;var r=Ep(),e=Rt(),t=Tt(),n=Cp(),i=H();function s(a,o,c){var d=i(a)?r:n,u=arguments.length<3;return d(a,t(o,4),c,u,e)}return Fi=s,Fi}var ki,Tu;function Rp(){if(Tu)return ki;Tu=1;var r=Oe(),e=H(),t=se(),n="[object String]";function i(s){return typeof s=="string"||!e(s)&&t(s)&&r(s)==n}return ki=i,ki}var ji,Au;function qp(){if(Au)return ji;Au=1;var r=Td(),e=r("length");return ji=e,ji}var Gi,Lu;function xp(){if(Lu)return Gi;Lu=1;var r="\\ud800-\\udfff",e="\\u0300-\\u036f",t="\\ufe20-\\ufe2f",n="\\u20d0-\\u20ff",i=e+t+n,s="\\ufe0e\\ufe0f",a="\\u200d",o=RegExp("["+a+r+i+s+"]");function c(d){return o.test(d)}return Gi=c,Gi}var Bi,Ou;function Tp(){if(Ou)return Bi;Ou=1;var r="\\ud800-\\udfff",e="\\u0300-\\u036f",t="\\ufe20-\\ufe2f",n="\\u20d0-\\u20ff",i=e+t+n,s="\\ufe0e\\ufe0f",a="["+r+"]",o="["+i+"]",c="\\ud83c[\\udffb-\\udfff]",d="(?:"+o+"|"+c+")",u="[^"+r+"]",l="(?:\\ud83c[\\udde6-\\uddff]){2}",f="[\\ud800-\\udbff][\\udc00-\\udfff]",h="\\u200d",g=d+"?",p="["+s+"]?",y="(?:"+h+"(?:"+[u,l,f].join("|")+")"+p+g+")*",m=p+g+y,_="(?:"+[u+o+"?",o,l,f,a].join("|")+")",v=RegExp(c+"(?="+c+")|"+_+m,"g");function I(S){for(var E=v.lastIndex=0;v.test(S);)++E;return E}return Bi=I,Bi}var zi,Mu;function Ap(){if(Mu)return zi;Mu=1;var r=qp(),e=xp(),t=Tp();function n(i){return e(i)?t(i):r(i)}return zi=n,zi}var Hi,Du;function Lp(){if(Du)return Hi;Du=1;var r=ta(),e=Me(),t=be(),n=Rp(),i=Ap(),s="[object Map]",a="[object Set]";function o(c){if(c==null)return 0;if(t(c))return n(c)?i(c):c.length;var d=e(c);return d==s||d==a?c.size:r(c).length}return Hi=o,Hi}var Ui,Nu;function Op(){if(Nu)return Ui;Nu=1;var r=Zs(),e=yd(),t=wd(),n=Tt(),i=sa(),s=H(),a=Ye(),o=wt(),c=_e(),d=Ct();function u(l,f,h){var g=s(l),p=g||a(l)||d(l);if(f=n(f,4),h==null){var y=l&&l.constructor;p?h=g?new y:[]:c(l)?h=o(y)?e(i(l)):{}:h={}}return(p?r:t)(l,function(m,_,v){return f(h,m,_,v)}),h}return Ui=u,Ui}var $i,Fu;function Mp(){if(Fu)return $i;Fu=1;var r=Le(),e=Et(),t=H(),n=r?r.isConcatSpreadable:void 0;function i(s){return t(s)||e(s)||!!(n&&s&&s[n])}return $i=i,$i}var Wi,ku;function Dp(){if(ku)return Wi;ku=1;var r=ia(),e=Mp();function t(n,i,s,a,o){var c=-1,d=n.length;for(s||(s=e),o||(o=[]);++c<d;){var u=n[c];i>0&&s(u)?i>1?t(u,i-1,s,a,o):r(o,u):a||(o[o.length]=u)}return o}return Wi=t,Wi}var Vi,ju;function Np(){if(ju)return Vi;ju=1;function r(e,t,n){switch(n.length){case 0:return e.call(t);case 1:return e.call(t,n[0]);case 2:return e.call(t,n[0],n[1]);case 3:return e.call(t,n[0],n[1],n[2])}return e.apply(t,n)}return Vi=r,Vi}var Ki,Gu;function Fp(){if(Gu)return Ki;Gu=1;var r=Np(),e=Math.max;function t(n,i,s){return i=e(i===void 0?n.length-1:i,0),function(){for(var a=arguments,o=-1,c=e(a.length-i,0),d=Array(c);++o<c;)d[o]=a[i+o];o=-1;for(var u=Array(i+1);++o<i;)u[o]=a[o];return u[i]=s(d),r(n,this,u)}}return Ki=t,Ki}var Yi,Bu;function kp(){if(Bu)return Yi;Bu=1;var r=_d(),e=sd(),t=qt(),n=e?function(i,s){return e(i,"toString",{configurable:!0,enumerable:!1,value:r(s),writable:!0})}:t;return Yi=n,Yi}var Xi,zu;function jp(){if(zu)return Xi;zu=1;var r=800,e=16,t=Date.now;function n(i){var s=0,a=0;return function(){var o=t(),c=e-(o-a);if(a=o,c>0){if(++s>=r)return arguments[0]}else s=0;return i.apply(void 0,arguments)}}return Xi=n,Xi}var Zi,Hu;function Gp(){if(Hu)return Zi;Hu=1;var r=kp(),e=jp(),t=e(r);return Zi=t,Zi}var Ji,Uu;function Bp(){if(Uu)return Ji;Uu=1;var r=qt(),e=Fp(),t=Gp();function n(i,s){return t(e(i,s,r),i+"")}return Ji=n,Ji}var Qi,$u;function zp(){if($u)return Qi;$u=1;function r(e,t,n,i){for(var s=e.length,a=n+(i?1:-1);i?a--:++a<s;)if(t(e[a],a,e))return a;return-1}return Qi=r,Qi}var es,Wu;function Hp(){if(Wu)return es;Wu=1;function r(e){return e!==e}return es=r,es}var ts,Vu;function Up(){if(Vu)return ts;Vu=1;function r(e,t,n){for(var i=n-1,s=e.length;++i<s;)if(e[i]===t)return i;return-1}return ts=r,ts}var rs,Ku;function $p(){if(Ku)return rs;Ku=1;var r=zp(),e=Hp(),t=Up();function n(i,s,a){return s===s?t(i,s,a):r(i,e,a)}return rs=n,rs}var ns,Yu;function Wp(){if(Yu)return ns;Yu=1;var r=$p();function e(t,n){var i=t==null?0:t.length;return!!i&&r(t,n,0)>-1}return ns=e,ns}var is,Xu;function Vp(){if(Xu)return is;Xu=1;function r(e,t,n){for(var i=-1,s=e==null?0:e.length;++i<s;)if(n(t,e[i]))return!0;return!1}return is=r,is}var ss,Zu;function Kp(){if(Zu)return ss;Zu=1;function r(){}return ss=r,ss}var as,Ju;function Yp(){if(Ju)return as;Ju=1;var r=md(),e=Kp(),t=oa(),n=1/0,i=r&&1/t(new r([,-0]))[1]==n?function(s){return new r(s)}:e;return as=i,as}var os,Qu;function Xp(){if(Qu)return os;Qu=1;var r=bd(),e=Wp(),t=Vp(),n=Id(),i=Yp(),s=oa(),a=200;function o(c,d,u){var l=-1,f=e,h=c.length,g=!0,p=[],y=p;if(u)g=!1,f=t;else if(h>=a){var m=d?null:i(c);if(m)return s(m);g=!1,f=n,y=new r}else y=d?[]:p;e:for(;++l<h;){var _=c[l],v=d?d(_):_;if(_=u||_!==0?_:0,g&&v===v){for(var I=y.length;I--;)if(y[I]===v)continue e;d&&y.push(v),p.push(_)}else f(y,v,u)||(y!==p&&y.push(v),p.push(_))}return p}return os=o,os}var cs,el;function Zp(){if(el)return cs;el=1;var r=be(),e=se();function t(n){return e(n)&&r(n)}return cs=t,cs}var us,tl;function Jp(){if(tl)return us;tl=1;var r=Dp(),e=Bp(),t=Xp(),n=Zp(),i=e(function(s){return t(r(s,1,n,!0))});return us=i,us}var ls,rl;function Qp(){if(rl)return ls;rl=1;var r=la();function e(t,n){return r(n,function(i){return t[i]})}return ls=e,ls}var ds,nl;function eg(){if(nl)return ds;nl=1;var r=Qp(),e=Ie();function t(n){return n==null?[]:r(n,e(n))}return ds=t,ds}var fs,il;function Z(){if(il)return fs;il=1;var r;if(typeof kf=="function")try{r={clone:zh(),constant:_d(),each:Kh(),filter:vp(),has:_p(),isArray:H(),isEmpty:wp(),isFunction:wt(),isUndefined:bp(),keys:Ie(),map:Pp(),reduce:Sp(),size:Lp(),transform:Op(),union:Jp(),values:eg()}}catch{}return r||(r=window._),fs=r,fs}var hs,sl;function da(){if(sl)return hs;sl=1;var r=Z();hs=i;var e="\0",t="\0",n="";function i(u){this._isDirected=r.has(u,"directed")?u.directed:!0,this._isMultigraph=r.has(u,"multigraph")?u.multigraph:!1,this._isCompound=r.has(u,"compound")?u.compound:!1,this._label=void 0,this._defaultNodeLabelFn=r.constant(void 0),this._defaultEdgeLabelFn=r.constant(void 0),this._nodes={},this._isCompound&&(this._parent={},this._children={},this._children[t]={}),this._in={},this._preds={},this._out={},this._sucs={},this._edgeObjs={},this._edgeLabels={}}i.prototype._nodeCount=0,i.prototype._edgeCount=0,i.prototype.isDirected=function(){return this._isDirected},i.prototype.isMultigraph=function(){return this._isMultigraph},i.prototype.isCompound=function(){return this._isCompound},i.prototype.setGraph=function(u){return this._label=u,this},i.prototype.graph=function(){return this._label},i.prototype.setDefaultNodeLabel=function(u){return r.isFunction(u)||(u=r.constant(u)),this._defaultNodeLabelFn=u,this},i.prototype.nodeCount=function(){return this._nodeCount},i.prototype.nodes=function(){return r.keys(this._nodes)},i.prototype.sources=function(){var u=this;return r.filter(this.nodes(),function(l){return r.isEmpty(u._in[l])})},i.prototype.sinks=function(){var u=this;return r.filter(this.nodes(),function(l){return r.isEmpty(u._out[l])})},i.prototype.setNodes=function(u,l){var f=arguments,h=this;return r.each(u,function(g){f.length>1?h.setNode(g,l):h.setNode(g)}),this},i.prototype.setNode=function(u,l){return r.has(this._nodes,u)?(arguments.length>1&&(this._nodes[u]=l),this):(this._nodes[u]=arguments.length>1?l:this._defaultNodeLabelFn(u),this._isCompound&&(this._parent[u]=t,this._children[u]={},this._children[t][u]=!0),this._in[u]={},this._preds[u]={},this._out[u]={},this._sucs[u]={},++this._nodeCount,this)},i.prototype.node=function(u){return this._nodes[u]},i.prototype.hasNode=function(u){return r.has(this._nodes,u)},i.prototype.removeNode=function(u){var l=this;if(r.has(this._nodes,u)){var f=function(h){l.removeEdge(l._edgeObjs[h])};delete this._nodes[u],this._isCompound&&(this._removeFromParentsChildList(u),delete this._parent[u],r.each(this.children(u),function(h){l.setParent(h)}),delete this._children[u]),r.each(r.keys(this._in[u]),f),delete this._in[u],delete this._preds[u],r.each(r.keys(this._out[u]),f),delete this._out[u],delete this._sucs[u],--this._nodeCount}return this},i.prototype.setParent=function(u,l){if(!this._isCompound)throw new Error("Cannot set parent in a non-compound graph");if(r.isUndefined(l))l=t;else{l+="";for(var f=l;!r.isUndefined(f);f=this.parent(f))if(f===u)throw new Error("Setting "+l+" as parent of "+u+" would create a cycle");this.setNode(l)}return this.setNode(u),this._removeFromParentsChildList(u),this._parent[u]=l,this._children[l][u]=!0,this},i.prototype._removeFromParentsChildList=function(u){delete this._children[this._parent[u]][u]},i.prototype.parent=function(u){if(this._isCompound){var l=this._parent[u];if(l!==t)return l}},i.prototype.children=function(u){if(r.isUndefined(u)&&(u=t),this._isCompound){var l=this._children[u];if(l)return r.keys(l)}else{if(u===t)return this.nodes();if(this.hasNode(u))return[]}},i.prototype.predecessors=function(u){var l=this._preds[u];if(l)return r.keys(l)},i.prototype.successors=function(u){var l=this._sucs[u];if(l)return r.keys(l)},i.prototype.neighbors=function(u){var l=this.predecessors(u);if(l)return r.union(l,this.successors(u))},i.prototype.isLeaf=function(u){var l;return this.isDirected()?l=this.successors(u):l=this.neighbors(u),l.length===0},i.prototype.filterNodes=function(u){var l=new this.constructor({directed:this._isDirected,multigraph:this._isMultigraph,compound:this._isCompound});l.setGraph(this.graph());var f=this;r.each(this._nodes,function(p,y){u(y)&&l.setNode(y,p)}),r.each(this._edgeObjs,function(p){l.hasNode(p.v)&&l.hasNode(p.w)&&l.setEdge(p,f.edge(p))});var h={};function g(p){var y=f.parent(p);return y===void 0||l.hasNode(y)?(h[p]=y,y):y in h?h[y]:g(y)}return this._isCompound&&r.each(l.nodes(),function(p){l.setParent(p,g(p))}),l},i.prototype.setDefaultEdgeLabel=function(u){return r.isFunction(u)||(u=r.constant(u)),this._defaultEdgeLabelFn=u,this},i.prototype.edgeCount=function(){return this._edgeCount},i.prototype.edges=function(){return r.values(this._edgeObjs)},i.prototype.setPath=function(u,l){var f=this,h=arguments;return r.reduce(u,function(g,p){return h.length>1?f.setEdge(g,p,l):f.setEdge(g,p),p}),this},i.prototype.setEdge=function(){var u,l,f,h,g=!1,p=arguments[0];typeof p=="object"&&p!==null&&"v"in p?(u=p.v,l=p.w,f=p.name,arguments.length===2&&(h=arguments[1],g=!0)):(u=p,l=arguments[1],f=arguments[3],arguments.length>2&&(h=arguments[2],g=!0)),u=""+u,l=""+l,r.isUndefined(f)||(f=""+f);var y=o(this._isDirected,u,l,f);if(r.has(this._edgeLabels,y))return g&&(this._edgeLabels[y]=h),this;if(!r.isUndefined(f)&&!this._isMultigraph)throw new Error("Cannot set a named edge when isMultigraph = false");this.setNode(u),this.setNode(l),this._edgeLabels[y]=g?h:this._defaultEdgeLabelFn(u,l,f);var m=c(this._isDirected,u,l,f);return u=m.v,l=m.w,Object.freeze(m),this._edgeObjs[y]=m,s(this._preds[l],u),s(this._sucs[u],l),this._in[l][y]=m,this._out[u][y]=m,this._edgeCount++,this},i.prototype.edge=function(u,l,f){var h=arguments.length===1?d(this._isDirected,arguments[0]):o(this._isDirected,u,l,f);return this._edgeLabels[h]},i.prototype.hasEdge=function(u,l,f){var h=arguments.length===1?d(this._isDirected,arguments[0]):o(this._isDirected,u,l,f);return r.has(this._edgeLabels,h)},i.prototype.removeEdge=function(u,l,f){var h=arguments.length===1?d(this._isDirected,arguments[0]):o(this._isDirected,u,l,f),g=this._edgeObjs[h];return g&&(u=g.v,l=g.w,delete this._edgeLabels[h],delete this._edgeObjs[h],a(this._preds[l],u),a(this._sucs[u],l),delete this._in[l][h],delete this._out[u][h],this._edgeCount--),this},i.prototype.inEdges=function(u,l){var f=this._in[u];if(f){var h=r.values(f);return l?r.filter(h,function(g){return g.v===l}):h}},i.prototype.outEdges=function(u,l){var f=this._out[u];if(f){var h=r.values(f);return l?r.filter(h,function(g){return g.w===l}):h}},i.prototype.nodeEdges=function(u,l){var f=this.inEdges(u,l);if(f)return f.concat(this.outEdges(u,l))};function s(u,l){u[l]?u[l]++:u[l]=1}function a(u,l){--u[l]||delete u[l]}function o(u,l,f,h){var g=""+l,p=""+f;if(!u&&g>p){var y=g;g=p,p=y}return g+n+p+n+(r.isUndefined(h)?e:h)}function c(u,l,f,h){var g=""+l,p=""+f;if(!u&&g>p){var y=g;g=p,p=y}var m={v:g,w:p};return h&&(m.name=h),m}function d(u,l){return o(u,l.v,l.w,l.name)}return hs}var ps,al;function tg(){return al||(al=1,ps="2.1.8"),ps}var gs,ol;function rg(){return ol||(ol=1,gs={Graph:da(),version:tg()}),gs}var ms,cl;function ng(){if(cl)return ms;cl=1;var r=Z(),e=da();ms={write:t,read:s};function t(a){var o={options:{directed:a.isDirected(),multigraph:a.isMultigraph(),compound:a.isCompound()},nodes:n(a),edges:i(a)};return r.isUndefined(a.graph())||(o.value=r.clone(a.graph())),o}function n(a){return r.map(a.nodes(),function(o){var c=a.node(o),d=a.parent(o),u={v:o};return r.isUndefined(c)||(u.value=c),r.isUndefined(d)||(u.parent=d),u})}function i(a){return r.map(a.edges(),function(o){var c=a.edge(o),d={v:o.v,w:o.w};return r.isUndefined(o.name)||(d.name=o.name),r.isUndefined(c)||(d.value=c),d})}function s(a){var o=new e(a.options).setGraph(a.value);return r.each(a.nodes,function(c){o.setNode(c.v,c.value),c.parent&&o.setParent(c.v,c.parent)}),r.each(a.edges,function(c){o.setEdge({v:c.v,w:c.w,name:c.name},c.value)}),o}return ms}var vs,ul;function ig(){if(ul)return vs;ul=1;var r=Z();vs=e;function e(t){var n={},i=[],s;function a(o){r.has(n,o)||(n[o]=!0,s.push(o),r.each(t.successors(o),a),r.each(t.predecessors(o),a))}return r.each(t.nodes(),function(o){s=[],a(o),s.length&&i.push(s)}),i}return vs}var ys,ll;function Ad(){if(ll)return ys;ll=1;var r=Z();ys=e;function e(){this._arr=[],this._keyIndices={}}return e.prototype.size=function(){return this._arr.length},e.prototype.keys=function(){return this._arr.map(function(t){return t.key})},e.prototype.has=function(t){return r.has(this._keyIndices,t)},e.prototype.priority=function(t){var n=this._keyIndices[t];if(n!==void 0)return this._arr[n].priority},e.prototype.min=function(){if(this.size()===0)throw new Error("Queue underflow");return this._arr[0].key},e.prototype.add=function(t,n){var i=this._keyIndices;if(t=String(t),!r.has(i,t)){var s=this._arr,a=s.length;return i[t]=a,s.push({key:t,priority:n}),this._decrease(a),!0}return!1},e.prototype.removeMin=function(){this._swap(0,this._arr.length-1);var t=this._arr.pop();return delete this._keyIndices[t.key],this._heapify(0),t.key},e.prototype.decrease=function(t,n){var i=this._keyIndices[t];if(n>this._arr[i].priority)throw new Error("New priority is greater than current priority. Key: "+t+" Old: "+this._arr[i].priority+" New: "+n);this._arr[i].priority=n,this._decrease(i)},e.prototype._heapify=function(t){var n=this._arr,i=2*t,s=i+1,a=t;i<n.length&&(a=n[i].priority<n[a].priority?i:a,s<n.length&&(a=n[s].priority<n[a].priority?s:a),a!==t&&(this._swap(t,a),this._heapify(a)))},e.prototype._decrease=function(t){for(var n=this._arr,i=n[t].priority,s;t!==0&&(s=t>>1,!(n[s].priority<i));)this._swap(t,s),t=s},e.prototype._swap=function(t,n){var i=this._arr,s=this._keyIndices,a=i[t],o=i[n];i[t]=o,i[n]=a,s[o.key]=t,s[a.key]=n},ys}var _s,dl;function Ld(){if(dl)return _s;dl=1;var r=Z(),e=Ad();_s=n;var t=r.constant(1);function n(s,a,o,c){return i(s,String(a),o||t,c||function(d){return s.outEdges(d)})}function i(s,a,o,c){var d={},u=new e,l,f,h=function(g){var p=g.v!==l?g.v:g.w,y=d[p],m=o(g),_=f.distance+m;if(m<0)throw new Error("dijkstra does not allow negative edge weights. Bad edge: "+g+" Weight: "+m);_<y.distance&&(y.distance=_,y.predecessor=l,u.decrease(p,_))};for(s.nodes().forEach(function(g){var p=g===a?0:Number.POSITIVE_INFINITY;d[g]={distance:p},u.add(g,p)});u.size()>0&&(l=u.removeMin(),f=d[l],f.distance!==Number.POSITIVE_INFINITY);)c(l).forEach(h);return d}return _s}var ws,fl;function sg(){if(fl)return ws;fl=1;var r=Ld(),e=Z();ws=t;function t(n,i,s){return e.transform(n.nodes(),function(a,o){a[o]=r(n,o,i,s)},{})}return ws}var bs,hl;function Od(){if(hl)return bs;hl=1;var r=Z();bs=e;function e(t){var n=0,i=[],s={},a=[];function o(c){var d=s[c]={onStack:!0,lowlink:n,index:n++};if(i.push(c),t.successors(c).forEach(function(f){r.has(s,f)?s[f].onStack&&(d.lowlink=Math.min(d.lowlink,s[f].index)):(o(f),d.lowlink=Math.min(d.lowlink,s[f].lowlink))}),d.lowlink===d.index){var u=[],l;do l=i.pop(),s[l].onStack=!1,u.push(l);while(c!==l);a.push(u)}}return t.nodes().forEach(function(c){r.has(s,c)||o(c)}),a}return bs}var Is,pl;function ag(){if(pl)return Is;pl=1;var r=Z(),e=Od();Is=t;function t(n){return r.filter(e(n),function(i){return i.length>1||i.length===1&&n.hasEdge(i[0],i[0])})}return Is}var Ps,gl;function og(){if(gl)return Ps;gl=1;var r=Z();Ps=t;var e=r.constant(1);function t(i,s,a){return n(i,s||e,a||function(o){return i.outEdges(o)})}function n(i,s,a){var o={},c=i.nodes();return c.forEach(function(d){o[d]={},o[d][d]={distance:0},c.forEach(function(u){d!==u&&(o[d][u]={distance:Number.POSITIVE_INFINITY})}),a(d).forEach(function(u){var l=u.v===d?u.w:u.v,f=s(u);o[d][l]={distance:f,predecessor:d}})}),c.forEach(function(d){var u=o[d];c.forEach(function(l){var f=o[l];c.forEach(function(h){var g=f[d],p=u[h],y=f[h],m=g.distance+p.distance;m<y.distance&&(y.distance=m,y.predecessor=p.predecessor)})})}),o}return Ps}var Es,ml;function Md(){if(ml)return Es;ml=1;var r=Z();Es=e,e.CycleException=t;function e(n){var i={},s={},a=[];function o(c){if(r.has(s,c))throw new t;r.has(i,c)||(s[c]=!0,i[c]=!0,r.each(n.predecessors(c),o),delete s[c],a.push(c))}if(r.each(n.sinks(),o),r.size(i)!==n.nodeCount())throw new t;return a}function t(){}return t.prototype=new Error,Es}var Cs,vl;function cg(){if(vl)return Cs;vl=1;var r=Md();Cs=e;function e(t){try{r(t)}catch(n){if(n instanceof r.CycleException)return!1;throw n}return!0}return Cs}var Ss,yl;function Dd(){if(yl)return Ss;yl=1;var r=Z();Ss=e;function e(n,i,s){r.isArray(i)||(i=[i]);var a=(n.isDirected()?n.successors:n.neighbors).bind(n),o=[],c={};return r.each(i,function(d){if(!n.hasNode(d))throw new Error("Graph does not have node: "+d);t(n,d,s==="post",c,a,o)}),o}function t(n,i,s,a,o,c){r.has(a,i)||(a[i]=!0,s||c.push(i),r.each(o(i),function(d){t(n,d,s,a,o,c)}),s&&c.push(i))}return Ss}var Rs,_l;function ug(){if(_l)return Rs;_l=1;var r=Dd();Rs=e;function e(t,n){return r(t,n,"post")}return Rs}var qs,wl;function lg(){if(wl)return qs;wl=1;var r=Dd();qs=e;function e(t,n){return r(t,n,"pre")}return qs}var xs,bl;function dg(){if(bl)return xs;bl=1;var r=Z(),e=da(),t=Ad();xs=n;function n(i,s){var a=new e,o={},c=new t,d;function u(f){var h=f.v===d?f.w:f.v,g=c.priority(h);if(g!==void 0){var p=s(f);p<g&&(o[h]=d,c.decrease(h,p))}}if(i.nodeCount()===0)return a;r.each(i.nodes(),function(f){c.add(f,Number.POSITIVE_INFINITY),a.setNode(f)}),c.decrease(i.nodes()[0],0);for(var l=!1;c.size()>0;){if(d=c.removeMin(),r.has(o,d))a.setEdge(d,o[d]);else{if(l)throw new Error("Input graph is not connected: "+i);l=!0}i.nodeEdges(d).forEach(u)}return a}return xs}var Ts,Il;function fg(){return Il||(Il=1,Ts={components:ig(),dijkstra:Ld(),dijkstraAll:sg(),findCycles:ag(),floydWarshall:og(),isAcyclic:cg(),postorder:ug(),preorder:lg(),prim:dg(),tarjan:Od(),topsort:Md()}),Ts}var As,Pl;function hg(){if(Pl)return As;Pl=1;var r=rg();return As={Graph:r.Graph,json:ng(),alg:fg(),version:r.version},As}var El=hg();class K{constructor(e,t=[],{validateConnectivity:n=!0}={}){if(this.id=e,this.pieces=[...t],this.borderPieces=new Set,t.length>0){if(n&&!K.arePiecesConnected(t))throw new Error(`Cannot create group ${e}: initial pieces are not connected`);t.forEach(i=>{i&&i._setGroupId(this.id)}),this._updateBorderPieces()}}addPieces(e){const t=e.filter(a=>a!=null);if(t.length===0)return 0;const n=[...this.pieces,...t];if(!K.arePiecesConnected(n))throw new Error(`Cannot add pieces to group ${this.id}: resulting group would not be connected`);const i=t.filter(a=>!this.pieces.includes(a)),s=i.length;return s>0&&(this.pieces=[...this.pieces,...i],i.forEach(a=>{a._setGroupId(this.id)})),s>0&&this._updateBorderPieces(),s}removePieces(e){const t=new Set(e.filter(o=>o&&this.pieces.includes(o)));if(t.size===0)return[];const n=this.pieces.filter(o=>!t.has(o));if(t.forEach(o=>{o._setGroupId(null)}),n.length===0)return this.pieces=[],[];const i=K._findConnectedComponents(n);if(i.length===1)return this.pieces=n,this._updateBorderPieces(),[];const s=[],a=i.reduce((o,c)=>c.length>o.length?c:o);return this.pieces=[...a],a.forEach(o=>{o._setGroupId(this.id)}),this._updateBorderPieces(),i.forEach((o,c)=>{if(o!==a){const d=`${this.id}_split_${c}_${Date.now()}`,u=new K(d,o);s.push(u)}}),s}get allPieces(){return this.pieces}size(){return this.pieces.length}isEmpty(){return this.pieces.length===0}clear(){this.pieces.forEach(e=>{e._setGroupId(null)}),this.pieces=[],this.borderPieces.clear()}get allBorderPieces(){return Array.from(this.borderPieces)}_updateBorderPieces(){if(this.borderPieces.clear(),this.pieces.length===0)return;const e=new Map;for(const t of this.pieces){if(!t)continue;const n=`${t.gridX},${t.gridY}`;e.set(n,t)}for(const t of this.pieces){if(!t)continue;let n=0;const i=[{x:t.gridX,y:t.gridY-1},{x:t.gridX+1,y:t.gridY},{x:t.gridX,y:t.gridY+1},{x:t.gridX-1,y:t.gridY}];for(const s of i){const a=`${s.x},${s.y}`;e.has(a)&&n++}n<4&&this.borderPieces.add(t)}}calculateBounds(){if(this.isEmpty())return null;let e=new $;for(const t of this.pieces){if(!t||!t.calculateBoundingFrame)continue;const n=t.calculateBoundingFrame();if(!n)continue;const i=A.getPiecePosition(t.id)||new b(0,0),s=i.add(n.topLeft),a=i.add(n.bottomRight),o=$.fromPoints(s,a);o.isEmpty()||(e=e.plus(o))}return e.isEmpty()?null:e}getCenter(){const e=this.calculateBounds();return e?e.center:null}merge(e){if(!e||e===this)return!1;const t=e.allPieces;return this.addPieces(t),e.clear(),!0}validate(){for(const e of this.pieces)if(!e||e.groupId!==this.id)return!1;return!0}getStats(){const e=this.calculateBounds();return{id:this.id,pieceCount:this.size(),bounds:e,center:this.getCenter()}}static arePiecesConnected(e){return e.length<2?!0:K._findConnectedComponents(e).length===1}static _findConnectedComponents(e){if(e.length===0)return[];const t=new El.Graph({directed:!1});e.forEach(i=>{t.setNode(i.id,i)});for(let i=0;i<e.length;i++){const s=e[i];for(let a=i+1;a<e.length;a++){const o=e[a];A.arePiecesNeighbors(s,o)&&t.setEdge(s.id,o.id)}}return El.alg.components(t).map(i=>i.map(s=>t.node(s)))}isConnected(){return this.size()<=1?!0:K.arePiecesConnected(this.pieces)}toString(){return`Group(id: ${this.id}, pieces: ${this.size()}, center: ${this.getCenter()})`}}const Nd="piecesGenerated",fa="piece:rotate",At="piece:select",We="piece:deselect",Fd="piece:detach-animation",ks="piece:long-press-start",pe="piece:long-press-end",kd="piece:north",ha="drag:move",Xe="drag:end",jd="drag:high-curvature",js="groups:changed",le="puzzle:state-changed",Gd="deeplink:enabled",ht="deeplink:disabled",Bd="image:upload-request",Cl=/^g(\d+)/;class pg{constructor(){this.groups=new Map,this.nextGroupId=1}initialize(){this.groups.clear();const e=new Map;w.pieces.forEach(t=>{let n=t.groupId;n||(n=`g${t.id}`,t._setGroupId(n));let i=e.get(n);i||(i=[],e.set(n,i)),i.push(t)}),e.forEach((t,n)=>{const i=K._findConnectedComponents(t);i.length>1&&console.warn(`[GroupManager] Group ${n} is fragmented into ${i.length} components`),i.forEach(s=>{const a=this.generateGroupId();s.forEach(c=>{c._setGroupId(a)});const o=new K(a,s,{validateConnectivity:!1});this.groups.set(a,o)})}),console.log(`[GroupManager] Initialized with ${this.groups.size} groups for ${w.pieces.length} pieces`),this.updateNextGroupId()}generateGroupId(){return`g${this.nextGroupId++}`}updateNextGroupId(){const t=[...Array.from(this.groups.keys()),...w.pieces.map(n=>n.groupId)].filter(n=>n&&n.match(Cl)).map(n=>parseInt(n.match(Cl)[1],10)).reduce((n,i)=>Math.max(n,i),0);this.nextGroupId=t+1}getGroup(e){return this.groups.get(e)}getGroupCount(){return this.groups.size}getGroupForPiece(e){return this.groups.get(e.groupId)}createSinglePieceGroup(e){const t=this.generateGroupId();e._setGroupId(t);const n=new K(t,[e]);return this.groups.set(t,n),n}mergeGroups(e,t){const n=this.getGroupForPiece(e),i=this.getGroupForPiece(t);if(!n||!i)return!1;if(n===i)return!0;try{const s=[...n.allPieces,...i.allPieces];if(!K.arePiecesConnected(s))return console.warn("[GroupManager] Cannot merge - would create disconnected group"),!1;const[a,o]=n.size()>=i.size()?[n,i]:[i,n],c=o.allPieces;return a.addPieces(c),this.groups.delete(o.id),document.dispatchEvent(new CustomEvent(js,{detail:{type:"merged",fromGroupId:o.id,toGroupId:a.id}})),!0}catch(s){return console.error("[GroupManager] Error during group merge:",s),!1}}detachPiece(e){const t=this.getGroupForPiece(e);if(!t)return null;if(t.size()===1)return t;try{const n=t.removePieces([e]),i=this.createSinglePieceGroup(e);return n.forEach(s=>{this.groups.set(s.id,s),console.log(`[GroupManager] Created fragment group ${s.id} with ${s.size()} pieces`)}),document.dispatchEvent(new CustomEvent(js,{detail:{type:"detached",pieceId:e.id,newGroupId:i.id}})),i}catch(n){return console.error("[GroupManager] Error during piece detachment:",n),null}}validateConnectivity(e){return!e||e.length<=1?!0:new K("temp",e).isConnected()}}const z=new pg;typeof window<"u"&&(window.groupManager=z);class gg{constructor(){this._cells=new Map}_key(e,t){return`${e},${t}`}set(e,t,n){this._cells.set(this._key(e,t),n)}get(e,t){return this._cells.get(this._key(e,t))}has(e,t){return this._cells.has(this._key(e,t))}delete(e,t){return this._cells.delete(this._key(e,t))}clear(){this._cells.clear()}getRange(e,t,n,i){const s=[];for(let a=n;a<=i;a++)for(let o=e;o<=t;o++){const c=this._key(o,a);this._cells.has(c)&&s.push({col:o,row:a,value:this._cells.get(c)})}return s}get size(){return this._cells.size}forEach(e){this._cells.forEach((t,n)=>{const[i,s]=n.split(",").map(Number);e(t,i,s)})}}const Sl=80,Rl=2.5;class mg{constructor(e,t,n){this.boundsWidth=e,this.boundsHeight=t,this.avgPieceSize=n,this.cellSize=Math.max(Sl,Math.round(n*Rl)),this.grid=new gg,this.itemMap=new Map}needsRebuild(e,t,n){return this.boundsWidth!==e||this.boundsHeight!==t||Math.abs(this.avgPieceSize-n)>.01}updateDimensions(e,t,n){return this.needsRebuild(e,t,n)?(this.boundsWidth=e,this.boundsHeight=t,this.avgPieceSize=n,this.cellSize=Math.max(Sl,Math.round(n*Rl)),!0):!1}_cellFor(e){const t=Math.floor(e.x/this.cellSize),n=Math.floor(e.y/this.cellSize);return{col:t,row:n}}insert(e){const{col:t,row:n}=this._cellFor(e.position);let i=this.grid.get(t,n);i||(i=new Set,this.grid.set(t,n,i)),i.add(e.id),this.itemMap.set(e.id,{col:t,row:n,point:e.position})}update(e){const t=this.itemMap.get(e.id),{col:n,row:i}=this._cellFor(e.position);if(!t||t.col!==n||t.row!==i){if(t){const a=this.grid.get(t.col,t.row);a&&(a.delete(e.id),a.size===0&&this.grid.delete(t.col,t.row))}let s=this.grid.get(n,i);s||(s=new Set,this.grid.set(n,i,s)),s.add(e.id),this.itemMap.set(e.id,{col:n,row:i,point:e.position})}}remove(e){const t=this.itemMap.get(e.id);if(t){const n=this.grid.get(t.col,t.row);n&&(n.delete(e.id),n.size===0&&this.grid.delete(t.col,t.row)),this.itemMap.delete(e.id)}}queryRadius(e,t){const n=new Set,i=Math.floor((e.x-t)/this.cellSize),s=Math.floor((e.x+t)/this.cellSize),a=Math.floor((e.y-t)/this.cellSize),o=Math.floor((e.y+t)/this.cellSize);for(let c=a;c<=o;c++)for(let d=i;d<=s;d++){const u=this.grid.get(d,c);u&&u.forEach(l=>n.add(l))}return Array.from(n)}rebuild(e){this.grid.clear(),this.itemMap.clear(),e.forEach(t=>this.insert(t))}}class vg{constructor({spatialIndex:e=null,pieceElements:t=null}={}){this.spatialIndex=e,this.pieceElements=t,this._piecePositions=new Map,this._worldDataCache=new Map,this.maxZIndex=0}syncAllPositions(){!w||!w.pieces||(w.pieces.forEach(e=>{!this.getPiecePosition(e.id)&&e.displayX!==void 0&&e.displayY!==void 0&&this._piecePositions.set(e.id,new b(e.displayX,e.displayY))}),this._autoManageSpatialIndex(null,null))}attachPieceElements(e){this.pieceElements=e,Eg(e)}bringToFront(e){var a;const t=(a=w.pieces)==null?void 0:a.find(o=>o.id===e);if(!t)return;const n=z.getGroup(t.groupId),i=n?n.allPieces:[t];this.maxZIndex++;const s=this.maxZIndex;i.forEach(o=>{o.zIndex=s,Cg(o.id,s)})}initializeMaxZIndex(){this.maxZIndex=0,w.pieces.forEach(e=>{e.zIndex&&e.zIndex>this.maxZIndex&&(this.maxZIndex=e.zIndex)})}updateViewportArea(e,t){this._autoManageSpatialIndex(e,t)}_computeAvgPieceSize(){var e;return!w||!w.pieces||w.pieces.length===0?0:w.pieces.reduce((t,n)=>t+Math.min(n.imgRect.width,n.imgRect.height),0)/w.pieces.length*(((e=w.pieces[0])==null?void 0:e.scale)||1)}_autoManageSpatialIndex(e=null,t=null){if(e==null||t==null){if(!this.spatialIndex)return;e=this.spatialIndex.boundsWidth,t=this.spatialIndex.boundsHeight}if(!w||!w.pieces||w.pieces.length===0){this.spatialIndex=null;return}const n=this._computeAvgPieceSize();this.spatialIndex?this.spatialIndex.updateDimensions(e,t,n)&&this._rebuildSpatialIndex():(this.spatialIndex=new mg(e,t,n),this._rebuildSpatialIndex())}_rebuildSpatialIndex(){if(!this.spatialIndex)return;const e=[];w.pieces.forEach(t=>{const n=this._getElement(t.id),i=this.getCenter(t,n);i&&e.push({id:t.id,position:i})}),this.spatialIndex.rebuild(e)}getPiecePosition(e){return this._piecePositions.get(e)||null}getWorldData(e){const t=this.getPiecePosition(e.id);if(!t)return{worldCorners:{},worldSPoints:{}};let n=this._worldDataCache.get(e.id);const i=!n||!t.equals(n.lastPosition),s=n&&(e.rotation!==n.lastRotation||e.scale!==n.lastScale);return(!n||i||s)&&(n={data:this._computeWorldDataInternal(e),lastPosition:t.clone(),lastRotation:e.rotation,lastScale:e.scale},this._worldDataCache.set(e.id,n)),n.data}getCenter(e,t=null){const n=e.calculateBoundingFrame(),i=e.scale;let s,a;t?(s=t.offsetWidth,a=t.offsetHeight):(s=n.width*i,a=n.height*i);const o=new b(s/2,a/2),d=n.centerOffset.scaled(i).sub(o);return this.getPiecePosition(e.id).sub(d).add(o)}_computeWorldDataInternal(e){const t=e.scale,n=this.getPiecePosition(e.id)||new b(0,0),i=e.calculateBoundingFrame(),a=new b(e.bitmap.width*t,e.bitmap.height*t).scaled(.5),c=i.centerOffset.scaled(t).sub(a),d=n.sub(c),u=this.getCenter(e),l=y=>y.sub(i.topLeft).scaled(t),f={nw:l(e.corners.nw),ne:l(e.corners.ne),se:l(e.corners.se),sw:l(e.corners.sw)},h={};for(const[y,m]of Object.entries(f)){const v=m.add(d).rotatedAroundDeg(u,e.rotation);h[y]=v}const g=e.sPoints,p={};return["north","east","south","west"].forEach(y=>{const m=g[y];if(!m){p[y]=null;return}const I=l(m).add(d).rotatedAroundDeg(u,e.rotation);p[y]=I}),{worldCorners:h,worldSPoints:p}}setPiecePosition(e,t){this._piecePositions.set(e,t.clone()),this._updateSpatialIndexFor(e);const n=this._findPiece(e);n&&He(n)}movePiece(e,t){const n=this.getPiecePosition(e);n&&this.setPiecePosition(e,n.add(t))}placePieceCenter(e,t,n){const i=this._findPiece(e);if(!i)return;const s=n.offsetWidth,a=n.offsetHeight,o=i.calculateBoundingFrame(),c=i.scale,d=new b(s/2,a/2),l=o.centerOffset.scaled(c).sub(d);this.setPiecePosition(e,t.sub(d).add(l))}moveGroup(e,t){const n=z.getGroup(e);n&&n.allPieces.forEach(i=>this.movePiece(i.id,t))}rotatePiece(e,t){const n=this._findPiece(e);n&&(n.rotate(t),He(n))}rotateGroup(e,t,n){const i=z.getGroup(e);if(!i||i.isEmpty())return;const s=this._getElement(n.id);if(!s)return;const a=this.getCenter(n,s);i.allPieces.forEach(o=>{if(!o)return;const c=this._getElement(o.id);if(!c)return;o.rotate(t);const u=this.getCenter(o,c).rotatedAroundDeg(a,t);this.placePieceCenter(o.id,u,c),He(o)})}queryRadius(e,t){return!this.spatialIndex||!e?[]:this.spatialIndex.queryRadius(e,t)}rotatePieceOrGroup(e,t){const n=this._findPiece(e);if(!n)return;const i=z.getGroup(n.groupId);i&&i.size()>1?this.rotateGroup(i.id,t,n):this.rotatePiece(e,t)}calculatePiecesBounds(e){if(ne.isArrayEmpty(e))return null;let t=new $;for(const n of e){if(!n)continue;const i=n.calculateBoundingFrame();if(!i)continue;const s=this.getPiecePosition(n.id)||new b(0,0),a=s.add(i.topLeft),o=s.add(i.bottomRight),c=$.fromPoints(a,o);c.isEmpty()||(t=t.plus(c))}return t.isEmpty()?null:t}arePiecesNeighbors(e,t){if(!e||!t||!e.worldData||!t.worldData)return!1;const n=e.worldData.worldCorners,i=t.worldData.worldCorners;if(!n||!i)return!1;const a=18*((e.scale+t.scale)*.5)+4,o=(f,h)=>{const g=f.x-h.x,p=f.y-h.y;return g*g+p*p<=a*a};return!!(o(n.nw,i.sw)&&o(n.ne,i.se)||o(n.sw,i.nw)&&o(n.se,i.ne)||o(n.ne,i.nw)&&o(n.se,i.sw)||o(n.nw,i.ne)&&o(n.sw,i.se))}_findPiece(e){return w.pieces.find(t=>t.id===e)}_getElement(e){return this.pieceElements?this.pieceElements.get(e):null}_updateSpatialIndexFor(e){if(!this.spatialIndex)return;const t=this._findPiece(e);if(!t)return;const n=this._getElement(e),i=this.getCenter(t,n);this.spatialIndex.update({id:t.id,position:i})}}const A=new vg,ql=new WeakMap;function yg(r){const e=r.toString();let t=0;for(let n=0;n<e.length;n++){const i=e.charCodeAt(n);t=(t<<5)-t+i,t=t&t}return`fn_${t}_${e.length}`}function B(r,e,t=document){if(typeof r!="string"||!r)return console.warn("[event-util] Invalid event name:",r),!1;if(typeof e!="function")return console.warn("[event-util] Invalid handler:",e),!1;if(!t||typeof t.addEventListener!="function")return console.warn("[event-util] Invalid target:",t),!1;const n=yg(e);let i=ql.get(t);i||(i=new Map,ql.set(t,i));let s=i.get(r);return s||(s=new Map,i.set(r,s)),s.has(n)?(console.debug(`[event-util] Handler already registered for event "${r}"`),!1):(t.addEventListener(r,e),s.set(n,e),!0)}const pt=.1,zd=5,gt=1.2,_g=1.1,wg=.9;let de=null,Y=null,Gs=null,X=1,x=new b(0,0),Hd=new b(0,0),F=null,ue=4;B(Nd,r=>{const e=r.detail.totalPieces||20;ue=8*Math.sqrt(Math.sqrt(20/e))},window);B(At,r=>{const{pieceId:e}=r.detail,t=F==null?void 0:F.get(e);t&&t.classList.add("selected")});B(We,r=>{const{pieceId:e}=r.detail,t=F==null?void 0:F.get(e);t&&t.classList.remove("selected")});B(Fd,r=>{const{pieceId:e}=r.detail,t=F==null?void 0:F.get(e);t&&(t.classList.add("detached-piece"),setTimeout(()=>t.classList.remove("detached-piece"),1e3))});B(ks,r=>{const{pieceId:e}=r.detail,t=F==null?void 0:F.get(e);t&&t.classList.add("long-press-active")});B(pe,r=>{const{pieceId:e}=r.detail,t=F==null?void 0:F.get(e);t&&t.classList.remove("long-press-active")});function bg(){return de=document.getElementById("piecesViewport"),Y=document.getElementById("piecesContainer"),Gs=document.getElementById("zoomDisplay"),de}function qe(){return de}function Ud(){return{zoomLevel:X,panX:x.x,panY:x.y}}function Ig(r){Q(r.zoomLevel),x=new b(r.panX,r.panY),ve(),Lt()}function Pg(){ne.isArrayEmpty(w.pieces)||w.pieces.forEach(r=>{pa(r)})}function He(r){if(!r)return null;const e=va(r.id);if(!e)return null;const t=r.calculateBoundingFrame(),n=new b(e.offsetWidth,e.offsetHeight).scaled(.5),s=t.centerOffset.scaled(r.scale).sub(n),a=A.getPiecePosition(r.id).sub(s);return e.style.left=a.x+"px",e.style.top=a.y+"px",e.style.transform=`rotate(${r.rotation}deg)`,e}function Eg(r){F=r}function Cg(r,e){const t=F==null?void 0:F.get(r);t&&(t.style.zIndex=e.toString())}function Bs(){if(!de)return;const r=w.deepLinkRemoveColor,e=localStorage.getItem("removeColor");(r||e)==="y"?de.style.filter="grayscale(100%)":de.style.filter="none"}function xe(){return X}function Sg(){return x}function Rg(r){x=r,ve()}function qg(){return Hd}function xl(r){Hd=r}function Q(r,e=null){const t=X,n=Math.max(pt,Math.min(zd,r));if(X=n,e&&Y){const i=Y.getBoundingClientRect(),s=new b(i.left,i.top),a=e.sub(s),o=n/t,c=a.sub(x).scaled(o);x=a.sub(c)}ve(),Lt()}function ve(){!ne.isElementValid(de)||!x||(de.style.transform=`translate(${x.x}px, ${x.y}px) scale(${X})`)}function Tl(r,e,t=3){if(!r.path){console.warn(`[drawPieceOutline] No path found for piece ${r.id}`);return}pa(r);const s=va(r.id).querySelector("canvas").getContext("2d"),a=r.scale;s.save();const o=r.calculateBoundingFrame();s.scale(a,a),s.translate(-o.topLeft.x,-o.topLeft.y),s.strokeStyle=e,s.lineWidth=t/a,s.stroke(r.path),s.restore()}function pa(r){const e=va(r.id);if(!e)return;const t=e.querySelector("canvas");if(!t){console.warn(`[clearPieceOutline] No canvas found for piece ${r.id}`);return}const n=t.getContext("2d");n.save(),n.clearRect(0,0,t.width,t.height),n.scale(r.scale,r.scale),n.drawImage(r.bitmap,0,0),n.restore()}function Al(r){const e=document.getElementById("orientationTipButton");e&&(w.noRotate||!r?e.style.display="none":r&&(e.style.display="block"))}function Lt(){Gs&&(Gs.textContent=Math.round(X*100)+"%")}function xg(r,e){e?Tl(r,"#2ea862",4):Tl(r,"#c94848",4)}function zs(r){if(!F||(F.forEach(t=>t.classList.remove("candidate-highlight")),r==null))return;(Array.isArray(r)?r:[r]).forEach(t=>{const n=F.get(t);n&&n.classList.add("candidate-highlight")})}const Ls="#D2691E";function Tg(r,e){const t=r.replace("#",""),n=Math.max(0,parseInt(t.substring(0,2),16)*(1-e)),i=Math.max(0,parseInt(t.substring(2,4),16)*(1-e)),s=Math.max(0,parseInt(t.substring(4,6),16)*(1-e));return`rgb(${Math.round(n)}, ${Math.round(i)}, ${Math.round(s)})`}function Ag(r,e){const t=r.replace("#",""),n=Math.min(255,parseInt(t.substring(0,2),16)+255*e),i=Math.min(255,parseInt(t.substring(2,4),16)+255*e),s=Math.min(255,parseInt(t.substring(4,6),16)+255*e);return`rgb(${Math.round(n)}, ${Math.round(i)}, ${Math.round(s)})`}function Lg(r,e,t,n){const i=Math.ceil(r.width),s=Math.ceil(r.height),a=r.topLeft.add(t),o=r.bottomRight.add(t);let c=a.x,d=a.y,u=o.x-a.x,l=o.y-a.y;const f=Math.max(0,c),h=Math.max(0,d),g=Math.min(u,n.width-f),p=Math.min(l,n.height-h),y=f-t.x,m=h-t.y,_=document.createElement("canvas");_.width=i+2*ue,_.height=s+2*ue;const v=_.getContext("2d");return v.translate(-r.topLeft.x+ue,-r.topLeft.y+ue),v.save(),v.clip(e),v.drawImage(n,f,h,g,p,y,m,g,p),v.restore(),v.lineJoin="round",v.lineCap="round",v.strokeStyle=Tg(Ls,.4),v.lineWidth=ue,v.shadowColor="rgba(0, 0, 0, 0.3)",v.shadowBlur=4,v.shadowOffsetX=2,v.shadowOffsetY=2,v.stroke(e),v.shadowColor="transparent",v.shadowBlur=0,v.shadowOffsetX=0,v.shadowOffsetY=0,v.strokeStyle=Ls,v.lineWidth=ue,v.stroke(e),v.strokeStyle=Ag(Ls,.3),v.lineWidth=ue/2,v.stroke(e),v.restore(),_}function Og(r,e,t={}){const{forceZoom:n=!1}=t;if(!ne.isElementValid(Y))return;const i=Y.clientWidth,s=Y.clientHeight;function a(){const u=r.scaled(X),l=x.add(u),f=e.scaled(X),h=l,g=l.add(f);return{topLeft:h,bottomRight:g}}let o=a();if(n){const u=Math.max(0,-o.topLeft.x),l=Math.max(0,o.bottomRight.x-i),f=Math.max(0,-o.topLeft.y),h=Math.max(0,o.bottomRight.y-s),g=u+l,p=f+h;if(g>0||p>0){const m=g>0?i/(i+g):1,_=p>0?s/(s+p):1,v=Math.min(m,_);if(v<.999){const I=Math.max(pt,X*v);I<X-1e-4&&(Q(I),o=a())}}o.topLeft.x<0&&(x=x.add(new b(-o.topLeft.x,0))),o.topLeft.y<0&&(x=x.add(new b(0,-o.topLeft.y))),o.bottomRight.x>i&&(x=x.sub(new b(o.bottomRight.x-i,0))),o.bottomRight.y>s&&(x=x.sub(new b(0,o.bottomRight.y-s))),ve();return}let c=!1;if(o.topLeft.x<0&&(x=x.add(new b(-o.topLeft.x,0)),c=!0),o.topLeft.y<0&&(x=x.add(new b(0,-o.topLeft.y)),c=!0),o.bottomRight.x>i&&(x=x.sub(new b(o.bottomRight.x-i,0)),c=!0),o.bottomRight.y>s&&(x=x.sub(new b(0,o.bottomRight.y-s)),c=!0),c&&(ve(),o=a()),o.topLeft.x<0||o.topLeft.y<0||o.bottomRight.x>i||o.bottomRight.y>s){const u=i/e.x,l=s/e.y,f=Math.min(X,u,l);f<X-5e-4&&(Q(Math.max(pt,f)),o=a(),o.topLeft.x<0&&(x=x.add(new b(-o.topLeft.x,0))),o.topLeft.y<0&&(x=x.add(new b(0,-o.topLeft.y))),o.bottomRight.x>i&&(x=x.sub(new b(o.bottomRight.x-i,0))),o.bottomRight.y>s&&(x=x.sub(new b(0,o.bottomRight.y-s))),ve(),Lt())}}function Mg(){if(ne.isArrayEmpty(w.pieces))return;const r=(Y==null?void 0:Y.clientWidth)||0,e=(Y==null?void 0:Y.clientHeight)||0;if(r===0||e===0)return;const t=A.calculatePiecesBounds(w.pieces);if(!t)return;const n=t.topLeft.x,i=t.topLeft.y,s=t.bottomRight.x,a=t.bottomRight.y;if(!isFinite(n)||!isFinite(i)||!isFinite(s)||!isFinite(a))return;const o=Math.max(1,s-n),c=Math.max(1,a-i),d=Math.min(r/o,e/c),u=Math.max(pt,Math.min(zd,d));Q(u),x=new b(-n*u,-i*u),ve()}const $d="north",Wd="east",Vd="south",Kd="west",Ll=[$d,Wd,Vd,Kd],Ol="nw",Ml="ne",Dl="se",Nl="sw",Fl=30,Yd=Fl*Fl,Dg=Yd,kl=2,Ng=kl*kl,Fg=1.5,Ue={CONNECTION_TOLERANCE:Yd,ALIGNMENT_TOLERANCE:Dg,PROFILE_TOLERANCE:Ng};let Ne=null;function jl(r){switch(r){case $d:return{first:Ol,second:Ml};case Wd:return{first:Ml,second:Dl};case Vd:return{first:Dl,second:Nl};case Kd:return{first:Nl,second:Ol};default:return{first:null,second:null}}}function kg(r,e){if(r.length===0)return!1;const t=Math.max(...r),n=Math.min(...r);return t-n<=e}function Gl(r,e,t,n,i=!1){if(r.length!==e.length)return null;let s=[],a=!0;for(let o=0;o<r.length;o++){const c=Ff(r[o],e[o]);if(s.push(c),c>t){a=!1;break}}if(a){const o=kg(s,n);return{reversed:i,distances2:s,profileValid:o}}return null}function jg(r,e,t,n){const i=xe(),s=Ue.CONNECTION_TOLERANCE/(i*i),a=Ue.PROFILE_TOLERANCE/(i*i);let o=null;return Ll.forEach(c=>{if(!r.sPoints[c])return;const u=jl(c),l=t.worldCorners[u.first],f=t.worldCorners[u.second],h=t.worldSPoints[c];Ll.forEach(g=>{if(!e.sPoints[g])return;const y=jl(g),m=n.worldCorners[y.first],_=n.worldCorners[y.second],v=n.worldSPoints[g],I=[l,h,f],S=[m,v,_],E=Gl(I,S,s,a)||Gl(I,[...S].reverse(),s,a,!0);if(E&&E.profileValid){const P=E.distances2.reduce((q,M)=>q+M,0);let R;E.reversed?R=y.second:R=y.first,(!o||P<o.score)&&(o={score:P,stationaryPieceId:e.id,mapping:{movingCornerA:u.first,stationaryCornerA:R}})}})}),o}function Xd(r){const e=r.worldData,t=r.bitmap.width*r.scale,n=r.bitmap.height*r.scale,s=Math.max(t,n)*Fg,a=r.getCenter(),o=A.queryRadius(a,s);let c=null;return o.forEach(d=>{if(d===r.id)return;const u=w.pieces.find(g=>g.id===d),l=z.getGroupForPiece(u),f=z.getGroupForPiece(r);if(l&&f&&l===f)return;const h=jg(r,u,e,u.worldData);h&&(!c||h.score<c.score)&&(c=h)}),c}function Zd(r){if(!r||r.length===0){Ne&&(Ne=null,zs(null));return}const e=[...new Set(r.map(i=>i.candidate.stationaryPieceId))],t=Ne?Ne.map(i=>i.pieceId).sort().join(","):"",n=e.sort().join(",");t!==n&&(Ne=r.map(i=>({pieceId:i.candidate.stationaryPieceId,data:i.candidate})),zs(e))}function Gg(){Zd(null)}function Bg(r,e){if(!e)return;const t=w.pieces.find(i=>i.id===e.stationaryPieceId);if(!t)return;const n=t.worldData.worldCorners[e.mapping.stationaryCornerA].sub(r.worldData.worldCorners[e.mapping.movingCornerA]);A&&r.groupId&&A.moveGroup(r.groupId,n)}function Jd(r){r.tolerance!=null&&(Ue.CONNECTION_TOLERANCE=r.tolerance,Ue.ALIGNMENT_TOLERANCE=r.tolerance),r.profileTolerance!=null&&(Ue.PROFILE_TOLERANCE=r.profileTolerance)}B(ha,r=>{const e=r.detail.piece;if(!e)return;const t=z.getGroup(e.groupId),n=t?t.allBorderPieces:[e],i=[];for(const s of n){const a=Xd(s);a&&a.stationaryPieceId!=null&&i.push({movingPiece:s,candidate:a})}Zd(i.length>0?i:null)});B(Xe,r=>{const e=r.detail.piece;if(!e)return;const t=z.getGroup(e.groupId),n=t?t.allBorderPieces:[e],i=[];for(const s of n){const a=Xd(s);a&&a.stationaryPieceId!=null&&i.push({movingPiece:s,candidate:a})}if(i.length>0){i.sort((o,c)=>o.candidate.score-c.candidate.score);const s=i[0],a=w.pieces.find(o=>o.id===s.candidate.stationaryPieceId);a&&(Bg(s.movingPiece,s.candidate),z.mergeGroups(s.movingPiece,a))}Gg()});const Te=.7;function Bl(r,e){const t={};for(const[n,i]of Object.entries(r))i instanceof b?t[n]=i.sub(e):t[n]=i;return t}function zl(r){const e={};for(const[t,n]of Object.entries(r))n&&typeof n.x=="number"&&typeof n.y=="number"?e[t]=new b(n.x,n.y):e[t]=n;return e}function Qd(r){if(!r||r.length===0)return $.fromPoints(new b(0,0),new b(0,0));let e=1/0,t=-1/0,n=1/0,i=-1/0;for(const s of r)s&&s.x!==void 0&&s.y!==void 0&&(e=Math.min(e,s.x),t=Math.max(t,s.x),n=Math.min(n,s.y),i=Math.max(i,s.y));return isFinite(e)?$.fromPoints(new b(e,n),new b(t,i)):$.fromPoints(new b(0,0),new b(0,0))}class Ve{constructor(e){this.id=e.id,this.gridPos=new b(e.gridX,e.gridY),this._groupId=e.groupId||null,this.imgRect=new $(new b(e.imgX,e.imgY),e.w,e.h),this.bitmap=e.bitmap,this.path=e.path,this.scale=e.scale||Te;const t=e.nw instanceof b?e.nw:new b(e.displayX||0,e.displayY||0);if(this.rotation=e.rotation||0,this.zIndex=e.zIndex!==void 0?e.zIndex:null,e.geometryCorners&&e.geometrySidePoints&&e.nw?(this.corners=Bl(e.geometryCorners,e.nw),this.sPoints=Bl(e.geometrySidePoints,e.nw)):(this.corners=zl(e.corners),this.sPoints=zl(e.sPoints)),!this.path&&this.corners&&this.sPoints&&(this.path=this.generatePath()),!this.bitmap&&e.master&&this.path&&e.nw){const n=this.calculateBoundingFrame();this.bitmap=Lg(n,this.path,e.nw,e.master)}A.setPiecePosition(this.id,t)}get worldData(){return A.getWorldData(this)}get groupId(){return this._groupId}getCenter(e=null){return A.getCenter(this,e)}rotate(e){this.rotation=(this.rotation+e)%360,this.rotation<0&&(this.rotation+=360)}setRotation(e){this.rotation=e%360,this.rotation<0&&(this.rotation+=360)}_setGroupId(e){this._groupId=e}getWorldCorners(){var e;return((e=this.worldData)==null?void 0:e.worldCorners)||{}}getWorldSidePoints(){var e;return((e=this.worldData)==null?void 0:e.worldSPoints)||{}}calculateBoundingFrame(){const e=this.corners,t=this.sPoints,n=[e.nw,e.ne,e.se,e.sw];t.north&&n.push(t.north),t.east&&n.push(t.east),t.south&&n.push(t.south),t.west&&n.push(t.west);const i=Qd(n);return i.width===0&&i.height===0?$.fromPoints(new b(0,0),new b(this.imgRect.width,this.imgRect.height)):i}generatePath(){const e=[];e.push(this.corners.nw),this.sPoints.north&&e.push(this.sPoints.north),e.push(this.corners.ne),this.sPoints.east&&e.push(this.sPoints.east),e.push(this.corners.se),this.sPoints.south&&e.push(this.sPoints.south),e.push(this.corners.sw),this.sPoints.west&&e.push(this.sPoints.west);const t=new Path2D;t.moveTo(e[0].x,e[0].y);for(let n=1;n<e.length;n++)t.lineTo(e[n].x,e[n].y);return t.closePath(),t}serialize(e=!1){var i;const t=A.getPiecePosition(this.id)||new b(0,0),n={id:this.id,gridX:this.gridPos.x,gridY:this.gridPos.y,rotation:this.rotation,displayX:t.x,displayY:t.y,groupId:this.groupId,zIndex:this.zIndex,corners:this.corners,sPoints:this.sPoints,w:this.imgRect.width,h:this.imgRect.height,scale:Te,imgX:this.imgRect.position.x,imgY:this.imgRect.position.y};if(e&&((i=this.bitmap)!=null&&i.toDataURL))try{n.bitmapData=this.bitmap.toDataURL()}catch(s){console.warn(`[Piece] Failed to serialize bitmap for piece ${this.id}:`,s)}return n}static deserialize(e,t,n){return new Ve({...e,bitmap:t,path:n})}toString(){const e=A.getPiecePosition(this.id)||new b(0,0);return`Piece{id:${this.id}, grid:(${this.gridPos.x},${this.gridPos.y}), pos:(${e.x.toFixed(1)},${e.y.toFixed(1)}), rot:${this.rotation}, group:${this.groupId}}`}}const zg="PuzzleImageStorage",Hg=1,fe="images";let me=null;async function ga(){return me||new Promise((r,e)=>{const t=indexedDB.open(zg,Hg);t.onerror=()=>{console.error("Failed to open IndexedDB:",t.error),e(t.error)},t.onsuccess=()=>{me=t.result,console.log("IndexedDB initialized successfully"),r(me)},t.onupgradeneeded=n=>{const i=n.target.result;if(!i.objectStoreNames.contains(fe)){const s=i.createObjectStore(fe,{keyPath:"id"});s.createIndex("filename","filename",{unique:!1}),s.createIndex("timestamp","timestamp",{unique:!1}),console.log("Created IndexedDB object store")}}})}function Ze(){return"indexedDB"in window}async function Ug(r){if(!Ze())throw new Error("IndexedDB not supported");try{await ga();try{await Wg(),console.log("Cleared previous images before storing new one")}catch(i){console.warn("Failed to clear previous images, proceeding anyway:",i)}const e=`img_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,t=r instanceof Blob?r:new Blob([r]),n={id:e,filename:r.name||"uploaded_image",blob:t,size:t.size,type:t.type,timestamp:Date.now()};return new Promise((i,s)=>{const c=me.transaction([fe],"readwrite").objectStore(fe).add(n);c.onsuccess=()=>{console.log(`Stored image in IndexedDB: ${e} (previous images cleared)`),i({imageId:e,filename:n.filename,size:n.size,type:n.type})},c.onerror=()=>{console.error("Failed to store image in IndexedDB:",c.error),s(c.error)}})}catch(e){throw console.error("Error storing image in IndexedDB:",e),e}}async function $g(r){if(!Ze())throw new Error("IndexedDB not supported");try{return await ga(),new Promise((e,t)=>{const s=me.transaction([fe],"readonly").objectStore(fe).get(r);s.onsuccess=()=>{const a=s.result;a?(console.log(`Loaded image from IndexedDB: ${r}`),e({id:a.id,filename:a.filename,blob:a.blob,size:a.size,type:a.type,timestamp:a.timestamp})):t(new Error(`Image not found: ${r}`))},s.onerror=()=>{console.error("Failed to load image from IndexedDB:",s.error),t(s.error)}})}catch(e){throw console.error("Error loading image from IndexedDB:",e),e}}async function Wg(){if(!Ze())throw new Error("IndexedDB not supported");try{return await ga(),new Promise((r,e)=>{const i=me.transaction([fe],"readwrite").objectStore(fe).clear();i.onsuccess=()=>{console.log("Cleared all images from IndexedDB"),r(!0)},i.onerror=()=>{console.error("Failed to clear images from IndexedDB:",i.error),e(i.error)}})}catch(r){throw console.error("Error clearing images from IndexedDB:",r),r}}const Je="puzzle.save.v2",Vg=1200,ef=!1,Kg=1,Yg=25e5;let Ot=!1,Os=null,L=null;function Hl(r){L=r,window.puzzlePersistence={manualSave:Hs,load:Us,clear:Ke,stats:()=>{var e;return{size:((e=localStorage.getItem(Je))==null?void 0:e.length)||0}}},window.addEventListener("beforeunload",()=>{if(Ot)try{Hs()}catch{}})}function ma(){Ot=!0,Os&&clearTimeout(Os),Os=setTimeout(()=>{Hs()},Vg)}function Xg(r){let e=0,t=0;for(const n of r)n.gridY>e&&(e=n.gridY),n.gridX>t&&(t=n.gridX);return{rows:e+1,cols:t+1}}function Zg(r=ef){if(!L)return null;const e=L.getState();if(ne.isArrayEmpty(e.pieces))return null;const t=e.pieces.map(s=>{var a,o;if(typeof s.serialize=="function")return s.serialize(r);{let c=null;if(r)try{c=(o=(a=s.bitmap)==null?void 0:a.toDataURL)==null?void 0:o.call(a)}catch{c=null}const d=gameTableController.getPiecePosition(s.id)||new b(0,0);return{id:s.id,gridX:s.gridX,gridY:s.gridY,rotation:s.rotation,displayX:d.x,displayY:d.y,groupId:s.groupId,sPoints:s.sPoints,w:s.imgRect.width,h:s.imgRect.height,scale:s.scale,imgX:s.imgRect.position.x,imgY:s.imgRect.position.y,bitmapData:c}}}),{rows:n,cols:i}=Xg(e.pieces);return{version:"puzzleStateV2",savedAt:Date.now(),layout:{rows:n,cols:i},ui:{...L.getViewportState(),sliderValue:L.getSliderValue()},totalPieces:e.totalPieces,pieces:t,light:!r}}function Hs(){if(L)try{const r=L.getCurrentImage(),e=L.getCurrentImageSource();let t=ef,n=0;for(;n<=Kg;){const i=Zg(t);if(!i)return;if(e&&(i.imageSource={source:e,width:((r==null?void 0:r.naturalWidth)||(r==null?void 0:r.width))??null,height:((r==null?void 0:r.naturalHeight)||(r==null?void 0:r.height))??null},typeof L.getCurrentImageId=="function")){const a=L.getCurrentImageId();a&&(i.imageSource.imageId=a,console.log("[persistence] Stored image ID for IndexedDB source:",a))}const s=JSON.stringify(i);if(s.length>Yg&&t){console.warn(`[persistence] Payload ~${s.length}B above soft limit; retry without bitmaps.`),t=!1,n++;continue}try{localStorage.setItem(Je,s),Ot=!1;break}catch(a){if(t&&(a.name==="QuotaExceededError"||a.code===22)){console.warn("[persistence] Quota exceeded with bitmaps; retrying without them."),t=!1,n++;continue}console.warn("[persistence] Save failed",a);break}}}catch(r){console.warn("[persistence] Save failed (outer)",r)}}function Jg(){return!!localStorage.getItem(Je)}function Ke(){localStorage.removeItem(Je),console.info("[persistence] Cleared save")}function at(){const r=Jg();L&&typeof L.showResumePrompt=="function"?L.showResumePrompt({onResume:r?()=>Us():null,onDiscard:()=>{r&&Ke(),L.afterDiscard&&L.afterDiscard()},onCancel:()=>{},hasResume:r}):r&&window.confirm("Resume previous puzzle session?")?Us():!r&&L.afterDiscard&&L.afterDiscard()}function Us(){var t,n;if(!L)return;const r=localStorage.getItem(Je);if(!r)return;let e;try{e=JSON.parse(r)}catch{console.warn("[persistence] Corrupt save; clearing"),Ke();return}if(e.version!=="puzzleStateV2"&&e.version!=="puzzleStateV1"){console.warn("[persistence] Version mismatch:",e.version);return}if((t=e.imageSource)!=null&&t.source){const i=e.imageSource.source;L.setImageSource(i);const s=new Image;if(s.onload=()=>{L.setImage(s),te(e,s)},s.onerror=()=>{console.warn("[persistence] Failed to load image from source:",i),console.warn("[persistence] This may be due to file being moved or URL no longer accessible"),te(e,null)},i.startsWith("idb:")&&e.imageSource.imageId){if(console.log("[persistence] Attempting to load IndexedDB source:",e.imageSource.imageId),Ze())try{$g(e.imageSource.imageId).then(a=>{const o=URL.createObjectURL(a.blob);s.src=o,L.setImageId(a.id),s.onload=()=>{URL.revokeObjectURL(o),L.setImage(s),te(e,s)}}).catch(a=>{console.warn("[persistence] Failed to load IndexedDB image:",a),console.warn("[persistence] Image may have been deleted from browser storage"),te(e,null)});return}catch(a){console.warn("[persistence] IndexedDB loading failed:",a)}else console.warn("[persistence] IndexedDB not supported in this browser");console.warn("[persistence] Cannot reload IndexedDB image"),te(e,null);return}else i.startsWith("http://")||i.startsWith("https://")?(s.crossOrigin="anonymous",s.src=i):(console.warn("[persistence] Cannot reload local file:",i),console.warn("[persistence] Please select the file again if you want to see the image"),te(e,null))}else if((n=e.image)!=null&&n.src){const i=new Image;i.onload=()=>{L.setImage(i),te(e,i)},i.onerror=()=>{console.warn("[persistence] Failed to load embedded image"),te(e,null)},i.src=e.image.src}else te(e,null)}function te(r,e){var i;const t=r.pieces.map(s=>{const a=new Ve({id:-1,gridY:s.gridY||0,gridX:s.gridX||0,corners:s.corners||{nw:{x:0,y:0},ne:{x:s.w,y:0},se:{x:s.w,y:s.h},sw:{x:0,y:s.h}},sPoints:s.sPoints||{},w:s.w,h:s.h}),o=a.generatePath(),c=a.calculateBoundingFrame(),d=Math.ceil(c.width),u=Math.ceil(c.height),l=document.createElement("canvas");l.width=d,l.height=u;const f=l.getContext("2d");if(s.bitmapData){const h=new Image;h.src=s.bitmapData,h.onload=()=>f.drawImage(h,0,0)}else if(e){f.save(),f.translate(-c.topLeft.x,-c.topLeft.y),f.clip(o);const h=s.imgX??0,g=s.imgY??0,p=new b(h,g),y=c.topLeft.add(p),m=c.bottomRight.add(p),_=new $(y,m.x-y.x,m.y-y.y);let v=m.x-y.x,I=m.y-y.y;const S=e.naturalWidth||e.width,E=e.naturalHeight||e.height,P=Math.max(0,_.position.x),R=Math.max(0,_.position.y),q=Math.min(v,S-P),M=Math.min(I,E-R),C=P-h,N=R-g;f.drawImage(e,P,R,q,M,C,N,q,M),f.restore()}else f.fillStyle="#222",f.fillRect(0,0,d,u);return new Ve({id:s.id,gridX:s.gridX,gridY:s.gridY,rotation:s.rotation,position:new b(s.displayX||0,s.displayY||0),groupId:s.groupId,zIndex:s.zIndex,sPoints:s.sPoints,w:s.w,h:s.h,scale:s.scale,imgX:s.imgX,imgY:s.imgY,bitmap:l,path:o,corners:s.corners||{nw:{x:0,y:0},ne:{x:s.w,y:0},se:{x:s.w,y:s.h},sw:{x:0,y:s.h}}})});L.setPieces(t);const n=L.getState();n&&(n.noRotate=!1),L.renderPiecesFromState?L.renderPiecesFromState():L.redrawPiecesContainer(),r.ui&&typeof r.ui.zoomLevel=="number"&&typeof r.ui.panX=="number"&&typeof r.ui.panY=="number"&&L.applyViewportState(r.ui),((i=r.ui)==null?void 0:i.sliderValue)!=null&&L.setSliderValue(r.ui.sliderValue),console.info("[persistence] Loaded game",{pieces:t.length,light:r.light}),Ot=!1}class Qg{constructor(){this.lastPosition=null,this.lastTimestamp=null,this.currentCurvature=1,this.positionWindow=[],this.maxPositionSamples=10,this.curvatureThreshold=8,this.curvatureCallbacks=[],this.isDragging=!1,this._setupEventListeners()}_setupEventListeners(){B(ha,e=>{this.dragEvent(e.detail)}),B(Xe,()=>{this.endDrag()})}dragEvent(e){const t=e.timestamp||performance.now(),n={x:e.x,y:e.y};if(this.lastPosition===null||this.lastTimestamp===null){this.lastPosition=n,this.lastTimestamp=t,this.isDragging=!0;return}this.positionWindow.push({x:n.x,y:n.y,timestamp:t}),this.positionWindow.length>this.maxPositionSamples&&this.positionWindow.shift(),this.calculateCurvature(),this.checkCurvatureCallbacks(),this.lastPosition=n,this.lastTimestamp=t,this.isDragging=!0}calculateCurvature(){if(this.positionWindow.length<3){this.currentCurvature=1;return}let e=0;for(let o=1;o<this.positionWindow.length;o++){const c=this.positionWindow[o-1],d=this.positionWindow[o],u=d.x-c.x,l=d.y-c.y;e+=Math.sqrt(u*u+l*l)}const t=this.positionWindow[0],n=this.positionWindow[this.positionWindow.length-1],i=n.x-t.x,s=n.y-t.y,a=Math.sqrt(i*i+s*s);a<1?this.currentCurvature=1:this.currentCurvature=e/a}getCurvature(){return this.currentCurvature}registerCurvatureCallback(e,t){if(typeof e!="number"||e<=0)return console.warn("[DragMonitor] Invalid curvature threshold:",e),()=>{};if(typeof t!="function")return console.warn("[DragMonitor] Invalid callback:",t),()=>{};const n={threshold:e,callback:t,lastTriggered:0};return this.curvatureCallbacks.push(n),()=>{const i=this.curvatureCallbacks.indexOf(n);i!==-1&&this.curvatureCallbacks.splice(i,1)}}checkCurvatureCallbacks(){this.currentCurvature>=this.curvatureThreshold&&document.dispatchEvent(new CustomEvent(jd,{detail:{curvature:this.currentCurvature,threshold:this.curvatureThreshold,positionCount:this.positionWindow.length}}));const e=performance.now();for(const t of this.curvatureCallbacks)if(this.currentCurvature>=t.threshold&&e-t.lastTriggered>100){t.lastTriggered=e;try{t.callback({curvature:this.currentCurvature,threshold:t.threshold,positionCount:this.positionWindow.length})}catch(n){console.error("[DragMonitor] Curvature callback error:",n)}}}endDrag(){this.isDragging=!1,this.currentCurvature=1,this.lastPosition=null,this.lastTimestamp=null,this.positionWindow=[]}reset(){this.currentCurvature=1,this.positionWindow=[],this.lastPosition=null,this.lastTimestamp=null,this.isDragging=!1}getStatistics(){return{currentCurvature:this.currentCurvature,positionWindowCount:this.positionWindow.length,isDragging:this.isDragging,curvatureCallbackCount:this.curvatureCallbacks.length}}}new Qg;let U=null,j=null;function em(r){j=r,B(fa,e=>{const{pieceId:t,rotation:n}=e.detail;im(t,n)}),B(Xe,e=>{const{pieceId:t,wentOutside:n}=e.detail;nm(t,n)}),B(kd,e=>{sm()})}function Ul(r){const e=typeof r=="string"?parseInt(r,10):r;if(isNaN(e)||e==null){console.warn("[hlInteractionHandler] onPieceSelected: invalid ID",r);return}const t=Qe(e);if(!t){console.warn("[hlInteractionHandler] onPieceSelected: piece not found for ID",e);return}if((U==null?void 0:U.id)===e)return;const n=(U==null?void 0:U.id)??null;U=t,A.bringToFront(e),j!=null&&j.onPieceSelectedVisual&&j.onPieceSelectedVisual(e,n),document.dispatchEvent(new CustomEvent(At,{detail:{pieceId:e,piece:t}}))}function tm(){if(U){const r=U.id;U=null,j!=null&&j.onPieceDeselectedVisual&&j.onPieceDeselectedVisual(r),document.dispatchEvent(new CustomEvent(We,{detail:{pieceId:r}}))}}function rm(r,e){const t=Qe(r);t&&(t.groupId?A.moveGroup(t.groupId,e):A.movePiece(t.id,e))}function nm(r,e){Qe(r)&&(e?Mg():j!=null&&j.onEnsurePieceInView&&j.onEnsurePieceInView(r))}function im(r,e){const t=Qe(r);if(t){if(w.noRotate){console.log("[hlInteractionHandler] Rotation disabled (noRotate mode)");return}A.rotatePieceOrGroup(t.id,e),j!=null&&j.onEnsurePieceInView&&j.onEnsurePieceInView(r)}}function Ms(r){const e=Qe(r);if(!e)return;if(!z.detachPiece(e)){console.error("[hlInteractionHandler] GroupManager detachment failed - piece cannot be detached");return}A.bringToFront(e.id),j!=null&&j.onPieceDetachedVisual&&j.onPieceDetachedVisual(e.id)}function tf(){return U}function sm(){if(!U)return!1;const r=U.rotation;if(r===0)return!0;let e=-r;e<=-180&&(e+=360),e>180&&(e-=360);const t=z.getGroup(U.groupId);return t&&t.size()>1?A.rotateGroup(t.id,e,U):A.rotatePiece(U.id,e),!0}function Qe(r){const e=typeof r=="string"?parseInt(r,10):r;return w.pieces.find(t=>t.id===e)}const ot=40,Ds=1e3;class rf{constructor(e){this.pieceElements=e,this.activeTouchIds=new Set,this.longPressTimer=null,this.longPressStartTime=null,this.longPressPieceId=null,this.dragPauseTimer=null,this.isDragging=!1,this.highCurvatureDetach=!1,this._initialize()}_initialize(){em({onPieceSelectedVisual:(t,n)=>{n!=null&&document.dispatchEvent(new CustomEvent(We,{detail:{pieceId:n}})),document.dispatchEvent(new CustomEvent(At,{detail:{pieceId:t}}))},onPieceDeselectedVisual:t=>{document.dispatchEvent(new CustomEvent(We,{detail:{pieceId:t}}))},onPieceDetachedVisual:t=>{document.dispatchEvent(new CustomEvent(Fd,{detail:{pieceId:t}}))},onEnsurePieceInView:t=>{const n=w.pieces.find(s=>s.id===t),i=this.pieceElements.get(t);if(n&&i){const s=A.getPiecePosition(n.id)||new b(0,0);Og(s,new b(i.offsetWidth,i.offsetHeight),{forceZoom:!1})}}});try{this.pieceElements.forEach((t,n)=>{var i=window.interact(t);i.unset(),i=window.interact(t),i.draggable({listeners:{start:s=>this._onDragStart(s),move:s=>this._onDragMove(s),end:s=>this._onDragEnd(s)}}).on("tap",s=>this._onTap(s)).on("doubletap",s=>this._onDoubleTap(s)).on("down",s=>this._onPointerDown(s)).on("up",s=>this._onPointerUp(s)),i.options&&i.options.actions&&(i.options.actions.doubletap={interval:500,distance:30})});var e=window.interact("#piecesContainer");e.unset(),e=window.interact("#piecesContainer"),e.on("tap",t=>this._onContainerTap(t)).draggable({ignoreFrom:".piece",listeners:{start:t=>this._onViewportDragStart(t),move:t=>this._onViewportDragMove(t),end:t=>this._onViewportDragEnd(t)}})}catch(t){throw console.error("[interactionManager] Error configuring interact.js:",t),t}B(jd,t=>{this.highCurvatureDetach=!0})}addPieceInteraction(e){const t=window.interact(e);t.draggable({origin:"self",listeners:{start:n=>this._onDragStart(n),move:n=>this._onDragMove(n),end:n=>this._onDragEnd(n)}}).on("tap",n=>this._onTap(n)).on("doubletap",n=>this._onDoubleTap(n)).on("down",n=>this._onPointerDown(n)).on("up",n=>this._onPointerUp(n)),t.options&&t.options.actions&&(t.options.actions.doubletap={interval:500,distance:30})}_onDragStart(e){const{element:t,pieceId:n}=this.getNearestPieceId(e);Ul(n),e.interaction.pointerType==="touch"&&this.activeTouchIds.add(e.interaction.id),Pg(),this.isDragging=!0,this._clearDragPauseTimer();const i=e.shiftKey,s=e.interaction.pointerType==="touch"&&this.activeTouchIds.size>=2,a=this.longPressStartTime!==null&&String(this.longPressPieceId)===String(n)&&performance.now()-this.longPressStartTime>=Ds;(i||s||a)&&Ms(n),document.dispatchEvent(new CustomEvent(pe,{detail:{pieceId:n}})),this._clearLongPressTimer(),this.longPressStartTime=null,this.longPressPieceId=null}_onDragMove(e){const{element:t,pieceId:n}=this.getNearestPieceId(e),i=w.pieces.find(c=>c.id===n);if(!i)return;document.dispatchEvent(new CustomEvent(ha,{detail:{piece:i,x:e.client.x,y:e.client.y,timestamp:performance.now()}}));const s=Ud(),a=e.dx/s.zoomLevel,o=e.dy/s.zoomLevel;if(this.highCurvatureDetach){const c=z.getGroup(i.groupId);c&&c.size()>1&&Ms(i.id),this.highCurvatureDetach=!1}if(this._clearDragPauseTimer(),document.dispatchEvent(new CustomEvent(pe,{detail:{pieceId:n}})),i.groupId){const c=z.getGroup(i.groupId);c&&c.size()>1&&(this.dragPauseTimer=setTimeout(()=>{document.dispatchEvent(new CustomEvent(ks,{detail:{pieceId:i.id}})),Ms(i.id),setTimeout(()=>{document.dispatchEvent(new CustomEvent(pe,{detail:{pieceId:i.id}}))},300)},Ds))}rm(i.id,new b(a,o)),this._checkBoundaries(t,i)}_onDragEnd(e){const{element:t,pieceId:n}=this.getNearestPieceId(e);e.interaction.pointerType==="touch"&&this.activeTouchIds.delete(e.interaction.id),this.isDragging=!1,this._clearDragPauseTimer(),document.dispatchEvent(new CustomEvent(pe,{detail:{pieceId:n}})),this.highCurvatureDetach=!1;const i=t.hasAttribute("data-outside");i&&t.removeAttribute("data-outside");const s=w.pieces.find(a=>a.id===n);document.dispatchEvent(new CustomEvent(Xe,{detail:{pieceId:n,wentOutside:i,piece:s}}))}_onPointerDown(e){const{pieceId:t}=this.getNearestPieceId(e);this.longPressStartTime=performance.now(),this.longPressPieceId=t,this._clearLongPressTimer(),this.longPressTimer=setTimeout(()=>{document.dispatchEvent(new CustomEvent(ks,{detail:{pieceId:parseInt(t,10)}}))},Ds)}_onPointerUp(e){const{pieceId:t}=this.getNearestPieceId(e);document.dispatchEvent(new CustomEvent(pe,{detail:{pieceId:t}})),this._clearLongPressTimer(),this.longPressStartTime=null,this.longPressPieceId=null}_onTap(e){const{pieceId:t}=this.getNearestPieceId(e);Ul(t)}_onDoubleTap(e){const{pieceId:t}=this.getNearestPieceId(e);document.dispatchEvent(new CustomEvent(pe,{detail:{pieceId:t}})),this._clearLongPressTimer(),this.longPressStartTime=null,this.longPressPieceId=null,e.preventDefault(),e.stopPropagation(),document.dispatchEvent(new CustomEvent(fa,{detail:{pieceId:t,rotation:90}}))}getNearestPieceId(e){const t=e.target.closest(".piece")||e.target,n=parseInt(t.dataset.id,10);return{element:t,pieceId:n}}_onContainerTap(e){(e.target.id==="piecesContainer"||e.target.classList.contains("pieces-viewport"))&&(this._clearLongPressTimer(),this.longPressStartTime=null,this.longPressPieceId=null,tm())}_checkBoundaries(e,t){const i=e.parentElement.getBoundingClientRect(),s=A.getPiecePosition(t.id),a=s.x<-ot,o=s.y<-ot,c=s.x+e.offsetWidth>i.width+ot,d=s.y+e.offsetHeight>i.height+ot,u=a||o||c||d;u&&!e.hasAttribute("data-outside")?e.setAttribute("data-outside","true"):!u&&e.hasAttribute("data-outside")&&e.removeAttribute("data-outside")}getPieceElement(e){return this.pieceElements.get(e)}applyHighlight(e){zs(e)}_clearLongPressTimer(){this.longPressTimer&&(clearTimeout(this.longPressTimer),this.longPressTimer=null)}_clearDragPauseTimer(){this.dragPauseTimer&&(clearTimeout(this.dragPauseTimer),this.dragPauseTimer=null)}_onViewportDragStart(e){const t=document.getElementById("piecesContainer");e.preventDefault(),xl(new b(e.client.x,e.client.y)),t.style.cursor="grabbing"}_onViewportDragMove(e){e.preventDefault();const t=new b(e.client.x,e.client.y),n=t.sub(qg());Rg(Sg().add(n)),xl(t)}_onViewportDragEnd(e){const t=document.getElementById("piecesContainer");t.style.cursor="grab",ma()}}const J=new Map,am=Te,$l=24,Fe=am;function nf(r){if(A.getPiecePosition(r.id)instanceof b)return r;const t=A.getPiecePosition(r.id);if(!t||!(t instanceof b)){const n=(t==null?void 0:t.x)||0,i=(t==null?void 0:t.y)||0;A.setPiecePosition(r.id,new b(n,i))}return r}function om(r,e,t=!1){const n=r.clientWidth||800,i=r.clientHeight||600;if(J.clear(),e.reduce((o,c)=>o+Math.min(c.imgRect.width,c.imgRect.height),0)/e.length*Fe,t)e.forEach(o=>{o.setRotation(0)});else{const o=[0,90,180,270];e.forEach(c=>{const d=o[Math.floor(Math.random()*o.length)];c.setRotation(d)})}const s=[];e.forEach(o=>{const c=document.createElement("div");c.className="piece",c.dataset.id=o.id;const d=document.createElement("canvas"),u=Math.max($l,o.bitmap.width*Fe),l=Math.max($l,o.bitmap.height*Fe);d.width=u,d.height=l;const f=d.getContext("2d");f.save(),f.scale(Fe,Fe),f.drawImage(o.bitmap,0,0),f.restore(),c.style.width=u+"px",c.style.height=l+"px";const h=Math.random()*(n-u),g=Math.random()*(i-l),p=new b(h+u/2,g+l/2);s.push(p),nf(o),c.appendChild(d),r.appendChild(c),J.set(o.id,c),o.scale=Te});const a=e.length;for(let o=0;o<a;o++){const c=Math.floor(Math.random()*e.length),d=Math.floor(Math.random()*e.length);if(c!==d){const u=s[c];s[c]=s[d],s[d]=u}}new rf(J),e.forEach((o,c)=>{const d=J.get(o.id);A.placePieceCenter(o.id,s[c],d),He(o)}),z.initialize(),Jd({}),A.updateViewportArea(n,i),A.syncAllPositions(),A.attachPieceElements(J)}function cm(r,e){var i;const t=r.clientWidth||800,n=r.clientHeight||600;console.debug("[pieceRenderer] renderPiecesAtPositions count",e.length),J.clear(),e.reduce((s,a)=>s+Math.min(a.imgRect.width,a.imgRect.height),0)/e.length*(((i=e[0])==null?void 0:i.scale)||Te),e.forEach(s=>{const a=document.createElement("div");a.className="piece",a.dataset.id=s.id;const o=document.createElement("canvas"),c=s.scale||Te,d=Math.max(24,s.bitmap.width*c),u=Math.max(24,s.bitmap.height*c);o.width=d,o.height=u;const l=o.getContext("2d");l.save(),l.scale(c,c),l.drawImage(s.bitmap,0,0),l.restore(),a.style.width=d+"px",a.style.height=u+"px",s.zIndex!==null&&s.zIndex!==void 0&&(a.style.zIndex=s.zIndex.toString()),nf(s),He(s),a.appendChild(o),s.scale=c,J.set(s.id,a),r.appendChild(a)}),z.initialize(),Jd({tolerance:900}),A.updateViewportArea(t,n),A.syncAllPositions(),A.initializeMaxZIndex(),A.attachPieceElements(J),new rf(J)}function va(r){return J.get(r)}let sf="en",ge={};function um(r,e){return e?Object.entries(e).reduce((t,[n,i])=>t.replace(new RegExp("{"+n+"}","g"),i),r):r}function T(r,e){const t=ge[r]||r;return um(t,e)}async function $s(r){try{const t=await fetch(`/pzl/i18n/${r}.json`,{cache:"no-cache"});if(!t.ok)throw new Error(`${t.status} ${t.statusText}`);ge=await t.json(),sf=r,localStorage.setItem("lang",r),af()}catch(e){console.warn("[i18n] Failed to load language",r,e),r!=="en"&&await $s("en")}}function af(){document.querySelectorAll("[data-i18n]").forEach(e=>{const t=e.dataset.i18n;ge[t]&&(e.innerHTML=T(t))}),document.querySelectorAll("[data-i18n-title]").forEach(e=>{const t=e.dataset.i18nTitle;ge[t]&&(e.title=T(t))}),document.querySelectorAll("[data-i18n-aria-label]").forEach(e=>{const t=e.dataset.i18nAriaLabel;ge[t]&&e.setAttribute("aria-label",T(t))});const r=document.querySelector("#helpModal .modal-body");r&&ge["help.bodyHtml"]&&(r.innerHTML=ge["help.bodyHtml"]),fm()}async function lm(){var i;const r=localStorage.getItem("lang"),e=((i=navigator.language)==null?void 0:i.toLowerCase())||"en";let t="en";e.startsWith("de")?t="de":e.startsWith("ru")?t="ru":e.startsWith("ua")&&(t="ua"),await $s(r||t||"en");const n=document.getElementById("langSelect");n&&(n.value=sf,n.addEventListener("change",s=>{const a=s.target.value;$s(a)}))}function dm({onResume:r,onDiscard:e,onCancel:t,hasResume:n=!0}){const i=document.getElementById("resume-modal-overlay");i&&i.remove();const s=document.createElement("div");s.id="resume-modal-overlay";const a=n?`
    <button class="resume-primary" data-action="resume">${T("resume.resume")}</button>
    <button class="resume-warn" data-action="cancel">${T("resume.cancel")}</button>
    <button class="resume-danger" data-action="discard">${T("resume.discard")}</button>
  `:`
    <button class="resume-primary" data-action="discard">${T("welcome.start")}</button>
    <button class="resume-warn" data-action="cancel">${T("resume.cancel")}</button>
  `;s.innerHTML=`
    <div class="resume-modal" role="dialog" aria-modal="true" aria-labelledby="resume-modal-title">
      <div style="text-align: center; font-size: 4rem; margin-bottom: 12px; line-height: 1;"></div>
      <h2 id="resume-modal-title">${T(n?"resume.title":"welcome.title")}</h2>
      <p>${T(n?"resume.message":"welcome.message")}</p>
      <div class="resume-actions">
        ${a}
      </div>
      ${n?`<div class="resume-meta">${T("resume.meta")}</div>`:""}
    </div>`,document.body.appendChild(s);function o(){s.remove(),document.removeEventListener("keydown",c)}function c(u){u.key==="Escape"&&(o(),t&&t())}document.addEventListener("keydown",c),s.addEventListener("click",u=>{u.target===s&&(o(),t&&t())}),s.querySelectorAll("button").forEach(u=>{u.addEventListener("click",()=>{const l=u.dataset.action;l==="resume"?(o(),r&&r()):l==="discard"?(o(),e&&e()):l==="cancel"&&(o(),t&&t())})});const d=s.querySelector("button[data-action='resume']");d&&d.focus()}function fm(){const r=document.getElementById("resume-modal-overlay");if(r){const e=r.querySelector("#resume-modal-title");e&&(e.textContent=T("resume.title"));const t=r.querySelector(".resume-modal p");t&&(t.textContent=T("resume.message")),r.querySelectorAll("button").forEach(i=>{const s=i.dataset.action;s==="resume"?i.textContent=T("resume.resume"):s==="cancel"?i.textContent=T("resume.cancel"):s==="discard"&&(i.textContent=T("resume.discard"))});const n=r.querySelector(".resume-meta");n&&(n.textContent=T("resume.meta"))}}async function hm(r,e={}){const{returnDataUrl:t=!1}=e,n=typeof r=="string"?await of(r):r,i=document.createElement("canvas");i.width=n.width,i.height=n.height;const s=i.getContext("2d");s.filter="grayscale(100%)",s.drawImage(n,0,0),s.filter="none";const a=i.toDataURL();if(t)return a;const o=new Image;return o.src=a,await o.decode(),o}async function mt(r,e={}){const t=typeof r=="string"?await of(r):r,{centered:n=!1,fontSizePercent:i=2,minFontSize:s=12,returnDataUrl:a=!1,removeColor:o=null,license:c=null}=e,d=c??w.deepLinkLicense??null;if(!d)return t;const u=o??w.deepLinkRemoveColor??"n",l=document.createElement("canvas");l.width=t.width,l.height=t.height;const f=l.getContext("2d");u==="y"&&(f.filter="grayscale(100%)"),f.drawImage(t,0,0),f.filter="none";const h=Math.max(s,Math.floor(t.height*(i/100))),g=Math.floor(h*.5);f.font=`${h}px Arial, sans-serif`,f.textBaseline="bottom",n?f.textAlign="center":f.textAlign="left";const y=f.measureText(d).width,m=h;let _,v;n?(_=(t.width-y)/2-g,v=t.width/2):(_=g,v=g*2);const I=t.height-m-g*2,S=y+g*2,E=m+g*2;f.fillStyle="rgba(0, 0, 0, 0.7)",f.fillRect(_,I,S,E),f.fillStyle="white",f.fillText(d,v,t.height-g*1.5);const P=l.toDataURL();if(a)return P;const R=new Image;return R.src=P,await R.decode(),R}function of(r,e=!0){return new Promise((t,n)=>{const i=new Image;e&&(i.crossOrigin="anonymous"),i.onload=()=>t(i),i.onerror=()=>n(new Error(`Failed to load image: ${r}`)),i.src=r})}function pm(r,e={}){const{timeout:t=1e4,onLoad:n=()=>{},onError:i=()=>{},onTimeout:s=()=>{}}=e;return new Promise((a,o)=>{const c=new Image;c.crossOrigin="anonymous",c.decoding="async";const d=setTimeout(()=>{console.warn("[remote-image] Image load timeout for:",r),s(),o(new Error(`Image load timeout: ${r}`))},t);c.onload=async()=>{clearTimeout(d),console.info("[remote-image] Image loaded successfully:",r),n(c),a(c)},c.onerror=()=>{clearTimeout(d),console.warn("[remote-image] Failed to load image URL:",r),i(),o(new Error(`Failed to load image: ${r}`))},c.src=r})}const gm=1,Ns=-1,Wl=.25,mm=.25,vm=.5,ym=.3;class _m{constructor(e,t,n,i,s,a){this.rows=e,this.cols=t,this.imgWidth=n,this.imgHeight=i,this.pieceW=n/t,this.pieceH=i/e,this.totalInternalEdges=(e-1)*t+(t-1)*e,this.positiveTarget=this.totalInternalEdges/2,this.posCount=0,this.corners=this.buildCornerLattice();const{hSides:o,vSides:c}=this.generateInternalEdges(s,a);this.hSides=o,this.vSides=c}chooseOrientation(){const e=this.totalInternalEdges-this.posCount,n=(this.positiveTarget-this.posCount)/Math.max(1,e);return Math.random()<n?(this.posCount++,gm):Ns}splitSegment(e,t){if(t===0)return[];const n=[];for(let i=1;i<=t;i++){const s=i/(t+1)*e,a=e/(t+1)*ym;n.push(s+ne.symmetricRandomDeviation(a))}return n}buildCornerLattice(){const e=this.splitSegment(this.imgWidth,this.cols-1),t=this.splitSegment(this.imgWidth,this.cols-1),n=this.splitSegment(this.imgHeight,this.rows-1),i=this.splitSegment(this.imgHeight,this.rows-1),s=Array(this.rows+1).fill(0).map(()=>Array(this.cols+1));s[0][0]=new b(0,0),s[0][this.cols]=new b(this.imgWidth,0),s[this.rows][0]=new b(0,this.imgHeight),s[this.rows][this.cols]=new b(this.imgWidth,this.imgHeight);for(let a=1;a<this.cols;a++)s[0][a]=new b(e[a-1],0),s[this.rows][a]=new b(t[a-1],this.imgHeight);for(let a=1;a<this.rows;a++)s[a][0]=new b(0,n[a-1]),s[a][this.cols]=new b(this.imgWidth,i[a-1]);for(let a=1;a<this.rows;a++)for(let o=1;o<this.cols;o++){const c=new b(e[o-1],0),d=new b(t[o-1],this.imgHeight),u=new b(0,n[a-1]),l=new b(this.imgWidth,i[a-1]),f=this.calculateLineIntersection(c,d,u,l);s[a][o]=f}return s}calculateLineIntersection(e,t,n,i){const s=(e.x-t.x)*(n.y-i.y)-(e.y-t.y)*(n.x-i.x);if(Math.abs(s)<1e-10)return null;const a=((e.x-n.x)*(n.y-i.y)-(e.y-n.y)*(n.x-i.x))/s,o=e.x+a*(t.x-e.x),c=e.y+a*(t.y-e.y);return new b(o,c)}deviatePoint(e,t,n){const s=.5+ne.symmetricRandomDeviation(n);return e.add(t.sub(e).scaled(s))}clampDepthForCavity(e,t){return Math.min(e,mm*Math.min(this.pieceW,this.pieceH),vm*t)}generateInternalEdges(e,t){if(!this.corners)throw new Error("Corner lattice must be built before generating internal edges");const n=Array(this.rows-1).fill(0).map(()=>Array(this.cols)),i=Array(this.rows).fill(0).map(()=>Array(this.cols-1));for(let s=0;s<this.rows-1;s++)for(let a=0;a<this.cols;a++){const o=this.corners[s+1][a],c=this.corners[s+1][a+1],d=this.pieceW,u=this.deviatePoint(o,c,Wl),l=this.chooseOrientation();let f=e+Math.random()*(t-e);l===Ns&&(f=this.clampDepthForCavity(f,d));const h=u.y+l*f;n[s][a]={x:u.x,y:h,orientation:l}}for(let s=0;s<this.rows&&!(this.cols-1<=0);s++)for(let a=0;a<this.cols-1;a++){const o=this.corners[s][a+1],c=this.corners[s+1]?this.corners[s+1][a+1]:{x:o.x,y:o.y+this.pieceH},d=this.pieceH,u=this.deviatePoint(o,c,Wl),l=this.chooseOrientation();let f=e+Math.random()*(t-e);l===Ns&&(f=this.clampDepthForCavity(f,d));const h=u.x+l*f;i[s][a]={x:h,y:u.y,orientation:l}}return{hSides:n,vSides:i}}getCorners(){return this.corners}getHSides(){return this.hSides}getVSides(){return this.vSides}}const Vl=2,wm=.18,bm=.1,Kl=[0,90,180,270];function Im(r,e){var{cols:t,rows:n,actualCount:i}=Pm(r,e);window.dispatchEvent(new CustomEvent(Nd,{detail:{totalPieces:i}}));const s=r.width/t,a=r.height/n,o=wm*Math.min(s,a),c=bm*Math.min(s,a),d=new _m(n,t,r.width,r.height,c,o),u=d.getCorners(),l=d.getHSides(),f=d.getVSides(),h=[];let g=0;const p=document.createElement("canvas");p.width=r.width,p.height=r.height,p.getContext("2d").drawImage(r,0,0);for(let m=0;m<n;m++)for(let _=0;_<t;_++){const v=u[m][_],I=u[m][_+1],S=u[m+1][_+1],E=u[m+1][_],P={north:m>0?new b(l[m-1][_].x,l[m-1][_].y):null,east:_<t-1&&f[m][_]?new b(f[m][_].x,f[m][_].y):null,south:m<n-1?new b(l[m][_].x,l[m][_].y):null,west:_>0&&f[m][_-1]?new b(f[m][_-1].x,f[m][_-1].y):null},R=[v,I,S,E];P.north&&R.push(P.north),P.east&&R.push(P.east),P.south&&R.push(P.south),P.west&&R.push(P.west);const q=Qd(R),M=g++,C={id:M,gridX:_,gridY:m,w:q.width,h:q.height,imgX:v.x,imgY:v.y,rotation:Kl[Math.floor(Math.random()*Kl.length)],groupId:"g"+M,geometryCorners:{nw:v,ne:I,se:S,sw:E},geometrySidePoints:P,nw:v,master:p};h.push(new Ve(C))}return{pieces:h,rows:n,cols:t,actualCount:i}}function Pm(r,e){const t=r.width/r.height;let n=Math.max(Vl,Math.round(Math.sqrt(e*t))),i=Math.max(Vl,Math.round(e/n));for(;i*n<e;)n++;const s=i*n;return{cols:n,rows:i,actualCount:s}}const Yl=document.getElementById("helpButton"),ie=document.getElementById("helpModal"),Xl=document.getElementById("closeHelp");function Em(){ie&&(ie.style.display="flex")}function ya(){ie&&(ie.style.display="none")}function cf(){return ie&&ie.style.display==="flex"}function Cm(r){r.target===ie&&ya()}function Sm(r){r.key==="Escape"&&cf()&&ya()}function Rm(){Yl&&Yl.addEventListener("click",Em),Xl&&Xl.addEventListener("click",ya),ie&&ie.addEventListener("click",Cm),document.addEventListener("keydown",Sm)}const ct="pictures/",re=20;let ke=null;async function qm(){if(ke!==null)return ke;const r=[];try{const e=await fetch(`${ct}pictures.json`);if(e.ok){const n=((await e.json()).pictures||[]).map(i=>typeof i=="string"?{type:"local",filename:i,url:`${ct}${i}`,title:i.replace(/\.(png|jpg|jpeg|gif|webp)$/i,""),pieces:re}:{type:"local",filename:i.filename,url:`${ct}${i.filename}`,title:i.title||i.filename.replace(/\.(png|jpg|jpeg|gif|webp)$/i,""),pieces:i.pieces??re,removeColor:i.removeColor??"n",...i});r.push(...n),console.log(`[picture-gallery] Loaded ${n.length} local pictures`)}}catch(e){console.error("[picture-gallery] Error loading local pictures:",e)}try{const e=await fetch(`${ct}remote-pictures.json`);if(e.ok){const n=((await e.json()).pictures||[]).map(i=>({type:"remote",url:i.url,title:i.title??"Remote Image",pieces:i.pieces??re,removeColor:i.removeColor??"n",...i}));r.push(...n),console.log(`[picture-gallery] Loaded ${n.length} remote pictures`)}}catch(e){console.error("[picture-gallery] Error loading remote pictures:",e)}return ke=r,console.log(`[picture-gallery] Total ${ke.length} pictures available`),ke}async function _a(r,e){const t=document.getElementById("picture-gallery-overlay");t&&t.remove();const n=document.createElement("div");n.id="picture-gallery-overlay",n.className="picture-gallery-overlay";const i=document.createElement("div");i.className="picture-gallery";const s=document.createElement("h2");s.textContent=T("gallery.title"),i.appendChild(s);const a=document.createElement("div");a.className="picture-gallery-filter-bar";const o=document.createElement("button");o.className="picture-gallery-filter-btn",o.innerHTML="",o.title=T("gallery.filterBaby");const c=document.createElement("button");c.className="picture-gallery-filter-btn",c.innerHTML="",c.title=T("gallery.filterStudent");const d=document.createElement("button");d.className="picture-gallery-filter-btn",d.innerHTML="",d.title=T("gallery.filterMaster"),a.appendChild(o),a.appendChild(c),a.appendChild(d),i.appendChild(a);let u=null;const l=document.createElement("div");l.className="picture-gallery-grid",i.appendChild(l);const f=await qm();function h(m){l.innerHTML="";let _=f;[o,c,d].forEach(v=>v.classList.remove("selected")),m==="baby"?(_=f.filter(v=>(v.pieces||re)>=4&&(v.pieces||re)<=8),o.classList.add("selected")):m==="student"?(_=f.filter(v=>(v.pieces||re)>=10&&(v.pieces||re)<=100),c.classList.add("selected")):m==="master"&&(_=f.filter(v=>(v.pieces||re)>100),d.classList.add("selected")),m||(_=f),_.forEach(v=>{const I=document.createElement("a");I.className="picture-gallery-item";const S=v.pieces||re,E=v.removeColor||"n",P=v.license?`&license=${encodeURIComponent(v.license)}`:"",R=`&removeColor=${E}`,q=`?image=${encodeURIComponent(v.url)}&pieces=${S}&norotate=y${R}${P}`;I.href=q,I.title=T("gallery.itemTooltip",{title:v.title,pieces:S});const M=document.createElement("div");M.className="picture-gallery-item-container";const C=document.createElement("img");C.alt=v.title,C.loading="lazy",mt(v.url,{centered:!0,fontSizePercent:4,minFontSize:20,returnDataUrl:!0,removeColor:v.removeColor,license:v.license}).then(G=>{C.src=G}).catch(G=>{console.warn(`[picture-gallery] Failed to add license to preview: ${G.message}`),v.removeColor==="y"?hm(v.url,{returnDataUrl:!0}).then(ae=>{C.src=ae}).catch(()=>{C.src=v.url}):C.src=v.url}),C.addEventListener("error",()=>{I.style.display="none",console.warn(`[picture-gallery] Failed to load image: ${v.url}`)});const N=document.createElement("div");N.className="picture-gallery-item-title",N.textContent=v.title,M.appendChild(C),M.appendChild(N),I.appendChild(M),I.addEventListener("click",G=>{G.preventDefault(),ze(),r&&r(q)}),l.appendChild(I)}),g()}function g(){const m=document.createElement("button");m.className="picture-gallery-item picture-gallery-upload",m.title=T("gallery.uploadOwn");const _=document.createElement("div");_.className="picture-gallery-item-container";const v=document.createElement("div");v.innerHTML="",v.style.flex="0 0 80%",v.style.fontSize="6em",v.style.display="flex",v.style.alignItems="center",v.style.justifyContent="center",v.style.width="100%",_.appendChild(v);const I=document.createElement("div");I.className="picture-gallery-item-title",I.textContent=T("gallery.selectOwn"),_.appendChild(I),m.appendChild(_),m.style.border="none",m.style.background="transparent",m.style.cursor="pointer",m.style.padding="0",m.addEventListener("click",()=>{const S=document.createElement("input");S.type="file",S.accept="image/png,image/jpeg,image/jpg,image/gif,image/webp",S.addEventListener("change",async E=>{var R;const P=(R=E.target.files)==null?void 0:R[0];P&&(ze(),window.dispatchEvent(new CustomEvent(ht,{detail:{reason:"file-upload"}})),window.dispatchEvent(new CustomEvent(Bd,{detail:{file:P}})))}),S.click()}),l.appendChild(m)}h(),o.addEventListener("click",()=>{u==="baby"?(u=null,h()):(u="baby",h("baby"))}),c.addEventListener("click",()=>{u==="student"?(u=null,h()):(u="student",h("student"))}),d.addEventListener("click",()=>{u==="master"?(u=null,h()):(u="master",h("master"))});const p=document.getElementById("logo");p&&(p.style.cursor="pointer",p.addEventListener("click",()=>{_a(r)})),n.appendChild(i),document.body.appendChild(n),n.addEventListener("click",m=>{m.target===n&&ze()});const y=m=>{m.key==="Escape"&&(ze(),document.removeEventListener("keydown",y))};document.addEventListener("keydown",y)}function ze(){const r=document.getElementById("picture-gallery-overlay");r&&r.remove()}const uf=3,lf=1e3,ut=document.querySelector(".top-bar"),De=document.getElementById("pieceSlider"),xm=document.getElementById("pieceDisplay"),Ae=document.getElementById("progressDisplay"),Tm=document.getElementById("orientationTipButton"),Am=document.getElementById("zoomInButton"),Lm=document.getElementById("zoomOutButton"),Om=document.getElementById("zoomResetButton"),Mm=document.getElementById("piecesContainer");let ye=null,$e=null,vt=null,Mt=null,Fs=!1,V=null;function df(r){if(r===0)return 0;const e=r/100*uf,t=Math.round(Math.pow(10,e));return Math.max(1,Math.min(lf,t))}function Dm(r){const e=Math.max(1,Math.min(lf,r)),n=Math.log10(e)/uf*100;return Math.round(Math.max(0,Math.min(100,n)))}function et(){const r=df(parseInt(De.value));xm.textContent=r}function Nm(){return parseInt(De.value,10)||0}function Zl(r){De.value=String(r),et()}function Fm(){return ye}function Jl(r){ye=r}function km(){return $e}function Ql(r){$e=r}function jm(){return vt}function Gm(r){vt=r}function Bm(){return Mt}function ed(r){Mt=r}function ff(){Q(1,null)}function td(){if(!w.pieces||w.pieces.length===0){Ae.textContent=T("status.emptyProgress");return}const r=w.totalPieces;let e;try{e=z.getGroupCount()}catch{console.warn("[updateProgress] GroupManager not available, falling back to simple count"),e=new Set(w.pieces.map(a=>a.groupId)).size}const t=r-(e-1),n=(t/r*100).toFixed(1);Ae.textContent=T("status.progressFormat",{score:t,total:r,percent:n}),e===1&&r>0&&setTimeout(()=>Qm(),100),V&&V.requestAutoSave&&V.requestAutoSave()}async function Ws(){if(!ye||Fs)return;const r=w.noRotate||!1;console.log("[control-bar] generatePuzzle called with noRotate from state:",r);const e=df(parseInt(De.value));if(e===0){const n=qe();if(n){const i=w.deepLinkLicense;w.deepLinkLicense=Mt;const s=await mt(ye);w.deepLinkLicense=i,n.innerHTML=`
        <div class="original-image-container">
          <img src="${s.src}" alt="${T("alt.originalImage")}" style="max-width:100%;max-height:100%;object-fit:contain;" />
        </div>
      `}w.pieces=[],w.totalPieces=0,document.dispatchEvent(new CustomEvent(le,{detail:{action:"cleared"}}));return}Fs=!0;const t=qe();t&&(t.innerHTML=""),Ae.textContent=T("status.generating");try{const n=await mt(ye),{pieces:i,rows:s,cols:a}=Im(n,e);w.pieces=i,w.totalPieces=i.length,w.noRotate=r,console.log("[control-bar] Set state.noRotate to:",w.noRotate),z.initialize();const o=qe();o&&om(o,i,r),document.dispatchEvent(new CustomEvent(le,{detail:{action:"generated"}})),V&&V.markDirty&&V.markDirty()}catch(n){console.error(n),alert(T("error.generate",{error:n.message})),Ae.textContent=T("status.error")}finally{Fs=!1}}function zm(){et(),Ws()}function Hm(){if(w.noRotate){console.log("[control-bar] Rotation disabled (noRotate mode)");return}const r=tf();r&&(document.dispatchEvent(new CustomEvent(kd,{detail:{pieceId:r.id}})),V&&V.requestAutoSave&&V.requestAutoSave())}function Um(){Q(xe()*gt)}function $m(){Q(xe()/gt)}function Wm(){ff()}function Vm(r){r.preventDefault();const e=r.deltaY>0?wg:_g;Q(xe()*e,new b(r.clientX,r.clientY))}function Km(r){if(!(cf()||r.target.tagName==="INPUT"))switch(r.key){case"+":case"=":r.preventDefault(),Q(xe()*gt);break;case"-":r.preventDefault(),Q(xe()/gt);break;case"0":r.preventDefault(),ff();break;case"r":case"R":const e=tf();if(e){const t=r.shiftKey?270:90;document.dispatchEvent(new CustomEvent(fa,{detail:{pieceId:e.id,rotation:t}}))}break}}function Ym(){const r=document.getElementById("logo");r&&(r.style.cursor="pointer",r.addEventListener("click",()=>{_a(e=>{window.location.href=e})})),De.addEventListener("input",zm),Tm.addEventListener("click",Hm),Am.addEventListener("click",Um),Lm.addEventListener("click",$m),Om.addEventListener("click",Wm),Mm.addEventListener("wheel",Vm),document.addEventListener("keydown",Km),B(At,e=>{const{piece:t}=e.detail;Al(t)}),B(We,()=>{Al(null)}),B(js,td),B(le,td),window.addEventListener(Gd,()=>{ut&&ut.classList.add("deep-link-mode")}),window.addEventListener(ht,()=>{ut&&ut.classList.remove("deep-link-mode")}),window.addEventListener(Bd,e=>{const{file:t}=e.detail;Zm(t)}),et(),Lt()}function Xm(r){V=r}async function Zm(r){if(r)try{w.reset(),Bs(),Ae.textContent=T("status.loadingImage");const e=new Image,t=await new Promise((i,s)=>{const a=new FileReader;a.onload=o=>i(o.target.result),a.onerror=s,a.readAsDataURL(r)});if(await new Promise((i,s)=>{e.onload=i,e.onerror=s,e.src=t}),ye=e,vt=null,Ze())try{console.log("[controlBar] Attempting to store file in IndexedDB");const i=await Ug(r);vt=i.imageId,$e=`idb:${i.imageId}`,console.log("[controlBar] File stored successfully in IndexedDB:",i.imageId)}catch(i){console.warn("[controlBar] Failed to store file in IndexedDB:",i.message),$e=r.webkitRelativePath||r.name}else $e=r.webkitRelativePath||r.name;De.value=0,et();const n=qe();if(n){const i=w.deepLinkLicense;w.deepLinkLicense=Mt;const s=await mt(ye);w.deepLinkLicense=i,n.innerHTML=`
        <div class="original-image-container">
          <img src="${s.src}" alt="${T("alt.originalImage")}" style="max-width:100%;max-height:100%;object-fit:contain;" />
        </div>
      `}w.pieces=[],w.totalPieces=0,document.dispatchEvent(new CustomEvent(le,{detail:{action:"cleared"}})),V&&V.markDirty&&V.markDirty()}catch(e){console.error(e),alert(T("error.loadImage",{error:e.message})),Ae.textContent=T("status.error")}}function Jm(){try{const r=new URLSearchParams(window.location.search),e=r.get("image"),t=r.get("pieces"),n=r.get("norotate"),i=r.get("removeColor"),s=r.get("license");if(!e||!t){w.deepLinkImageUrl=null,w.deepLinkPieceCount=null;return}const a=parseInt(t,10);if(!ne.isPositiveNumber(a)){console.warn("[url-util] Invalid pieces param:",t),w.deepLinkImageUrl=null,w.deepLinkPieceCount=null;return}const o=n==="y"?"y":"n",c=i==="y"?"y":"n";w.deepLinkImageUrl=e,w.deepLinkPieceCount=a,w.deepLinkNoRotate=o,w.deepLinkRemoveColor=c,w.deepLinkLicense=s||null,w.noRotate=o==="y"}catch(r){console.warn("[url-util] Error parsing deep link params:",r),w.deepLinkImageUrl=null,w.deepLinkPieceCount=null}}document.getElementById("piecesContainer");let Re=!1;function Qm(){w.pieces.forEach(t=>{pa(t)});const r=w.pieces.map(t=>t.rotation),e=r.every(t=>t===r[0]);w.pieces.forEach(t=>{let n=!0,i=[];if(!e){const a={};r.forEach(c=>{a[c]=(a[c]||0)+1});const o=Object.entries(a).sort((c,d)=>d[1]-c[1])[0][0];t.rotation!==Number(o)&&(n=!1,i.push(`Inconsistent rotation: ${t.rotation} (most pieces at ${o})`))}const s={north:w.pieces.find(a=>a.gridX===t.gridX&&a.gridY===t.gridY-1),east:w.pieces.find(a=>a.gridX===t.gridX+1&&a.gridY===t.gridY),south:w.pieces.find(a=>a.gridX===t.gridX&&a.gridY===t.gridY+1),west:w.pieces.find(a=>a.gridX===t.gridX-1&&a.gridY===t.gridY)};Object.entries(s).forEach(([a,o])=>{o&&(t.groupId!==o.groupId?(n=!1,i.push(`Not connected to expected neighbor at (${o.gridX}, ${o.gridY})`)):A.arePiecesNeighbors(t,o)||(n=!1,i.push(`Neighbor ${a} (${o.gridX}, ${o.gridY}) corners are not properly aligned with this piece`)))}),xg(t,n)})}B(Xe,r=>{ma()});async function ev(){if(await lm(),af(),bg(),Bs(),Ym(),Rm(),Jm(),w.deepLinkImageUrl&&(Re=!0,window.dispatchEvent(new CustomEvent(Gd)),localStorage.setItem("removeColor",w.deepLinkRemoveColor?"y":"n"),pm(w.deepLinkImageUrl,{timeout:1e4,onLoad:async r=>{Jl(r),Ql(w.deepLinkImageUrl),ed(w.deepLinkLicense);const e=Dm(w.deepLinkPieceCount);Zl(e),et(),Bs(w.deepLinkRemoveColor),await Ws(),Re=!1,ze()},onTimeout:()=>{Re=!1,window.dispatchEvent(new CustomEvent(ht,{detail:{reason:"timeout"}})),at()},onError:()=>{Re=!1,window.dispatchEvent(new CustomEvent(ht,{detail:{reason:"error"}})),at()}}).catch(()=>{})),Xm({initPersistence:Hl,clearSavedGame:Ke,tryOfferResume:at,requestAutoSave:ma}),Hl({getViewportState:Ud,applyViewportState:Ig,getSliderValue:Nm,setSliderValue:Zl,getCurrentImage:Fm,getCurrentImageSource:km,getCurrentImageId:jm,setImage:Jl,setImageSource:Ql,setImageId:Gm,getImageLicense:Bm,setImageLicense:ed,regenerate:Ws,getState:()=>w,setPieces:r=>{w.pieces=r,w.totalPieces=r.length},redrawPiecesContainer:()=>{const r=qe();r&&(r.innerHTML="",scatterInitialPieces(r,w.pieces)),document.dispatchEvent(new CustomEvent(le,{detail:{action:"restored"}}))},renderPiecesFromState:()=>{const r=qe();r&&(r.innerHTML="",cm(r,w.pieces)),document.dispatchEvent(new CustomEvent(le,{detail:{action:"loaded"}})),A.syncAllPositions()},markDirtyHook:()=>document.dispatchEvent(new CustomEvent(le,{detail:{action:"restored"}})),showResumePrompt:dm,afterDiscard:()=>{document.dispatchEvent(new CustomEvent(le,{detail:{action:"cleared"}})),Re||_a(r=>{window.location.href=r})}}),Re)try{Ke(),console.info("[deep-link] Previous session discarded due to deep link mode")}catch(r){console.warn("[deep-link] Failed to clear previous save",r)}else at()}window.__puzzleBootstrapExecuted||(window.__puzzleBootstrapExecuted=!0,ev());
