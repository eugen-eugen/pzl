(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const s of i)if(s.type==="childList")for(const a of s.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&n(a)}).observe(document,{childList:!0,subtree:!0});function t(i){const s={};return i.integrity&&(s.integrity=i.integrity),i.referrerPolicy&&(s.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?s.credentials="include":i.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function n(i){if(i.ep)return;i.ep=!0;const s=t(i);fetch(i.href,s)}})();const Rf=50,Af=25,I={pieces:[],totalPieces:0,groups:[],settings:{snapNearPx:Rf,snapReadyPx:Af},noRotate:!1};class U{static isArrayEmpty(e){return!e||e.length===0}static hasElements(e){return e&&e.length>0}static getPieceCount(e){return e.pieces?e.pieces.length:0}static isElementValid(e){return e!=null}static isTotalPiecesEmpty(e){return!e.totalPieces||e.totalPieces===0}static isPositiveNumber(e){return typeof e=="number"&&!isNaN(e)&&e>0}static symmetricRandomDeviation(e){return(Math.random()-.5)*2*e}}class b{constructor(e=0,t=0){this._point=new DOMPoint(e,t)}get x(){return this._point.x}set x(e){this._point.x=e}get y(){return this._point.y}set y(e){this._point.y=e}clone(){return new b(this.x,this.y)}add(e){const t=this._point.matrixTransform(new DOMMatrix().translate(e.x,e.y));return new b(t.x,t.y)}sub(e){const t=this._point.matrixTransform(new DOMMatrix().translate(-e.x,-e.y));return new b(t.x,t.y)}scaled(e){const t=this._point.matrixTransform(new DOMMatrix().scale(e));return new b(t.x,t.y)}rotatedAroundDeg(e,t){const n=new DOMMatrix().translate(e.x,e.y).rotate(t).translate(-e.x,-e.y),i=this._point.matrixTransform(n);return new b(i.x,i.y)}mutAdd(e){return this.x+=e.x,this.y+=e.y,this}distance2(e){const t=this.x-e.x,n=this.y-e.y;return t*t+n*n}toString(){return`Point(${this.x}, ${this.y})`}toJSON(){return{x:this.x,y:this.y}}static min(e,t){return new b(Math.min(e.x,t.x),Math.min(e.y,t.y))}static max(e,t){return new b(Math.max(e.x,t.x),Math.max(e.y,t.y))}}function Ha(r,e){return r.distance2(e)}class Tf{constructor(){this.lastPosition=null,this.lastTimestamp=null,this.currentCurvature=1,this.positionWindow=[],this.maxPositionSamples=10,this.curvatureCallbacks=[],this.isDragging=!1}dragEvent(e){const t=e.timestamp||performance.now(),n={x:e.x,y:e.y};if(this.lastPosition===null||this.lastTimestamp===null){this.lastPosition=n,this.lastTimestamp=t,this.isDragging=!0;return}this.positionWindow.push({x:n.x,y:n.y,timestamp:t}),this.positionWindow.length>this.maxPositionSamples&&this.positionWindow.shift(),this.calculateCurvature(),this.checkCurvatureCallbacks(),this.lastPosition=n,this.lastTimestamp=t,this.isDragging=!0}calculateCurvature(){if(this.positionWindow.length<3){this.currentCurvature=1;return}let e=0;for(let o=1;o<this.positionWindow.length;o++){const c=this.positionWindow[o-1],l=this.positionWindow[o],u=l.x-c.x,d=l.y-c.y;e+=Math.sqrt(u*u+d*d)}const t=this.positionWindow[0],n=this.positionWindow[this.positionWindow.length-1],i=n.x-t.x,s=n.y-t.y,a=Math.sqrt(i*i+s*s);a<1?this.currentCurvature=1:this.currentCurvature=e/a}getCurvature(){return this.currentCurvature}registerCurvatureCallback(e,t){if(typeof e!="number"||e<=0)return console.warn("[DragMonitor] Invalid curvature threshold:",e),()=>{};if(typeof t!="function")return console.warn("[DragMonitor] Invalid callback:",t),()=>{};const n={threshold:e,callback:t,lastTriggered:0};return this.curvatureCallbacks.push(n),()=>{const i=this.curvatureCallbacks.indexOf(n);i!==-1&&this.curvatureCallbacks.splice(i,1)}}checkCurvatureCallbacks(){const e=performance.now();for(const t of this.curvatureCallbacks)if(this.currentCurvature>=t.threshold&&e-t.lastTriggered>100){t.lastTriggered=e;try{t.callback({curvature:this.currentCurvature,threshold:t.threshold,positionCount:this.positionWindow.length})}catch(n){console.error("[DragMonitor] Curvature callback error:",n)}}}endDrag(){this.isDragging=!1,this.currentCurvature=1,this.lastPosition=null,this.lastTimestamp=null,this.positionWindow=[]}reset(){this.currentCurvature=1,this.positionWindow=[],this.lastPosition=null,this.lastTimestamp=null,this.isDragging=!1}getStatistics(){return{currentCurvature:this.currentCurvature,positionWindowCount:this.positionWindow.length,isDragging:this.isDragging,curvatureCallbackCount:this.curvatureCallbacks.length}}}const fa=new Tf;class V{constructor(e=null,t=0,n=0){this._position=e instanceof b?e.clone():new b,this.width=t,this.height=n}get position(){return this._position}static fromPoints(e,t){return new V(e,t.x-e.x,t.y-e.y)}clone(){return new V(this.position,this.width,this.height)}get topLeft(){return this.position.clone()}get bottomRight(){return new b(this.position.x+this.width,this.position.y+this.height)}get center(){return new b(this.position.x+this.width/2,this.position.y+this.height/2)}get centerOffset(){return new b(this.width/2,this.height/2)}isEmpty(){return this.width<=0||this.height<=0}plus(e){if(this.isEmpty())return e.clone();if(e.isEmpty())return this.clone();const t=new b(Math.min(this.topLeft.x,e.topLeft.x),Math.min(this.topLeft.y,e.topLeft.y)),n=new b(Math.max(this.bottomRight.x,e.bottomRight.x),Math.max(this.bottomRight.y,e.bottomRight.y));return V.fromPoints(t,n)}scaled(e){return new V(this.position.scaled(e),this.width*e,this.height*e)}toString(){return`Rectangle(${this.position.x}, ${this.position.y}, ${this.width}, ${this.height})`}}var vt=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function Mf(r){throw new Error('Could not dynamically require "'+r+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var ir,$a;function Of(){if($a)return ir;$a=1;function r(){this.__data__=[],this.size=0}return ir=r,ir}var sr,Ua;function ha(){if(Ua)return sr;Ua=1;function r(e,t){return e===t||e!==e&&t!==t}return sr=r,sr}var ar,Wa;function Lt(){if(Wa)return ar;Wa=1;var r=ha();function e(t,n){for(var i=t.length;i--;)if(r(t[i][0],n))return i;return-1}return ar=e,ar}var or,Ya;function Lf(){if(Ya)return or;Ya=1;var r=Lt(),e=Array.prototype,t=e.splice;function n(i){var s=this.__data__,a=r(s,i);if(a<0)return!1;var o=s.length-1;return a==o?s.pop():t.call(s,a,1),--this.size,!0}return or=n,or}var cr,Va;function Df(){if(Va)return cr;Va=1;var r=Lt();function e(t){var n=this.__data__,i=r(n,t);return i<0?void 0:n[i][1]}return cr=e,cr}var ur,Xa;function Gf(){if(Xa)return ur;Xa=1;var r=Lt();function e(t){return r(this.__data__,t)>-1}return ur=e,ur}var lr,Ka;function Ff(){if(Ka)return lr;Ka=1;var r=Lt();function e(t,n){var i=this.__data__,s=r(i,t);return s<0?(++this.size,i.push([t,n])):i[s][1]=n,this}return lr=e,lr}var dr,Za;function Dt(){if(Za)return dr;Za=1;var r=Of(),e=Lf(),t=Df(),n=Gf(),i=Ff();function s(a){var o=-1,c=a==null?0:a.length;for(this.clear();++o<c;){var l=a[o];this.set(l[0],l[1])}}return s.prototype.clear=r,s.prototype.delete=e,s.prototype.get=t,s.prototype.has=n,s.prototype.set=i,dr=s,dr}var fr,Ja;function Nf(){if(Ja)return fr;Ja=1;var r=Dt();function e(){this.__data__=new r,this.size=0}return fr=e,fr}var hr,Qa;function Bf(){if(Qa)return hr;Qa=1;function r(e){var t=this.__data__,n=t.delete(e);return this.size=t.size,n}return hr=r,hr}var gr,eo;function kf(){if(eo)return gr;eo=1;function r(e){return this.__data__.get(e)}return gr=r,gr}var pr,to;function jf(){if(to)return pr;to=1;function r(e){return this.__data__.has(e)}return pr=r,pr}var mr,ro;function fd(){if(ro)return mr;ro=1;var r=typeof vt=="object"&&vt&&vt.Object===Object&&vt;return mr=r,mr}var yr,no;function te(){if(no)return yr;no=1;var r=fd(),e=typeof self=="object"&&self&&self.Object===Object&&self,t=r||e||Function("return this")();return yr=t,yr}var vr,io;function Fe(){if(io)return vr;io=1;var r=te(),e=r.Symbol;return vr=e,vr}var _r,so;function zf(){if(so)return _r;so=1;var r=Fe(),e=Object.prototype,t=e.hasOwnProperty,n=e.toString,i=r?r.toStringTag:void 0;function s(a){var o=t.call(a,i),c=a[i];try{a[i]=void 0;var l=!0}catch{}var u=n.call(a);return l&&(o?a[i]=c:delete a[i]),u}return _r=s,_r}var br,ao;function Hf(){if(ao)return br;ao=1;var r=Object.prototype,e=r.toString;function t(n){return e.call(n)}return br=t,br}var wr,oo;function Ne(){if(oo)return wr;oo=1;var r=Fe(),e=zf(),t=Hf(),n="[object Null]",i="[object Undefined]",s=r?r.toStringTag:void 0;function a(o){return o==null?o===void 0?i:n:s&&s in Object(o)?e(o):t(o)}return wr=a,wr}var Ir,co;function we(){if(co)return Ir;co=1;function r(e){var t=typeof e;return e!=null&&(t=="object"||t=="function")}return Ir=r,Ir}var Pr,uo;function Gt(){if(uo)return Pr;uo=1;var r=Ne(),e=we(),t="[object AsyncFunction]",n="[object Function]",i="[object GeneratorFunction]",s="[object Proxy]";function a(o){if(!e(o))return!1;var c=r(o);return c==n||c==i||c==t||c==s}return Pr=a,Pr}var Cr,lo;function $f(){if(lo)return Cr;lo=1;var r=te(),e=r["__core-js_shared__"];return Cr=e,Cr}var Er,fo;function Uf(){if(fo)return Er;fo=1;var r=$f(),e=(function(){var n=/[^.]+$/.exec(r&&r.keys&&r.keys.IE_PROTO||"");return n?"Symbol(src)_1."+n:""})();function t(n){return!!e&&e in n}return Er=t,Er}var xr,ho;function hd(){if(ho)return xr;ho=1;var r=Function.prototype,e=r.toString;function t(n){if(n!=null){try{return e.call(n)}catch{}try{return n+""}catch{}}return""}return xr=t,xr}var Sr,go;function Wf(){if(go)return Sr;go=1;var r=Gt(),e=Uf(),t=we(),n=hd(),i=/[\\^$.*+?()[\]{}|]/g,s=/^\[object .+?Constructor\]$/,a=Function.prototype,o=Object.prototype,c=a.toString,l=o.hasOwnProperty,u=RegExp("^"+c.call(l).replace(i,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");function d(f){if(!t(f)||e(f))return!1;var h=r(f)?u:s;return h.test(n(f))}return Sr=d,Sr}var qr,po;function Yf(){if(po)return qr;po=1;function r(e,t){return e==null?void 0:e[t]}return qr=r,qr}var Rr,mo;function Ie(){if(mo)return Rr;mo=1;var r=Wf(),e=Yf();function t(n,i){var s=e(n,i);return r(s)?s:void 0}return Rr=t,Rr}var Ar,yo;function ga(){if(yo)return Ar;yo=1;var r=Ie(),e=te(),t=r(e,"Map");return Ar=t,Ar}var Tr,vo;function Ft(){if(vo)return Tr;vo=1;var r=Ie(),e=r(Object,"create");return Tr=e,Tr}var Mr,_o;function Vf(){if(_o)return Mr;_o=1;var r=Ft();function e(){this.__data__=r?r(null):{},this.size=0}return Mr=e,Mr}var Or,bo;function Xf(){if(bo)return Or;bo=1;function r(e){var t=this.has(e)&&delete this.__data__[e];return this.size-=t?1:0,t}return Or=r,Or}var Lr,wo;function Kf(){if(wo)return Lr;wo=1;var r=Ft(),e="__lodash_hash_undefined__",t=Object.prototype,n=t.hasOwnProperty;function i(s){var a=this.__data__;if(r){var o=a[s];return o===e?void 0:o}return n.call(a,s)?a[s]:void 0}return Lr=i,Lr}var Dr,Io;function Zf(){if(Io)return Dr;Io=1;var r=Ft(),e=Object.prototype,t=e.hasOwnProperty;function n(i){var s=this.__data__;return r?s[i]!==void 0:t.call(s,i)}return Dr=n,Dr}var Gr,Po;function Jf(){if(Po)return Gr;Po=1;var r=Ft(),e="__lodash_hash_undefined__";function t(n,i){var s=this.__data__;return this.size+=this.has(n)?0:1,s[n]=r&&i===void 0?e:i,this}return Gr=t,Gr}var Fr,Co;function Qf(){if(Co)return Fr;Co=1;var r=Vf(),e=Xf(),t=Kf(),n=Zf(),i=Jf();function s(a){var o=-1,c=a==null?0:a.length;for(this.clear();++o<c;){var l=a[o];this.set(l[0],l[1])}}return s.prototype.clear=r,s.prototype.delete=e,s.prototype.get=t,s.prototype.has=n,s.prototype.set=i,Fr=s,Fr}var Nr,Eo;function eh(){if(Eo)return Nr;Eo=1;var r=Qf(),e=Dt(),t=ga();function n(){this.size=0,this.__data__={hash:new r,map:new(t||e),string:new r}}return Nr=n,Nr}var Br,xo;function th(){if(xo)return Br;xo=1;function r(e){var t=typeof e;return t=="string"||t=="number"||t=="symbol"||t=="boolean"?e!=="__proto__":e===null}return Br=r,Br}var kr,So;function Nt(){if(So)return kr;So=1;var r=th();function e(t,n){var i=t.__data__;return r(n)?i[typeof n=="string"?"string":"hash"]:i.map}return kr=e,kr}var jr,qo;function rh(){if(qo)return jr;qo=1;var r=Nt();function e(t){var n=r(this,t).delete(t);return this.size-=n?1:0,n}return jr=e,jr}var zr,Ro;function nh(){if(Ro)return zr;Ro=1;var r=Nt();function e(t){return r(this,t).get(t)}return zr=e,zr}var Hr,Ao;function ih(){if(Ao)return Hr;Ao=1;var r=Nt();function e(t){return r(this,t).has(t)}return Hr=e,Hr}var $r,To;function sh(){if(To)return $r;To=1;var r=Nt();function e(t,n){var i=r(this,t),s=i.size;return i.set(t,n),this.size+=i.size==s?0:1,this}return $r=e,$r}var Ur,Mo;function pa(){if(Mo)return Ur;Mo=1;var r=eh(),e=rh(),t=nh(),n=ih(),i=sh();function s(a){var o=-1,c=a==null?0:a.length;for(this.clear();++o<c;){var l=a[o];this.set(l[0],l[1])}}return s.prototype.clear=r,s.prototype.delete=e,s.prototype.get=t,s.prototype.has=n,s.prototype.set=i,Ur=s,Ur}var Wr,Oo;function ah(){if(Oo)return Wr;Oo=1;var r=Dt(),e=ga(),t=pa(),n=200;function i(s,a){var o=this.__data__;if(o instanceof r){var c=o.__data__;if(!e||c.length<n-1)return c.push([s,a]),this.size=++o.size,this;o=this.__data__=new t(c)}return o.set(s,a),this.size=o.size,this}return Wr=i,Wr}var Yr,Lo;function ma(){if(Lo)return Yr;Lo=1;var r=Dt(),e=Nf(),t=Bf(),n=kf(),i=jf(),s=ah();function a(o){var c=this.__data__=new r(o);this.size=c.size}return a.prototype.clear=e,a.prototype.delete=t,a.prototype.get=n,a.prototype.has=i,a.prototype.set=s,Yr=a,Yr}var Vr,Do;function ya(){if(Do)return Vr;Do=1;function r(e,t){for(var n=-1,i=e==null?0:e.length;++n<i&&t(e[n],n,e)!==!1;);return e}return Vr=r,Vr}var Xr,Go;function gd(){if(Go)return Xr;Go=1;var r=Ie(),e=(function(){try{var t=r(Object,"defineProperty");return t({},"",{}),t}catch{}})();return Xr=e,Xr}var Kr,Fo;function pd(){if(Fo)return Kr;Fo=1;var r=gd();function e(t,n,i){n=="__proto__"&&r?r(t,n,{configurable:!0,enumerable:!0,value:i,writable:!0}):t[n]=i}return Kr=e,Kr}var Zr,No;function md(){if(No)return Zr;No=1;var r=pd(),e=ha(),t=Object.prototype,n=t.hasOwnProperty;function i(s,a,o){var c=s[a];(!(n.call(s,a)&&e(c,o))||o===void 0&&!(a in s))&&r(s,a,o)}return Zr=i,Zr}var Jr,Bo;function Bt(){if(Bo)return Jr;Bo=1;var r=md(),e=pd();function t(n,i,s,a){var o=!s;s||(s={});for(var c=-1,l=i.length;++c<l;){var u=i[c],d=a?a(s[u],n[u],u,s,n):void 0;d===void 0&&(d=n[u]),o?e(s,u,d):r(s,u,d)}return s}return Jr=t,Jr}var Qr,ko;function oh(){if(ko)return Qr;ko=1;function r(e,t){for(var n=-1,i=Array(e);++n<e;)i[n]=t(n);return i}return Qr=r,Qr}var en,jo;function ce(){if(jo)return en;jo=1;function r(e){return e!=null&&typeof e=="object"}return en=r,en}var tn,zo;function ch(){if(zo)return tn;zo=1;var r=Ne(),e=ce(),t="[object Arguments]";function n(i){return e(i)&&r(i)==t}return tn=n,tn}var rn,Ho;function kt(){if(Ho)return rn;Ho=1;var r=ch(),e=ce(),t=Object.prototype,n=t.hasOwnProperty,i=t.propertyIsEnumerable,s=r((function(){return arguments})())?r:function(a){return e(a)&&n.call(a,"callee")&&!i.call(a,"callee")};return rn=s,rn}var nn,$o;function B(){if($o)return nn;$o=1;var r=Array.isArray;return nn=r,nn}var Ye={exports:{}},sn,Uo;function uh(){if(Uo)return sn;Uo=1;function r(){return!1}return sn=r,sn}Ye.exports;var Wo;function it(){return Wo||(Wo=1,(function(r,e){var t=te(),n=uh(),i=e&&!e.nodeType&&e,s=i&&!0&&r&&!r.nodeType&&r,a=s&&s.exports===i,o=a?t.Buffer:void 0,c=o?o.isBuffer:void 0,l=c||n;r.exports=l})(Ye,Ye.exports)),Ye.exports}var an,Yo;function yd(){if(Yo)return an;Yo=1;var r=9007199254740991,e=/^(?:0|[1-9]\d*)$/;function t(n,i){var s=typeof n;return i=i??r,!!i&&(s=="number"||s!="symbol"&&e.test(n))&&n>-1&&n%1==0&&n<i}return an=t,an}var on,Vo;function va(){if(Vo)return on;Vo=1;var r=9007199254740991;function e(t){return typeof t=="number"&&t>-1&&t%1==0&&t<=r}return on=e,on}var cn,Xo;function lh(){if(Xo)return cn;Xo=1;var r=Ne(),e=va(),t=ce(),n="[object Arguments]",i="[object Array]",s="[object Boolean]",a="[object Date]",o="[object Error]",c="[object Function]",l="[object Map]",u="[object Number]",d="[object Object]",f="[object RegExp]",h="[object Set]",g="[object String]",p="[object WeakMap]",m="[object ArrayBuffer]",y="[object DataView]",_="[object Float32Array]",v="[object Float64Array]",w="[object Int8Array]",R="[object Int16Array]",P="[object Int32Array]",C="[object Uint8Array]",q="[object Uint8ClampedArray]",E="[object Uint16Array]",S="[object Uint32Array]",x={};x[_]=x[v]=x[w]=x[R]=x[P]=x[C]=x[q]=x[E]=x[S]=!0,x[n]=x[i]=x[m]=x[s]=x[y]=x[a]=x[o]=x[c]=x[l]=x[u]=x[d]=x[f]=x[h]=x[g]=x[p]=!1;function O(N){return t(N)&&e(N.length)&&!!x[r(N)]}return cn=O,cn}var un,Ko;function _a(){if(Ko)return un;Ko=1;function r(e){return function(t){return e(t)}}return un=r,un}var Ve={exports:{}};Ve.exports;var Zo;function ba(){return Zo||(Zo=1,(function(r,e){var t=fd(),n=e&&!e.nodeType&&e,i=n&&!0&&r&&!r.nodeType&&r,s=i&&i.exports===n,a=s&&t.process,o=(function(){try{var c=i&&i.require&&i.require("util").types;return c||a&&a.binding&&a.binding("util")}catch{}})();r.exports=o})(Ve,Ve.exports)),Ve.exports}var ln,Jo;function jt(){if(Jo)return ln;Jo=1;var r=lh(),e=_a(),t=ba(),n=t&&t.isTypedArray,i=n?e(n):r;return ln=i,ln}var dn,Qo;function vd(){if(Qo)return dn;Qo=1;var r=oh(),e=kt(),t=B(),n=it(),i=yd(),s=jt(),a=Object.prototype,o=a.hasOwnProperty;function c(l,u){var d=t(l),f=!d&&e(l),h=!d&&!f&&n(l),g=!d&&!f&&!h&&s(l),p=d||f||h||g,m=p?r(l.length,String):[],y=m.length;for(var _ in l)(u||o.call(l,_))&&!(p&&(_=="length"||h&&(_=="offset"||_=="parent")||g&&(_=="buffer"||_=="byteLength"||_=="byteOffset")||i(_,y)))&&m.push(_);return m}return dn=c,dn}var fn,ec;function zt(){if(ec)return fn;ec=1;var r=Object.prototype;function e(t){var n=t&&t.constructor,i=typeof n=="function"&&n.prototype||r;return t===i}return fn=e,fn}var hn,tc;function _d(){if(tc)return hn;tc=1;function r(e,t){return function(n){return e(t(n))}}return hn=r,hn}var gn,rc;function dh(){if(rc)return gn;rc=1;var r=_d(),e=r(Object.keys,Object);return gn=e,gn}var pn,nc;function wa(){if(nc)return pn;nc=1;var r=zt(),e=dh(),t=Object.prototype,n=t.hasOwnProperty;function i(s){if(!r(s))return e(s);var a=[];for(var o in Object(s))n.call(s,o)&&o!="constructor"&&a.push(o);return a}return pn=i,pn}var mn,ic;function Pe(){if(ic)return mn;ic=1;var r=Gt(),e=va();function t(n){return n!=null&&e(n.length)&&!r(n)}return mn=t,mn}var yn,sc;function Ce(){if(sc)return yn;sc=1;var r=vd(),e=wa(),t=Pe();function n(i){return t(i)?r(i):e(i)}return yn=n,yn}var vn,ac;function fh(){if(ac)return vn;ac=1;var r=Bt(),e=Ce();function t(n,i){return n&&r(i,e(i),n)}return vn=t,vn}var _n,oc;function hh(){if(oc)return _n;oc=1;function r(e){var t=[];if(e!=null)for(var n in Object(e))t.push(n);return t}return _n=r,_n}var bn,cc;function gh(){if(cc)return bn;cc=1;var r=we(),e=zt(),t=hh(),n=Object.prototype,i=n.hasOwnProperty;function s(a){if(!r(a))return t(a);var o=e(a),c=[];for(var l in a)l=="constructor"&&(o||!i.call(a,l))||c.push(l);return c}return bn=s,bn}var wn,uc;function Ia(){if(uc)return wn;uc=1;var r=vd(),e=gh(),t=Pe();function n(i){return t(i)?r(i,!0):e(i)}return wn=n,wn}var In,lc;function ph(){if(lc)return In;lc=1;var r=Bt(),e=Ia();function t(n,i){return n&&r(i,e(i),n)}return In=t,In}var Xe={exports:{}};Xe.exports;var dc;function mh(){return dc||(dc=1,(function(r,e){var t=te(),n=e&&!e.nodeType&&e,i=n&&!0&&r&&!r.nodeType&&r,s=i&&i.exports===n,a=s?t.Buffer:void 0,o=a?a.allocUnsafe:void 0;function c(l,u){if(u)return l.slice();var d=l.length,f=o?o(d):new l.constructor(d);return l.copy(f),f}r.exports=c})(Xe,Xe.exports)),Xe.exports}var Pn,fc;function yh(){if(fc)return Pn;fc=1;function r(e,t){var n=-1,i=e.length;for(t||(t=Array(i));++n<i;)t[n]=e[n];return t}return Pn=r,Pn}var Cn,hc;function bd(){if(hc)return Cn;hc=1;function r(e,t){for(var n=-1,i=e==null?0:e.length,s=0,a=[];++n<i;){var o=e[n];t(o,n,e)&&(a[s++]=o)}return a}return Cn=r,Cn}var En,gc;function wd(){if(gc)return En;gc=1;function r(){return[]}return En=r,En}var xn,pc;function Pa(){if(pc)return xn;pc=1;var r=bd(),e=wd(),t=Object.prototype,n=t.propertyIsEnumerable,i=Object.getOwnPropertySymbols,s=i?function(a){return a==null?[]:(a=Object(a),r(i(a),function(o){return n.call(a,o)}))}:e;return xn=s,xn}var Sn,mc;function vh(){if(mc)return Sn;mc=1;var r=Bt(),e=Pa();function t(n,i){return r(n,e(n),i)}return Sn=t,Sn}var qn,yc;function Ca(){if(yc)return qn;yc=1;function r(e,t){for(var n=-1,i=t.length,s=e.length;++n<i;)e[s+n]=t[n];return e}return qn=r,qn}var Rn,vc;function Ea(){if(vc)return Rn;vc=1;var r=_d(),e=r(Object.getPrototypeOf,Object);return Rn=e,Rn}var An,_c;function Id(){if(_c)return An;_c=1;var r=Ca(),e=Ea(),t=Pa(),n=wd(),i=Object.getOwnPropertySymbols,s=i?function(a){for(var o=[];a;)r(o,t(a)),a=e(a);return o}:n;return An=s,An}var Tn,bc;function _h(){if(bc)return Tn;bc=1;var r=Bt(),e=Id();function t(n,i){return r(n,e(n),i)}return Tn=t,Tn}var Mn,wc;function Pd(){if(wc)return Mn;wc=1;var r=Ca(),e=B();function t(n,i,s){var a=i(n);return e(n)?a:r(a,s(n))}return Mn=t,Mn}var On,Ic;function Cd(){if(Ic)return On;Ic=1;var r=Pd(),e=Pa(),t=Ce();function n(i){return r(i,t,e)}return On=n,On}var Ln,Pc;function bh(){if(Pc)return Ln;Pc=1;var r=Pd(),e=Id(),t=Ia();function n(i){return r(i,t,e)}return Ln=n,Ln}var Dn,Cc;function wh(){if(Cc)return Dn;Cc=1;var r=Ie(),e=te(),t=r(e,"DataView");return Dn=t,Dn}var Gn,Ec;function Ih(){if(Ec)return Gn;Ec=1;var r=Ie(),e=te(),t=r(e,"Promise");return Gn=t,Gn}var Fn,xc;function Ed(){if(xc)return Fn;xc=1;var r=Ie(),e=te(),t=r(e,"Set");return Fn=t,Fn}var Nn,Sc;function Ph(){if(Sc)return Nn;Sc=1;var r=Ie(),e=te(),t=r(e,"WeakMap");return Nn=t,Nn}var Bn,qc;function Be(){if(qc)return Bn;qc=1;var r=wh(),e=ga(),t=Ih(),n=Ed(),i=Ph(),s=Ne(),a=hd(),o="[object Map]",c="[object Object]",l="[object Promise]",u="[object Set]",d="[object WeakMap]",f="[object DataView]",h=a(r),g=a(e),p=a(t),m=a(n),y=a(i),_=s;return(r&&_(new r(new ArrayBuffer(1)))!=f||e&&_(new e)!=o||t&&_(t.resolve())!=l||n&&_(new n)!=u||i&&_(new i)!=d)&&(_=function(v){var w=s(v),R=w==c?v.constructor:void 0,P=R?a(R):"";if(P)switch(P){case h:return f;case g:return o;case p:return l;case m:return u;case y:return d}return w}),Bn=_,Bn}var kn,Rc;function Ch(){if(Rc)return kn;Rc=1;var r=Object.prototype,e=r.hasOwnProperty;function t(n){var i=n.length,s=new n.constructor(i);return i&&typeof n[0]=="string"&&e.call(n,"index")&&(s.index=n.index,s.input=n.input),s}return kn=t,kn}var jn,Ac;function xd(){if(Ac)return jn;Ac=1;var r=te(),e=r.Uint8Array;return jn=e,jn}var zn,Tc;function xa(){if(Tc)return zn;Tc=1;var r=xd();function e(t){var n=new t.constructor(t.byteLength);return new r(n).set(new r(t)),n}return zn=e,zn}var Hn,Mc;function Eh(){if(Mc)return Hn;Mc=1;var r=xa();function e(t,n){var i=n?r(t.buffer):t.buffer;return new t.constructor(i,t.byteOffset,t.byteLength)}return Hn=e,Hn}var $n,Oc;function xh(){if(Oc)return $n;Oc=1;var r=/\w*$/;function e(t){var n=new t.constructor(t.source,r.exec(t));return n.lastIndex=t.lastIndex,n}return $n=e,$n}var Un,Lc;function Sh(){if(Lc)return Un;Lc=1;var r=Fe(),e=r?r.prototype:void 0,t=e?e.valueOf:void 0;function n(i){return t?Object(t.call(i)):{}}return Un=n,Un}var Wn,Dc;function qh(){if(Dc)return Wn;Dc=1;var r=xa();function e(t,n){var i=n?r(t.buffer):t.buffer;return new t.constructor(i,t.byteOffset,t.length)}return Wn=e,Wn}var Yn,Gc;function Rh(){if(Gc)return Yn;Gc=1;var r=xa(),e=Eh(),t=xh(),n=Sh(),i=qh(),s="[object Boolean]",a="[object Date]",o="[object Map]",c="[object Number]",l="[object RegExp]",u="[object Set]",d="[object String]",f="[object Symbol]",h="[object ArrayBuffer]",g="[object DataView]",p="[object Float32Array]",m="[object Float64Array]",y="[object Int8Array]",_="[object Int16Array]",v="[object Int32Array]",w="[object Uint8Array]",R="[object Uint8ClampedArray]",P="[object Uint16Array]",C="[object Uint32Array]";function q(E,S,x){var O=E.constructor;switch(S){case h:return r(E);case s:case a:return new O(+E);case g:return e(E,x);case p:case m:case y:case _:case v:case w:case R:case P:case C:return i(E,x);case o:return new O;case c:case d:return new O(E);case l:return t(E);case u:return new O;case f:return n(E)}}return Yn=q,Yn}var Vn,Fc;function Sd(){if(Fc)return Vn;Fc=1;var r=we(),e=Object.create,t=(function(){function n(){}return function(i){if(!r(i))return{};if(e)return e(i);n.prototype=i;var s=new n;return n.prototype=void 0,s}})();return Vn=t,Vn}var Xn,Nc;function Ah(){if(Nc)return Xn;Nc=1;var r=Sd(),e=Ea(),t=zt();function n(i){return typeof i.constructor=="function"&&!t(i)?r(e(i)):{}}return Xn=n,Xn}var Kn,Bc;function Th(){if(Bc)return Kn;Bc=1;var r=Be(),e=ce(),t="[object Map]";function n(i){return e(i)&&r(i)==t}return Kn=n,Kn}var Zn,kc;function Mh(){if(kc)return Zn;kc=1;var r=Th(),e=_a(),t=ba(),n=t&&t.isMap,i=n?e(n):r;return Zn=i,Zn}var Jn,jc;function Oh(){if(jc)return Jn;jc=1;var r=Be(),e=ce(),t="[object Set]";function n(i){return e(i)&&r(i)==t}return Jn=n,Jn}var Qn,zc;function Lh(){if(zc)return Qn;zc=1;var r=Oh(),e=_a(),t=ba(),n=t&&t.isSet,i=n?e(n):r;return Qn=i,Qn}var ei,Hc;function Dh(){if(Hc)return ei;Hc=1;var r=ma(),e=ya(),t=md(),n=fh(),i=ph(),s=mh(),a=yh(),o=vh(),c=_h(),l=Cd(),u=bh(),d=Be(),f=Ch(),h=Rh(),g=Ah(),p=B(),m=it(),y=Mh(),_=we(),v=Lh(),w=Ce(),R=Ia(),P=1,C=2,q=4,E="[object Arguments]",S="[object Array]",x="[object Boolean]",O="[object Date]",N="[object Error]",ue="[object Function]",le="[object GeneratorFunction]",de="[object Map]",W="[object Number]",je="[object Object]",Xt="[object RegExp]",lt="[object Set]",Kt="[object String]",Zt="[object Symbol]",Jt="[object WeakMap]",Qt="[object ArrayBuffer]",er="[object DataView]",ze="[object Float32Array]",He="[object Float64Array]",dt="[object Int8Array]",ft="[object Int16Array]",tr="[object Int32Array]",rr="[object Uint8Array]",ht="[object Uint8ClampedArray]",nr="[object Uint16Array]",Ef="[object Uint32Array]",D={};D[E]=D[S]=D[Qt]=D[er]=D[x]=D[O]=D[ze]=D[He]=D[dt]=D[ft]=D[tr]=D[de]=D[W]=D[je]=D[Xt]=D[lt]=D[Kt]=D[Zt]=D[rr]=D[ht]=D[nr]=D[Ef]=!0,D[N]=D[ue]=D[Jt]=!1;function gt(L,Ee,xe,xf,pt,fe){var H,mt=Ee&P,yt=Ee&C,Sf=Ee&q;if(xe&&(H=pt?xe(L,xf,pt,fe):xe(L)),H!==void 0)return H;if(!_(L))return L;var Ba=p(L);if(Ba){if(H=f(L),!mt)return a(L,H)}else{var Se=d(L),ka=Se==ue||Se==le;if(m(L))return s(L,mt);if(Se==je||Se==E||ka&&!pt){if(H=yt||ka?{}:g(L),!mt)return yt?c(L,i(H,L)):o(L,n(H,L))}else{if(!D[Se])return pt?L:{};H=h(L,Se,mt)}}fe||(fe=new r);var ja=fe.get(L);if(ja)return ja;fe.set(L,H),v(L)?L.forEach(function(he){H.add(gt(he,Ee,xe,he,L,fe))}):y(L)&&L.forEach(function(he,me){H.set(me,gt(he,Ee,xe,me,L,fe))});var qf=Sf?yt?u:l:yt?R:w,za=Ba?void 0:qf(L);return e(za||L,function(he,me){za&&(me=he,he=L[me]),t(H,me,gt(he,Ee,xe,me,L,fe))}),H}return ei=gt,ei}var ti,$c;function Gh(){if($c)return ti;$c=1;var r=Dh(),e=4;function t(n){return r(n,e)}return ti=t,ti}var ri,Uc;function qd(){if(Uc)return ri;Uc=1;function r(e){return function(){return e}}return ri=r,ri}var ni,Wc;function Fh(){if(Wc)return ni;Wc=1;function r(e){return function(t,n,i){for(var s=-1,a=Object(t),o=i(t),c=o.length;c--;){var l=o[e?c:++s];if(n(a[l],l,a)===!1)break}return t}}return ni=r,ni}var ii,Yc;function Nh(){if(Yc)return ii;Yc=1;var r=Fh(),e=r();return ii=e,ii}var si,Vc;function Rd(){if(Vc)return si;Vc=1;var r=Nh(),e=Ce();function t(n,i){return n&&r(n,i,e)}return si=t,si}var ai,Xc;function Bh(){if(Xc)return ai;Xc=1;var r=Pe();function e(t,n){return function(i,s){if(i==null)return i;if(!r(i))return t(i,s);for(var a=i.length,o=n?a:-1,c=Object(i);(n?o--:++o<a)&&s(c[o],o,c)!==!1;);return i}}return ai=e,ai}var oi,Kc;function Ht(){if(Kc)return oi;Kc=1;var r=Rd(),e=Bh(),t=e(r);return oi=t,oi}var ci,Zc;function $t(){if(Zc)return ci;Zc=1;function r(e){return e}return ci=r,ci}var ui,Jc;function kh(){if(Jc)return ui;Jc=1;var r=$t();function e(t){return typeof t=="function"?t:r}return ui=e,ui}var li,Qc;function jh(){if(Qc)return li;Qc=1;var r=ya(),e=Ht(),t=kh(),n=B();function i(s,a){var o=n(s)?r:e;return o(s,t(a))}return li=i,li}var di,eu;function zh(){return eu||(eu=1,di=jh()),di}var fi,tu;function Hh(){if(tu)return fi;tu=1;var r=Ht();function e(t,n){var i=[];return r(t,function(s,a,o){n(s,a,o)&&i.push(s)}),i}return fi=e,fi}var hi,ru;function $h(){if(ru)return hi;ru=1;var r="__lodash_hash_undefined__";function e(t){return this.__data__.set(t,r),this}return hi=e,hi}var gi,nu;function Uh(){if(nu)return gi;nu=1;function r(e){return this.__data__.has(e)}return gi=r,gi}var pi,iu;function Ad(){if(iu)return pi;iu=1;var r=pa(),e=$h(),t=Uh();function n(i){var s=-1,a=i==null?0:i.length;for(this.__data__=new r;++s<a;)this.add(i[s])}return n.prototype.add=n.prototype.push=e,n.prototype.has=t,pi=n,pi}var mi,su;function Wh(){if(su)return mi;su=1;function r(e,t){for(var n=-1,i=e==null?0:e.length;++n<i;)if(t(e[n],n,e))return!0;return!1}return mi=r,mi}var yi,au;function Td(){if(au)return yi;au=1;function r(e,t){return e.has(t)}return yi=r,yi}var vi,ou;function Md(){if(ou)return vi;ou=1;var r=Ad(),e=Wh(),t=Td(),n=1,i=2;function s(a,o,c,l,u,d){var f=c&n,h=a.length,g=o.length;if(h!=g&&!(f&&g>h))return!1;var p=d.get(a),m=d.get(o);if(p&&m)return p==o&&m==a;var y=-1,_=!0,v=c&i?new r:void 0;for(d.set(a,o),d.set(o,a);++y<h;){var w=a[y],R=o[y];if(l)var P=f?l(R,w,y,o,a,d):l(w,R,y,a,o,d);if(P!==void 0){if(P)continue;_=!1;break}if(v){if(!e(o,function(C,q){if(!t(v,q)&&(w===C||u(w,C,c,l,d)))return v.push(q)})){_=!1;break}}else if(!(w===R||u(w,R,c,l,d))){_=!1;break}}return d.delete(a),d.delete(o),_}return vi=s,vi}var _i,cu;function Yh(){if(cu)return _i;cu=1;function r(e){var t=-1,n=Array(e.size);return e.forEach(function(i,s){n[++t]=[s,i]}),n}return _i=r,_i}var bi,uu;function Sa(){if(uu)return bi;uu=1;function r(e){var t=-1,n=Array(e.size);return e.forEach(function(i){n[++t]=i}),n}return bi=r,bi}var wi,lu;function Vh(){if(lu)return wi;lu=1;var r=Fe(),e=xd(),t=ha(),n=Md(),i=Yh(),s=Sa(),a=1,o=2,c="[object Boolean]",l="[object Date]",u="[object Error]",d="[object Map]",f="[object Number]",h="[object RegExp]",g="[object Set]",p="[object String]",m="[object Symbol]",y="[object ArrayBuffer]",_="[object DataView]",v=r?r.prototype:void 0,w=v?v.valueOf:void 0;function R(P,C,q,E,S,x,O){switch(q){case _:if(P.byteLength!=C.byteLength||P.byteOffset!=C.byteOffset)return!1;P=P.buffer,C=C.buffer;case y:return!(P.byteLength!=C.byteLength||!x(new e(P),new e(C)));case c:case l:case f:return t(+P,+C);case u:return P.name==C.name&&P.message==C.message;case h:case p:return P==C+"";case d:var N=i;case g:var ue=E&a;if(N||(N=s),P.size!=C.size&&!ue)return!1;var le=O.get(P);if(le)return le==C;E|=o,O.set(P,C);var de=n(N(P),N(C),E,S,x,O);return O.delete(P),de;case m:if(w)return w.call(P)==w.call(C)}return!1}return wi=R,wi}var Ii,du;function Xh(){if(du)return Ii;du=1;var r=Cd(),e=1,t=Object.prototype,n=t.hasOwnProperty;function i(s,a,o,c,l,u){var d=o&e,f=r(s),h=f.length,g=r(a),p=g.length;if(h!=p&&!d)return!1;for(var m=h;m--;){var y=f[m];if(!(d?y in a:n.call(a,y)))return!1}var _=u.get(s),v=u.get(a);if(_&&v)return _==a&&v==s;var w=!0;u.set(s,a),u.set(a,s);for(var R=d;++m<h;){y=f[m];var P=s[y],C=a[y];if(c)var q=d?c(C,P,y,a,s,u):c(P,C,y,s,a,u);if(!(q===void 0?P===C||l(P,C,o,c,u):q)){w=!1;break}R||(R=y=="constructor")}if(w&&!R){var E=s.constructor,S=a.constructor;E!=S&&"constructor"in s&&"constructor"in a&&!(typeof E=="function"&&E instanceof E&&typeof S=="function"&&S instanceof S)&&(w=!1)}return u.delete(s),u.delete(a),w}return Ii=i,Ii}var Pi,fu;function Kh(){if(fu)return Pi;fu=1;var r=ma(),e=Md(),t=Vh(),n=Xh(),i=Be(),s=B(),a=it(),o=jt(),c=1,l="[object Arguments]",u="[object Array]",d="[object Object]",f=Object.prototype,h=f.hasOwnProperty;function g(p,m,y,_,v,w){var R=s(p),P=s(m),C=R?u:i(p),q=P?u:i(m);C=C==l?d:C,q=q==l?d:q;var E=C==d,S=q==d,x=C==q;if(x&&a(p)){if(!a(m))return!1;R=!0,E=!1}if(x&&!E)return w||(w=new r),R||o(p)?e(p,m,y,_,v,w):t(p,m,C,y,_,v,w);if(!(y&c)){var O=E&&h.call(p,"__wrapped__"),N=S&&h.call(m,"__wrapped__");if(O||N){var ue=O?p.value():p,le=N?m.value():m;return w||(w=new r),v(ue,le,y,_,w)}}return x?(w||(w=new r),n(p,m,y,_,v,w)):!1}return Pi=g,Pi}var Ci,hu;function Od(){if(hu)return Ci;hu=1;var r=Kh(),e=ce();function t(n,i,s,a,o){return n===i?!0:n==null||i==null||!e(n)&&!e(i)?n!==n&&i!==i:r(n,i,s,a,t,o)}return Ci=t,Ci}var Ei,gu;function Zh(){if(gu)return Ei;gu=1;var r=ma(),e=Od(),t=1,n=2;function i(s,a,o,c){var l=o.length,u=l,d=!c;if(s==null)return!u;for(s=Object(s);l--;){var f=o[l];if(d&&f[2]?f[1]!==s[f[0]]:!(f[0]in s))return!1}for(;++l<u;){f=o[l];var h=f[0],g=s[h],p=f[1];if(d&&f[2]){if(g===void 0&&!(h in s))return!1}else{var m=new r;if(c)var y=c(g,p,h,s,a,m);if(!(y===void 0?e(p,g,t|n,c,m):y))return!1}}return!0}return Ei=i,Ei}var xi,pu;function Ld(){if(pu)return xi;pu=1;var r=we();function e(t){return t===t&&!r(t)}return xi=e,xi}var Si,mu;function Jh(){if(mu)return Si;mu=1;var r=Ld(),e=Ce();function t(n){for(var i=e(n),s=i.length;s--;){var a=i[s],o=n[a];i[s]=[a,o,r(o)]}return i}return Si=t,Si}var qi,yu;function Dd(){if(yu)return qi;yu=1;function r(e,t){return function(n){return n==null?!1:n[e]===t&&(t!==void 0||e in Object(n))}}return qi=r,qi}var Ri,vu;function Qh(){if(vu)return Ri;vu=1;var r=Zh(),e=Jh(),t=Dd();function n(i){var s=e(i);return s.length==1&&s[0][2]?t(s[0][0],s[0][1]):function(a){return a===i||r(a,i,s)}}return Ri=n,Ri}var Ai,_u;function qa(){if(_u)return Ai;_u=1;var r=Ne(),e=ce(),t="[object Symbol]";function n(i){return typeof i=="symbol"||e(i)&&r(i)==t}return Ai=n,Ai}var Ti,bu;function Ra(){if(bu)return Ti;bu=1;var r=B(),e=qa(),t=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,n=/^\w*$/;function i(s,a){if(r(s))return!1;var o=typeof s;return o=="number"||o=="symbol"||o=="boolean"||s==null||e(s)?!0:n.test(s)||!t.test(s)||a!=null&&s in Object(a)}return Ti=i,Ti}var Mi,wu;function eg(){if(wu)return Mi;wu=1;var r=pa(),e="Expected a function";function t(n,i){if(typeof n!="function"||i!=null&&typeof i!="function")throw new TypeError(e);var s=function(){var a=arguments,o=i?i.apply(this,a):a[0],c=s.cache;if(c.has(o))return c.get(o);var l=n.apply(this,a);return s.cache=c.set(o,l)||c,l};return s.cache=new(t.Cache||r),s}return t.Cache=r,Mi=t,Mi}var Oi,Iu;function tg(){if(Iu)return Oi;Iu=1;var r=eg(),e=500;function t(n){var i=r(n,function(a){return s.size===e&&s.clear(),a}),s=i.cache;return i}return Oi=t,Oi}var Li,Pu;function rg(){if(Pu)return Li;Pu=1;var r=tg(),e=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,t=/\\(\\)?/g,n=r(function(i){var s=[];return i.charCodeAt(0)===46&&s.push(""),i.replace(e,function(a,o,c,l){s.push(c?l.replace(t,"$1"):o||a)}),s});return Li=n,Li}var Di,Cu;function Aa(){if(Cu)return Di;Cu=1;function r(e,t){for(var n=-1,i=e==null?0:e.length,s=Array(i);++n<i;)s[n]=t(e[n],n,e);return s}return Di=r,Di}var Gi,Eu;function ng(){if(Eu)return Gi;Eu=1;var r=Fe(),e=Aa(),t=B(),n=qa(),i=r?r.prototype:void 0,s=i?i.toString:void 0;function a(o){if(typeof o=="string")return o;if(t(o))return e(o,a)+"";if(n(o))return s?s.call(o):"";var c=o+"";return c=="0"&&1/o==-1/0?"-0":c}return Gi=a,Gi}var Fi,xu;function ig(){if(xu)return Fi;xu=1;var r=ng();function e(t){return t==null?"":r(t)}return Fi=e,Fi}var Ni,Su;function Gd(){if(Su)return Ni;Su=1;var r=B(),e=Ra(),t=rg(),n=ig();function i(s,a){return r(s)?s:e(s,a)?[s]:t(n(s))}return Ni=i,Ni}var Bi,qu;function Ut(){if(qu)return Bi;qu=1;var r=qa();function e(t){if(typeof t=="string"||r(t))return t;var n=t+"";return n=="0"&&1/t==-1/0?"-0":n}return Bi=e,Bi}var ki,Ru;function Fd(){if(Ru)return ki;Ru=1;var r=Gd(),e=Ut();function t(n,i){i=r(i,n);for(var s=0,a=i.length;n!=null&&s<a;)n=n[e(i[s++])];return s&&s==a?n:void 0}return ki=t,ki}var ji,Au;function sg(){if(Au)return ji;Au=1;var r=Fd();function e(t,n,i){var s=t==null?void 0:r(t,n);return s===void 0?i:s}return ji=e,ji}var zi,Tu;function ag(){if(Tu)return zi;Tu=1;function r(e,t){return e!=null&&t in Object(e)}return zi=r,zi}var Hi,Mu;function Nd(){if(Mu)return Hi;Mu=1;var r=Gd(),e=kt(),t=B(),n=yd(),i=va(),s=Ut();function a(o,c,l){c=r(c,o);for(var u=-1,d=c.length,f=!1;++u<d;){var h=s(c[u]);if(!(f=o!=null&&l(o,h)))break;o=o[h]}return f||++u!=d?f:(d=o==null?0:o.length,!!d&&i(d)&&n(h,d)&&(t(o)||e(o)))}return Hi=a,Hi}var $i,Ou;function og(){if(Ou)return $i;Ou=1;var r=ag(),e=Nd();function t(n,i){return n!=null&&e(n,i,r)}return $i=t,$i}var Ui,Lu;function cg(){if(Lu)return Ui;Lu=1;var r=Od(),e=sg(),t=og(),n=Ra(),i=Ld(),s=Dd(),a=Ut(),o=1,c=2;function l(u,d){return n(u)&&i(d)?s(a(u),d):function(f){var h=e(f,u);return h===void 0&&h===d?t(f,u):r(d,h,o|c)}}return Ui=l,Ui}var Wi,Du;function Bd(){if(Du)return Wi;Du=1;function r(e){return function(t){return t==null?void 0:t[e]}}return Wi=r,Wi}var Yi,Gu;function ug(){if(Gu)return Yi;Gu=1;var r=Fd();function e(t){return function(n){return r(n,t)}}return Yi=e,Yi}var Vi,Fu;function lg(){if(Fu)return Vi;Fu=1;var r=Bd(),e=ug(),t=Ra(),n=Ut();function i(s){return t(s)?r(n(s)):e(s)}return Vi=i,Vi}var Xi,Nu;function Wt(){if(Nu)return Xi;Nu=1;var r=Qh(),e=cg(),t=$t(),n=B(),i=lg();function s(a){return typeof a=="function"?a:a==null?t:typeof a=="object"?n(a)?e(a[0],a[1]):r(a):i(a)}return Xi=s,Xi}var Ki,Bu;function dg(){if(Bu)return Ki;Bu=1;var r=bd(),e=Hh(),t=Wt(),n=B();function i(s,a){var o=n(s)?r:e;return o(s,t(a,3))}return Ki=i,Ki}var Zi,ku;function fg(){if(ku)return Zi;ku=1;var r=Object.prototype,e=r.hasOwnProperty;function t(n,i){return n!=null&&e.call(n,i)}return Zi=t,Zi}var Ji,ju;function hg(){if(ju)return Ji;ju=1;var r=fg(),e=Nd();function t(n,i){return n!=null&&e(n,i,r)}return Ji=t,Ji}var Qi,zu;function gg(){if(zu)return Qi;zu=1;var r=wa(),e=Be(),t=kt(),n=B(),i=Pe(),s=it(),a=zt(),o=jt(),c="[object Map]",l="[object Set]",u=Object.prototype,d=u.hasOwnProperty;function f(h){if(h==null)return!0;if(i(h)&&(n(h)||typeof h=="string"||typeof h.splice=="function"||s(h)||o(h)||t(h)))return!h.length;var g=e(h);if(g==c||g==l)return!h.size;if(a(h))return!r(h).length;for(var p in h)if(d.call(h,p))return!1;return!0}return Qi=f,Qi}var es,Hu;function pg(){if(Hu)return es;Hu=1;function r(e){return e===void 0}return es=r,es}var ts,$u;function mg(){if($u)return ts;$u=1;var r=Ht(),e=Pe();function t(n,i){var s=-1,a=e(n)?Array(n.length):[];return r(n,function(o,c,l){a[++s]=i(o,c,l)}),a}return ts=t,ts}var rs,Uu;function yg(){if(Uu)return rs;Uu=1;var r=Aa(),e=Wt(),t=mg(),n=B();function i(s,a){var o=n(s)?r:t;return o(s,e(a,3))}return rs=i,rs}var ns,Wu;function vg(){if(Wu)return ns;Wu=1;function r(e,t,n,i){var s=-1,a=e==null?0:e.length;for(i&&a&&(n=e[++s]);++s<a;)n=t(n,e[s],s,e);return n}return ns=r,ns}var is,Yu;function _g(){if(Yu)return is;Yu=1;function r(e,t,n,i,s){return s(e,function(a,o,c){n=i?(i=!1,a):t(n,a,o,c)}),n}return is=r,is}var ss,Vu;function bg(){if(Vu)return ss;Vu=1;var r=vg(),e=Ht(),t=Wt(),n=_g(),i=B();function s(a,o,c){var l=i(a)?r:n,u=arguments.length<3;return l(a,t(o,4),c,u,e)}return ss=s,ss}var as,Xu;function wg(){if(Xu)return as;Xu=1;var r=Ne(),e=B(),t=ce(),n="[object String]";function i(s){return typeof s=="string"||!e(s)&&t(s)&&r(s)==n}return as=i,as}var os,Ku;function Ig(){if(Ku)return os;Ku=1;var r=Bd(),e=r("length");return os=e,os}var cs,Zu;function Pg(){if(Zu)return cs;Zu=1;var r="\\ud800-\\udfff",e="\\u0300-\\u036f",t="\\ufe20-\\ufe2f",n="\\u20d0-\\u20ff",i=e+t+n,s="\\ufe0e\\ufe0f",a="\\u200d",o=RegExp("["+a+r+i+s+"]");function c(l){return o.test(l)}return cs=c,cs}var us,Ju;function Cg(){if(Ju)return us;Ju=1;var r="\\ud800-\\udfff",e="\\u0300-\\u036f",t="\\ufe20-\\ufe2f",n="\\u20d0-\\u20ff",i=e+t+n,s="\\ufe0e\\ufe0f",a="["+r+"]",o="["+i+"]",c="\\ud83c[\\udffb-\\udfff]",l="(?:"+o+"|"+c+")",u="[^"+r+"]",d="(?:\\ud83c[\\udde6-\\uddff]){2}",f="[\\ud800-\\udbff][\\udc00-\\udfff]",h="\\u200d",g=l+"?",p="["+s+"]?",m="(?:"+h+"(?:"+[u,d,f].join("|")+")"+p+g+")*",y=p+g+m,_="(?:"+[u+o+"?",o,d,f,a].join("|")+")",v=RegExp(c+"(?="+c+")|"+_+y,"g");function w(R){for(var P=v.lastIndex=0;v.test(R);)++P;return P}return us=w,us}var ls,Qu;function Eg(){if(Qu)return ls;Qu=1;var r=Ig(),e=Pg(),t=Cg();function n(i){return e(i)?t(i):r(i)}return ls=n,ls}var ds,el;function xg(){if(el)return ds;el=1;var r=wa(),e=Be(),t=Pe(),n=wg(),i=Eg(),s="[object Map]",a="[object Set]";function o(c){if(c==null)return 0;if(t(c))return n(c)?i(c):c.length;var l=e(c);return l==s||l==a?c.size:r(c).length}return ds=o,ds}var fs,tl;function Sg(){if(tl)return fs;tl=1;var r=ya(),e=Sd(),t=Rd(),n=Wt(),i=Ea(),s=B(),a=it(),o=Gt(),c=we(),l=jt();function u(d,f,h){var g=s(d),p=g||a(d)||l(d);if(f=n(f,4),h==null){var m=d&&d.constructor;p?h=g?new m:[]:c(d)?h=o(m)?e(i(d)):{}:h={}}return(p?r:t)(d,function(y,_,v){return f(h,y,_,v)}),h}return fs=u,fs}var hs,rl;function qg(){if(rl)return hs;rl=1;var r=Fe(),e=kt(),t=B(),n=r?r.isConcatSpreadable:void 0;function i(s){return t(s)||e(s)||!!(n&&s&&s[n])}return hs=i,hs}var gs,nl;function Rg(){if(nl)return gs;nl=1;var r=Ca(),e=qg();function t(n,i,s,a,o){var c=-1,l=n.length;for(s||(s=e),o||(o=[]);++c<l;){var u=n[c];i>0&&s(u)?i>1?t(u,i-1,s,a,o):r(o,u):a||(o[o.length]=u)}return o}return gs=t,gs}var ps,il;function Ag(){if(il)return ps;il=1;function r(e,t,n){switch(n.length){case 0:return e.call(t);case 1:return e.call(t,n[0]);case 2:return e.call(t,n[0],n[1]);case 3:return e.call(t,n[0],n[1],n[2])}return e.apply(t,n)}return ps=r,ps}var ms,sl;function Tg(){if(sl)return ms;sl=1;var r=Ag(),e=Math.max;function t(n,i,s){return i=e(i===void 0?n.length-1:i,0),function(){for(var a=arguments,o=-1,c=e(a.length-i,0),l=Array(c);++o<c;)l[o]=a[i+o];o=-1;for(var u=Array(i+1);++o<i;)u[o]=a[o];return u[i]=s(l),r(n,this,u)}}return ms=t,ms}var ys,al;function Mg(){if(al)return ys;al=1;var r=qd(),e=gd(),t=$t(),n=e?function(i,s){return e(i,"toString",{configurable:!0,enumerable:!1,value:r(s),writable:!0})}:t;return ys=n,ys}var vs,ol;function Og(){if(ol)return vs;ol=1;var r=800,e=16,t=Date.now;function n(i){var s=0,a=0;return function(){var o=t(),c=e-(o-a);if(a=o,c>0){if(++s>=r)return arguments[0]}else s=0;return i.apply(void 0,arguments)}}return vs=n,vs}var _s,cl;function Lg(){if(cl)return _s;cl=1;var r=Mg(),e=Og(),t=e(r);return _s=t,_s}var bs,ul;function Dg(){if(ul)return bs;ul=1;var r=$t(),e=Tg(),t=Lg();function n(i,s){return t(e(i,s,r),i+"")}return bs=n,bs}var ws,ll;function Gg(){if(ll)return ws;ll=1;function r(e,t,n,i){for(var s=e.length,a=n+(i?1:-1);i?a--:++a<s;)if(t(e[a],a,e))return a;return-1}return ws=r,ws}var Is,dl;function Fg(){if(dl)return Is;dl=1;function r(e){return e!==e}return Is=r,Is}var Ps,fl;function Ng(){if(fl)return Ps;fl=1;function r(e,t,n){for(var i=n-1,s=e.length;++i<s;)if(e[i]===t)return i;return-1}return Ps=r,Ps}var Cs,hl;function Bg(){if(hl)return Cs;hl=1;var r=Gg(),e=Fg(),t=Ng();function n(i,s,a){return s===s?t(i,s,a):r(i,e,a)}return Cs=n,Cs}var Es,gl;function kg(){if(gl)return Es;gl=1;var r=Bg();function e(t,n){var i=t==null?0:t.length;return!!i&&r(t,n,0)>-1}return Es=e,Es}var xs,pl;function jg(){if(pl)return xs;pl=1;function r(e,t,n){for(var i=-1,s=e==null?0:e.length;++i<s;)if(n(t,e[i]))return!0;return!1}return xs=r,xs}var Ss,ml;function zg(){if(ml)return Ss;ml=1;function r(){}return Ss=r,Ss}var qs,yl;function Hg(){if(yl)return qs;yl=1;var r=Ed(),e=zg(),t=Sa(),n=1/0,i=r&&1/t(new r([,-0]))[1]==n?function(s){return new r(s)}:e;return qs=i,qs}var Rs,vl;function $g(){if(vl)return Rs;vl=1;var r=Ad(),e=kg(),t=jg(),n=Td(),i=Hg(),s=Sa(),a=200;function o(c,l,u){var d=-1,f=e,h=c.length,g=!0,p=[],m=p;if(u)g=!1,f=t;else if(h>=a){var y=l?null:i(c);if(y)return s(y);g=!1,f=n,m=new r}else m=l?[]:p;e:for(;++d<h;){var _=c[d],v=l?l(_):_;if(_=u||_!==0?_:0,g&&v===v){for(var w=m.length;w--;)if(m[w]===v)continue e;l&&m.push(v),p.push(_)}else f(m,v,u)||(m!==p&&m.push(v),p.push(_))}return p}return Rs=o,Rs}var As,_l;function Ug(){if(_l)return As;_l=1;var r=Pe(),e=ce();function t(n){return e(n)&&r(n)}return As=t,As}var Ts,bl;function Wg(){if(bl)return Ts;bl=1;var r=Rg(),e=Dg(),t=$g(),n=Ug(),i=e(function(s){return t(r(s,1,n,!0))});return Ts=i,Ts}var Ms,wl;function Yg(){if(wl)return Ms;wl=1;var r=Aa();function e(t,n){return r(n,function(i){return t[i]})}return Ms=e,Ms}var Os,Il;function Vg(){if(Il)return Os;Il=1;var r=Yg(),e=Ce();function t(n){return n==null?[]:r(n,e(n))}return Os=t,Os}var Ls,Pl;function J(){if(Pl)return Ls;Pl=1;var r;if(typeof Mf=="function")try{r={clone:Gh(),constant:qd(),each:zh(),filter:dg(),has:hg(),isArray:B(),isEmpty:gg(),isFunction:Gt(),isUndefined:pg(),keys:Ce(),map:yg(),reduce:bg(),size:xg(),transform:Sg(),union:Wg(),values:Vg()}}catch{}return r||(r=window._),Ls=r,Ls}var Ds,Cl;function Ta(){if(Cl)return Ds;Cl=1;var r=J();Ds=i;var e="\0",t="\0",n="";function i(u){this._isDirected=r.has(u,"directed")?u.directed:!0,this._isMultigraph=r.has(u,"multigraph")?u.multigraph:!1,this._isCompound=r.has(u,"compound")?u.compound:!1,this._label=void 0,this._defaultNodeLabelFn=r.constant(void 0),this._defaultEdgeLabelFn=r.constant(void 0),this._nodes={},this._isCompound&&(this._parent={},this._children={},this._children[t]={}),this._in={},this._preds={},this._out={},this._sucs={},this._edgeObjs={},this._edgeLabels={}}i.prototype._nodeCount=0,i.prototype._edgeCount=0,i.prototype.isDirected=function(){return this._isDirected},i.prototype.isMultigraph=function(){return this._isMultigraph},i.prototype.isCompound=function(){return this._isCompound},i.prototype.setGraph=function(u){return this._label=u,this},i.prototype.graph=function(){return this._label},i.prototype.setDefaultNodeLabel=function(u){return r.isFunction(u)||(u=r.constant(u)),this._defaultNodeLabelFn=u,this},i.prototype.nodeCount=function(){return this._nodeCount},i.prototype.nodes=function(){return r.keys(this._nodes)},i.prototype.sources=function(){var u=this;return r.filter(this.nodes(),function(d){return r.isEmpty(u._in[d])})},i.prototype.sinks=function(){var u=this;return r.filter(this.nodes(),function(d){return r.isEmpty(u._out[d])})},i.prototype.setNodes=function(u,d){var f=arguments,h=this;return r.each(u,function(g){f.length>1?h.setNode(g,d):h.setNode(g)}),this},i.prototype.setNode=function(u,d){return r.has(this._nodes,u)?(arguments.length>1&&(this._nodes[u]=d),this):(this._nodes[u]=arguments.length>1?d:this._defaultNodeLabelFn(u),this._isCompound&&(this._parent[u]=t,this._children[u]={},this._children[t][u]=!0),this._in[u]={},this._preds[u]={},this._out[u]={},this._sucs[u]={},++this._nodeCount,this)},i.prototype.node=function(u){return this._nodes[u]},i.prototype.hasNode=function(u){return r.has(this._nodes,u)},i.prototype.removeNode=function(u){var d=this;if(r.has(this._nodes,u)){var f=function(h){d.removeEdge(d._edgeObjs[h])};delete this._nodes[u],this._isCompound&&(this._removeFromParentsChildList(u),delete this._parent[u],r.each(this.children(u),function(h){d.setParent(h)}),delete this._children[u]),r.each(r.keys(this._in[u]),f),delete this._in[u],delete this._preds[u],r.each(r.keys(this._out[u]),f),delete this._out[u],delete this._sucs[u],--this._nodeCount}return this},i.prototype.setParent=function(u,d){if(!this._isCompound)throw new Error("Cannot set parent in a non-compound graph");if(r.isUndefined(d))d=t;else{d+="";for(var f=d;!r.isUndefined(f);f=this.parent(f))if(f===u)throw new Error("Setting "+d+" as parent of "+u+" would create a cycle");this.setNode(d)}return this.setNode(u),this._removeFromParentsChildList(u),this._parent[u]=d,this._children[d][u]=!0,this},i.prototype._removeFromParentsChildList=function(u){delete this._children[this._parent[u]][u]},i.prototype.parent=function(u){if(this._isCompound){var d=this._parent[u];if(d!==t)return d}},i.prototype.children=function(u){if(r.isUndefined(u)&&(u=t),this._isCompound){var d=this._children[u];if(d)return r.keys(d)}else{if(u===t)return this.nodes();if(this.hasNode(u))return[]}},i.prototype.predecessors=function(u){var d=this._preds[u];if(d)return r.keys(d)},i.prototype.successors=function(u){var d=this._sucs[u];if(d)return r.keys(d)},i.prototype.neighbors=function(u){var d=this.predecessors(u);if(d)return r.union(d,this.successors(u))},i.prototype.isLeaf=function(u){var d;return this.isDirected()?d=this.successors(u):d=this.neighbors(u),d.length===0},i.prototype.filterNodes=function(u){var d=new this.constructor({directed:this._isDirected,multigraph:this._isMultigraph,compound:this._isCompound});d.setGraph(this.graph());var f=this;r.each(this._nodes,function(p,m){u(m)&&d.setNode(m,p)}),r.each(this._edgeObjs,function(p){d.hasNode(p.v)&&d.hasNode(p.w)&&d.setEdge(p,f.edge(p))});var h={};function g(p){var m=f.parent(p);return m===void 0||d.hasNode(m)?(h[p]=m,m):m in h?h[m]:g(m)}return this._isCompound&&r.each(d.nodes(),function(p){d.setParent(p,g(p))}),d},i.prototype.setDefaultEdgeLabel=function(u){return r.isFunction(u)||(u=r.constant(u)),this._defaultEdgeLabelFn=u,this},i.prototype.edgeCount=function(){return this._edgeCount},i.prototype.edges=function(){return r.values(this._edgeObjs)},i.prototype.setPath=function(u,d){var f=this,h=arguments;return r.reduce(u,function(g,p){return h.length>1?f.setEdge(g,p,d):f.setEdge(g,p),p}),this},i.prototype.setEdge=function(){var u,d,f,h,g=!1,p=arguments[0];typeof p=="object"&&p!==null&&"v"in p?(u=p.v,d=p.w,f=p.name,arguments.length===2&&(h=arguments[1],g=!0)):(u=p,d=arguments[1],f=arguments[3],arguments.length>2&&(h=arguments[2],g=!0)),u=""+u,d=""+d,r.isUndefined(f)||(f=""+f);var m=o(this._isDirected,u,d,f);if(r.has(this._edgeLabels,m))return g&&(this._edgeLabels[m]=h),this;if(!r.isUndefined(f)&&!this._isMultigraph)throw new Error("Cannot set a named edge when isMultigraph = false");this.setNode(u),this.setNode(d),this._edgeLabels[m]=g?h:this._defaultEdgeLabelFn(u,d,f);var y=c(this._isDirected,u,d,f);return u=y.v,d=y.w,Object.freeze(y),this._edgeObjs[m]=y,s(this._preds[d],u),s(this._sucs[u],d),this._in[d][m]=y,this._out[u][m]=y,this._edgeCount++,this},i.prototype.edge=function(u,d,f){var h=arguments.length===1?l(this._isDirected,arguments[0]):o(this._isDirected,u,d,f);return this._edgeLabels[h]},i.prototype.hasEdge=function(u,d,f){var h=arguments.length===1?l(this._isDirected,arguments[0]):o(this._isDirected,u,d,f);return r.has(this._edgeLabels,h)},i.prototype.removeEdge=function(u,d,f){var h=arguments.length===1?l(this._isDirected,arguments[0]):o(this._isDirected,u,d,f),g=this._edgeObjs[h];return g&&(u=g.v,d=g.w,delete this._edgeLabels[h],delete this._edgeObjs[h],a(this._preds[d],u),a(this._sucs[u],d),delete this._in[d][h],delete this._out[u][h],this._edgeCount--),this},i.prototype.inEdges=function(u,d){var f=this._in[u];if(f){var h=r.values(f);return d?r.filter(h,function(g){return g.v===d}):h}},i.prototype.outEdges=function(u,d){var f=this._out[u];if(f){var h=r.values(f);return d?r.filter(h,function(g){return g.w===d}):h}},i.prototype.nodeEdges=function(u,d){var f=this.inEdges(u,d);if(f)return f.concat(this.outEdges(u,d))};function s(u,d){u[d]?u[d]++:u[d]=1}function a(u,d){--u[d]||delete u[d]}function o(u,d,f,h){var g=""+d,p=""+f;if(!u&&g>p){var m=g;g=p,p=m}return g+n+p+n+(r.isUndefined(h)?e:h)}function c(u,d,f,h){var g=""+d,p=""+f;if(!u&&g>p){var m=g;g=p,p=m}var y={v:g,w:p};return h&&(y.name=h),y}function l(u,d){return o(u,d.v,d.w,d.name)}return Ds}var Gs,El;function Xg(){return El||(El=1,Gs="2.1.8"),Gs}var Fs,xl;function Kg(){return xl||(xl=1,Fs={Graph:Ta(),version:Xg()}),Fs}var Ns,Sl;function Zg(){if(Sl)return Ns;Sl=1;var r=J(),e=Ta();Ns={write:t,read:s};function t(a){var o={options:{directed:a.isDirected(),multigraph:a.isMultigraph(),compound:a.isCompound()},nodes:n(a),edges:i(a)};return r.isUndefined(a.graph())||(o.value=r.clone(a.graph())),o}function n(a){return r.map(a.nodes(),function(o){var c=a.node(o),l=a.parent(o),u={v:o};return r.isUndefined(c)||(u.value=c),r.isUndefined(l)||(u.parent=l),u})}function i(a){return r.map(a.edges(),function(o){var c=a.edge(o),l={v:o.v,w:o.w};return r.isUndefined(o.name)||(l.name=o.name),r.isUndefined(c)||(l.value=c),l})}function s(a){var o=new e(a.options).setGraph(a.value);return r.each(a.nodes,function(c){o.setNode(c.v,c.value),c.parent&&o.setParent(c.v,c.parent)}),r.each(a.edges,function(c){o.setEdge({v:c.v,w:c.w,name:c.name},c.value)}),o}return Ns}var Bs,ql;function Jg(){if(ql)return Bs;ql=1;var r=J();Bs=e;function e(t){var n={},i=[],s;function a(o){r.has(n,o)||(n[o]=!0,s.push(o),r.each(t.successors(o),a),r.each(t.predecessors(o),a))}return r.each(t.nodes(),function(o){s=[],a(o),s.length&&i.push(s)}),i}return Bs}var ks,Rl;function kd(){if(Rl)return ks;Rl=1;var r=J();ks=e;function e(){this._arr=[],this._keyIndices={}}return e.prototype.size=function(){return this._arr.length},e.prototype.keys=function(){return this._arr.map(function(t){return t.key})},e.prototype.has=function(t){return r.has(this._keyIndices,t)},e.prototype.priority=function(t){var n=this._keyIndices[t];if(n!==void 0)return this._arr[n].priority},e.prototype.min=function(){if(this.size()===0)throw new Error("Queue underflow");return this._arr[0].key},e.prototype.add=function(t,n){var i=this._keyIndices;if(t=String(t),!r.has(i,t)){var s=this._arr,a=s.length;return i[t]=a,s.push({key:t,priority:n}),this._decrease(a),!0}return!1},e.prototype.removeMin=function(){this._swap(0,this._arr.length-1);var t=this._arr.pop();return delete this._keyIndices[t.key],this._heapify(0),t.key},e.prototype.decrease=function(t,n){var i=this._keyIndices[t];if(n>this._arr[i].priority)throw new Error("New priority is greater than current priority. Key: "+t+" Old: "+this._arr[i].priority+" New: "+n);this._arr[i].priority=n,this._decrease(i)},e.prototype._heapify=function(t){var n=this._arr,i=2*t,s=i+1,a=t;i<n.length&&(a=n[i].priority<n[a].priority?i:a,s<n.length&&(a=n[s].priority<n[a].priority?s:a),a!==t&&(this._swap(t,a),this._heapify(a)))},e.prototype._decrease=function(t){for(var n=this._arr,i=n[t].priority,s;t!==0&&(s=t>>1,!(n[s].priority<i));)this._swap(t,s),t=s},e.prototype._swap=function(t,n){var i=this._arr,s=this._keyIndices,a=i[t],o=i[n];i[t]=o,i[n]=a,s[o.key]=t,s[a.key]=n},ks}var js,Al;function jd(){if(Al)return js;Al=1;var r=J(),e=kd();js=n;var t=r.constant(1);function n(s,a,o,c){return i(s,String(a),o||t,c||function(l){return s.outEdges(l)})}function i(s,a,o,c){var l={},u=new e,d,f,h=function(g){var p=g.v!==d?g.v:g.w,m=l[p],y=o(g),_=f.distance+y;if(y<0)throw new Error("dijkstra does not allow negative edge weights. Bad edge: "+g+" Weight: "+y);_<m.distance&&(m.distance=_,m.predecessor=d,u.decrease(p,_))};for(s.nodes().forEach(function(g){var p=g===a?0:Number.POSITIVE_INFINITY;l[g]={distance:p},u.add(g,p)});u.size()>0&&(d=u.removeMin(),f=l[d],f.distance!==Number.POSITIVE_INFINITY);)c(d).forEach(h);return l}return js}var zs,Tl;function Qg(){if(Tl)return zs;Tl=1;var r=jd(),e=J();zs=t;function t(n,i,s){return e.transform(n.nodes(),function(a,o){a[o]=r(n,o,i,s)},{})}return zs}var Hs,Ml;function zd(){if(Ml)return Hs;Ml=1;var r=J();Hs=e;function e(t){var n=0,i=[],s={},a=[];function o(c){var l=s[c]={onStack:!0,lowlink:n,index:n++};if(i.push(c),t.successors(c).forEach(function(f){r.has(s,f)?s[f].onStack&&(l.lowlink=Math.min(l.lowlink,s[f].index)):(o(f),l.lowlink=Math.min(l.lowlink,s[f].lowlink))}),l.lowlink===l.index){var u=[],d;do d=i.pop(),s[d].onStack=!1,u.push(d);while(c!==d);a.push(u)}}return t.nodes().forEach(function(c){r.has(s,c)||o(c)}),a}return Hs}var $s,Ol;function ep(){if(Ol)return $s;Ol=1;var r=J(),e=zd();$s=t;function t(n){return r.filter(e(n),function(i){return i.length>1||i.length===1&&n.hasEdge(i[0],i[0])})}return $s}var Us,Ll;function tp(){if(Ll)return Us;Ll=1;var r=J();Us=t;var e=r.constant(1);function t(i,s,a){return n(i,s||e,a||function(o){return i.outEdges(o)})}function n(i,s,a){var o={},c=i.nodes();return c.forEach(function(l){o[l]={},o[l][l]={distance:0},c.forEach(function(u){l!==u&&(o[l][u]={distance:Number.POSITIVE_INFINITY})}),a(l).forEach(function(u){var d=u.v===l?u.w:u.v,f=s(u);o[l][d]={distance:f,predecessor:l}})}),c.forEach(function(l){var u=o[l];c.forEach(function(d){var f=o[d];c.forEach(function(h){var g=f[l],p=u[h],m=f[h],y=g.distance+p.distance;y<m.distance&&(m.distance=y,m.predecessor=p.predecessor)})})}),o}return Us}var Ws,Dl;function Hd(){if(Dl)return Ws;Dl=1;var r=J();Ws=e,e.CycleException=t;function e(n){var i={},s={},a=[];function o(c){if(r.has(s,c))throw new t;r.has(i,c)||(s[c]=!0,i[c]=!0,r.each(n.predecessors(c),o),delete s[c],a.push(c))}if(r.each(n.sinks(),o),r.size(i)!==n.nodeCount())throw new t;return a}function t(){}return t.prototype=new Error,Ws}var Ys,Gl;function rp(){if(Gl)return Ys;Gl=1;var r=Hd();Ys=e;function e(t){try{r(t)}catch(n){if(n instanceof r.CycleException)return!1;throw n}return!0}return Ys}var Vs,Fl;function $d(){if(Fl)return Vs;Fl=1;var r=J();Vs=e;function e(n,i,s){r.isArray(i)||(i=[i]);var a=(n.isDirected()?n.successors:n.neighbors).bind(n),o=[],c={};return r.each(i,function(l){if(!n.hasNode(l))throw new Error("Graph does not have node: "+l);t(n,l,s==="post",c,a,o)}),o}function t(n,i,s,a,o,c){r.has(a,i)||(a[i]=!0,s||c.push(i),r.each(o(i),function(l){t(n,l,s,a,o,c)}),s&&c.push(i))}return Vs}var Xs,Nl;function np(){if(Nl)return Xs;Nl=1;var r=$d();Xs=e;function e(t,n){return r(t,n,"post")}return Xs}var Ks,Bl;function ip(){if(Bl)return Ks;Bl=1;var r=$d();Ks=e;function e(t,n){return r(t,n,"pre")}return Ks}var Zs,kl;function sp(){if(kl)return Zs;kl=1;var r=J(),e=Ta(),t=kd();Zs=n;function n(i,s){var a=new e,o={},c=new t,l;function u(f){var h=f.v===l?f.w:f.v,g=c.priority(h);if(g!==void 0){var p=s(f);p<g&&(o[h]=l,c.decrease(h,p))}}if(i.nodeCount()===0)return a;r.each(i.nodes(),function(f){c.add(f,Number.POSITIVE_INFINITY),a.setNode(f)}),c.decrease(i.nodes()[0],0);for(var d=!1;c.size()>0;){if(l=c.removeMin(),r.has(o,l))a.setEdge(l,o[l]);else{if(d)throw new Error("Input graph is not connected: "+i);d=!0}i.nodeEdges(l).forEach(u)}return a}return Zs}var Js,jl;function ap(){return jl||(jl=1,Js={components:Jg(),dijkstra:jd(),dijkstraAll:Qg(),findCycles:ep(),floydWarshall:tp(),isAcyclic:rp(),postorder:np(),preorder:ip(),prim:sp(),tarjan:zd(),topsort:Hd()}),Js}var Qs,zl;function op(){if(zl)return Qs;zl=1;var r=Kg();return Qs={Graph:r.Graph,json:Zg(),alg:ap(),version:r.version},Qs}var Hl=op();class cp{constructor(){this._cells=new Map}_key(e,t){return`${e},${t}`}set(e,t,n){this._cells.set(this._key(e,t),n)}get(e,t){return this._cells.get(this._key(e,t))}has(e,t){return this._cells.has(this._key(e,t))}delete(e,t){return this._cells.delete(this._key(e,t))}clear(){this._cells.clear()}getRange(e,t,n,i){const s=[];for(let a=n;a<=i;a++)for(let o=e;o<=t;o++){const c=this._key(o,a);this._cells.has(c)&&s.push({col:o,row:a,value:this._cells.get(c)})}return s}get size(){return this._cells.size}forEach(e){this._cells.forEach((t,n)=>{const[i,s]=n.split(",").map(Number);e(t,i,s)})}}const up=180,lp=80,dp=2.5;class fp{constructor(e,t,n=up){this.cellSize=n,this.grid=new cp,this.itemMap=new Map}_cellFor(e,t){typeof e=="object"&&e!==null&&(t=e.y,e=e.x);const n=Math.floor(e/this.cellSize),i=Math.floor(t/this.cellSize);return{col:n,row:i}}insert(e){const t=e.position instanceof b?e.position:e.pos instanceof b?e.pos:new b(e.x,e.y),{col:n,row:i}=this._cellFor(t);let s=this.grid.get(n,i);s||(s=new Set,this.grid.set(n,i,s)),s.add(e.id),this.itemMap.set(e.id,{col:n,row:i,point:t})}update(e){const t=e.position instanceof b?e.position:e.pos instanceof b?e.pos:new b(e.x,e.y),n=this.itemMap.get(e.id),{col:i,row:s}=this._cellFor(t);if(!n||n.col!==i||n.row!==s){if(n){const o=this.grid.get(n.col,n.row);o&&(o.delete(e.id),o.size===0&&this.grid.delete(n.col,n.row))}let a=this.grid.get(i,s);a||(a=new Set,this.grid.set(i,s,a)),a.add(e.id),this.itemMap.set(e.id,{col:i,row:s,point:t})}}remove(e){const t=this.itemMap.get(e.id);if(t){const n=this.grid.get(t.col,t.row);n&&(n.delete(e.id),n.size===0&&this.grid.delete(t.col,t.row)),this.itemMap.delete(e.id)}}queryRadius(e,t){const n=new Set,i=Math.floor((e.x-t)/this.cellSize),s=Math.floor((e.x+t)/this.cellSize),a=Math.floor((e.y-t)/this.cellSize),o=Math.floor((e.y+t)/this.cellSize);for(let c=a;c<=o;c++)for(let l=i;l<=s;l++){const u=this.grid.get(l,c);u&&u.forEach(d=>n.add(d))}return Array.from(n)}rebuild(e){this.grid.clear(),this.itemMap.clear(),e.forEach(t=>this.insert(t))}}function hp(r){return Math.max(lp,Math.round(r*dp))}class gp{constructor({spatialIndex:e=null,pieceElements:t=null}={}){this.spatialIndex=e,this.pieceElements=t,this._piecePositions=new Map,this._worldDataCache=new Map,this.maxZIndex=0,this._indexAreaW=null,this._indexAreaH=null,this._lastIndexSignature=null,this._bootstrapPositions()}_bootstrapPositions(){!I||!I.pieces||I.pieces.forEach(e=>{this.getPiecePosition(e.id)instanceof b||e.displayX!==void 0&&e.displayY!==void 0&&this._piecePositions.set(e.id,new b(e.displayX,e.displayY))})}resetPositions(){this._piecePositions.clear(),this._bootstrapPositions()}syncAllPositions(){!I||!I.pieces||(I.pieces.forEach(e=>{!this.getPiecePosition(e.id)&&e.displayX!==void 0&&e.displayY!==void 0&&this._piecePositions.set(e.id,new b(e.displayX,e.displayY))}),this._autoManageSpatialIndex())}registerPiece(e){if(!e)return;const t=!!this.spatialIndex;this._autoManageSpatialIndex(),t&&this.spatialIndex&&this._updateSpatialIndexFor(e.id)}attachSpatialIndex(){console.warn("GameTableController.attachSpatialIndex is deprecated  spatial index is internally managed.")}attachPieceElements(e){this.pieceElements=e,Tm(e)}bringToFront(e){var a;const t=(a=I.pieces)==null?void 0:a.find(o=>o.id===e);if(!t)return;const n=G.getGroupForPiece(t);if(!n)return;const i=n.allPieces;this.maxZIndex++;const s=this.maxZIndex;i.forEach(o=>{o.zIndex=s,Mm(o.id,s)})}initializeMaxZIndex(){I!=null&&I.pieces&&(this.maxZIndex=0,I.pieces.forEach(e=>{e.zIndex&&e.zIndex>this.maxZIndex&&(this.maxZIndex=e.zIndex)}))}updateViewportArea(e,t){this._indexAreaW=e,this._indexAreaH=t,this._autoManageSpatialIndex(!0)}_computeAvgPieceSize(){var e;return!I||!I.pieces||I.pieces.length===0?0:I.pieces.reduce((t,n)=>t+Math.min(n.imgRect.width,n.imgRect.height),0)/I.pieces.length*(((e=I.pieces[0])==null?void 0:e.scale)||1)}_autoManageSpatialIndex(e=!1){if(this._indexAreaW==null||this._indexAreaH==null)return;if(!I||!I.pieces||I.pieces.length===0){this.spatialIndex=null,this._lastIndexSignature=null;return}const t=I.pieces.length,n=this._computeAvgPieceSize(),i=`${t}|${n.toFixed(2)}|${this._indexAreaW}x${this._indexAreaH}`,s=!this.spatialIndex,a=this._lastIndexSignature!==i;if(e||s||a){this.spatialIndex=new fp(this._indexAreaW,this._indexAreaH,hp(n)),this._rebuildSpatialIndex(),this._lastIndexSignature=i;return}}_rebuildSpatialIndex(){if(!this.spatialIndex)return;const e=[];I.pieces.forEach(t=>{const n=this._getElement(t.id),i=t.getCenter?t.getCenter(n):this.getPiecePosition(t.id);i&&e.push({id:t.id,position:i})}),this.spatialIndex.rebuild(e)}getPiecePosition(e){return this._piecePositions.get(e)||null}getWorldData(e){const t=e.id,n=this.getPiecePosition(t);if(!n||!(n instanceof b))return{worldCorners:{},worldSPoints:{}};const i=e.rotation,s=e.scale;let a=this._worldDataCache.get(t);const o=!a||n.x!==a.lastPositionX||n.y!==a.lastPositionY,c=a&&(i!==a.lastRotation||s!==a.lastScale);return(!a||o||c)&&(a={data:this._computeWorldDataInternal(e),lastPositionX:n.x,lastPositionY:n.y,lastRotation:i,lastScale:s},this._worldDataCache.set(t,a)),a.data}getCenter(e,t=null){const n=e.calculateBoundingFrame(),i=e.scale;let s,a;t?(s=t.offsetWidth,a=t.offsetHeight):(s=n.width*i,a=n.height*i);const o=new b(s/2,a/2),l=n.centerOffset.scaled(i).sub(o);return this.getPiecePosition(e.id).sub(l).add(o)}_computeWorldDataInternal(e){const t=e.scale,n=this.getPiecePosition(e.id)||new b(0,0),i=e.calculateBoundingFrame(),a=new b(e.bitmap.width*t,e.bitmap.height*t).scaled(.5),c=i.centerOffset.scaled(t).sub(a),l=n.sub(c),u=e.getCenter(),d=y=>y.sub(i.topLeft).scaled(t),f=e.corners,h={nw:d(f.nw),ne:d(f.ne),se:d(f.se),sw:d(f.sw)},g={};for(const[y,_]of Object.entries(h)){const w=_.add(l).rotatedAroundDeg(u,e.rotation);g[y]=w}const p=e.sPoints,m={};return["north","east","south","west"].forEach(y=>{const _=p[y];if(!_){m[y]=null;return}const R=d(_).add(l).rotatedAroundDeg(u,e.rotation);m[y]=R}),{worldCorners:g,worldSPoints:m}}setPiecePosition(e,t){if(!(t instanceof b))throw new Error("GameTableController.setPiecePosition expects Point");this._piecePositions.set(e,t.clone()),this._updateSpatialIndexFor(e),this._applyDomPosition(e)}movePiece(e,t){const n=this.getPiecePosition(e);if(!n)return;const i=n.add(t);this.setPiecePosition(e,i)}movePieces(e,t){e.forEach(n=>this.movePiece(n,t))}placePieceCenter(e,t,n){const i=this._findPiece(e);if(!i)return;const s=n.offsetWidth,a=n.offsetHeight,o=i.calculateBoundingFrame(),c=i.scale||.35,l=new b(s/2,a/2),d=o.centerOffset.scaled(c).sub(l),f=t.sub(l).add(d);this.setPiecePosition(e,f)}moveGroup(e,t){const n=G.getGroup(e);n&&n.allPieces.forEach(i=>this.movePiece(i.id,t))}dragMove(e,t,{detached:n=!1}={}){const i=this._findPiece(e);i&&(n||!i.groupId?this.movePiece(e,t):this.moveGroup(i.groupId,t))}rotatePiece(e,t){const n=this._findPiece(e);if(!n)return;n.rotate(t);const i=this._getElement(e);i&&(i.style.transform=`rotate(${n.rotation}deg)`)}rotateGroup(e,t,n,i){const s=G.getGroup(e);if(!s||s.isEmpty())return;const a=i||(l=>this._getElement(l)),o=a(n.id);if(!o)return;const c=n.getCenter(o);s.allPieces.forEach(l=>{if(!l)return;const u=a(l.id);if(!u)return;l.rotate(t);const f=l.getCenter(u).rotatedAroundDeg(c,t);this.placePieceCenter(l.id,f,u),tt(u,l)})}queryRadius(e,t){return!this.spatialIndex||!e?[]:this.spatialIndex.queryRadius(e,t)}rotatePieceOrGroup(e,t,n){const i=this._findPiece(e);if(!i)return;const s=G.getGroup(i.groupId);s&&s.size()>1?this.rotateGroup(s.id,t,i,n):this.rotatePiece(e,t)}arePiecesNeighbors(e,t){if(!e||!t||!e.worldData||!t.worldData)return!1;const n=e.worldData.worldCorners,i=t.worldData.worldCorners;if(!n||!i)return!1;const s=e.scale||.35,a=t.scale||.35,c=18*((s+a)*.5)+4,l=(g,p)=>{const m=g.x-p.x,y=g.y-p.y;return m*m+y*y<=c*c};return!!(l(n.nw,i.sw)&&l(n.ne,i.se)||l(n.sw,i.nw)&&l(n.se,i.ne)||l(n.ne,i.nw)&&l(n.se,i.sw)||l(n.nw,i.ne)&&l(n.sw,i.se))}_findPiece(e){return I.pieces.find(t=>t.id===e)}_getElement(e){return this.pieceElements?this.pieceElements.get(e):null}_applyDomPosition(e){const t=this._getElement(e),n=this._findPiece(e);t&&n&&tt(t,n)}_updateSpatialIndexFor(e){if(!this.spatialIndex)return;const t=this._findPiece(e);if(!t)return;const n=this._getElement(e),i=t.getCenter(n);this.spatialIndex.update({id:t.id,position:i})}}const A=new gp;class Z{constructor(e,t=[],{validateConnectivity:n=!0}={}){if(this.id=e,this.pieces=[...t],this.borderPieces=new Set,t.length>0){if(n&&!Z.arePiecesConnected(t))throw new Error(`Cannot create group ${e}: initial pieces are not connected`);t.forEach(i=>{i&&i._setGroupId(this.id)}),this._updateBorderPieces()}}addPieces(e){const t=e.filter(a=>a!=null);if(t.length===0)return 0;const n=[...this.pieces,...t];if(!Z.arePiecesConnected(n))throw new Error(`Cannot add pieces to group ${this.id}: resulting group would not be connected`);const i=t.filter(a=>!this.pieces.includes(a)),s=i.length;return s>0&&(this.pieces=[...this.pieces,...i],i.forEach(a=>{a._setGroupId(this.id)})),s>0&&this._updateBorderPieces(),s}removePieces(e){const t=new Set(e.filter(o=>o&&this.pieces.includes(o)));if(t.size===0)return[];const n=this.pieces.filter(o=>!t.has(o));if(t.forEach(o=>{o._setGroupId(null)}),n.length===0)return this.pieces=[],[];const i=Z._findConnectedComponents(n);if(i.length===1)return this.pieces=n,this._updateBorderPieces(),[];const s=[],a=i.reduce((o,c)=>c.length>o.length?c:o);return this.pieces=[...a],a.forEach(o=>{o._setGroupId(this.id)}),this._updateBorderPieces(),i.forEach((o,c)=>{if(o!==a){const l=`${this.id}_split_${c}_${Date.now()}`,u=new Z(l,o);s.push(u)}}),s}get allPieces(){return this.pieces}size(){return this.pieces.length}isEmpty(){return this.pieces.length===0}clear(){this.pieces.forEach(e=>{e._setGroupId(null)}),this.pieces=[],this.borderPieces.clear()}get allBorderPieces(){return Array.from(this.borderPieces)}_updateBorderPieces(){if(this.borderPieces.clear(),this.pieces.length===0)return;const e=new Map;for(const t of this.pieces){if(!t)continue;const n=`${t.gridX},${t.gridY}`;e.set(n,t)}for(const t of this.pieces){if(!t)continue;let n=0;const i=[{x:t.gridX,y:t.gridY-1},{x:t.gridX+1,y:t.gridY},{x:t.gridX,y:t.gridY+1},{x:t.gridX-1,y:t.gridY}];for(const s of i){const a=`${s.x},${s.y}`;e.has(a)&&n++}n<4&&this.borderPieces.add(t)}}calculateBounds(){if(this.isEmpty())return null;let e=new V;for(const t of this.pieces){if(!t||!t.calculateBoundingFrame)continue;const n=t.calculateBoundingFrame();if(!n)continue;const i=A.getPiecePosition(t.id)||new b(0,0),s=i.add(n.topLeft),a=i.add(n.bottomRight),o=V.fromPoints(s,a);o.isEmpty()||(e=e.plus(o))}return e.isEmpty()?null:e}getCenter(){const e=this.calculateBounds();return e?e.center:null}merge(e){if(!e||e===this)return!1;const t=e.allPieces;return this.addPieces(t),e.clear(),!0}validate(){for(const e of this.pieces)if(!e||e.groupId!==this.id)return!1;return!0}getStats(){const e=this.calculateBounds();return{id:this.id,pieceCount:this.size(),bounds:e,center:this.getCenter()}}static arePiecesConnected(e){return e.length<2?!0:Z._findConnectedComponents(e).length===1}static _findConnectedComponents(e){if(e.length===0)return[];const t=new Hl.Graph({directed:!1});e.forEach(i=>{t.setNode(i.id,i)});for(let i=0;i<e.length;i++){const s=e[i];for(let a=i+1;a<e.length;a++){const o=e[a];A.arePiecesNeighbors(s,o)&&t.setEdge(s.id,o.id)}}return Hl.alg.components(t).map(i=>i.map(s=>t.node(s)))}isConnected(){return this.size()<=1?!0:Z.arePiecesConnected(this.pieces)}toString(){return`Group(id: ${this.id}, pieces: ${this.size()}, center: ${this.getCenter()})`}}const $l=3e3,pp=.9;async function mp(r){const e=URL.createObjectURL(r),t=new Image;t.decoding="async",t.src=e,await t.decode();let{width:n,height:i}=t;if(Math.max(n,i)>$l){const s=$l/Math.max(n,i);n=Math.round(n*s),i=Math.round(i*s);const a=document.createElement("canvas");a.width=n,a.height=i,a.getContext("2d").drawImage(t,0,0,n,i);const c=new Image;return c.src=a.toDataURL("image/jpeg",pp),await c.decode(),c}return t}function yp(r,e={}){const{timeout:t=1e4,onLoad:n=()=>{},onError:i=()=>{},onTimeout:s=()=>{}}=e;return new Promise((a,o)=>{const c=new Image;c.crossOrigin="anonymous",c.decoding="async";const l=setTimeout(()=>{console.warn("[remote-image] Image load timeout for:",r),s(),o(new Error(`Image load timeout: ${r}`))},t);c.onload=async()=>{clearTimeout(l),console.info("[remote-image] Image loaded successfully:",r),n(c),a(c)},c.onerror=()=>{clearTimeout(l),console.warn("[remote-image] Failed to load image URL:",r),i(),o(new Error(`Failed to load image: ${r}`))},c.src=r})}function Ul(r,e){const t={};for(const[n,i]of Object.entries(r))i instanceof b?t[n]=i.sub(e):t[n]=i;return t}function Wl(r){const e={};for(const[t,n]of Object.entries(r))n&&typeof n.x=="number"&&typeof n.y=="number"?e[t]=new b(n.x,n.y):e[t]=n;return e}const Te=.7;class Me{constructor(e){this.id=e.id,this.gridPos=new b(e.gridX,e.gridY),this._requestedGroupId=e.groupId,this._groupId=null,this.imgRect=new V(new b(e.imgX,e.imgY),e.w,e.h),this.bitmap=e.bitmap,this.path=e.path,this.scale=e.scale||Te;const t=e.nw instanceof b?e.nw:new b(e.displayX||0,e.displayY||0);this.rotation=e.rotation||0,this.zIndex=e.zIndex!==void 0?e.zIndex:null,e.geometryCorners&&e.geometrySidePoints&&e.nw?(this.corners=Ul(e.geometryCorners,e.nw),this.sPoints=Ul(e.geometrySidePoints,e.nw)):(this.corners=Wl(e.corners),this.sPoints=Wl(e.sPoints)),A.setPiecePosition(this.id,t)}get worldData(){return A.getWorldData(this)}get groupId(){return this._groupId}getCenter(e=null){return A.getCenter(this,e)}rotate(e){this.rotation=(this.rotation+e)%360,this.rotation<0&&(this.rotation+=360)}setRotation(e){this.rotation=e%360,this.rotation<0&&(this.rotation+=360)}_setGroupId(e){this._groupId=e}getWorldCorners(){var e;return((e=this.worldData)==null?void 0:e.worldCorners)||{}}getWorldSidePoints(){var e;return((e=this.worldData)==null?void 0:e.worldSPoints)||{}}calculateBoundingFrame(){const e=this.corners,t=this.sPoints,n=[e.nw,e.ne,e.se,e.sw];t.north&&n.push(t.north),t.east&&n.push(t.east),t.south&&n.push(t.south),t.west&&n.push(t.west);let i=1/0,s=-1/0,a=1/0,o=-1/0;for(const c of n)c&&c.x!==void 0&&c.y!==void 0&&(i=Math.min(i,c.x),s=Math.max(s,c.x),a=Math.min(a,c.y),o=Math.max(o,c.y));return isFinite(i)?V.fromPoints(new b(i,a),new b(s,o)):V.fromPoints(new b(0,0),new b(this.imgRect.width,this.imgRect.height))}generatePath(){const e=new Path2D,t=[];t.push(this.corners.nw),this.sPoints.north&&t.push(this.sPoints.north),t.push(this.corners.ne),this.sPoints.east&&t.push(this.sPoints.east),t.push(this.corners.se),this.sPoints.south&&t.push(this.sPoints.south),t.push(this.corners.sw),this.sPoints.west&&t.push(this.sPoints.west),e.moveTo(t[0].x,t[0].y);for(let n=1;n<t.length;n++)e.lineTo(t[n].x,t[n].y);return e.closePath(),e}serialize(e=!1){var i;const t=A.getPiecePosition(this.id)||new b(0,0),n={id:this.id,gridX:this.gridPos.x,gridY:this.gridPos.y,rotation:this.rotation,displayX:t.x,displayY:t.y,groupId:this.groupId,zIndex:this.zIndex,corners:this.corners,sPoints:this.sPoints,w:this.imgRect.width,h:this.imgRect.height,scale:Te,imgX:this.imgRect.position.x,imgY:this.imgRect.position.y};if(e&&((i=this.bitmap)!=null&&i.toDataURL))try{n.bitmapData=this.bitmap.toDataURL()}catch(s){console.warn(`[Piece] Failed to serialize bitmap for piece ${this.id}:`,s)}return n}static deserialize(e,t,n){return new Me({...e,bitmap:t,path:n})}toString(){const e=A.getPiecePosition(this.id)||new b(0,0);return`Piece{id:${this.id}, grid:(${this.gridPos.x},${this.gridPos.y}), pos:(${e.x.toFixed(1)},${e.y.toFixed(1)}), rot:${this.rotation}, group:${this.groupId}}`}}const vp=1,ea=-1,Yl=.25,_p=.25,bp=.5,wp=.3;class Vl{constructor(e,t,n,i,s,a){this.rows=e,this.cols=t,this.imgWidth=n,this.imgHeight=i,this.pieceW=n/t,this.pieceH=i/e,this.totalInternalEdges=(e-1)*t+(t-1)*e,this.positiveTarget=this.totalInternalEdges/2,this.posCount=0,this.corners=this.buildCornerLattice();const{hSides:o,vSides:c}=this.generateInternalEdges(s,a);this.hSides=o,this.vSides=c}chooseOrientation(){const e=this.totalInternalEdges-this.posCount,n=(this.positiveTarget-this.posCount)/Math.max(1,e);return Math.random()<n?(this.posCount++,vp):ea}splitSegment(e,t){if(t===0)return[];const n=[];for(let i=1;i<=t;i++){const s=i/(t+1)*e,a=e/(t+1)*wp;n.push(s+U.symmetricRandomDeviation(a))}return n}buildCornerLattice(){const e=this.splitSegment(this.imgWidth,this.cols-1),t=this.splitSegment(this.imgWidth,this.cols-1),n=this.splitSegment(this.imgHeight,this.rows-1),i=this.splitSegment(this.imgHeight,this.rows-1),s=Array(this.rows+1).fill(0).map(()=>Array(this.cols+1));s[0][0]=new b(0,0),s[0][this.cols]=new b(this.imgWidth,0),s[this.rows][0]=new b(0,this.imgHeight),s[this.rows][this.cols]=new b(this.imgWidth,this.imgHeight);for(let a=1;a<this.cols;a++)s[0][a]=new b(e[a-1],0),s[this.rows][a]=new b(t[a-1],this.imgHeight);for(let a=1;a<this.rows;a++)s[a][0]=new b(0,n[a-1]),s[a][this.cols]=new b(this.imgWidth,i[a-1]);for(let a=1;a<this.rows;a++)for(let o=1;o<this.cols;o++){const c=new b(e[o-1],0),l=new b(t[o-1],this.imgHeight),u=new b(0,n[a-1]),d=new b(this.imgWidth,i[a-1]),f=this.calculateLineIntersection(c,l,u,d);s[a][o]=f}return s}calculateLineIntersection(e,t,n,i){const s=(e.x-t.x)*(n.y-i.y)-(e.y-t.y)*(n.x-i.x);if(Math.abs(s)<1e-10)return null;const a=((e.x-n.x)*(n.y-i.y)-(e.y-n.y)*(n.x-i.x))/s,o=e.x+a*(t.x-e.x),c=e.y+a*(t.y-e.y);return new b(o,c)}deviatePoint(e,t,n){const s=.5+U.symmetricRandomDeviation(n);return e.add(t.sub(e).scaled(s))}clampDepthForCavity(e,t){return Math.min(e,_p*Math.min(this.pieceW,this.pieceH),bp*t)}generateInternalEdges(e,t){if(!this.corners)throw new Error("Corner lattice must be built before generating internal edges");const n=Array(this.rows-1).fill(0).map(()=>Array(this.cols)),i=Array(this.rows).fill(0).map(()=>Array(this.cols-1));for(let s=0;s<this.rows-1;s++)for(let a=0;a<this.cols;a++){const o=this.corners[s+1][a],c=this.corners[s+1][a+1],l=this.pieceW,u=this.deviatePoint(o,c,Yl),d=this.chooseOrientation();let f=e+Math.random()*(t-e);d===ea&&(f=this.clampDepthForCavity(f,l));const h=u.y+d*f;n[s][a]={x:u.x,y:h,orientation:d}}for(let s=0;s<this.rows&&!(this.cols-1<=0);s++)for(let a=0;a<this.cols-1;a++){const o=this.corners[s][a+1],c=this.corners[s+1]?this.corners[s+1][a+1]:{x:o.x,y:o.y+this.pieceH},l=this.pieceH,u=this.deviatePoint(o,c,Yl),d=this.chooseOrientation();let f=e+Math.random()*(t-e);d===ea&&(f=this.clampDepthForCavity(f,l));const h=u.x+d*f;i[s][a]={x:h,y:u.y,orientation:d}}return{hSides:n,vSides:i}}getCorners(){return this.corners}getHSides(){return this.hSides}getVSides(){return this.vSides}static createPiecePath(e,t,n,i){const s=new Path2D,a=[];a.push(n.nw),i.north&&a.push(i.north),a.push(n.ne),i.east&&a.push(i.east),a.push(n.se),i.south&&a.push(i.south),a.push(n.sw),i.west&&a.push(i.west),s.moveTo(a[0].x,a[0].y);for(let o=1;o<a.length;o++)s.lineTo(a[o].x,a[o].y);return s.closePath(),s}}const Xl=2,Ip=.18,Pp=.1,Cp="#ff00aa",Ep=1.25,Kl=[0,90,180,270];function xp(r,e){const t=r.width/r.height;let n=Math.max(Xl,Math.round(Math.sqrt(e*t))),i=Math.max(Xl,Math.round(e/n));for(;i*n<e;)n++;const s=i*n,a=r.width/n,o=r.height/i,c=Ip*Math.min(a,o),l=Pp*Math.min(a,o),u=new Vl(i,n,r.width,r.height,l,c),d=u.getCorners(),f=u.getHSides(),h=u.getVSides(),g=[];let p=0;const m=document.createElement("canvas");m.width=r.width,m.height=r.height,m.getContext("2d").drawImage(r,0,0);for(let _=0;_<i;_++)for(let v=0;v<n;v++){const w=d[_][v],R=d[_][v+1],P=d[_+1][v+1],C=d[_+1][v],q={north:_>0?new b(f[_-1][v].x,f[_-1][v].y):null,east:v<n-1&&h[_][v]?new b(h[_][v].x,h[_][v].y):null,south:_<i-1?new b(f[_][v].x,f[_][v].y):null,west:v>0&&h[_][v-1]?new b(h[_][v-1].x,h[_][v-1].y):null},E=new Me({id:-1,gridX:v,gridY:_,geometryCorners:{nw:w,ne:R,se:P,sw:C},geometrySidePoints:q,nw:w,w:a,h:o}),S=E.calculateBoundingFrame(),x=S.width,O=S.height,N=Vl.createPiecePath(_,v,E.corners,E.sPoints),ue=Math.ceil(x),le=Math.ceil(O),de=document.createElement("canvas");de.width=ue,de.height=le;const W=de.getContext("2d");W.save(),W.translate(-S.topLeft.x,-S.topLeft.y),W.clip(N);const je=S.topLeft.x+w.x,Xt=S.bottomRight.x+w.x,lt=S.topLeft.y+w.y,Kt=S.bottomRight.y+w.y;let Zt=je,Jt=lt,Qt=Xt-je,er=Kt-lt;const ze=Math.max(0,Zt),He=Math.max(0,Jt),dt=Math.min(Qt,m.width-ze),ft=Math.min(er,m.height-He),tr=ze-w.x,rr=He-w.y;W.drawImage(m,ze,He,dt,ft,tr,rr,dt,ft),W.restore(),W.save(),W.translate(-S.topLeft.x,-S.topLeft.y),W.strokeStyle=Cp,W.lineWidth=Ep,W.stroke(N),W.restore();const ht=p++,nr={id:ht,gridX:v,gridY:_,w:x,h:O,imgX:w.x,imgY:w.y,rotation:Kl[Math.floor(Math.random()*Kl.length)],path:N,bitmap:de,groupId:"g"+ht,geometryCorners:{nw:w,ne:R,se:P,sw:C},geometrySidePoints:q,nw:w};g.push(new Me(nr))}return{pieces:g,rows:i,cols:n,actualCount:s}}let Ud="en",ye={};function Sp(r,e){return e?Object.entries(e).reduce((t,[n,i])=>t.replace(new RegExp("{"+n+"}","g"),i),r):r}function T(r,e){const t=ye[r]||r;return Sp(t,e)}async function ia(r){try{const t=await fetch(`/pzl/i18n/${r}.json`,{cache:"no-cache"});if(!t.ok)throw new Error(`${t.status} ${t.statusText}`);ye=await t.json(),Ud=r,localStorage.setItem("lang",r),Wd()}catch(e){console.warn("[i18n] Failed to load language",r,e),r!=="en"&&await ia("en")}}function Wd(){document.querySelectorAll("[data-i18n]").forEach(t=>{const n=t.dataset.i18n;ye[n]&&(t.innerHTML=T(n))}),document.querySelectorAll("[data-i18n-title]").forEach(t=>{const n=t.dataset.i18nTitle;ye[n]&&(t.title=T(n))}),document.querySelectorAll("[data-i18n-aria-label]").forEach(t=>{const n=t.dataset.i18nAriaLabel;ye[n]&&t.setAttribute("aria-label",T(n))});const r=document.querySelector("#helpModal .modal-body");r&&ye["help.bodyHtml"]&&(r.innerHTML=ye["help.bodyHtml"]);const e=document.getElementById("resume-modal-overlay");if(e){const t=e.querySelector("#resume-modal-title");t&&(t.textContent=T("resume.title"));const n=e.querySelector(".resume-modal p");n&&(n.textContent=T("resume.message")),e.querySelectorAll("button").forEach(s=>{const a=s.dataset.action;a==="resume"?s.textContent=T("resume.resume"):a==="cancel"?s.textContent=T("resume.cancel"):a==="discard"&&(s.textContent=T("resume.discard"))});const i=e.querySelector(".resume-meta");i&&(i.textContent=T("resume.meta"))}}async function qp(){var i;const r=localStorage.getItem("lang"),e=((i=navigator.language)==null?void 0:i.toLowerCase())||"en";let t="en";e.startsWith("de")?t="de":e.startsWith("ru")?t="ru":e.startsWith("ua")&&(t="ua"),await ia(r||t||"en");const n=document.getElementById("langSelect");n&&(n.value=Ud,n.addEventListener("change",s=>{const a=s.target.value;ia(a)}))}const Rp="PuzzleImageStorage",Ap=1,pe="images";let ve=null;async function Ma(){return ve||new Promise((r,e)=>{const t=indexedDB.open(Rp,Ap);t.onerror=()=>{console.error("Failed to open IndexedDB:",t.error),e(t.error)},t.onsuccess=()=>{ve=t.result,console.log("IndexedDB initialized successfully"),r(ve)},t.onupgradeneeded=n=>{const i=n.target.result;if(!i.objectStoreNames.contains(pe)){const s=i.createObjectStore(pe,{keyPath:"id"});s.createIndex("filename","filename",{unique:!1}),s.createIndex("timestamp","timestamp",{unique:!1}),console.log("Created IndexedDB object store")}}})}function st(){return"indexedDB"in window}async function Tp(r){if(!st())throw new Error("IndexedDB not supported");try{await Ma();try{await Op(),console.log("Cleared previous images before storing new one")}catch(i){console.warn("Failed to clear previous images, proceeding anyway:",i)}const e=`img_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,t=r instanceof Blob?r:new Blob([r]),n={id:e,filename:r.name||"uploaded_image",blob:t,size:t.size,type:t.type,timestamp:Date.now()};return new Promise((i,s)=>{const c=ve.transaction([pe],"readwrite").objectStore(pe).add(n);c.onsuccess=()=>{console.log(`Stored image in IndexedDB: ${e} (previous images cleared)`),i({imageId:e,filename:n.filename,size:n.size,type:n.type})},c.onerror=()=>{console.error("Failed to store image in IndexedDB:",c.error),s(c.error)}})}catch(e){throw console.error("Error storing image in IndexedDB:",e),e}}async function Mp(r){if(!st())throw new Error("IndexedDB not supported");try{return await Ma(),new Promise((e,t)=>{const s=ve.transaction([pe],"readonly").objectStore(pe).get(r);s.onsuccess=()=>{const a=s.result;a?(console.log(`Loaded image from IndexedDB: ${r}`),e({id:a.id,filename:a.filename,blob:a.blob,size:a.size,type:a.type,timestamp:a.timestamp})):t(new Error(`Image not found: ${r}`))},s.onerror=()=>{console.error("Failed to load image from IndexedDB:",s.error),t(s.error)}})}catch(e){throw console.error("Error loading image from IndexedDB:",e),e}}async function Op(){if(!st())throw new Error("IndexedDB not supported");try{return await Ma(),new Promise((r,e)=>{const i=ve.transaction([pe],"readwrite").objectStore(pe).clear();i.onsuccess=()=>{console.log("Cleared all images from IndexedDB"),r(!0)},i.onerror=()=>{console.error("Failed to clear images from IndexedDB:",i.error),e(i.error)}})}catch(r){throw console.error("Error clearing images from IndexedDB:",r),r}}async function Et(r,e,t={}){const{removeColor:n=!1,centered:i=!1,fontSizePercent:s=2,minFontSize:a=12,returnDataUrl:o=!1}=t,c=typeof r=="string"?await Lp(r):r,l=document.createElement("canvas");l.width=c.width,l.height=c.height;const u=l.getContext("2d");if(u.drawImage(c,0,0),n){const C=u.getImageData(0,0,l.width,l.height),q=C.data;for(let E=0;E<q.length;E+=4){const S=.299*q[E]+.587*q[E+1]+.114*q[E+2];q[E]=q[E+1]=q[E+2]=S}u.putImageData(C,0,0)}const d=Math.max(a,Math.floor(c.height*(s/100))),f=Math.floor(d*.5);u.font=`${d}px Arial, sans-serif`,u.textBaseline="bottom",i?u.textAlign="center":u.textAlign="left";const g=u.measureText(e).width,p=d;let m,y;i?(m=(c.width-g)/2-f,y=c.width/2):(m=f,y=f*2);const _=c.height-p-f*2,v=g+f*2,w=p+f*2;u.fillStyle="rgba(0, 0, 0, 0.7)",u.fillRect(m,_,v,w),u.fillStyle="white",u.fillText(e,y,c.height-f*1.5);const R=l.toDataURL();if(o)return R;const P=new Image;return P.src=R,await P.decode(),P}function Lp(r,e=!0){return new Promise((t,n)=>{const i=new Image;e&&(i.crossOrigin="anonymous"),i.onload=()=>t(i),i.onerror=()=>n(new Error(`Failed to load image: ${r}`)),i.src=r})}let sa=null;const Yd=3,Vd=1e3,Oa=document.getElementById("imageInput"),ke=document.getElementById("pieceSlider"),Dp=document.getElementById("pieceDisplay"),Oe=document.getElementById("progressDisplay"),Gp=document.getElementById("orientationTipButton"),Fp=document.getElementById("helpButton"),Qe=document.getElementById("helpModal"),Np=document.getElementById("closeHelp"),Bp=document.getElementById("zoomInButton"),kp=document.getElementById("zoomOutButton"),jp=document.getElementById("zoomResetButton"),zp=document.getElementById("piecesContainer");let ee=null,Ze=null,xt=null,ge=null,ta=!1,X=null;function Xd(r){if(r===0)return 0;const e=r/100*Yd,t=Math.round(Math.pow(10,e));return Math.max(1,Math.min(Vd,t))}function Hp(r){const e=Math.max(1,Math.min(Vd,r)),n=Math.log10(e)/Yd*100;return Math.round(Math.max(0,Math.min(100,n)))}function at(){const r=Xd(parseInt(ke.value));Dp.textContent=r}function $p(){return parseInt(ke.value,10)||0}function Zl(r){ke.value=String(r),at()}function Up(){return ee}function Jl(r){ee=r}function Wp(){return Ze}function Ql(r){Ze=r}function Yp(){return xt}function Vp(r){xt=r}function Xp(){return ge}function ed(r){ge=r}function Kd(){Ge(1,null)}function se(){if(!I.pieces||I.pieces.length===0){Oe.textContent=T("status.emptyProgress");return}const r=I.totalPieces;let e;try{e=G.getAllGroups().length;const s=G.validateAllGroups();s.length>0&&console.warn("[updateProgress] Group validation issues:",s)}catch{console.warn("[updateProgress] GroupManager not available, falling back to simple count"),e=new Set(I.pieces.map(a=>a.groupId)).size}const t=r-(e-1),n=(t/r*100).toFixed(1);Oe.textContent=T("status.progressFormat",{score:t,total:r,percent:n}),e===1&&r>0&&setTimeout(()=>gy(),100),X&&X.requestAutoSave&&X.requestAutoSave()}async function aa(r=!1){if(!ee||ta)return;console.log("[control-bar] generatePuzzle called with noRotate:",r);const e=Xd(parseInt(ke.value));if(e===0){const n=Ae();if(n){const i=ge?await Et(ee,ge):ee;n.innerHTML=`
        <div class="original-image-container">
          <img src="${i.src}" alt="${T("alt.originalImage")}" style="max-width:100%;max-height:100%;object-fit:contain;" />
        </div>
      `}I.pieces=[],I.totalPieces=0,se();return}ta=!0;const t=Ae();t&&(t.innerHTML=""),Oe.textContent=T("status.generating");try{const n=ge?await Et(ee,ge):ee,{pieces:i,rows:s,cols:a}=xp(n,e);I.pieces=i,I.totalPieces=i.length,I.noRotate=r,console.log("[control-bar] Set state.noRotate to:",I.noRotate),G.initialize();const o=Ae();o&&Jm(o,i,r),sa&&sa(),se(),X&&X.markDirty&&X.markDirty()}catch(n){console.error(n),alert(T("error.generate",{error:n.message})),Oe.textContent=T("status.error")}finally{ta=!1}}async function Kp(r){var t;const e=(t=r.target.files)==null?void 0:t[0];if(e)try{if(Oe.textContent=T("status.loadingImage"),ee=await mp(e),xt=null,st())try{console.log("[controlBar] Attempting to store file in IndexedDB");const i=await Tp(e);xt=i.imageId,Ze=`idb:${i.imageId}`,console.log("[controlBar] File stored successfully in IndexedDB:",i.imageId)}catch(i){console.warn("[controlBar] Failed to store file in IndexedDB:",i.message),Ze=e.webkitRelativePath||e.name}else Ze=e.webkitRelativePath||e.name;ke.value=0,at();const n=Ae();if(n){const i=ge?await Et(ee,ge):ee;n.innerHTML=`
        <div class="original-image-container">
          <img src="${i.src}" alt="${T("alt.originalImage")}" style="max-width:100%;max-height:100%;object-fit:contain;" />
        </div>
      `}I.pieces=[],I.totalPieces=0,se(),X&&X.markDirty&&X.markDirty()}catch(n){console.error(n),alert(T("error.loadImage",{error:n.message})),Oe.textContent=T("status.error")}}function Zp(){at(),aa()}function Jp(){if(I.noRotate){console.log("[control-bar] Rotation disabled (noRotate mode)");return}xm()&&(Sm(),X&&X.requestAutoSave&&X.requestAutoSave())}function Qp(){Qe.style.display="flex"}function em(){Qe.style.display="none"}function tm(r){r.target===Qe&&(Qe.style.display="none")}function rm(){Ge($()*Rt)}function nm(){Ge($()/Rt)}function im(){Kd()}function sm(r){r.preventDefault();const e=r.deltaY>0?Rm:qm;Ge($()*e,new b(r.clientX,r.clientY))}function am(r){const e=document.getElementById("helpModal");if(!(e&&e.style.display==="flex"||r.target.tagName==="INPUT"))switch(r.key){case"+":case"=":r.preventDefault(),Ge($()*Rt);break;case"-":r.preventDefault(),Ge($()/Rt);break;case"0":r.preventDefault(),Kd();break}}function om(){Oa.addEventListener("change",Kp),ke.addEventListener("input",Zp),Gp.addEventListener("click",Jp),Fp.addEventListener("click",Qp),Np.addEventListener("click",em),Bp.addEventListener("click",rm),kp.addEventListener("click",nm),jp.addEventListener("click",im),Qe.addEventListener("click",tm),zp.addEventListener("wheel",sm),document.addEventListener("keydown",am),at(),rt()}function cm(r){X=r}function um(r){sa=r}class lm{constructor(){this.groups=new Map,this.nextGroupId=1}initialize(){this.groups.clear();const e=new Map;I.pieces.forEach(t=>{let n=t._requestedGroupId;n||(n=`g${t.id}`),t._setGroupId(n),e.has(n)||e.set(n,[]),e.get(n).push(t)}),e.forEach((t,n)=>{try{const i=new Z(n,t,{validateConnectivity:!1});this.groups.set(n,i)}catch(i){console.warn(`[GroupManager] Failed to create group ${n}:`,i),t.forEach(s=>{const a=this.generateGroupId();s._setGroupId(a);const o=new Z(a,[s]);this.groups.set(a,o)})}}),console.log(`[GroupManager] Initialized with ${this.groups.size} groups for ${I.pieces.length} pieces`),this.updateNextGroupId()}generateGroupId(){return`g${this.nextGroupId++}`}updateNextGroupId(){let e=0;this.groups.forEach((t,n)=>{const i=n.match(/^g(\d+)/);if(i){const s=parseInt(i[1],10);s>e&&(e=s)}}),I.pieces.forEach(t=>{if(t.groupId){const n=t.groupId.match(/^g(\d+)/);if(n){const i=parseInt(n[1],10);i>e&&(e=i)}}}),this.nextGroupId=e+1}getGroup(e){return this.groups.get(e)}getAllGroups(){return Array.from(this.groups.values())}getGroupForPiece(e){return this.groups.get(e.groupId)}createSinglePieceGroup(e){const t=this.generateGroupId();e._setGroupId(t);const n=new Z(t,[e]);return this.groups.set(t,n),console.log(`[GroupManager] Created single-piece group ${t} for piece ${e.id}`),n}mergeGroups(e,t){const n=this.getGroupForPiece(e),i=this.getGroupForPiece(t);if(!n||!i)return console.warn("[GroupManager] Cannot merge - one or both pieces not in groups"),!1;if(n===i)return console.log("[GroupManager] Pieces already in same group"),!0;try{const s=[...n.allPieces,...i.allPieces];if(!Z.arePiecesConnected(s))return console.warn("[GroupManager] Cannot merge - would create disconnected group"),!1;const[a,o]=n.size()>=i.size()?[n,i]:[i,n],c=o.allPieces;return a.addPieces(c),this.groups.delete(o.id),console.log(`[GroupManager] Merged group ${o.id} into ${a.id}`),se(),!0}catch(s){return console.error("[GroupManager] Error during group merge:",s),!1}}detachPiece(e){const t=this.getGroupForPiece(e);if(!t)return console.warn("[GroupManager] Cannot detach - piece not in a group"),null;if(t.size()===1)return console.log("[GroupManager] Piece is already in single-piece group"),t;try{const n=t.removePieces([e]),i=this.createSinglePieceGroup(e);return n.forEach(s=>{this.groups.set(s.id,s),console.log(`[GroupManager] Created fragment group ${s.id} with ${s.size()} pieces`)}),se(),i}catch(n){return console.error("[GroupManager] Error during piece detachment:",n),null}}moveGroup(e,t){if(!this.getGroup(e))return!1;try{return A.moveGroup(e,t),!0}catch(i){return console.error("[GroupManager] Error moving group:",i),!1}}rotateGroup(e,t,n,i){if(!this.getGroup(e))return!1;try{return A.rotateGroup(e,t,n,i),!0}catch(a){return console.error("[GroupManager] Error rotating group:",a),!1}}validateConnectivity(e){if(!e||e.length<=1)return!0;try{return new Z("temp",e).isConnected()}catch{return!1}}getGroupStats(){const e={totalGroups:this.groups.size,singlePieceGroups:0,multiPieceGroups:0,largestGroupSize:0,totalPieces:0,groups:[]};return this.groups.forEach(t=>{const n=t.getStats();e.groups.push(n),e.totalPieces+=n.pieceCount,n.pieceCount===1?e.singlePieceGroups++:e.multiPieceGroups++,n.pieceCount>e.largestGroupSize&&(e.largestGroupSize=n.pieceCount)}),e}validateAllGroups(){let e=[];return this.groups.forEach((t,n)=>{t.validate()||e.push(`Group ${n} has integrity issues`),t.isConnected()||e.push(`Group ${n} is not connected`)}),e}cleanup(){const e=[];return this.groups.forEach((t,n)=>{t.isEmpty()&&e.push(n)}),e.forEach(t=>{this.groups.delete(t),console.log(`[GroupManager] Removed empty group ${t}`)}),e.length}debugStatus(){console.log("=== GroupManager Debug Status ==="),console.log(`Total pieces in state: ${I.pieces.length}`),console.log(`Total groups in manager: ${this.groups.size}`),console.log(`Next group ID: ${this.nextGroupId}`);const e=new Set;I.pieces.forEach(s=>{e.add(s.groupId)}),console.log(`Unique piece group IDs: ${e.size}`),console.log("Piece group IDs:",Array.from(e).sort()),console.log("Manager group IDs:",Array.from(this.groups.keys()).sort());const t=new Set(this.groups.keys()),n=Array.from(e).filter(s=>!t.has(s)),i=Array.from(t).filter(s=>!e.has(s));n.length>0&&console.warn("Groups missing in manager:",n),i.length>0&&console.warn("Extra groups in manager:",i),console.log("================================")}}const G=new lm;typeof window<"u"&&(window.groupManager=G);let j=null,et=null,F=null;function dm(r){F=r}function Zd(r){const e=typeof r=="string"?parseInt(r,10):r;if(isNaN(e)||e==null){console.warn("[hlInteractionHandler] onPieceSelected: invalid ID",r);return}const t=ot(e);if(!t){console.warn("[hlInteractionHandler] onPieceSelected: piece not found for ID",e);return}if((j==null?void 0:j.id)===e)return;const n=(j==null?void 0:j.id)??null;j=t,A.bringToFront(e),F!=null&&F.onPieceSelectedVisual&&F.onPieceSelectedVisual(e,n),et&&et(t)}function fm(){if(j){const r=j.id;j=null,F!=null&&F.onPieceDeselectedVisual&&F.onPieceDeselectedVisual(r),et&&et(null)}}function hm(r,e){const t=ot(r);t&&(t.groupId?A.moveGroup(t.groupId,e):A.movePiece(t.id,e))}function gm(r,e){const t=ot(r);t&&(Km(t,!1),Gm(Na(I.pieces)),e?vy():F!=null&&F.onEnsurePieceInView&&F.onEnsurePieceInView(r))}function Jd(r,e){const t=ot(r);if(t){if(I.noRotate){console.log("[hlInteractionHandler] Rotation disabled (noRotate mode)");return}A.rotatePieceOrGroup(t.id,e),F!=null&&F.onEnsurePieceInView&&F.onEnsurePieceInView(r)}}function oa(r){const e=ot(r);if(!e)return;if(!G.detachPiece(e)){console.error("[hlInteractionHandler] GroupManager detachment failed - piece cannot be detached");return}A.bringToFront(e.id),F!=null&&F.onPieceDetachedVisual&&F.onPieceDetachedVisual(e.id)}function Qd(){return j}function pm(){if(!j)return!1;const r=j.rotation;if(r===0)return!0;let e=-r;e<=-180&&(e+=360),e>180&&(e-=360);const t=G.getGroup(j.groupId);return t&&t.size()>1?A.rotateGroup(t.id,e,j):A.rotatePiece(j.id,e),!0}function mm(r){et=r}function ot(r){const e=typeof r=="string"?parseInt(r,10):r;return I.pieces.find(t=>t.id===e)}const _t=40,La=1e3;let ne=null;const ca=new Set;let It=null,_e=null,Le=null,Pt=null,St=!1;function ef(r){if(ne=r,dm({onPieceSelectedVisual:(n,i)=>{if(i!=null){const a=ne.get(i);a&&a.classList.remove("selected")}const s=ne.get(n);s&&s.classList.add("selected")},onPieceDeselectedVisual:n=>{const i=ne.get(n);i&&i.classList.remove("selected")},onPieceDetachedVisual:n=>{const i=ne.get(n);i&&(i.classList.add("detached-piece"),setTimeout(()=>i.classList.remove("detached-piece"),1e3))},onEnsurePieceInView:n=>{const i=I.pieces.find(a=>a.id===n),s=ne.get(n);if(i&&s){const a=A.getPiecePosition(i.id)||new b(0,0);dy(a,new b(s.offsetWidth,s.offsetHeight),{forceZoom:!1})}}}),!window.interact){console.error("[interactionManager] interact.js is not loaded! Interaction functionality will not work.");return}try{r.forEach((n,i)=>{var s=window.interact(n);s.unset(),s=window.interact(n),s.draggable({listeners:{start:ym,move:vm,end:_m}}).on("tap",Im).on("doubletap",Pm).on("down",bm).on("up",wm),s.options&&s.options.actions&&(s.options.actions.doubletap={interval:500,distance:30})});var e=window.interact("#piecesContainer");e.unset(),e=window.interact("#piecesContainer"),e.on("tap",Cm),console.log("[interactionManager] interact.js configured successfully")}catch(n){throw console.error("[interactionManager] Error configuring interact.js:",n),n}const t=8;console.log(`[interactionManager] Curvature threshold for detachment: ${t}`),fa.registerCurvatureCallback(t,n=>{St=!0,console.log(`[DragMonitor] HIGH curvature detected (shuffle motion)! Curvature: ${n.curvature.toFixed(2)} (threshold: ${n.threshold}) - enabling detachment mode`)})}function ym(r){const e=r.target.closest(".piece")||r.target,t=e.dataset.id,n=parseInt(t,10);Zd(n),r.interaction.pointerType==="touch"&&ca.add(r.interaction.id),hy(),Da();const i=r.shiftKey,s=r.interaction.pointerType==="touch"&&ca.size>=2,a=_e!==null&&String(Le)===String(t)&&performance.now()-_e>=La;(i||s||a)&&(oa(n),e.setAttribute("data-detached","true")),e.classList.remove("long-press-active"),ct(),_e=null,Le=null}function vm(r){const e=r.target.closest(".piece")||r.target,t=e.dataset.id,n=parseInt(t,10),i=I.pieces.find(c=>c.id===n);if(!i)return;fa.dragEvent({x:r.client.x,y:r.client.y,timestamp:performance.now()});const s=Cf();Lm(new b(r.client.x,r.client.y),new b(s.panX,s.panY),s.zoomLevel);const a=r.dx/s.zoomLevel,o=r.dy/s.zoomLevel;if(St&&!e.hasAttribute("data-detached")){const c=G.getGroup(i.groupId);c&&c.size()>1&&(oa(i.id),e.setAttribute("data-detached","true")),St=!1}if(Da(),e.classList.remove("long-press-active"),!e.hasAttribute("data-detached")&&i.groupId){const c=G.getGroup(i.groupId);c&&c.size()>1&&(Pt=setTimeout(()=>{e.classList.add("long-press-active"),oa(i.id),e.setAttribute("data-detached","true"),setTimeout(()=>{e.classList.remove("long-press-active")},300)},La))}hm(i.id,new b(a,o)),Em(e,i),Xm(i)}function _m(r){const e=r.target.closest(".piece")||r.target,t=e.dataset.id,n=parseInt(t,10);r.interaction.pointerType==="touch"&&ca.delete(r.interaction.id),Da(),e.classList.remove("long-press-active"),St=!1,fa.endDrag(),e.removeAttribute("data-detached");const i=e.hasAttribute("data-outside");i&&e.removeAttribute("data-outside"),gm(n,i)}function bm(r){const t=(r.target.closest(".piece")||r.target).dataset.id;_e=performance.now(),Le=t,ct(),It=setTimeout(()=>{const n=ne.get(parseInt(t,10));n&&n.classList.add("long-press-active")},La)}function wm(r){(r.target.closest(".piece")||r.target).classList.remove("long-press-active"),ct(),_e=null,Le=null}function Im(r){const t=(r.target.closest(".piece")||r.target).dataset.id,n=parseInt(t,10);Zd(n)}function Pm(r){const e=r.target.closest(".piece")||r.target,t=e.dataset.id,n=parseInt(t,10);e.classList.remove("long-press-active"),ct(),_e=null,Le=null,r.preventDefault(),r.stopPropagation(),Jd(n,90)}function Cm(r){(r.target.id==="piecesContainer"||r.target.classList.contains("pieces-viewport"))&&(ct(),_e=null,Le=null,fm())}function Em(r,e){const n=r.parentElement.getBoundingClientRect(),i=A.getPiecePosition(e.id),s=i.x<-_t,a=i.y<-_t,o=i.x+r.offsetWidth>n.width+_t,c=i.y+r.offsetHeight>n.height+_t,l=s||a||o||c;l&&!r.hasAttribute("data-outside")?r.setAttribute("data-outside","true"):!l&&r.hasAttribute("data-outside")&&r.removeAttribute("data-outside")}function xm(){return Qd()}function Sm(){return pm()}function tf(r){return ne.get(r)}function rf(r,e){Bm(ne,r)}function ct(){It&&(clearTimeout(It),It=null)}function Da(){Pt&&(clearTimeout(Pt),Pt=null)}window.addEventListener("keydown",r=>{const e=Qd();if(e&&(r.key==="r"||r.key==="R")){const t=r.shiftKey?270:90;Jd(e.id,t)}});const qt=.1,nf=5,Rt=1.2,qm=1.1,Rm=.9;let ae=null,De=null,At=null,be=1,oe=new b(0,0),sf=!1,af=new b(0,0),of=null,Ct=null;function Am(r="piecesViewport",e="piecesContainer"){return ae=document.getElementById(r),De=document.getElementById(e),At=document.getElementById("zoomDisplay"),U.isElementValid(ae)||console.warn(`[display] Viewport element with ID '${r}' not found`),U.isElementValid(De)||console.warn(`[display] Container element with ID '${e}' not found`),U.isElementValid(At)||console.warn("[display] Zoom display element with ID 'zoomDisplay' not found"),ae}function Ae(){return ae}function tt(r,e){if(!r||!e)return r;const t=e.calculateBoundingFrame(),n=e.scale||.35,i=new b((r.offsetWidth||e.bitmap.width*n)/2,(r.offsetHeight||e.bitmap.height*n)/2),a=t.centerOffset.scaled(n).sub(i),c=(A.getPiecePosition(e.id)||new b(0,0)).sub(a);return r.style.left=c.x+"px",r.style.top=c.y+"px",r.style.transform=`rotate(${e.rotation}deg)`,r}function Tm(r){Ct=r}function Mm(r,e){const t=Ct==null?void 0:Ct.get(r);t&&(t.style.zIndex=e.toString())}function cf(r){ae&&(r?ae.style.filter="grayscale(100%)":ae.style.filter="none")}function $(){return be}function Tt(r){be=r}function k(){return oe}function z(r){oe=r}function uf(){return sf}function lf(r){sf=r}function Om(){return af}function df(r){af=r}function Ge(r,e=null){const t=be,n=Math.max(qt,Math.min(nf,r));if(be=n,e&&De){const i=De.getBoundingClientRect(),s=new b(i.left,i.top),a=e.sub(s),o=n/t,c=a.sub(oe).scaled(o);oe=a.sub(c)}K(),rt()}function K(r=null,e=null){const t=r||oe,n=e!==null?e:be;r&&(oe=r),e!==null&&(be=e),!(!U.isElementValid(ae)||!t)&&(ae.style.transform=`translate(${t.x}px, ${t.y}px) scale(${n})`)}function Lm(r,e,t){if(!U.isElementValid(De)||!r||!e||typeof t!="number")return new b(0,0);const n=De.getBoundingClientRect(),i=r.x-n.left,s=r.y-n.top,a=(i-e.x)/t,o=(s-e.y)/t;return new b(a,o)}function Mt(r,e,t=3){const i=tf(r.id).querySelector("canvas");if(!r.path){console.warn(`[drawPieceOutline] No path found for piece ${r.id}`);return}const s=i.getContext("2d"),a=r.scale||.35;console.log(`[drawPieceOutline] Drawing with scale=${a}, lineWidth=${t}`),s.save(),s.clearRect(0,0,i.width,i.height),s.scale(a,a),s.drawImage(r.bitmap,0,0);const o=r.calculateBoundingFrame();s.translate(-o.topLeft.x,-o.topLeft.y),s.strokeStyle=e,s.lineWidth=t/a,s.stroke(r.path),console.log(`[drawPieceOutline] Successfully drew outline for piece ${r.id}`),s.restore()}function Ga(r){const e=tf(r.id);if(!e)return;const t=e.querySelector("canvas");if(!t){console.warn(`[clearPieceOutline] No canvas found for piece ${r.id}`);return}const n=t.getContext("2d"),i=r.scale||.35;n.save(),n.clearRect(0,0,t.width,t.height),n.scale(i,i),n.drawImage(r.bitmap,0,0),n.restore()}function Dm(r){const e=document.getElementById("orientationTipButton");e&&(I.noRotate||!r?e.style.display="none":r&&(e.style.display="block"))}function rt(){At&&(At.textContent=Math.round(be*100)+"%")}function ff(r){of=r}function Gm(r){if(!of)return;const e=50,t=r.left-e,n=r.right+e,i=r.top-e,s=r.bottom+e,a=oe.x,o=oe.y;let c=a,l=o;t<-window.innerWidth/2&&(c=a+(-window.innerWidth/2-t)),n>window.innerWidth/2&&(c=a+(window.innerWidth/2-n)),i<-window.innerHeight/2&&(l=o+(-window.innerHeight/2-i)),s>window.innerHeight/2&&(l=o+(window.innerHeight/2-s)),(c!==a||l!==o)&&(oe=new b(c,l),K())}function Fm(r,e){return e?(Mt(r,"#2ea862",4),"correct"):(Mt(r,"#c94848",4),"incorrect")}function Nm(r,e){const{BLINK_INTERVAL_MS:t,BLINK_HALF_CYCLES:n,BLINK_START_DELAY_MS:i}=e;setTimeout(()=>{let s=0;r.forEach(a=>{let o=!0;a.rotation!==0&&(o=!1);const c={north:r.find(l=>l.gridX===a.gridX&&l.gridY===a.gridY-1),east:r.find(l=>l.gridX===a.gridX+1&&l.gridY===a.gridY),south:r.find(l=>l.gridX===a.gridX&&l.gridY===a.gridY+1),west:r.find(l=>l.gridX===a.gridX-1&&l.gridY===a.gridY)};if(Object.entries(c).forEach(([l,u])=>{if(u){const d=G.getGroupForPiece(a),f=G.getGroupForPiece(u);d&&f&&d===f&&A.arePiecesNeighbors(a,u)||(o=!1)}}),!o){s++;let l=0;const u=setInterval(()=>{console.log(`[checkPuzzleCorrectness] Blink ${l} for piece ${a.id}`),l%2===0?Ga(a):Mt(a,"#c94848",4),l++,l>=n&&(clearInterval(u),Mt(a,"#c94848",4))},t)}}),console.log(`[checkPuzzleCorrectness] Started blinking for ${s} pieces`)},i)}function Bm(r,e,t){if(!r||(r.forEach(i=>i.classList.remove("candidate-highlight")),e==null))return;(Array.isArray(e)?e:[e]).forEach(i=>{const s=r.get(i);s&&s.classList.add("candidate-highlight")})}const hf="north",gf="east",pf="south",mf="west",td=[hf,gf,pf,mf],rd="nw",nd="ne",id="se",sd="sw",ad=30,yf=ad*ad,km=yf,od=2,jm=od*od,zm=1.5,Je={CONNECTION_TOLERANCE:yf,ALIGNMENT_TOLERANCE:km,PROFILE_TOLERANCE:jm};let Yt=null,Ot=()=>{},ua=null,$e=null;function cd(r){switch(r){case hf:return[rd,nd];case gf:return[nd,id];case pf:return[id,sd];case mf:return[sd,rd];default:return[]}}function ud(r,e){if(r.length===0)return!1;const t=Math.max(...r),n=Math.min(...r);return t-n<=e}function Hm(r,e,t,n){if(r.length!==e.length)return null;let i=[],s=!0;for(let o=0;o<r.length;o++){const c=Ha(r[o],e[o]);if(i.push(c),c>t){s=!1;break}}if(s){const o=ud(i,n);return{reversed:!1,distances:i,profileValid:o}}i=[],s=!0;const a=[...e].reverse();for(let o=0;o<r.length;o++){const c=Ha(r[o],a[o]);if(i.push(c),c>t){s=!1;break}}if(s){const o=ud(i,n);return{reversed:!0,distances:i,profileValid:o}}return null}function $m(r,e,t,n){const i=ly(),s=Je.CONNECTION_TOLERANCE/(i*i),a=Je.PROFILE_TOLERANCE/(i*i);let o=null;return td.forEach(c=>{if(!r.sPoints[c])return;const u=cd(c),d=t.worldCorners[u[0]],f=t.worldCorners[u[1]],h=t.worldSPoints[c];td.forEach(g=>{if(!e.sPoints[g])return;const m=cd(g),y=n.worldCorners[m[0]],_=n.worldCorners[m[1]],v=n.worldSPoints[g],P=Hm([d,h,f],[y,v,_],s,a);if(P&&P.profileValid){const C=P.distances.reduce((O,N)=>O+N,0);let q,E,S,x;P.reversed?(q=m[1],E=m[0],S=_,x=y):(q=m[0],E=m[1],S=y,x=_),(!o||C<o.score)&&((r.rotation!==0||e.rotation!==0)&&r.gridX===0&&r.gridY===0&&console.log("[matchSides] Found match with rotation:",{movingPiece:r.id,stationaryPiece:e.id,movingRotation:r.rotation,stationaryRotation:e.rotation,mLogicalSide:c,sLogicalSide:g,score:C}),o={score:C,stationaryPieceId:e.id,movingSide:c,stationarySide:g,mapping:{movingCornerA:u[0],movingCornerB:u[1],stationaryCornerA:q,stationaryCornerB:E},stationaryCornerWorldA:S,stationaryCornerWorldB:x})}})}),o}function vf(r){if(!A)return null;const e=r.worldData,t=r.bitmap.width*r.scale,n=r.bitmap.height*r.scale,s=Math.max(t,n)*zm,a=r.getCenter(),o=A.queryRadius(a,s);let c=null;return o.forEach(l=>{if(l===r.id)return;const u=Yt(l);if(!u)return;const d=G.getGroupForPiece(u),f=G.getGroupForPiece(r);if(d&&f&&d===f)return;const h=u.worldData,g=$m(r,u,e,h);g&&(!c||g.score<c.score)&&(c=g)}),c}function _f(r){if(!r||r.length===0){$e&&($e=null,Ot(null,null));return}const e=[...new Set(r.map(i=>i.candidate.stationaryPieceId))],t=$e?$e.map(i=>i.pieceId).sort().join(","):"",n=e.sort().join(",");t!==n&&($e=r.map(i=>({pieceId:i.candidate.stationaryPieceId,data:i.candidate})),Ot(e,r))}function Um(){_f(null)}function Wm(r,e){if(!e)return;const t=e.mapping.movingCornerA,n=e.mapping.stationaryCornerA,i=r.worldData,s=Yt(e.stationaryPieceId);if(!s)return;const a=s.worldData,o=i.worldCorners[t],l=a.worldCorners[n].sub(o);Ym(r).forEach(d=>{if(A&&A.movePiece(d.id,l),ua){const f=ua(d.id);f&&tt(f,d)}})}function Ym(r){const e=G.getGroup(r.groupId);return e?e.allPieces:[r]}function Vm(r,e){if(!G){console.error("[connectionManager] GroupManager not available - cannot merge groups");return}G.mergeGroups(r,e)||console.error("[connectionManager] Group merge failed - pieces cannot be merged (likely connectivity violation)")}function bf(r){Yt=r.getPieceById,Ot=r.onHighlightChange||Ot,ua=r.getPieceElement||null,r.tolerance!=null&&(Je.CONNECTION_TOLERANCE=r.tolerance,Je.ALIGNMENT_TOLERANCE=r.tolerance),r.profileTolerance!=null&&(Je.PROFILE_TOLERANCE=r.profileTolerance)}function Xm(r){if(!r)return;const e=G.getGroup(r.groupId),t=e?e.allBorderPieces:[r],n=[];for(const i of t){const s=vf(i);s&&s.stationaryPieceId!=null&&n.push({movingPiece:i,candidate:s})}_f(n.length>0?n:null)}function Km(r,e=!1){if(!r)return;const t=G.getGroup(r.groupId),n=t?t.allBorderPieces:[r],i=[];for(const s of n){const a=vf(s);a&&a.stationaryPieceId!=null&&i.push({movingPiece:s,candidate:a})}if(i.length>0){i.sort((o,c)=>o.candidate.score-c.candidate.score);const s=i[0],a=Yt(s.candidate.stationaryPieceId);a&&(Wm(s.movingPiece,s.candidate),Vm(s.movingPiece,a),s.movingPiece.id,a.id,void 0)}Um()}const Q=new Map,Zm=Te,ld=24,Ue=Zm;function wf(r){if(A.getPiecePosition(r.id)instanceof b)return r;const t=A.getPiecePosition(r.id);if(!t||!(t instanceof b)){const n=(t==null?void 0:t.x)||0,i=(t==null?void 0:t.y)||0;A.setPiecePosition(r.id,new b(n,i))}return r}function Jm(r,e,t=!1){const n=r.clientWidth||800,i=r.clientHeight||600;if(console.debug("[pieceRenderer] scatterInitialPieces count",e.length,"noRotate:",t),Q.clear(),e.reduce((o,c)=>o+Math.min(c.imgRect.width,c.imgRect.height),0)/e.length*Ue,t)e.forEach(o=>{o.setRotation(0)});else{const o=[0,90,180,270];e.forEach(c=>{const l=o[Math.floor(Math.random()*o.length)];c.setRotation(l)})}const s=[];e.forEach(o=>{const c=document.createElement("div");c.className="piece",c.dataset.id=o.id;const l=document.createElement("canvas"),u=Math.max(ld,o.bitmap.width*Ue),d=Math.max(ld,o.bitmap.height*Ue);l.width=u,l.height=d;const f=l.getContext("2d");f.save(),f.scale(Ue,Ue),f.drawImage(o.bitmap,0,0),f.restore(),c.style.width=u+"px",c.style.height=d+"px";const h=Math.random()*(n-u),g=Math.random()*(i-d),p=new b(h+u/2,g+d/2);s.push(p),wf(o),c.appendChild(l),r.appendChild(c),Q.set(o.id,c),o.scale=Te});const a=e.length;for(let o=0;o<a;o++){const c=Math.floor(Math.random()*e.length),l=Math.floor(Math.random()*e.length);if(c!==l){const u=s[c];s[c]=s[l],s[l]=u}}e.forEach((o,c)=>{const l=Q.get(o.id);A.placePieceCenter(o.id,s[c],l),tt(l,o)}),G.initialize(),bf({getPieceById:o=>I.pieces.find(c=>c.id===o),onHighlightChange:(o,c)=>rf(o),getPieceElement:o=>Q.get(o)}),A.updateViewportArea(n,i),A.syncAllPositions(),A.attachPieceElements(Q),ef(Q)}function Qm(r,e){var i;const t=r.clientWidth||800,n=r.clientHeight||600;console.debug("[pieceRenderer] renderPiecesAtPositions count",e.length),Q.clear(),e.reduce((s,a)=>s+Math.min(a.imgRect.width,a.imgRect.height),0)/e.length*(((i=e[0])==null?void 0:i.scale)||Te),e.forEach(s=>{const a=document.createElement("div");a.className="piece",a.dataset.id=s.id;const o=document.createElement("canvas"),c=s.scale||Te,l=Math.max(24,s.bitmap.width*c),u=Math.max(24,s.bitmap.height*c);o.width=l,o.height=u;const d=o.getContext("2d");d.save(),d.scale(c,c),d.drawImage(s.bitmap,0,0),d.restore(),a.style.width=l+"px",a.style.height=u+"px",s.zIndex!==null&&s.zIndex!==void 0&&(a.style.zIndex=s.zIndex.toString()),wf(s),tt(a,s),a.appendChild(o),s.scale=c,Q.set(s.id,a),r.appendChild(a)}),G.initialize(),bf({getPieceById:s=>I.pieces.find(a=>a.id===s),tolerance:900,onHighlightChange:(s,a)=>rf(s),getPieceElement:s=>Q.get(s)}),A.updateViewportArea(t,n),A.syncAllPositions(),A.initializeMaxZIndex(),A.attachPieceElements(Q),ef(Q)}const ut="puzzle.save.v2",ey=1200,If=!1,ty=1,ry=25e5;let Vt=!1,ra=null,M=null;function dd(r){M=r,window.puzzlePersistence={manualSave:la,load:da,clear:nt,stats:()=>{var e;return{size:((e=localStorage.getItem(ut))==null?void 0:e.length)||0}}},window.addEventListener("beforeunload",()=>{if(Vt)try{la()}catch{}})}function Pf(){Vt=!0,ra&&clearTimeout(ra),ra=setTimeout(()=>{la()},ey)}function ny(r){let e=0,t=0;for(const n of r)n.gridY>e&&(e=n.gridY),n.gridX>t&&(t=n.gridX);return{rows:e+1,cols:t+1}}function iy(r=If){if(!M)return null;const e=M.getState();if(U.isArrayEmpty(e.pieces))return null;const t=e.pieces.map(s=>{var a,o;if(typeof s.serialize=="function")return s.serialize(r);{let c=null;if(r)try{c=(o=(a=s.bitmap)==null?void 0:a.toDataURL)==null?void 0:o.call(a)}catch{c=null}const l=gameTableController.getPiecePosition(s.id)||new b(0,0);return{id:s.id,gridX:s.gridX,gridY:s.gridY,rotation:s.rotation,displayX:l.x,displayY:l.y,groupId:s.groupId,sPoints:s.sPoints,w:s.imgRect.width,h:s.imgRect.height,scale:s.scale,imgX:s.imgRect.position.x,imgY:s.imgRect.position.y,bitmapData:c}}}),{rows:n,cols:i}=ny(e.pieces);return{version:"puzzleStateV2",savedAt:Date.now(),layout:{rows:n,cols:i},ui:{...M.getViewportState(),sliderValue:M.getSliderValue()},totalPieces:e.totalPieces,pieces:t,light:!r}}function la(){if(M)try{const r=M.getCurrentImage(),e=M.getCurrentImageSource();let t=If,n=0;for(;n<=ty;){const i=iy(t);if(!i)return;if(e&&(i.imageSource={source:e,width:((r==null?void 0:r.naturalWidth)||(r==null?void 0:r.width))??null,height:((r==null?void 0:r.naturalHeight)||(r==null?void 0:r.height))??null},typeof M.getCurrentImageId=="function")){const a=M.getCurrentImageId();a&&(i.imageSource.imageId=a,console.log("[persistence] Stored image ID for IndexedDB source:",a))}const s=JSON.stringify(i);if(s.length>ry&&t){console.warn(`[persistence] Payload ~${s.length}B above soft limit; retry without bitmaps.`),t=!1,n++;continue}try{localStorage.setItem(ut,s),Vt=!1;break}catch(a){if(t&&(a.name==="QuotaExceededError"||a.code===22)){console.warn("[persistence] Quota exceeded with bitmaps; retrying without them."),t=!1,n++;continue}console.warn("[persistence] Save failed",a);break}}}catch(r){console.warn("[persistence] Save failed (outer)",r)}}function sy(){return!!localStorage.getItem(ut)}function nt(){localStorage.removeItem(ut),console.info("[persistence] Cleared save")}function bt(){const r=sy();M&&typeof M.showResumePrompt=="function"?M.showResumePrompt({onResume:r?()=>da():null,onDiscard:()=>{r&&nt(),M.afterDiscard&&M.afterDiscard()},onCancel:()=>{},hasResume:r}):r&&window.confirm("Resume previous puzzle session?")?da():!r&&M.afterDiscard&&M.afterDiscard()}function da(){var t,n;if(!M)return;const r=localStorage.getItem(ut);if(!r)return;let e;try{e=JSON.parse(r)}catch{console.warn("[persistence] Corrupt save; clearing"),nt();return}if(e.version!=="puzzleStateV2"&&e.version!=="puzzleStateV1"){console.warn("[persistence] Version mismatch:",e.version);return}if((t=e.imageSource)!=null&&t.source){const i=e.imageSource.source;M.setImageSource(i);const s=new Image;if(s.onload=()=>{M.setImage(s),re(e,s)},s.onerror=()=>{console.warn("[persistence] Failed to load image from source:",i),console.warn("[persistence] This may be due to file being moved or URL no longer accessible"),re(e,null)},i.startsWith("idb:")&&e.imageSource.imageId){if(console.log("[persistence] Attempting to load IndexedDB source:",e.imageSource.imageId),st())try{Mp(e.imageSource.imageId).then(a=>{const o=URL.createObjectURL(a.blob);s.src=o,M.setImageId(a.id),s.onload=()=>{URL.revokeObjectURL(o),M.setImage(s),re(e,s)}}).catch(a=>{console.warn("[persistence] Failed to load IndexedDB image:",a),console.warn("[persistence] Image may have been deleted from browser storage"),re(e,null)});return}catch(a){console.warn("[persistence] IndexedDB loading failed:",a)}else console.warn("[persistence] IndexedDB not supported in this browser");console.warn("[persistence] Cannot reload IndexedDB image"),re(e,null);return}else i.startsWith("http://")||i.startsWith("https://")?(s.crossOrigin="anonymous",s.src=i):(console.warn("[persistence] Cannot reload local file:",i),console.warn("[persistence] Please select the file again if you want to see the image"),re(e,null))}else if((n=e.image)!=null&&n.src){const i=new Image;i.onload=()=>{M.setImage(i),re(e,i)},i.onerror=()=>{console.warn("[persistence] Failed to load embedded image"),re(e,null)},i.src=e.image.src}else re(e,null)}function re(r,e){var i;const t=r.pieces.map(s=>{const a=new Me({id:-1,gridY:s.gridY||0,gridX:s.gridX||0,corners:s.corners||{nw:{x:0,y:0},ne:{x:s.w,y:0},se:{x:s.w,y:s.h},sw:{x:0,y:s.h}},sPoints:s.sPoints||{},w:s.w,h:s.h}),o=a.generatePath(),c=a.calculateBoundingFrame(),l=Math.ceil(c.width),u=Math.ceil(c.height),d=document.createElement("canvas");d.width=l,d.height=u;const f=d.getContext("2d");if(s.bitmapData){const h=new Image;h.src=s.bitmapData,h.onload=()=>f.drawImage(h,0,0)}else if(e){f.save(),f.translate(-c.topLeft.x,-c.topLeft.y),f.clip(o);const h=s.imgX??0,g=s.imgY??0,p=new b(h,g),m=c.topLeft.add(p),y=c.bottomRight.add(p),_=new V(m,y.x-m.x,y.y-m.y);let v=y.x-m.x,w=y.y-m.y;const R=e.naturalWidth||e.width,P=e.naturalHeight||e.height,C=Math.max(0,_.position.x),q=Math.max(0,_.position.y),E=Math.min(v,R-C),S=Math.min(w,P-q),x=C-h,O=q-g;f.drawImage(e,C,q,E,S,x,O,E,S),f.restore()}else f.fillStyle="#222",f.fillRect(0,0,l,u);return new Me({id:s.id,gridX:s.gridX,gridY:s.gridY,rotation:s.rotation,position:new b(s.displayX||0,s.displayY||0),groupId:s.groupId,zIndex:s.zIndex,sPoints:s.sPoints,w:s.w,h:s.h,scale:s.scale,imgX:s.imgX,imgY:s.imgY,bitmap:d,path:o,corners:s.corners||{nw:{x:0,y:0},ne:{x:s.w,y:0},se:{x:s.w,y:s.h},sw:{x:0,y:s.h}}})});M.setPieces(t);const n=M.getState();n&&(n.noRotate=!1),M.renderPiecesFromState?M.renderPiecesFromState():M.redrawPiecesContainer(),r.ui&&typeof r.ui.zoomLevel=="number"&&typeof r.ui.panX=="number"&&typeof r.ui.panY=="number"&&M.applyViewportState(r.ui),((i=r.ui)==null?void 0:i.sliderValue)!=null&&M.setSliderValue(r.ui.sliderValue),console.info("[persistence] Loaded game",{pieces:t.length,light:r.light}),Vt=!1}const wt="pictures/",ie=20;let We=null;async function ay(){if(We!==null)return We;const r=[];try{const e=await fetch(`${wt}pictures.json`);if(e.ok){const n=((await e.json()).pictures||[]).map(i=>typeof i=="string"?{type:"local",filename:i,url:`${wt}${i}`,title:i.replace(/\.(png|jpg|jpeg|gif|webp)$/i,""),pieces:ie}:{type:"local",filename:i.filename,url:`${wt}${i.filename}`,title:i.title||i.filename.replace(/\.(png|jpg|jpeg|gif|webp)$/i,""),pieces:i.pieces??ie,removeColor:i.removeColor??!1,...i});r.push(...n),console.log(`[picture-gallery] Loaded ${n.length} local pictures`)}}catch(e){console.error("[picture-gallery] Error loading local pictures:",e)}try{const e=await fetch(`${wt}remote-pictures.json`);if(e.ok){const n=((await e.json()).pictures||[]).map(i=>({type:"remote",url:i.url,title:i.title??"Remote Image",pieces:i.pieces??ie,removeColor:i.removeColor??!1,...i}));r.push(...n),console.log(`[picture-gallery] Loaded ${n.length} remote pictures`)}}catch(e){console.error("[picture-gallery] Error loading remote pictures:",e)}return We=r,console.log(`[picture-gallery] Total ${We.length} pictures available`),We}async function Fa(r,e){const t=document.getElementById("picture-gallery-overlay");t&&t.remove();const n=document.createElement("div");n.id="picture-gallery-overlay",n.className="picture-gallery-overlay";const i=document.createElement("div");i.className="picture-gallery";const s=document.createElement("h2");s.textContent=T("gallery.title"),i.appendChild(s);const a=document.createElement("div");a.className="picture-gallery-filter-bar";const o=document.createElement("button");o.className="picture-gallery-filter-btn",o.innerHTML="",o.title=T("gallery.filterBaby");const c=document.createElement("button");c.className="picture-gallery-filter-btn",c.innerHTML="",c.title=T("gallery.filterStudent");const l=document.createElement("button");l.className="picture-gallery-filter-btn",l.innerHTML="",l.title=T("gallery.filterMaster"),a.appendChild(o),a.appendChild(c),a.appendChild(l),i.appendChild(a);let u=null;const d=document.createElement("div");d.className="picture-gallery-grid",i.appendChild(d);const f=await ay();function h(y){d.innerHTML="";let _=f;[o,c,l].forEach(v=>v.classList.remove("selected")),y==="baby"?(_=f.filter(v=>(v.pieces||ie)>=4&&(v.pieces||ie)<=8),o.classList.add("selected")):y==="student"?(_=f.filter(v=>(v.pieces||ie)>=10&&(v.pieces||ie)<=100),c.classList.add("selected")):y==="master"&&(_=f.filter(v=>(v.pieces||ie)>100),l.classList.add("selected")),y||(_=f),_.forEach(v=>{const w=document.createElement("a");w.className="picture-gallery-item";const R=v.pieces||ie,P=v.removeColor?"true":"false",C=v.license?`&license=${encodeURIComponent(v.license)}`:"",q=`?image=${encodeURIComponent(v.url)}&pieces=${R}&norotate=y&removeColor=${P}${C}`;w.href=q,w.title=T("gallery.itemTooltip",{title:v.title,pieces:R});const E=document.createElement("div");E.className="picture-gallery-item-container";const S=document.createElement("img");S.alt=v.title,S.loading="lazy",v.license?Et(v.url,v.license,{removeColor:v.removeColor,centered:!0,fontSizePercent:4,minFontSize:20,returnDataUrl:!0}).then(O=>{S.src=O}).catch(O=>{console.warn(`[picture-gallery] Failed to add license to preview: ${O.message}`),S.src=v.url,v.removeColor&&(S.style.filter="grayscale(100%)")}):(S.src=v.url,v.removeColor&&(S.style.filter="grayscale(100%)")),S.addEventListener("error",()=>{w.style.display="none",console.warn(`[picture-gallery] Failed to load image: ${v.url}`)});const x=document.createElement("div");x.className="picture-gallery-item-title",x.textContent=v.title,E.appendChild(S),E.appendChild(x),w.appendChild(E),w.addEventListener("click",O=>{O.preventDefault(),Ke(),r&&r(q)}),d.appendChild(w)}),g()}function g(){const y=document.createElement("button");y.className="picture-gallery-item picture-gallery-upload",y.title=T("gallery.uploadOwn");const _=document.createElement("div");_.className="picture-gallery-item-container";const v=document.createElement("div");v.innerHTML="",v.style.flex="0 0 80%",v.style.fontSize="6em",v.style.display="flex",v.style.alignItems="center",v.style.justifyContent="center",v.style.width="100%",_.appendChild(v);const w=document.createElement("div");w.className="picture-gallery-item-title",w.textContent=T("gallery.selectOwn"),_.appendChild(w),y.appendChild(_),y.style.border="none",y.style.background="transparent",y.style.cursor="pointer",y.style.padding="0",y.addEventListener("click",()=>{Ke(),e&&e()}),d.appendChild(y)}h(),o.addEventListener("click",()=>{u==="baby"?(u=null,h()):(u="baby",h("baby"))}),c.addEventListener("click",()=>{u==="student"?(u=null,h()):(u="student",h("student"))}),l.addEventListener("click",()=>{u==="master"?(u=null,h()):(u="master",h("master"))});const p=document.getElementById("logo");p&&(p.style.cursor="pointer",p.addEventListener("click",()=>{Fa(r,e)})),n.appendChild(i),document.body.appendChild(n),n.addEventListener("click",y=>{y.target===n&&(Ke(),e&&e())});const m=y=>{y.key==="Escape"&&(Ke(),e&&e(),document.removeEventListener("keydown",m))};document.addEventListener("keydown",m)}function Ke(){const r=document.getElementById("picture-gallery-overlay");r&&r.remove()}document.addEventListener("DOMContentLoaded",()=>{const r=document.getElementById("logo");r&&(r.style.cursor="pointer",r.addEventListener("click",()=>{Fa(e=>{window.location.href=e},()=>{Oa.click()})}))});"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.register("/pzl/service-worker.js",{type:"module"}).catch(e=>{console.warn("SW registration failed",e)})});const oy=300,cy=8,uy=100,Y=document.getElementById("piecesContainer");document.getElementById("checkButton");const qe=document.querySelector(".top-bar");let Re=!1;function Na(r){if(U.isArrayEmpty(r))return null;let e=new V;for(const t of r){if(!t)continue;const n=t.calculateBoundingFrame();if(!n)continue;const i=A.getPiecePosition(t.id)||new b(0,0),s=i.add(n.topLeft),a=i.add(n.bottomRight),o=V.fromPoints(s,a);o.isEmpty()||(e=e.plus(o))}return e.isEmpty()?null:e}function na(){if(U.isArrayEmpty(I.pieces))return;const r=Na(I.pieces);if(!r)return;const e=r.topLeft,t=k().add(e.scaled($()));ff(t)}function ly(){return $()}function dy(r,e,t={}){const{forceZoom:n=!1}=t;if(!U.isElementValid(Y))return;const i=Y.clientWidth,s=Y.clientHeight;function a(){const u=r.scaled($()),d=k().add(u),f=e.scaled($()),h=d,g=d.add(f);return{topLeft:h,bottomRight:g}}let o=a();if(n){const u=Math.max(0,-o.topLeft.x),d=Math.max(0,o.bottomRight.x-i),f=Math.max(0,-o.topLeft.y),h=Math.max(0,o.bottomRight.y-s),g=u+d,p=f+h;if(g>0||p>0){const y=g>0?i/(i+g):1,_=p>0?s/(s+p):1,v=Math.min(y,_);if(v<.999){const w=Math.max(qt,$()*v);w<$()-1e-4&&(Tt(w),K(),rt(),o=a())}}o.topLeft.x<0&&z(k().add(new b(-o.topLeft.x,0))),o.topLeft.y<0&&z(k().add(new b(0,-o.topLeft.y))),o.bottomRight.x>i&&z(k().sub(new b(o.bottomRight.x-i,0))),o.bottomRight.y>s&&z(k().sub(new b(0,o.bottomRight.y-s))),K();return}let c=!1;if(o.topLeft.x<0&&(z(k().add(new b(-o.topLeft.x,0))),c=!0),o.topLeft.y<0&&(z(k().add(new b(0,-o.topLeft.y))),c=!0),o.bottomRight.x>i&&(z(k().sub(new b(o.bottomRight.x-i,0))),c=!0),o.bottomRight.y>s&&(z(k().sub(new b(0,o.bottomRight.y-s))),c=!0),c&&(K(),o=a()),o.topLeft.x<0||o.topLeft.y<0||o.bottomRight.x>i||o.bottomRight.y>s){const u=i/e.x,d=s/e.y,f=Math.min($(),u,d);f<$()-5e-4?(Tt(Math.max(qt,f)),K(),o=a(),o.topLeft.x<0&&z(k().add(new b(-o.topLeft.x,0))),o.topLeft.y<0&&z(k().add(new b(0,-o.topLeft.y))),o.bottomRight.x>i&&z(k().sub(new b(o.bottomRight.x-i,0))),o.bottomRight.y>s&&z(k().sub(new b(0,o.bottomRight.y-s))),K(),rt()):c&&K()}else c&&K()}function Cf(){return{zoomLevel:$(),panX:k().x,panY:k().y}}function fy(r){Tt(r.zoomLevel),z(new b(r.panX,r.panY)),K()}function hy(){U.isArrayEmpty(I.pieces)||I.pieces.forEach(r=>{Ga(r)})}function gy(){I.pieces.forEach(t=>{Ga(t)});const r=I.pieces.map(t=>t.rotation),e=r.every(t=>t===r[0]);I.pieces.forEach(t=>{let n=!0,i=[];if(!e){const a={};r.forEach(c=>{a[c]=(a[c]||0)+1});const o=Object.entries(a).sort((c,l)=>l[1]-c[1])[0][0];t.rotation!==Number(o)&&(n=!1,i.push(`Inconsistent rotation: ${t.rotation} (most pieces at ${o})`))}const s={north:I.pieces.find(a=>a.gridX===t.gridX&&a.gridY===t.gridY-1),east:I.pieces.find(a=>a.gridX===t.gridX+1&&a.gridY===t.gridY),south:I.pieces.find(a=>a.gridX===t.gridX&&a.gridY===t.gridY+1),west:I.pieces.find(a=>a.gridX===t.gridX-1&&a.gridY===t.gridY)};Object.entries(s).forEach(([a,o])=>{o&&(t.groupId!==o.groupId?(n=!1,i.push(`Not connected to expected neighbor at (${o.gridX}, ${o.gridY})`)):A.arePiecesNeighbors(t,o)||(n=!1,i.push(`Neighbor ${a} (${o.gridX}, ${o.gridY}) corners are not properly aligned with this piece`)))}),Fm(t,n)}),Nm(I.pieces,{BLINK_INTERVAL_MS:oy,BLINK_HALF_CYCLES:cy,BLINK_START_DELAY_MS:uy})}document.addEventListener("keydown",r=>{if(r.key==="Escape"){const e=document.getElementById("helpModal");e&&e.style.display==="flex"&&(e.style.display="none")}});Y.addEventListener("mousedown",r=>{(r.button===1||r.button===0&&r.ctrlKey)&&r.target===Y&&(r.preventDefault(),lf(!0),df(new b(r.clientX,r.clientY)),Y.style.cursor="grabbing")});document.addEventListener("mousemove",r=>{if(uf()){r.preventDefault();const e=new b(r.clientX,r.clientY),t=e.sub(Om());z(k().add(t)),df(e),K()}});document.addEventListener("mouseup",r=>{uf()&&(lf(!1),Y.style.cursor="grab"),Pf()});async function py(){await qp(),Wd(),Am(),om(),um(na);try{const r=new URLSearchParams(window.location.search),e=r.get("image"),t=r.get("pieces"),n=r.get("norotate"),i=r.get("removeColor"),s=r.get("license");if(console.log("[deep-link] URL params:",{imageParam:e,piecesParam:t,noRotateParam:n,removeColorParam:i,licenseParam:s}),e&&t){const a=parseInt(t,10),o=n==="y"||n==="yes"||n==="true",c=i==="true"||i==="yes";console.log("[deep-link] Parsed values:",{desiredPieces:a,noRotate:o,noRotateParam:n,removeColor:c,removeColorParam:i}),U.isPositiveNumber(a)?(Re=!0,qe&&qe.classList.add("deep-link-mode"),localStorage.setItem("removeColor",c?"true":"false"),console.info("[deep-link] Loading image:",e,"with",a,"pieces",o?"(no rotation)":"",c?"(grayscale)":""),yp(e,{timeout:1e4,onLoad:async l=>{Jl(l),Ql(e),ed(s||null);const u=Hp(a);Zl(u),at(),cf(c),await aa(o),Re=!1,Ke()},onTimeout:()=>{Re=!1,qe&&qe.classList.remove("deep-link-mode"),bt()},onError:()=>{Re=!1,qe&&qe.classList.remove("deep-link-mode"),bt()}}).catch(()=>{})):console.warn("[deep-link] Invalid pieces param",t)}}catch(r){console.warn("[deep-link] Error processing deep link params",r)}if(mm(Dm),cm({initPersistence:dd,clearSavedGame:nt,tryOfferResume:bt,requestAutoSave:Pf}),dd({getViewportState:Cf,applyViewportState:fy,getSliderValue:$p,setSliderValue:Zl,getCurrentImage:Up,getCurrentImageSource:Wp,getCurrentImageId:Yp,setImage:Jl,setImageSource:Ql,setImageId:Vp,getImageLicense:Xp,setImageLicense:ed,regenerate:aa,getState:()=>I,setPieces:r=>{I.pieces=r,I.totalPieces=r.length},redrawPiecesContainer:()=>{const r=Ae();r&&(r.innerHTML="",scatterInitialPieces(r,I.pieces)),na(),se()},renderPiecesFromState:()=>{const r=Ae();r&&(r.innerHTML="",Qm(r,I.pieces)),na(),se(),A.syncAllPositions()},markDirtyHook:()=>se(),showResumePrompt:yy,afterDiscard:()=>{se(),Re||Fa(r=>{window.location.href=r},()=>{Oa.click()})}}),Re)try{nt(),console.info("[deep-link] Previous session discarded due to deep link mode")}catch(r){console.warn("[deep-link] Failed to clear previous save",r)}else bt()}py();const my=localStorage.getItem("removeColor");my==="true"&&cf(!0);function yy({onResume:r,onDiscard:e,onCancel:t,hasResume:n=!0}){const i=document.getElementById("resume-modal-overlay");if(i&&i.remove(),!document.getElementById("resume-modal-styles")){const u=document.createElement("style");u.id="resume-modal-styles",u.textContent=`
      #resume-modal-overlay { position: fixed; inset:0; background: rgba(0,0,0,0.55); display:flex; align-items:center; justify-content:center; z-index:10000; }
      .resume-modal { background:#1f1f1f; color:#f5f5f5; padding:24px 28px 30px; width: min(420px, 90%); border-radius:12px; box-shadow:0 10px 32px rgba(0,0,0,0.4); font-family: system-ui, sans-serif; animation: fadeIn 160ms ease-out; }
      .resume-modal h2 { margin:0 0 12px; font-size:1.35rem; letter-spacing:0.5px; }
      .resume-modal p { margin:0 0 20px; line-height:1.45; font-size:0.95rem; color:#d0d0d0; }
      .resume-actions { display:flex; gap:12px; flex-wrap:wrap; }
      .resume-actions button { flex:1 1 auto; cursor:pointer; border:none; border-radius:8px; padding:12px 14px; font-size:0.9rem; font-weight:600; letter-spacing:0.4px; transition: background 140ms, transform 120ms; }
      .resume-primary { background:#2d7ef7; color:#fff; }
      .resume-primary:hover { background:#1f6bd8; }
      .resume-warn { background:#444; color:#eee; }
      .resume-warn:hover { background:#555; }
      .resume-danger { background:#c44545; color:#fff; }
      .resume-danger:hover { background:#b23838; }
      .resume-actions button:active { transform: translateY(1px); }
      .resume-meta { margin-top:16px; font-size:0.7rem; text-transform:uppercase; opacity:0.6; letter-spacing:1px; text-align:right; }
      @keyframes fadeIn { from { opacity:0; transform: translateY(6px);} to { opacity:1; transform: translateY(0);} }
      @media (max-width:520px){ .resume-actions { flex-direction:column; } }
    `,document.head.appendChild(u)}const s=document.createElement("div");s.id="resume-modal-overlay";const a=n?`
    <button class="resume-primary" data-action="resume">${T("resume.resume")}</button>
    <button class="resume-warn" data-action="cancel">${T("resume.cancel")}</button>
    <button class="resume-danger" data-action="discard">${T("resume.discard")}</button>
  `:`
    <button class="resume-primary" data-action="discard">${T("welcome.start")}</button>
    <button class="resume-warn" data-action="cancel">${T("resume.cancel")}</button>
  `;s.innerHTML=`
    <div class="resume-modal" role="dialog" aria-modal="true" aria-labelledby="resume-modal-title">
      <div style="text-align: center; font-size: 4rem; margin-bottom: 12px; line-height: 1;"></div>
      <h2 id="resume-modal-title">${T(n?"resume.title":"welcome.title")}</h2>
      <p>${T(n?"resume.message":"welcome.message")}</p>
      <div class="resume-actions">
        ${a}
      </div>
      ${n?`<div class="resume-meta">${T("resume.meta")}</div>`:""}
    </div>`,document.body.appendChild(s);function o(){s.remove(),document.removeEventListener("keydown",c)}function c(u){u.key==="Escape"&&(o(),t&&t())}document.addEventListener("keydown",c),s.addEventListener("click",u=>{u.target===s&&(o(),t&&t())}),s.querySelectorAll("button").forEach(u=>{u.addEventListener("click",()=>{const d=u.dataset.action;d==="resume"?(o(),r&&r()):d==="discard"?(o(),e&&e()):d==="cancel"&&(o(),t&&t())})});const l=s.querySelector("button[data-action='resume']");l&&l.focus()}function vy(){if(U.isArrayEmpty(I.pieces))return;const r=(Y==null?void 0:Y.clientWidth)||0,e=(Y==null?void 0:Y.clientHeight)||0;if(r===0||e===0)return;const t=Na(I.pieces);if(!t)return;const n=t.topLeft.x,i=t.topLeft.y,s=t.bottomRight.x,a=t.bottomRight.y;if(!isFinite(n)||!isFinite(i)||!isFinite(s)||!isFinite(a))return;const o=Math.max(1,s-n),c=Math.max(1,a-i),l=Math.min(r/o,e/c),u=Math.max(qt,Math.min(nf,l));Tt(u),z(new b(-n*u,-i*u)),K(),rt(),ff(new b(0,0))}
